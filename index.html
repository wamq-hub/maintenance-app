<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© ØµÙŠØ§Ù†Ø© Ø§Ù„ÙƒÙ„ÙŠØ©</title>
<style>
/* === Reset & Base === */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Arial','Tahoma',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;line-height:1.6}

/* Login */
.login-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);z-index:1000;display:flex;justify-content:center;align-items:center;padding:20px}
.login-box{background:rgba(255,255,255,.95);padding:40px;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.1);width:100%;max-width:500px;text-align:center}
.login-box h1{color:#4facfe;margin-bottom:30px;font-size:2rem}
.logo{font-size:4rem;margin-bottom:20px}
.google-sheets-section{margin-top:30px;padding-top:20px;border-top:2px solid #4facfe;text-align:right}
.google-sheets-section h4{margin-bottom:15px;color:#333;font-size:1.2rem}
.sheets-input{width:100%;padding:12px;margin:8px 0;border:2px solid #e0e0e0;border-radius:10px;font-size:1rem}
.demo-accounts{margin-top:20px;padding-top:15px;border-top:1px solid #eee;font-size:.9rem;color:#666;text-align:right}

/* User bar */
.user-info-bar{background:#4facfe;color:#fff;padding:10px 30px;display:none;justify-content:space-between;align-items:center;box-shadow:0 2px 10px rgba(0,0,0,.1)}
.user-info{display:flex;align-items:center;gap:20px}
.btn-logout{background:rgba(255,255,255,.2);color:#fff;border:1px solid rgba(255,255,255,.3);padding:8px 16px;border-radius:15px;cursor:pointer;transition:.3s}
.btn-logout:hover{background:rgba(255,255,255,.3)}

/* App shell */
.container{max-width:1200px;margin:0 auto;background:rgba(255,255,255,.95);border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.1);overflow:hidden;display:none}
.header{background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);color:#fff;padding:30px;text-align:center}
.header h1{font-size:2.5rem;margin-bottom:10px;text-shadow:2px 2px 4px rgba(0,0,0,.3)}

/* Tabs */
.nav-tabs{display:flex;background:#f8f9fa;border-bottom:3px solid #4facfe}
.tab-button{flex:1;padding:15px 20px;background:none;border:none;cursor:pointer;font-size:1.1rem;font-weight:bold;transition:.3s;color:#666;display:block}
.tab-button.active{background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);color:#fff;transform:translateY(-2px)}
.tab-button:hover:not(.active){background:#e9ecef;color:#333}
.tab-button.hidden{display:none}

/* Tab content */
.tab-content{display:none;padding:30px;animation:fadeIn .5s ease-in}
.tab-content.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}

/* Forms */
.form-group{margin-bottom:25px}
.form-row{display:flex;gap:20px;flex-wrap:wrap}
.form-col{flex:1;min-width:250px}
label{display:block;margin-bottom:8px;font-weight:bold;color:#333;font-size:1.1rem}
input[type="text"],input[type="email"],input[type="tel"],input[type="password"],select,textarea{width:100%;padding:12px 15px;border:2px solid #e0e0e0;border-radius:10px;font-size:1rem;transition:.3s;background:#fff}
input:focus,select:focus,textarea:focus{outline:none;border-color:#4facfe;box-shadow:0 0 10px rgba(79,172,254,.3);transform:translateY(-1px)}
textarea{min-height:120px;resize:vertical}

/* Radios */
.radio-group{display:flex;gap:20px;flex-wrap:wrap;margin-top:10px}
.radio-item{display:flex;align-items:center;background:#f8f9fa;padding:12px 20px;border-radius:25px;border:2px solid transparent;cursor:pointer;transition:.3s}
.radio-item:hover{background:#e9ecef;transform:translateY(-2px)}
.radio-item input[type="radio"]{margin-left:10px;transform:scale(1.2)}
.radio-item input[type="radio"]:checked + label{color:#4facfe;font-weight:bold}

/* Buttons */
.btn{padding:15px 30px;border:none;border-radius:25px;font-size:1.1rem;font-weight:bold;cursor:pointer;transition:.3s;text-transform:uppercase;letter-spacing:1px}
.btn-primary{background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);color:#fff;box-shadow:0 5px 15px rgba(79,172,254,.4)}
.btn-primary:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(79,172,254,.6)}
.btn-success{background:linear-gradient(135deg,#43e97b 0%,#38f9d7 100%);color:#fff;box-shadow:0 5px 15px rgba(67,233,123,.4)}
.btn-warning{background:linear-gradient(135deg,#fa709a 0%,#fee140 100%);color:#fff;box-shadow:0 5px 15px rgba(250,112,154,.4)}
.btn-danger{background:linear-gradient(135deg,#ff6b6b 0%,#ee5a24 100%);color:#fff;box-shadow:0 5px 15px rgba(255,107,107,.4)}

/* Status */
.status-badge{padding:8px 15px;border-radius:20px;font-weight:bold;font-size:.9rem;display:inline-block;margin:5px}
.status-new{background:#e3f2fd;color:#1976d2}
.status-progress{background:#fff3e0;color:#f57c00}
.status-completed{background:#e8f5e8;color:#388e3c}
.status-pending{background:#fce4ec;color:#c2185b}
.status-waiting{background:#ede7f6;color:#6a1b9a}

/* Cards */
.request-card{background:#fff;border-radius:15px;padding:25px;margin-bottom:20px;box-shadow:0 8px 25px rgba(0,0,0,.1);border-right:5px solid #4facfe;transition:.3s}
.request-card:hover{transform:translateY(-5px);box-shadow:0 15px 35px rgba(0,0,0,.15)}
.request-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:15px;border-bottom:2px solid #f0f0f0}
.request-id{font-size:1.3rem;font-weight:bold;color:#4facfe}
.datetime-display{background:#f8f9fa;padding:10px 15px;border-radius:10px;margin-bottom:15px;border-right:3px solid #4facfe}

/* Stats */
.stats-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px}
.stat-card{background:#fff;padding:25px;border-radius:15px;text-align:center;box-shadow:0 8px 25px rgba(0,0,0,.1);border-top:4px solid;transition:.3s}
.stat-card:hover{transform:translateY(-5px);box-shadow:0 15px 35px rgba(0,0,0,.15)}
.stat-card.total{border-color:#4facfe}
.stat-card.completed{border-color:#43e97b}
.stat-card.progress{border-color:#fa709a}
.stat-card.pending{border-color:#fee140}
.stat-number{font-size:3rem;font-weight:bold;margin-bottom:10px}

/* Modal */
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:1000;backdrop-filter:blur(10px)}
.modal-content{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:30px;border-radius:20px;max-width:600px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.3)}
.close{position:absolute;top:15px;left:15px;font-size:2rem;cursor:pointer;color:#999;transition:.3s}
.close:hover{color:#333}

/* Print & PDF Styles */
@media print{
  body{background:white !important;font-size:12pt}
  .login-screen,.user-info-bar,.nav-tabs,.btn,button{display:none !important}
  .container{box-shadow:none !important;max-width:none !important;margin:0 !important}
  .header{background:white !important;color:#333 !important;border-bottom:2px solid #333}
  .report-header{text-align:center;margin-bottom:30px;border-bottom:3px solid #333;padding-bottom:20px}
  .college-logo{font-size:48pt;margin-bottom:10px}
  .college-info{margin:20px 0;line-height:1.8}
  .print-only{display:block !important}
  .no-print{display:none !important}
  table{border-collapse:collapse;width:100%;margin:20px 0}
  th,td{border:1px solid #333;padding:8px;text-align:center}
  th{background:#f0f0f0}
}
.print-only{display:none}

/* Responsive */
@media (max-width:768px){
 body{padding:10px}
 .form-row{flex-direction:column}
 .radio-group{flex-direction:column}
 .nav-tabs{flex-wrap:wrap}
 .header h1{font-size:1.8rem}
 .stats-container{grid-template-columns:1fr}
 .login-box{padding:20px;margin:10px}
}

/* Animations */
.success-animation{animation:successPulse .6s ease}
@keyframes successPulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}

/* Hijri Date Converter */
.date-converter{background:#f8f9fa;padding:15px;margin:15px 0;border-radius:10px;border-right:3px solid #4facfe}
</style>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
<!-- Print Header -->
<div class="print-only report-header">
  <div id="collegeLogo" class="college-logo"></div>
  <div class="college-info">
    <h1>Ø§Ù„ÙƒÙ„ÙŠØ© Ø§Ù„ØªÙ‚Ù†ÙŠØ©</h1>
    <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª</h2>
    <h3>ØªÙ‚Ø±ÙŠØ± Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©</h3>
  </div>
  <div>Ø§Ù„ØªØ§Ø±ÙŠØ®: <span id="printDate"></span></div>
</div>


<!-- Login -->
<div id="loginScreen" class="login-screen">
  <div class="login-box">
    <div class="logo">ğŸ“</div>
    <h1>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© ØµÙŠØ§Ù†Ø© Ø§Ù„ÙƒÙ„ÙŠØ©</h1>
    <form id="loginForm">
      <div class="form-group">
        <label for="username">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label>
        <input type="text" id="username" placeholder="Ù…Ø«Ø§Ù„: 001234" required />
      </div>
      <div class="form-group">
        <label for="password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <input type="password" id="password" required />
      </div>
      <button type="submit" class="btn btn-primary">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </form>

    <div class="google-sheets-section">
      <h4>ğŸ”— Ø±Ø¨Ø· Google Sheets (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·)</h4>
      <p style="font-size:0.9rem;color:#666;margin-bottom:10px">
        Ø¨Ø¹Ø¯ Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ø£ÙˆÙ„ØŒ Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ ÙƒÙ„ Ù…Ø±Ø©
      </p>
      <input type="text" id="sheetsApiKey" class="sheets-input" placeholder="Google API Key (Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø©)" />
      <input type="text" id="sheetsId" class="sheets-input" placeholder="Ù…Ø¹Ø±Ù Google Sheet - Ù…Ø«Ø§Ù„: 1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms" />
      <button type="button" class="btn btn-primary" onclick="connectGoogleSheets()">Ø±Ø¨Ø· Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
      <div id="sheetsStatus" style="margin-top:10px;color:#666;font-size:0.9rem"></div>
      
      <div style="background:#f0f8ff;padding:15px;margin:15px 0;border-radius:10px;border:1px solid #4facfe">
        <h5 style="color:#4facfe;margin-bottom:10px">ğŸ“‹ ØªÙ†Ø³ÙŠÙ‚ Google Sheet Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</h5>
        <table style="width:100%;font-size:0.85rem;border-collapse:collapse">
          <tr style="background:#4facfe;color:white">
            <th style="padding:5px;border:1px solid #ddd">A - Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th>
            <th style="padding:5px;border:1px solid #ddd">B - Ø§Ù„Ø§Ø³Ù…</th>
            <th style="padding:5px;border:1px solid #ddd">C - ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</th>
            <th style="padding:5px;border:1px solid #ddd">D - Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th>
          </tr>
          <tr>
            <td style="padding:5px;border:1px solid #ddd">000002</td>
            <td style="padding:5px;border:1px solid #ddd">Ø¯. Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¹Ù…ÙŠØ¯</td>
            <td style="padding:5px;border:1px solid #ddd">123456</td>
            <td style="padding:5px;border:1px solid #ddd">dean</td>
          </tr>
          <tr>
            <td style="padding:5px;border:1px solid #ddd">000003</td>
            <td style="padding:5px;border:1px solid #ddd">Ø£Ø­Ù…Ø¯ Ø§Ù„Ù…Ø´Ø±Ù</td>
            <td style="padding:5px;border:1px solid #ddd">123456</td>
            <td style="padding:5px;border:1px solid #ddd">supervisor</td>
          </tr>
        </table>
        <p style="margin-top:10px;font-size:0.8rem;color:#666">
          Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©: dean, supervisor, technician, employee
        </p>
      </div>
    </div>

    <div class="demo-accounts">
      <h4>Ø­Ø³Ø§Ø¨ ØªØ¬Ø±ÙŠØ¨ÙŠ - ÙˆÙƒÙŠÙ„ Ø¶Ø¨Ø· Ø§Ù„Ø¬ÙˆØ¯Ø©:</h4>
      <p><strong>Ø§Ù„Ø±Ù‚Ù…:</strong> 000001 | <strong>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</strong> quality123</p>
    </div>
  </div>
</div>

<!-- User bar -->
<div id="userInfoBar" class="user-info-bar no-print">
  <div class="user-info">
    <span id="currentUser"></span>
    <button class="btn-primary" onclick="generatePDFReport()">ğŸ“„ ØªÙ‚Ø±ÙŠØ± PDF</button>
    <button class="btn-primary" onclick="exportPDFViaServer()">ğŸ“„ ØªÙ‚Ø±ÙŠØ± PDF (Ø§Ù„Ù‚Ø§Ù„Ø¨)</button>
    <button class="btn-primary" onclick="exportViaServer()">ğŸ“¥ ØªÙ‚Ø±ÙŠØ± Excel (Ø§Ù„Ø®Ø§Ø¯Ù…)</button>
  </div>
  <button class="btn-logout" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</div>

<!-- App -->
<div class="container">
  <div class="header">
    <h1>ğŸ”§ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©</h1>
    <p>Ù†Ø¸Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„ Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©</p>
  </div>

  <div class="nav-tabs no-print">
    <button class="tab-button active" data-tab="new-request" onclick="showTab('new-request', this)">Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</button>
    <button class="tab-button" data-tab="technician-report" onclick="showTab('technician-report', this)">ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙÙ†ÙŠ</button>
    <button class="tab-button" data-tab="supervisor-review" onclick="showTab('supervisor-review', this)">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø´Ø±Ù</button>
    <button class="tab-button" data-tab="client-evaluation" onclick="showTab('client-evaluation', this)">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
    <button class="tab-button" data-tab="quality-report" onclick="showTab('quality-report', this)">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¬ÙˆØ¯Ø©</button>
  </div>

  <!-- Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ -->
  <div id="new-request" class="tab-content active">
    <h2>Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ ØµÙŠØ§Ù†Ø© Ø¬Ø¯ÙŠØ¯</h2>
    
    <div class="date-converter">
      <h4>Ù…Ø­ÙˆÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ/Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ</h4>
      <div style="display:flex;gap:20px;margin:10px 0;flex-wrap:wrap">
        <input type="date" id="gregorianInput" onchange="convertToHijri()" />
        <input type="text" id="hijriInput" placeholder="Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ" readonly />
      </div>
    </div>

    <form id="maintenanceForm">
      <div class="datetime-display">
        <strong>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</strong> <span id="requestNumber"></span> |
        <strong>Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ:</strong> <span id="gregorianDate"></span> |
        <strong>Ø§Ù„ÙŠÙˆÙ…:</strong> <span id="dayName"></span> |
        <strong>Ø§Ù„ÙˆÙ‚Øª:</strong> <span id="currentTime"></span> |
        <strong>Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ:</strong> <span id="hijriDate"></span>
      </div>


      <div class="form-row">
        <div class="form-col">
          <div class="form-group">
            <label>Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨</label>
            <div class="radio-group">
              <div class="radio-item"><input type="radio" id="electronic" name="requestType" value="Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" checked /><label for="electronic">Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label></div>
              <div class="radio-item"><input type="radio" id="phone" name="requestType" value="Ù‡Ø§ØªÙ" /><label for="phone">Ù‡Ø§ØªÙ</label></div>
              <div class="radio-item"><input type="radio" id="email" name="requestType" value="Ø¥ÙŠÙ…ÙŠÙ„" /><label for="email">Ø¥ÙŠÙ…ÙŠÙ„</label></div>
            </div>
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-col">
          <div class="form-group"><label for="clientName">Ø§Ø³Ù… ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨ *</label><input type="text" id="clientName" required /></div>
        </div>
        <div class="form-col">
          <div class="form-group"><label for="building">Ø§Ù„Ù…Ø¨Ù†Ù‰/Ø§Ù„Ø¯ÙˆØ± *</label><input type="text" id="building" required /></div>
        </div>
      </div>

      <div class="form-group">
        <label>Ù†ÙˆØ¹ Ø§Ù„ØµÙŠØ§Ù†Ø©</label>
        <div class="radio-group">
          <div class="radio-item"><input type="radio" id="emergency" name="maintenanceType" value="ØµÙŠØ§Ù†Ø© Ø·Ø§Ø±Ø¦Ø©" checked /><label for="emergency">ØµÙŠØ§Ù†Ø© Ø·Ø§Ø±Ø¦Ø©</label></div>
          <div class="radio-item"><input type="radio" id="preventive" name="maintenanceType" value="ØµÙŠØ§Ù†Ø© ÙˆÙ‚Ø§Ø¦ÙŠØ©" /><label for="preventive">ØµÙŠØ§Ù†Ø© ÙˆÙ‚Ø§Ø¦ÙŠØ©</label></div>
          <div class="radio-item"><input type="radio" id="periodic" name="maintenanceType" value="ØµÙŠØ§Ù†Ø© Ø¯ÙˆØ±ÙŠØ©" /><label for="periodic">ØµÙŠØ§Ù†Ø© Ø¯ÙˆØ±ÙŠØ©</label></div>
        </div>
      </div>

      <div class="form-group">
        <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„</label>
        <div class="radio-group">
          <div class="radio-item"><input type="radio" id="electrical" name="problemType" value="ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ" checked /><label for="electrical">ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ</label></div>
          <div class="radio-item"><input type="radio" id="ac" name="problemType" value="ØªÙƒÙŠÙŠÙ" /><label for="ac">ØªÙƒÙŠÙŠÙ</label></div>
          <div class="radio-item"><input type="radio" id="plumbing" name="problemType" value="Ø³Ø¨Ø§ÙƒØ©" /><label for="plumbing">Ø³Ø¨Ø§ÙƒØ©</label></div>
          <div class="radio-item"><input type="radio" id="electronics" name="problemType" value="Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª" /><label for="electronics">Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª</label></div>
          <div class="radio-item"><input type="radio" id="other" name="problemType" value="Ø£Ø®Ø±Ù‰" /><label for="other">Ø£Ø®Ø±Ù‰</label></div>
        </div>
      </div>

      <div class="form-group" id="otherProblemGroup" style="display:none">
        <label for="otherProblem">ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„ Ø§Ù„Ø¢Ø®Ø±</label>
        <input type="text" id="otherProblem" />
      </div>

      <div class="form-group">
        <label for="problemDescription">ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„ *</label>
        <textarea id="problemDescription" placeholder="Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø¨Ø§Ù„ØªÙØµÙŠÙ„..." required></textarea>
      </div>

      <button type="submit" class="btn btn-primary no-print">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
    </form>
  </div>

  <!-- ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙÙ†ÙŠ -->
  <div id="technician-report" class="tab-content">
    <h2>ØªÙ‚Ø±ÙŠØ± Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„ØµÙŠØ§Ù†Ø©</h2>
    <div id="technicianRequests"></div>
  </div>

  <!-- Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø´Ø±Ù -->
  <div id="supervisor-review" class="tab-content">
    <h2>Ù…Ø±Ø§Ø¬Ø¹Ø© Ø±Ø¦ÙŠØ³/Ù…Ø´Ø±Ù Ø§Ù„ØµÙŠØ§Ù†Ø©</h2>
    <div id="supervisorRequests"></div>
  </div>

  <!-- ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
  <div id="client-evaluation" class="tab-content">
    <h2>ØªÙ‚ÙŠÙŠÙ… ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨</h2>
    <div id="clientRequests"></div>
  </div>

  <!-- ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¬ÙˆØ¯Ø© -->
  <div id="quality-report" class="tab-content">
    <h2>ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¬ÙˆØ¯Ø© ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
      <!-- Ø²Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± -->
  <button onclick="generateExcelFromTemplate()" class="btn btn-primary" style="margin-bottom: 20px;">
    ğŸ“¥ Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Excel Ù…Ù† Ø§Ù„Ù‚Ø§Ù„Ø¨
  </button>
    <div class="stats-container">
      <div class="stat-card total"><div class="stat-number" id="totalRequests">0</div><div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div></div>
      <div class="stat-card completed"><div class="stat-number" id="completedRequests">0</div><div>ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­</div></div>
      <div class="stat-card progress"><div class="stat-number" id="progressRequests">0</div><div>Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</div></div>
      <div class="stat-card pending"><div class="stat-number" id="pendingRequests">0</div><div>Ù…Ø¹Ù„Ù‚</div></div>
    </div>
    <div id="detailedReport"></div>
  </div>
</div>

<!-- Modal -->
<div id="modal" class="modal no-print">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <div id="modalContent"></div>
  </div>
</div>

<script>
/* ====== State ====== */
let requests = JSON.parse(localStorage.getItem('maintenanceRequests')) || [];
let requestCounter = parseInt(localStorage.getItem('requestCounter')) || 1;
let currentUser = null;
let userType = null;
let currentUserData = null;



/* ====== Hijri Date Converter ====== */
function gregorianToHijri(gDate) {
  const g = new Date(gDate);
  const gYear = g.getFullYear();
  const gMonth = g.getMonth() + 1;
  const gDay = g.getDate();
  
  // ØªØ­ÙˆÙŠÙ„ Ù…Ø¨Ø³Ø· Ù„Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ (ØªÙ‚Ø±ÙŠØ¨ÙŠ)
  const totalDays = Math.floor((gYear - 622) * 365.25 + gMonth * 30.4375 + gDay - 227015);
  const hYear = Math.floor(totalDays / 354.367) + 1;
  const remainingDays = totalDays % 354.367;
  const hMonth = Math.floor(remainingDays / 29.531) + 1;
  const hDay = Math.floor(remainingDays % 29.531) + 1;
  
  const hijriMonths = [
    'Ù…Ø­Ø±Ù…', 'ØµÙØ±', 'Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„', 'Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø«Ø§Ù†ÙŠ', 'Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø£ÙˆÙ„Ù‰', 'Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø«Ø§Ù†ÙŠØ©',
    'Ø±Ø¬Ø¨', 'Ø´Ø¹Ø¨Ø§Ù†', 'Ø±Ù…Ø¶Ø§Ù†', 'Ø´ÙˆØ§Ù„', 'Ø°Ùˆ Ø§Ù„Ù‚Ø¹Ø¯Ø©', 'Ø°Ùˆ Ø§Ù„Ø­Ø¬Ø©'
  ];
  
  return `${Math.max(1, Math.min(30, hDay))} ${hijriMonths[Math.min(11, Math.max(0, hMonth - 1))]} ${hYear}Ù‡Ù€`;
}

function convertToHijri() {
  const gDate = document.getElementById('gregorianInput').value;
  if (gDate) {
    const hijriDate = gregorianToHijri(gDate);
    document.getElementById('hijriInput').value = hijriDate;
  }
}

/* ====== Google Sheets Integration ====== */
// ====== Google Sheets Integration (Ø­Ù‚ÙŠÙ‚ÙŠ) ======
let gapi_loaded = false;
let sheets_id = localStorage.getItem('sheets_id') || '';
let sheets_api_key = localStorage.getItem('sheets_api_key') || '';

async function connectGoogleSheets() {

  function normalizeSheetId(input){
    const m = String(input || '').match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
    return m ? m[1] : String(input || '').trim();
  }

  const sheetsIdInputRaw = (document.getElementById('sheetsId')?.value || '').trim();
  const sheetsIdInput    = normalizeSheetId(sheetsIdInputRaw);
  const apiKeyInput      = (document.getElementById('sheetsApiKey')?.value || '').trim();

  if (!sheetsIdInput) { alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù Google Sheet'); return; }
  if (!apiKeyInput)   { alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Google API Key');   return; }

  sheets_id      = sheetsIdInput;
  sheets_api_key = apiKeyInput;
  localStorage.setItem('sheets_id', sheets_id);
  localStorage.setItem('sheets_api_key', sheets_api_key);

  // ğŸ‘ˆ Ø³Ø·Ø± Ø§Ù„ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯
  const statusEl = document.getElementById('sheetsStatus');

  const showErr = async (resp) => {
    let body = '';
    try { body = await resp.text(); } catch {}
    const msg = body || (`HTTP ${resp.status}`);
    statusEl.textContent = `ÙØ´Ù„ ÙÙŠ Ø±Ø¨Ø· Google Sheets: ${msg}`;
    statusEl.style.color = '#ff6b6b';
    console.error('Sheets error:', resp.status, msg);
  };

  try {
    const metaUrl  = `https://sheets.googleapis.com/v4/spreadsheets/${encodeURIComponent(sheets_id)}?key=${encodeURIComponent(sheets_api_key)}`;
    const metaResp = await fetch(metaUrl);
    if (!metaResp.ok) { await showErr(metaResp); return; }
    const meta = await metaResp.json();

    const firstSheet = meta?.sheets?.[0]?.properties?.title;
    if (!firstSheet) {
      statusEl.textContent = 'ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ (ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø´ÙŠØª ÙŠØ­ØªÙˆÙŠ ÙˆØ±Ù‚Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)';
      statusEl.style.color = '#ff6b6b';
      return;
    }

    const rangeA1   = `${firstSheet}!A:D`;
    const valuesUrl = `https://sheets.googleapis.com/v4/spreadsheets/${encodeURIComponent(sheets_id)}/values/${encodeURIComponent(rangeA1)}?key=${encodeURIComponent(sheets_api_key)}`;

    const valuesResp = await fetch(valuesUrl);
    if (!valuesResp.ok) { await showErr(valuesResp); return; }

    const valuesJson = await valuesResp.json();
    const rows = valuesJson?.values || [];

    const data         = [];
    const headerWords  = ['Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ','employeeid','id','empid','emp id'];
    const headerTokens = headerWords.map(w => w.replace(/\s+/g,'').toLowerCase());

    for (let i = 0; i < rows.length; i++) {
      const row = Array.isArray(rows[i]) ? rows[i] : [];
      const [a = '', b = '', c = '', d = ''] = row.map(x => (x ?? '').toString().trim());
      const aNorm = a.replace(/\s+/g,'').toLowerCase();
      if (!a || headerTokens.includes(aNorm)) continue;

      data.push({
        employeeId: a,
        name: b || '',
        password: c || '',
        role: (d || '').toLowerCase(),
        canChangePassword: (d && d.toLowerCase() !== 'quality')
      });
    }

    if (!data.length) {
      statusEl.textContent = 'ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ù„ÙƒÙ† Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ù„Ø­Ø© ÙÙŠ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© A:D (ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ØµÙÙˆÙ).';
      statusEl.style.color = '#ff6b6b';
      return;
    }

    localStorage.setItem('sheetsUserData', JSON.stringify(data));
    statusEl.textContent = 'ØªÙ… Ø±Ø¨Ø· Google Sheets Ø¨Ù†Ø¬Ø§Ø­ ÙˆÙ‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!';
    statusEl.style.color = '#43e97b';
    statusEl.classList.add('success-animation');
    setTimeout(() => statusEl.classList.remove('success-animation'), 600);
  } catch (err) {
    console.error('Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹:', err);
    statusEl.textContent = `ÙØ´Ù„ ÙÙŠ Ø±Ø¨Ø· Google Sheets: ${err?.message || err}`;
    statusEl.style.color = '#ff6b6b';
  }
}

// Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©) Ø¨Ù†Ø³Ø®Ø© Ø¨Ø³ÙŠØ·Ø© ØªØ³ØªØ±Ø¬Ø¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
async function loadUserDataFromSheets() {
  try {
    const raw = localStorage.getItem('sheetsUserData');
    return raw ? JSON.parse(raw) : [];
  } catch {
    return [];
  }
}


function getUserFromSheets(employeeId, password) {
  const userData = JSON.parse(localStorage.getItem('sheetsUserData') || '[]');
  return userData.find(user => 
    user.employeeId === employeeId && user.password === password
  );
}

/* ====== Boot ====== */
document.addEventListener('DOMContentLoaded', () => {
  const savedUser = localStorage.getItem('currentUser');
  if (savedUser) {
    const u = JSON.parse(savedUser);
    loginUser(u.username, u.type, u.name);
  }

  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù€Sheet ID ÙˆØ§Ù„Ù€API Key Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ Ù…Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
  if (!localStorage.getItem('sheets_id')) {
    localStorage.setItem('sheets_id', '1U78Zgj5y-ay-MQAoN4ZqSzPcywp-rPRxft4DuOdmipQ');
  }
  if (!localStorage.getItem('sheets_api_key')) {
    localStorage.setItem('sheets_api_key', 'AIzaSyCwZ_MetFoLWkrXMAD2UlF8OTUYaynbYXg');
  }

  // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ù€localStorage
  const savedSheetsId  = localStorage.getItem('sheets_id');
  const savedApiKey    = localStorage.getItem('sheets_api_key');
  if (document.getElementById('sheetsId')) {
    document.getElementById('sheetsId').value = savedSheetsId || '';
  }
  if (document.getElementById('sheetsApiKey')) {
    document.getElementById('sheetsApiKey').value = savedApiKey || '';
  }

  updateDateTime();
  updateRequestNumber();
  setInterval(updateDateTime, 1000);

  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  document.getElementById('loginForm').addEventListener('submit', e => { 
    e.preventDefault(); 
    handleLogin(); 
  });

  // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„ Ø§Ù„Ø¢Ø®Ø±
  document.addEventListener('change', e => {
    if (e.target.name === 'problemType') {
      const g = document.getElementById('otherProblemGroup');
      if (!g) return;
      if (e.target.value === 'Ø£Ø®Ø±Ù‰') g.style.display = 'block';
      else { g.style.display = 'none'; document.getElementById('otherProblem').value = ''; }
    }
  });

  // Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø·Ù„Ø¨
  const maintenanceForm = document.getElementById('maintenanceForm');
  if (maintenanceForm) {
    maintenanceForm.addEventListener('submit', e => { 
      e.preventDefault(); 
      submitMaintenanceRequest(); 
    });
  }

  // ØªØ­Ø¯ÙŠØ« ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
  document.getElementById('printDate').textContent = new Date().toLocaleDateString('ar-SA');
});

/* ====== Auth ====== */
function handleLogin() {
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value;
  
  // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù† Google Sheets Ø£ÙˆÙ„Ø§Ù‹
  const sheetsUser = getUserFromSheets(username, password);
  if (sheetsUser) {
    currentUserData = sheetsUser;
    return loginUser(username, sheetsUser.role, sheetsUser.name);
  }
  
  alert('Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ø£Ùˆ Ù„Ù… ÙŠØªÙ… Ø±Ø¨Ø· Google Sheets');
}

function findUserById(id){
  try{
    const list = JSON.parse(localStorage.getItem('sheetsUserData') || '[]');
    return list.find(u => String(u.employeeId).trim() === String(id).trim());
  }catch{ return null; }
}

function loginUser(username, type, name) {
  currentUser = username;
  userType = type;

  // âœ… Ø¹ÙØ¨Ù‘Ù currentUserData Ø­ØªÙ‰ Ù…Ø¹ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
  const fromSheet = findUserById(username);
  currentUserData = fromSheet || {
    employeeId: username,
    name: name || username,
    role: type,
    canChangePassword: false
  };

  localStorage.setItem('currentUser', JSON.stringify({ username, type, name: currentUserData.name }));

  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('userInfoBar').style.display = 'flex';
  document.getElementById('currentUser').textContent = `${currentUserData.name} (${getUserTypeArabic(type)})`;
  document.querySelector('.container').style.display = 'block';

  setupUserInterface(type);
  updateDateTime();
  updateRequestNumber();
  updateAllDisplays();
}


function logout() { 
  localStorage.removeItem('currentUser'); 
  location.reload(); 
}

function getUserTypeArabic(type){
  switch(type){
    case 'quality': return 'ÙˆÙƒÙŠÙ„ Ø¶Ø¨Ø· Ø§Ù„Ø¬ÙˆØ¯Ø©';
    case 'dean': return 'Ø§Ù„Ø¹Ù…ÙŠØ¯';
    case 'supervisor': return 'Ù…Ø´Ø±Ù Ø§Ù„ØµÙŠØ§Ù†Ø©';
    case 'technician': return 'ÙÙ†ÙŠ Ø§Ù„ØµÙŠØ§Ù†Ø©';
    case 'employee': return 'Ù…ÙˆØ¸Ù Ø§Ù„ÙƒÙ„ÙŠØ©';
    default: return '';
  }
}

/* ====== UI Tabs & Permissions ====== */

function showTab(tabId, btnEl) {
  const allowed = {
    'quality':    ['new-request','technician-report','supervisor-review','client-evaluation','quality-report'],
    'dean':       ['new-request','technician-report','supervisor-review','client-evaluation','quality-report'],
    'supervisor': ['new-request','supervisor-review','quality-report'],
    'technician': ['technician-report'],
    'employee':   ['new-request','client-evaluation']
  };
  
  if (!allowed[userType] || !allowed[userType].includes(tabId)) { 
    alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©'); 
    return; 
  }

  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));

  const tab = document.getElementById(tabId);
  if (tab) tab.classList.add('active');
  if (btnEl) btnEl.classList.add('active');

  if (tabId === 'technician-report')      displayTechnicianRequests();
  else if (tabId === 'supervisor-review') displaySupervisorRequests();
  else if (tabId === 'client-evaluation') displayClientRequests();
  else if (tabId === 'quality-report')    displayQualityReport();
}

/* ====== Date/Time ====== */
function updateDateTime(){
  const now = new Date();
  const gd = now.toLocaleDateString('ar-SA');
  const hd = gregorianToHijri(now);
  const dn = now.toLocaleDateString('ar-SA',{weekday:'long'});
  const tm = now.toLocaleTimeString('ar-SA',{hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'});
  
  const gEl = document.getElementById('gregorianDate'); if (gEl) gEl.textContent = gd;
  const hEl = document.getElementById('hijriDate');     if (hEl) hEl.textContent = hd;
  const dEl = document.getElementById('dayName');       if (dEl) dEl.textContent = dn;
  const tEl = document.getElementById('currentTime');   if (tEl) tEl.textContent = tm;
}

function updateRequestNumber(){ 
  const el = document.getElementById('requestNumber'); 
  if (el) el.textContent = `#${String(requestCounter).padStart(6,'0')}`; 
}

/* ====== Submit New Request ====== */
async function submitMaintenanceRequest(){
  if (!['quality','dean','supervisor','employee'].includes(userType)) { 
    alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨Ø§Øª ØµÙŠØ§Ù†Ø©'); 
    return; 
  }

  const now = new Date();
  const problemType = document.querySelector('input[name="problemType"]:checked').value;
  const otherProblem = document.getElementById('otherProblem').value;

  let clientName = document.getElementById('clientName').value.trim();
  if (userType === 'employee') {    
    clientName = currentUserData?.name || clientName;
    document.getElementById('clientName').value = clientName;
  }

  const request = {
    id: requestCounter,
    number: `#${String(requestCounter).padStart(6,'0')}`,
    requestType: document.querySelector('input[name="requestType"]:checked').value,
    clientName,
    building: document.getElementById('building').value.trim(),
    maintenanceType: document.querySelector('input[name="maintenanceType"]:checked').value,
    problemType: (problemType === 'Ø£Ø®Ø±Ù‰' ? otherProblem.trim() : problemType),
    problemDescription: document.getElementById('problemDescription').value.trim(),
    status: 'Ø¬Ø¯ÙŠØ¯',
    createdBy: currentUserData?.name || clientName,   
    createdByType: userType,
    submittedAt: now.toISOString(),
    hijriDate: gregorianToHijri(now),
    gregorianDate: now.toLocaleDateString('ar-SA'),
    dayName: now.toLocaleDateString('ar-SA',{weekday:'long'}),
    time: now.toLocaleTimeString('ar-SA',{hour12:false})
  };

  requests.push(request);
  requestCounter++;
  localStorage.setItem('maintenanceRequests', JSON.stringify(requests));
  localStorage.setItem('requestCounter', String(requestCounter));
  // Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ù…Ù† Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Google Sheets
  await saveRequestToSheet(request);

  document.getElementById('maintenanceForm').reset();
  const otherGroup = document.getElementById('otherProblemGroup'); 
  if (otherGroup) otherGroup.style.display = 'none';
  updateRequestNumber();

  showModal(`
    <div style="text-align:center;padding:20px">
      <div style="font-size:4rem;color:#43e97b;margin-bottom:20px">âœ…</div>
      <h3 style="color:#43e97b;margin-bottom:15px">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!</h3>
      <p style="color:#666;margin-bottom:20px">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${request.number}</p>
      <p style="color:#666">Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨</p>
    </div>
  `);
  updateAllDisplays();
}

/* ====== PDF Report Generation ====== */
// Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù…Ù„Ù HTML Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…Ø­Ø³Ù†Ø©

// ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© generatePDFReport
function generatePDFReport() {
  try {
    // ØªØ­Ø¯ÙŠØ« ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±
    document.getElementById('printDate').textContent = new Date().toLocaleDateString('ar-SA');
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ PDF Ù…Ø­Ø³Ù†
    createEnhancedReportContent();
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± ØºÙŠØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
    document.body.classList.add('print-mode');
    
    // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
    setTimeout(() => {
      window.print();
      document.body.classList.remove('print-mode');
    }, 500);
    
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± PDF:', error);
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
  }
}

function createEnhancedReportContent() {
  const container = document.querySelector('.container');
  if (!container) return;

  // Ø¥Ù†Ø´Ø§Ø¡ ØµÙØ­Ø© ØªÙ‚Ø±ÙŠØ± Ù…Ù†Ø³Ù‚Ø©
  const reportHTML = `
    <div class="enhanced-report print-only" style="
      padding: 40px; 
      font-family: 'Arial', 'Tahoma', sans-serif;
      background: white;
      color: black;
      line-height: 1.8;
      page-break-inside: avoid;
    ">
      ${generateReportHeader()}
      ${generateStatsSection()}
      ${generateDetailedTable()}
      ${generateReportFooter()}
    </div>
  `;

  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
  const existingReport = document.querySelector('.enhanced-report');
  if (existingReport) {
    existingReport.remove();
  }
  
  container.insertAdjacentHTML('beforeend', reportHTML);
}

function generateReportHeader() {
  const currentDate = new Date().toLocaleDateString('ar-SA');
  const currentTime = new Date().toLocaleTimeString('ar-SA', {hour12: false});
  
  return `
    <div style="text-align: center; margin-bottom: 40px; border-bottom: 3px solid #4facfe; padding-bottom: 20px;">
      <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“</div>
      <h1 style="font-size: 24px; color: #1F4E79; margin: 10px 0;">${config.collegeName || 'Ø§Ù„ÙƒÙ„ÙŠØ© Ø§Ù„ØªÙ‚Ù†ÙŠØ©'}</h1>
      <h2 style="font-size: 20px; color: #666; margin: 5px 0;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª</h2>
      <h3 style="font-size: 18px; color: #4facfe; margin: 15px 0;">ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„ Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©</h3>
      <div style="font-size: 14px; color: #999; margin-top: 20px;">
        ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${currentDate} | Ø§Ù„ÙˆÙ‚Øª: ${currentTime}
      </div>
    </div>
  `;
}

function generateStatsSection() {
  const total = requests.length;
  const completed = requests.filter(r => r.clientEvaluation && r.status === 'Ù…ÙƒØªÙ…Ù„').length;
  const progress = requests.filter(r => 
    ['Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©', 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­', 'ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­', 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù…Ø´Ø±Ù'].includes(r.status)
  ).length;
  const pending = requests.filter(r => 
    ['Ù…Ø¹Ù„Ù‚', 'ÙŠØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©', 'ÙŠØ­ØªØ§Ø¬ Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ù…Ù„', 'Ù…Ø­Ø§Ù„ Ø¥Ù„Ù‰ Ù…ØªØ®ØµØµ'].includes(r.status)
  ).length;

  return `
    <div style="margin: 30px 0; page-break-inside: avoid;">
      <h3 style="color: #1F4E79; border-bottom: 2px solid #4facfe; padding-bottom: 10px; margin-bottom: 20px;">
        ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
      </h3>
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin: 20px 0;">
        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center; border-top: 4px solid #4facfe;">
          <div style="font-size: 32px; font-weight: bold; color: #4facfe;">${total}</div>
          <div style="color: #666; margin-top: 5px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
        </div>
        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center; border-top: 4px solid #43e97b;">
          <div style="font-size: 32px; font-weight: bold; color: #43e97b;">${completed}</div>
          <div style="color: #666; margin-top: 5px;">ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­</div>
        </div>
        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center; border-top: 4px solid #fa709a;">
          <div style="font-size: 32px; font-weight: bold; color: #fa709a;">${progress}</div>
          <div style="color: #666; margin-top: 5px;">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</div>
        </div>
        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center; border-top: 4px solid #fee140;">
          <div style="font-size: 32px; font-weight: bold; color: #f57c00;">${pending}</div>
          <div style="color: #666; margin-top: 5px;">Ù…Ø¹Ù„Ù‚</div>
        </div>
      </div>
    </div>
  `;
}

function generateDetailedTable() {
  if (!requests.length) {
    return '<p style="text-align: center; color: #666; padding: 40px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§</p>';
  }

  const tableRows = requests.map((r, index) => `
    <tr style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'}; page-break-inside: avoid;">
      <td style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-size: 11px;">${r.number}</td>
      <td style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-size: 11px;">${r.clientName}</td>
      <td style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-size: 11px;">${r.building}</td>
      <td style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-size: 11px;">${r.problemType}</td>
      <td style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-size: 11px;">${r.technicianReport ? r.technicianReport.techName : 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹ÙŠÙŠÙ†'}</td>
      <td style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-size: 11px;">
        <span style="
          padding: 4px 8px; 
          border-radius: 15px; 
          font-size: 10px; 
          font-weight: bold;
          background: ${getStatusColor(r.status)};
          color: white;
        ">${r.status}</span>
      </td>
      <td style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-size: 11px;">${r.gregorianDate}</td>
      <td style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-size: 11px;">${r.hijriDate}</td>
    </tr>
  `).join('');

  return `
    <div style="margin: 30px 0; page-break-inside: avoid;">
      <h3 style="color: #1F4E79; border-bottom: 2px solid #4facfe; padding-bottom: 10px; margin-bottom: 20px;">
        ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
      </h3>
      <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <thead style="display: table-header-group;">
            <tr style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
              <th style="padding: 15px 8px; text-align: center; border: 1px solid #dee2e6; font-weight: bold; font-size: 12px;">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
              <th style="padding: 15px 8px; text-align: center; border: 1px solid #dee2e6; font-weight: bold; font-size: 12px;">Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
              <th style="padding: 15px 8px; text-align: center; border: 1px solid #dee2e6; font-weight: bold; font-size: 12px;">Ø§Ù„Ù…Ø¨Ù†Ù‰</th>
              <th style="padding: 15px 8px; text-align: center; border: 1px solid #dee2e6; font-weight: bold; font-size: 12px;">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„</th>
              <th style="padding: 15px 8px; text-align: center; border: 1px solid #dee2e6; font-weight: bold; font-size: 12px;">Ø§Ù„ÙÙ†ÙŠ</th>
              <th style="padding: 15px 8px; text-align: center; border: 1px solid #dee2e6; font-weight: bold; font-size: 12px;">Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th style="padding: 15px 8px; text-align: center; border: 1px solid #dee2e6; font-weight: bold; font-size: 12px;">Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ</th>
              <th style="padding: 15px 8px; text-align: center; border: 1px solid #dee2e6; font-weight: bold; font-size: 12px;">Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ</th>
            </tr>
          </thead>
          <tbody>
            ${tableRows}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function getStatusColor(status) {
  switch(status) {
    case 'Ø¬Ø¯ÙŠØ¯': return '#2196F3';
    case 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©':
    case 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­': return '#FF9800';
    case 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù…Ø´Ø±Ù': return '#9C27B0';
    case 'ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­':
    case 'Ù…ÙƒØªÙ…Ù„': return '#4CAF50';
    case 'Ù…Ø¹Ù„Ù‚':
    case 'ÙŠØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©':
    case 'ÙŠØ­ØªØ§Ø¬ Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ù…Ù„':
    case 'Ù…Ø­Ø§Ù„ Ø¥Ù„Ù‰ Ù…ØªØ®ØµØµ': return '#F44336';
    default: return '#607D8B';
  }
}

function generateReportFooter() {
  const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
  
  return `
    <div style="margin-top: 40px; border-top: 2px solid #4facfe; padding-top: 20px; page-break-inside: avoid;">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px;">
        <div>
          <h4 style="color: #1F4E79; margin-bottom: 10px;">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ±:</h4>
          <p style="margin: 5px 0; color: #666; font-size: 12px;">â€¢ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
          <p style="margin: 5px 0; color: #666; font-size: 12px;">â€¢ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø­Ø¯Ø«Ø© Ø­ØªÙ‰ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</p>
          <p style="margin: 5px 0; color: #666; font-size: 12px;">â€¢ Ù„Ù„Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©</p>
        </div>
        <div style="text-align: left;">
          <h4 style="color: #1F4E79; margin-bottom: 10px;">Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±:</h4>
          <p style="margin: 5px 0; color: #666; font-size: 12px;">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${currentUser.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
          <p style="margin: 5px 0; color: #666; font-size: 12px;">Ø§Ù„Ù…Ù†ØµØ¨: ${getUserTypeArabic(currentUser.type || '')}</p>
          <p style="margin: 5px 0; color: #666; font-size: 12px;">Ø§Ù„ØªÙˆÙ‚ÙŠØ¹: ________________</p>
        </div>
      </div>
      
      <div style="text-align: center; margin-top: 30px; color: #999; font-size: 10px;">
        <p>Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø³Ø±ÙŠ ÙˆÙ…Ø®ØµØµ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ ÙÙ‚Ø·</p>
        <p style="margin-top: 10px;">Â© ${new Date().getFullYear()} ${config.collegeName || 'Ø§Ù„ÙƒÙ„ÙŠØ© Ø§Ù„ØªÙ‚Ù†ÙŠØ©'} - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª</p>
      </div>
    </div>
  `;
}

// ØªØ­Ø³ÙŠÙ† ØªØµØ¯ÙŠØ± Excel Ù…Ø¹ ØªÙ†Ø³ÙŠÙ‚ Ø£ÙØ¶Ù„
async function exportViaServer(){
  const latest = requests[requests.length - 1];
  if (!latest){
    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.');
    return;
  }

  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø¹Ø§Ø± ÙƒÙ€ data URL
  const logoDataUrl = config?.logoPath ? await fetchLogoAsDataURL(config.logoPath) : null;

  // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø³Ù‚Ø©
  const payload = {
    request_id:       latest.number || String(latest.id).padStart(6,'0'),
    maintenance_type: latest.problemType || '',
    location:         latest.building || '',
    priority:         latest.maintenanceType || '',
    requester_name:   latest.clientName || '',
    request_time:     latest.time || '',
    request_date:     latest.gregorianDate || '',
    fault_type:       latest.problemType || '',
    fault_desc:       latest.problemDescription || '',
    technician_name:  latest?.technicianReport?.techName || '',
    execution_date:   latest?.technicianReport?.gregorianDate || '',
    supervisor_name:  latest?.supervisorReview?.reviewerName || '',
    status:           latest.status || '',
    status_date:      latest?.supervisorReview?.gregorianDate || '',
    requester_name_2: latest.clientName || '',
    is_fixed:         latest?.clientEvaluation?.satisfaction === 'Ù†Ø¹Ù…' ? 'Ù†Ø¹Ù…'
                     : latest?.clientEvaluation?.satisfaction === 'Ù„Ø§'  ? 'Ù„Ø§' : '',
    fixed_date: latest?.clientEvaluation?.gregorianDate || '',
    logo_data_url: logoDataUrl || null
    };
    
    try {
      const apiBase = (typeof config !== 'undefined' && config.apiBase) ? config.apiBase.replace(/\/+$/,'') : '';
      const res = await fetch(`${apiBase}/api/export-excel`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });


    if(!res.ok){
      const err = await res.json().catch(()=>({error:'unknown'}));
      alert('ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¹Ø¨Ø± Ø§Ù„Ø®Ø§Ø¯Ù…: ' + (err.error || res.status));
      return;
    }

    const blob = await res.blob();
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href = url;
    a.download = `ØªÙ‚Ø±ÙŠØ±_${payload.request_id}.xlsx`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

    showModal(`
      <div style="text-align:center;padding:20px">
        <div style="font-size:4rem;color:#43e97b;margin-bottom:20px">âœ…</div>
        <h3 style="color:#43e97b;margin-bottom:15px">ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!</h3>
        <p style="color:#666">ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù: ØªÙ‚Ø±ÙŠØ±_${payload.request_id}.xlsx</p>
      </div>
    `);
    
  } catch(e){
    alert('Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…: ' + e.message);
  }
}

// Ø¯Ø§Ù„Ø© ØªØµØ¯ÙŠØ± PDF Ø¹Ø¨Ø± Ø§Ù„Ø®Ø§Ø¯Ù…
async function exportPDFViaServer(){
  const latest = requests[requests.length - 1];
  if (!latest){
    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.');
    return;
  }

  const logoDataUrl = config?.logoPath ? await fetchLogoAsDataURL(config.logoPath) : null;

  const payload = {
    request_id: latest.number || String(latest.id).padStart(6,'0'),
    maintenance_type: latest.problemType || '',
    location: latest.building || '',
    priority: latest.maintenanceType || '',
    requester_name: latest.clientName || '',
    request_time: latest.time || '',
    request_date: latest.gregorianDate || '',
    fault_type: latest.problemType || '',
    fault_desc: latest.problemDescription || '',
    technician_name: latest?.technicianReport?.techName || '',
    execution_date: latest?.technicianReport?.gregorianDate || '',
    supervisor_name: latest?.supervisorReview?.reviewerName || '',
    status: latest.status || '',
    status_date: latest?.supervisorReview?.gregorianDate || '',
    requester_name_2: latest.clientName || '',
    is_fixed: latest?.clientEvaluation?.satisfaction === 'Ù†Ø¹Ù…' ? 'Ù†Ø¹Ù…'
            : latest?.clientEvaluation?.satisfaction === 'Ù„Ø§'  ? 'Ù„Ø§' : '',
    fixed_date: latest?.clientEvaluation?.gregorianDate || '',
    logo_data_url: logoDataUrl || null
  };

  try{
    const apiBase = (typeof config !== 'undefined' && config.apiBase) ? config.apiBase : '';
    const res = await fetch(`${apiBase}/api/export-pdf`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });

    if(!res.ok){
      const err = await res.json().catch(()=>({error:'unknown'}));
      alert('ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± PDF: ' + (err.error || res.status));
      return;
    }

    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ØªÙ‚Ø±ÙŠØ±_PDF_${payload.request_id}.pdf`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    
  } catch(e){
    alert('Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…: ' + e.message);
  }
}
// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø¹Ø§Ø±
async function fetchLogoAsDataURL(src){
  try{
    const resp = await fetch(src, {cache:'reload'});
    if(!resp.ok) return null;
    const blob = await resp.blob();
    return await new Promise((resolve, reject) => {
      const fr = new FileReader();
      fr.onload = () => resolve(fr.result);
      fr.onerror = reject;
      fr.readAsDataURL(blob);
    });
  }catch(e){
    console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø¹Ø§Ø±:', e);
    return null;
  }
}

// CSS Ù…Ø­Ø³Ù† Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
const enhancedPrintCSS = `
<style>
@media print {
  * { 
    -webkit-print-color-adjust: exact !important; 
    color-adjust: exact !important; 
    print-color-adjust: exact !important;
  }
  
  body {
    background: white !important;
    font-size: 12pt !important;
    margin: 0 !important;
    padding: 0 !important;
  }
  
  .login-screen, .user-info-bar, .nav-tabs, .btn, button, .no-print {
    display: none !important;
  }
  
  .container {
    box-shadow: none !important;
    max-width: none !important;
    margin: 0 !important;
    background: white !important;
    border-radius: 0 !important;
  }
  
  .enhanced-report {
    font-size: 11pt !important;
    line-height: 1.4 !important;
    margin: 0 !important;
    padding: 20px !important;
  }
  
  .enhanced-report h1 { 
    font-size: 16pt !important; 
    page-break-after: avoid !important;
  }
  .enhanced-report h2 { 
    font-size: 14pt !important; 
    page-break-after: avoid !important;
  }
  .enhanced-report h3 { 
    font-size: 12pt !important; 
    page-break-after: avoid !important;
  }
  .enhanced-report h4 { 
    font-size: 11pt !important; 
    page-break-after: avoid !important;
  }
  
  .enhanced-report table {
    page-break-inside: auto !important;
    font-size: 10pt !important;
  }
  
  .enhanced-report tr {
    page-break-inside: avoid !important;
    page-break-after: auto !important;
  }
  
  .enhanced-report thead {
    display: table-header-group !important;
  }
  
  .enhanced-report th, .enhanced-report td {
    padding: 8px 4px !important;
    font-size: 9pt !important;
  }
  
  .print-only {
    display: block !important;
  }
  
  @page {
    margin: 1.5cm 1cm;
    size: A4;
  }
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø¹Ø±Ø¶ */
.enhanced-report table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 20px;
}

.enhanced-report th {
  background-color: #4472C4 !important;
  color: white !important;
  font-weight: bold;
  text-align: center;
}

.enhanced-report td {
  text-align: center;
  vertical-align: middle;
}

.enhanced-report tr:nth-child(even) {
  background-color: #f2f2f2 !important;
}

.enhanced-report .stats-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 15px;
  margin: 20px 0;
}

@media screen and (max-width: 768px) {
  .enhanced-report .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media screen and (max-width: 480px) {
  .enhanced-report .stats-grid {
    grid-template-columns: 1fr;
  }
}
</style>
`;

// Ø¥Ø¶Ø§ÙØ© CSS Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø­Ø³Ù†
if (!document.getElementById('enhancedPrintStyles')) {
  const styleElement = document.createElement('div');
  styleElement.id = 'enhancedPrintStyles';
  styleElement.innerHTML = enhancedPrintCSS;
  document.head.appendChild(styleElement);
}

// ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ù„Ø¨
async function generateExcelFromTemplate() {
  try {
    const templatePath = config.reportTemplate || "template.xlsx";

    const response = await fetch(templatePath);
    if (!response.ok) {
      throw new Error(`Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù„Ø¨: ${response.status}`);
    }
    
    const arrayBuffer = await response.arrayBuffer();
    const workbook = XLSX.read(arrayBuffer, { 
      type: 'array',
      cellStyles: true,
      cellFormulas: true,
      cellDates: true
    });
    
    const sheetName = workbook.SheetNames[0];
    const ws = workbook.Sheets[sheetName];

    // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø·Ù„Ø¨Ø§Øª
    if (!requests.length) {
      alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø¨ Ù„ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ ÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ±");
      return;
    }

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¢Ø®Ø± Ø·Ù„Ø¨ Ø£Ùˆ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
    const latest = requests[requests.length - 1];

    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
    const cellMappings = {
      'C8': latest.number,
      'F8': latest.problemType,
      'I8': latest.building,
      'D9': latest.maintenanceType,
      'D11': latest.clientName,
      'D13': latest.time,
      'H13': latest.gregorianDate,
      'C15': latest.problemType,
      'A19': latest.problemDescription,
      'C25': latest?.technicianReport?.techName || '',
      'H26': latest?.technicianReport?.gregorianDate || '',
      'C29': latest?.supervisorReview?.reviewerName || '',
      'C30': latest.status,
      'H31': latest?.supervisorReview?.gregorianDate || '',
      'C34': latest.clientName,
      'C35': latest?.clientEvaluation?.satisfaction === 'Ù†Ø¹Ù…' ? 'Ù†Ø¹Ù…' 
             : latest?.clientEvaluation?.satisfaction === 'Ù„Ø§' ? 'Ù„Ø§' : '',
      'H36': latest?.clientEvaluation?.gregorianDate || ''
    };

    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ±Ù‚Ø©
    Object.entries(cellMappings).forEach(([cell, value]) => {
      if (!ws[cell]) ws[cell] = {};
      ws[cell].t = "s";
      ws[cell].v = String(value || '');
    });

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³Ù… Ù…Ù„Ù Ù…Ù†Ø³Ù‚
    const timestamp = new Date().toISOString().slice(0, 10);
    const filename = `ØªÙ‚Ø±ÙŠØ±_Ø·Ù„Ø¨_${latest.number}_${timestamp}.xlsx`;
    
    // Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù
    XLSX.writeFile(workbook, filename);

    showModal(`
      <div style="text-align:center;padding:20px">
        <div style="font-size:4rem;color:#43e97b;margin-bottom:20px">âœ…</div>
        <h3 style="color:#43e97b;margin-bottom:15px">ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!</h3>
        <p style="color:#666">ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù: ${filename}</p>
        <p style="color:#666;font-size:0.9rem;margin-top:10px">
          Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${latest.number}<br>
          Ø§Ù„Ø¹Ù…ÙŠÙ„: ${latest.clientName}<br>
          Ø§Ù„ØªØ§Ø±ÙŠØ®: ${latest.gregorianDate}
        </p>
      </div>
    `);
    
  } catch (err) {
    console.error("Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±:", err);
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±:\n" + (err?.message || err));
  }
}
/* ====== Views ====== */
function displayTechnicianRequests(){
  const container = document.getElementById('technicianRequests'); 
  if (!container) return;
  
  let relevant = [];
  if (userType === 'technician') {
    relevant = requests.filter(r =>
      r.status === 'Ø¬Ø¯ÙŠØ¯' ||
      (r.technicianReport && r.technicianReport.techName === (currentUserData?.name || ''))
    );
  } else {
    relevant = requests.filter(r =>
      ['Ø¬Ø¯ÙŠØ¯','Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©','Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­','Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù…Ø´Ø±Ù'].includes(r.status)
    );
  }
  
  if (!relevant.length){ 
    container.innerHTML = emptyMsg('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹'); 
    return; 
  }

  container.innerHTML = relevant.map(r => `
    <div class="request-card">
      <div class="request-header">
        <div class="request-id">${r.number}</div>
        <div class="status-badge ${getStatusClass(r.status)}">${r.status}</div>
      </div>
      <div><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${r.clientName}</div>
      <div><strong>Ø§Ù„Ù…Ø¨Ù†Ù‰:</strong> ${r.building}</div>
      <div><strong>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„:</strong> ${r.problemType}</div>
      <div><strong>Ø§Ù„ÙˆØµÙ:</strong> ${r.problemDescription}</div>
      <div><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨:</strong> ${r.gregorianDate} - ${r.time}</div>
      <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ:</strong> ${r.hijriDate}</div>

      ${r.technicianReport ? `
        <div style="background:#f8f9fa;padding:15px;margin-top:15px;border-radius:10px">
          <h4>ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙÙ†ÙŠ:</h4>
          <div><strong>Ø§Ù„ÙÙ†ÙŠ:</strong> ${r.technicianReport.techName}</div>
          <div><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${r.technicianReport.status}</div>
          <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${r.technicianReport.gregorianDate} - ${r.technicianReport.time}</div>
          <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ:</strong> ${r.technicianReport.hijriDate}</div>
          ${r.technicianReport.notes ? `<div><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${r.technicianReport.notes}</div>` : ''}
        </div>
      ` : `
        <div style="margin-top:20px" class="no-print">
          <label for="techName${r.id}">Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ:</label>
          <input type="text" id="techName${r.id}" value="${currentUserData?.name || ''}" readonly style="margin:10px 0">
          <select id="techStatus${r.id}" style="margin:10px 0">
            <option value="Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</option>
            <option value="Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­</option>
            <option value="ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­">ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­</option>
            <option value="ÙŠØ­ØªØ§Ø¬ Ù‚Ø·Ø¹ ØºÙŠØ§Ø±">ÙŠØ­ØªØ§Ø¬ Ù‚Ø·Ø¹ ØºÙŠØ§Ø±</option>
            <option value="ÙŠØ­ØªØ§Ø¬ Ù…ØªØ®ØµØµ">ÙŠØ­ØªØ§Ø¬ Ù…ØªØ®ØµØµ</option>
          </select>
          <textarea id="techNotes${r.id}" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙÙ†ÙŠ..." style="margin:10px 0;min-height:80px"></textarea>
          <button class="btn btn-success" onclick="submitTechnicianReport(${r.id})">ØªØ³Ù„ÙŠÙ… Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        </div>
      `}
    </div>
  `).join('');
}

function displaySupervisorRequests(){
  const container = document.getElementById('supervisorRequests'); 
  if (!container) return;
  
  const list = requests.filter(r => r.technicianReport && !r.supervisorReview);
  if (!list.length){ 
    container.innerHTML = emptyMsg('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ØªØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©'); 
    return; 
  }

  container.innerHTML = list.map(r => `
    <div class="request-card">
      <div class="request-header">
        <div class="request-id">${r.number}</div>
        <div class="status-badge ${getStatusClass(r.status)}">${r.status}</div>
      </div>
      <div><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${r.clientName}</div>
      <div><strong>Ø§Ù„Ù…Ø¨Ù†Ù‰:</strong> ${r.building}</div>
      <div><strong>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„:</strong> ${r.problemType}</div>
      <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ:</strong> ${r.hijriDate}</div>

      <div style="background:#e3f2fd;padding:15px;margin:15px 0;border-radius:10px">
        <h4>ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙÙ†ÙŠ:</h4>
        <div><strong>Ø§Ù„ÙÙ†ÙŠ:</strong> ${r.technicianReport.techName}</div>
        <div><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${r.technicianReport.status}</div>
        ${r.technicianReport.notes ? `<div><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${r.technicianReport.notes}</div>` : ''}
        <div><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±:</strong> ${r.technicianReport.gregorianDate} - ${r.technicianReport.time}</div>
        <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ:</strong> ${r.technicianReport.hijriDate}</div>
      </div>

      <div style="margin-top:20px" class="no-print">
        <label>Ù‚Ø±Ø§Ø± Ø§Ù„Ù…Ø´Ø±Ù:</label>
        <select id="supervisorStatus${r.id}" style="margin:10px 0" onchange="toggleReferField(${r.id})">
          <option value="Ù…Ù‚Ø¨ÙˆÙ„">Ù…Ù‚Ø¨ÙˆÙ„ - ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­</option>
          <option value="Ù…Ø¹Ù„Ù‚">Ù…Ø¹Ù„Ù‚ - ÙŠØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©</option>
          <option value="Ù…Ø±ÙÙˆØ¶">Ù…Ø±ÙÙˆØ¶ - ÙŠØ­ØªØ§Ø¬ Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ù…Ù„</option>
          <option value="Ø¥Ø­Ø§Ù„Ø©">Ø¥Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ Ù…ØªØ®ØµØµ</option>
        </select>
        <textarea id="supervisorNotes${r.id}" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø´Ø±Ù..." style="margin:10px 0;min-height:80px"></textarea>
        <input type="text" id="referTo${r.id}" placeholder="Ø¥Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰..." style="display:none;margin:10px 0">
        <button class="btn btn-warning" onclick="submitSupervisorReview(${r.id})">Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
      </div>
    </div>
  `).join('');
}

function toggleReferField(requestId) {
  const select = document.getElementById(`supervisorStatus${requestId}`);
  const referField = document.getElementById(`referTo${requestId}`);
  
  if (select && referField) {
    if (select.value === 'Ø¥Ø­Ø§Ù„Ø©') {
      referField.style.display = 'block';
      referField.placeholder = 'Ø§ÙƒØªØ¨ Ø§Ù„Ø¬Ù‡Ø©/Ø§Ù„Ù…ØªØ®ØµØµ Ø§Ù„Ù…ÙØ­Ø§Ù„ Ø¥Ù„ÙŠÙ‡';
    } else {
      referField.style.display = 'none';
      referField.value = '';
    }
  }
}

function displayClientRequests(){
  const container = document.getElementById('clientRequests'); 
  if (!container) return;

  let list = [];
  if (userType === 'employee') {
    list = requests.filter(r => 
      r.supervisorReview && 
      !r.clientEvaluation && 
      r.clientName === (currentUserData?.name || '')
    );
  } else {
    list = requests.filter(r => r.supervisorReview && !r.clientEvaluation);
  }
  
  if (!list.length){ 
    container.innerHTML = emptyMsg('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ØªØ­ØªØ§Ø¬ ØªÙ‚ÙŠÙŠÙ…'); 
    return; 
  }

  container.innerHTML = list.map(r => `
    <div class="request-card">
      <div class="request-header">
        <div class="request-id">${r.number}</div>
        <div class="status-badge status-completed">${r.supervisorReview.status}</div>
      </div>
      <div><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${r.clientName}</div>
      <div><strong>Ø§Ù„Ù…Ø¨Ù†Ù‰:</strong> ${r.building}</div>
      <div><strong>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„:</strong> ${r.problemType}</div>
      <div><strong>Ø­Ø§Ù„Ø© Ø§Ù„Ø¥ØµÙ„Ø§Ø­:</strong> ${r.supervisorReview.status}</div>
      <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ:</strong> ${r.hijriDate}</div>
      
      <div style="margin-top:20px" class="no-print">
        <label>Ù‡Ù„ ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¹Ø·Ù„ØŸ</label>
        <div class="radio-group">
          <div class="radio-item">
            <input type="radio" id="satisfied${r.id}" name="clientSatisfaction${r.id}" value="Ù†Ø¹Ù…" />
            <label for="satisfied${r.id}">Ù†Ø¹Ù…</label>
          </div>
          <div class="radio-item">
            <input type="radio" id="notSatisfied${r.id}" name="clientSatisfaction${r.id}" value="Ù„Ø§" />
            <label for="notSatisfied${r.id}">Ù„Ø§</label>
          </div>
        </div>
        <textarea id="clientNotes${r.id}" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..." style="margin:10px 0"></textarea>
        <button class="btn btn-primary" onclick="submitClientEvaluation(${r.id})">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
      </div>
    </div>
  `).join('');
}

/* ====== Actions ====== */
function submitTechnicianReport(id){
  if (!['technician','quality','dean'].includes(userType)) {
    alert('ÙŠØ³Ù…Ø­ ÙÙ‚Ø· Ù„Ù„ÙÙ†ÙŠ Ø£Ùˆ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠÙŠÙ† Ø¨ØªØ³Ù„ÙŠÙ… ØªÙ‚Ø±ÙŠØ± ÙÙ†ÙŠ');
    return;
  }
  
  const r = requests.find(x => x.id === id);
  if (!r) return;
  
  const techName = document.getElementById(`techName${id}`).value.trim();
  const techStatus = document.getElementById(`techStatus${id}`).value;
  const techNotes = document.getElementById(`techNotes${id}`).value.trim();

  if (!techName){ 
    alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ'); 
    return; 
  }

  const now = new Date();
  const nextStatus = (techStatus === 'ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­')
    ? 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù…Ø´Ø±Ù'
    : techStatus;

  r.technicianReport = {
    techName,
    status: techStatus,
    notes: techNotes,
    submittedAt: now.toISOString(),
    hijriDate: gregorianToHijri(now),
    gregorianDate: now.toLocaleDateString('ar-SA'),
    time: now.toLocaleTimeString('ar-SA',{hour12:false})
  };

  r.status = nextStatus;

  localStorage.setItem('maintenanceRequests', JSON.stringify(requests));

  showModal(`
    <div style="text-align:center;padding:20px">
      <div style="font-size:4rem;color:#43e97b;margin-bottom:20px">âœ…</div>
      <h3 style="color:#43e97b;margin-bottom:15px">ØªÙ… ØªØ³Ù„ÙŠÙ… ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙÙ†ÙŠ Ø¨Ù†Ø¬Ø§Ø­!</h3>
      <p style="color:#666">Ø§Ù„Ø·Ù„Ø¨ Ø±Ù‚Ù…: ${r.number}</p>
    </div>
  `);
  displayTechnicianRequests();
  updateAllDisplays();
}

function submitSupervisorReview(id){
  const r = requests.find(x => x.id === id);
  if (!['quality','dean','supervisor'].includes(userType)){ 
    alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±'); 
    return; 
  }

  const status = document.getElementById(`supervisorStatus${id}`).value;
  const notes  = document.getElementById(`supervisorNotes${id}`).value.trim();
  const referTo= document.getElementById(`referTo${id}`).value.trim();

  const now = new Date();
  r.supervisorReview = {
    status, 
    notes, 
    referTo, 
    reviewerName: currentUserData?.name || '',
    submittedAt: now.toISOString(),
    hijriDate: gregorianToHijri(now),
    gregorianDate: now.toLocaleDateString('ar-SA'),
    time: now.toLocaleTimeString('ar-SA',{hour12:false})
  };

  switch(status){
    case 'Ù…Ù‚Ø¨ÙˆÙ„': r.status = 'ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­'; break;
    case 'Ù…Ø¹Ù„Ù‚': r.status = 'Ù…Ø¹Ù„Ù‚'; break;
    case 'Ù…Ø±ÙÙˆØ¶': r.status = 'ÙŠØ­ØªØ§Ø¬ Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ù…Ù„'; break;
    case 'Ø¥Ø­Ø§Ù„Ø©': r.status = 'Ù…Ø­Ø§Ù„ Ø¥Ù„Ù‰ Ù…ØªØ®ØµØµ'; break;
  }

  localStorage.setItem('maintenanceRequests', JSON.stringify(requests));
  showModal(`
    <div style="text-align:center;padding:20px">
      <div style="font-size:4rem;color:#fa709a;margin-bottom:20px">âœ…</div>
      <h3 style="color:#fa709a;margin-bottom:15px">ØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨Ù†Ø¬Ø§Ø­!</h3>
      <p style="color:#666">Ø§Ù„Ø·Ù„Ø¨ Ø±Ù‚Ù…: ${r.number}</p>
    </div>
  `);
  displaySupervisorRequests();
  updateAllDisplays();
}

function submitClientEvaluation(id){
  const r = requests.find(x => x.id === id);
  if (!r) return;
  
  const sat = document.querySelector(`input[name="clientSatisfaction${id}"]:checked`);
  const notes = document.getElementById(`clientNotes${id}`).value.trim();
  
  if (!sat){ 
    alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­'); 
    return; 
  }
  
  if (userType === 'employee' && r.clientName !== (currentUserData?.name || '')) {
    alert('Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªÙ‚ÙŠÙŠÙ… Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†'); 
    return; 
  }

  const now = new Date();
  r.clientEvaluation = {
    satisfaction: sat.value, 
    notes,
    evaluatorName: currentUserData?.name || '',
    submittedAt: now.toISOString(),
    hijriDate: gregorianToHijri(now),
    gregorianDate: now.toLocaleDateString('ar-SA'),
    time: now.toLocaleTimeString('ar-SA',{hour12:false})
  };
  
  r.status = (sat.value === 'Ù†Ø¹Ù…') ? 'Ù…ÙƒØªÙ…Ù„' : 'ÙŠØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©';

  localStorage.setItem('maintenanceRequests', JSON.stringify(requests));
  showModal(`
    <div style="text-align:center;padding:20px">
      <div style="font-size:4rem;color:#4facfe;margin-bottom:20px">âœ…</div>
      <h3 style="color:#4facfe;margin-bottom:15px">Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ Ø¹Ù„Ù‰ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…!</h3>
      <p style="color:#666">ØªÙ… ØªØ³Ø¬ÙŠÙ„ ØªÙ‚ÙŠÙŠÙ…Ùƒ Ù„Ù„Ø·Ù„Ø¨ Ø±Ù‚Ù…: ${r.number}</p>
    </div>
  `);
  displayClientRequests();
  updateAllDisplays();
}

/* ====== Quality Report ====== */
function displayQualityReport(){
  if (userType === 'technician'){
    const c = document.getElementById('detailedReport');
    if (c) c.innerHTML = '<p style="text-align:center;color:#666;padding:40px">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ø´Ø§Ù…Ù„</p>';
    return;
  }
  
  const total = requests.length;
  const completed = requests.filter(r => r.clientEvaluation && r.status === 'Ù…ÙƒØªÙ…Ù„').length;
  const progress = requests.filter(r =>
    ['Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©','Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­','ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­','Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù…Ø´Ø±Ù'].includes(r.status)
  ).length;
  const pending  = requests.filter(r =>
    ['Ù…Ø¹Ù„Ù‚','ÙŠØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©','ÙŠØ­ØªØ§Ø¬ Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ù…Ù„','Ù…Ø­Ø§Ù„ Ø¥Ù„Ù‰ Ù…ØªØ®ØµØµ'].includes(r.status)
  ).length;

  document.getElementById('totalRequests').textContent = total;
  document.getElementById('completedRequests').textContent = completed;
  document.getElementById('progressRequests').textContent = progress;
  document.getElementById('pendingRequests').textContent = pending;

  const detailed = document.getElementById('detailedReport');
  if (!requests.length){ 
    detailed.innerHTML = emptyMsg('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§'); 
    return; 
  }

  // Groupings
  const byProblem = {};
  const byMaintenance = {};
  const techStats = {};

  requests.forEach(r => {
    byProblem[r.problemType] = (byProblem[r.problemType] || 0) + 1;
    byMaintenance[r.maintenanceType] = (byMaintenance[r.maintenanceType] || 0) + 1;
    if (r.technicianReport){
      const t = r.technicianReport.techName;
      if (!techStats[t]) techStats[t] = { total:0, completed:0 };
      techStats[t].total++;
      if (['Ù…ÙƒØªÙ…Ù„','ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­'].includes(r.status)) techStats[t].completed++;
    }
  });

  const problemCard = `
    <div class="request-card">
      <h3 style="color:#4facfe;margin-bottom:20px">ğŸ“‹ ØªÙØµÙŠÙ„ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„</h3>
      ${Object.entries(byProblem).map(([k,v]) => rowKV(k,v,'status-new')).join('')}
    </div>
  `;

  const maintenanceCard = `
    <div class="request-card">
      <h3 style="color:#43e97b;margin-bottom:20px">ğŸ”§ ØªÙØµÙŠÙ„ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„ØµÙŠØ§Ù†Ø©</h3>
      ${Object.entries(byMaintenance).map(([k,v]) => rowKV(k,v,'status-completed')).join('')}
    </div>
  `;

  const techCard = Object.keys(techStats).length ? `
    <div class="request-card">
      <h3 style="color:#764ba2;margin-bottom:20px">ğŸ”§ Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙÙ†ÙŠÙŠÙ†</h3>
      ${Object.entries(techStats).map(([tech,st]) => {
        const pct = Math.round((st.completed / st.total)*100);
        const badge = (pct>=80)?'status-completed':(pct>=60)?'status-progress':'status-pending';
        return `
          <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid #eee">
            <span>${tech}</span>
            <div>
              <span class="status-badge status-completed">${st.completed}/${st.total}</span>
              <span class="status-badge ${badge}">${pct}%</span>
            </div>
          </div>
        `;
      }).join('')}
    </div>
  ` : '';

  const table = `
    <div class="request-card" style="margin-top:30px">
      <h3 style="color:#fa709a;margin-bottom:20px">ğŸ“Š Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
      <div style="overflow-x:auto">
        <table style="width:100%;border-collapse:collapse">
          <thead>
            <tr style="background:#f8f9fa">
              ${['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨','Ø§Ù„Ø¹Ù…ÙŠÙ„','Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„','Ø§Ù„ÙÙ†ÙŠ','Ø§Ù„Ø­Ø§Ù„Ø©','Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ','Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ','Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª'].map(h => 
                `<th style="padding:15px;text-align:center;border:1px solid #dee2e6">${h}</th>`
              ).join('')}
            </tr>
          </thead>
          <tbody>
              ${requests.map(r => `
                <tr>
                  <td style="padding:12px;text-align:center;border:1px solid #dee2e6">${r.number}</td>
                  <td style="padding:12px;text-align:center;border:1px solid #dee2e6">${r.clientName}</td>
                  <td style="padding:12px;text-align:center;border:1px solid #dee2e6">${r.problemType}</td>
                  <td style="padding:12px;text-align:center;border:1px solid #dee2e6">${r.technicianReport ? r.technicianReport.techName : 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹ÙŠÙŠÙ†'}</td>
                  <td style="padding:12px;text-align:center;border:1px solid #dee2e6">
                    <span class="status-badge ${getStatusClass(r.status)}">${r.status}</span>
                  </td>
                  <td style="padding:12px;text-align:center;border:1px solid #dee2e6">${r.gregorianDate}</td>
                  <td style="padding:12px;text-align:center;border:1px solid #dee2e6">${r.hijriDate}</td>
                  <td style="padding:12px;text-align:center;border:1px solid #dee2e6" class="no-print">
                    ${['quality','dean'].includes(userType) ? 
                      `<button class="btn btn-danger" style="padding:5px 10px;margin:2px;font-size:.8rem" onclick="deleteRequest(${r.id})">Ø­Ø°Ù</button>` : 
                      '-'}
                  </td>
                </tr>
              `).join('')}
            </tbody>
        </table>
      </div>
    </div>
  `;

  detailed.innerHTML = `
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:30px;margin-top:30px">
      ${problemCard}
      ${maintenanceCard}
      ${techCard}
    </div>
    ${table}
  `;
}

/* ====== Password Management ====== */
function changePassword() {
  if (!currentUserData || !currentUserData.canChangePassword) {
    alert('Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
    return;
  }
  
  const newPassword = prompt('Ø§Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:');
  if (!newPassword) return;
  
  const confirmPassword = prompt('ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:');
  if (newPassword !== confirmPassword) {
    alert('ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©');
    return;
  }
  
  // ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
  const userData = JSON.parse(localStorage.getItem('sheetsUserData') || '[]');
  const userIndex = userData.findIndex(u => u.employeeId === currentUser);
  
  if (userIndex !== -1) {
    userData[userIndex].password = newPassword;
    localStorage.setItem('sheetsUserData', JSON.stringify(userData));
    
    // ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØŒ ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ« Google Sheets Ù‡Ù†Ø§
    updatePasswordInSheets(currentUser, newPassword);
    
    alert('ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­');
  }
}


// ==== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆÙŠØ¨-Ø¢Ø¨ (Apps Script) ====
// ØºÙŠÙ‘Ø± ÙÙ‚Ø· Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ùˆ Ø§Ù„Ø³Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
const APPS_SCRIPT_URL    = 'https://script.google.com/macros/s/AKfycbz7Slqwx4zeevaKUpKTqsIyzPbi2M9viyYrVfy5ulOInhq1gMTMTgZuBd4k4Au21YM5/exec';
const APPS_SCRIPT_SECRET = '1193';
const SHEET_NAME         = 'Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ¸ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙŠØ§Ù†Ø©'; // Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø§Ø³Ù… Ù„Ùˆ ÙˆØ±Ù‚ØªÙƒ Ù…Ø®ØªÙ„ÙØ©

// ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙŠ Google Sheet Ø¹Ø¨Ø± Web App
async function updatePasswordInSheets(employeeId, newPassword) {
  try {
    const resp = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      // Ù„Ø§ ØªØ±Ø³Ù„ Ø£ÙŠ Ù…ÙØ§ØªÙŠØ­ API Ù‡Ù†Ø§ â€” ÙÙ‚Ø· Ø§Ù„Ø³Ø± Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„ÙˆÙŠØ¨-Ø¢Ø¨
      body: JSON.stringify({
        secret: APPS_SCRIPT_SECRET,
        spreadsheetId: sheets_id,
        employeeId,
        newPassword,
        sheetName: SHEET_NAME
      })
    });

    // Ù†Ø­Ø§ÙˆÙ„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø¯Ø§Ø¦Ù…Ù‹Ø§ ÙƒÙ€ JSON
    const data = await resp.json().catch(() => ({}));

    if (!resp.ok || !data.ok) {
      const msg = (data && (data.error || data.message)) || `HTTP ${resp.status}`;
      throw new Error(msg);
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ²Ø§Ù…Ù† Ø§Ù„ÙÙˆØ±ÙŠ
    const users = JSON.parse(localStorage.getItem('sheetsUserData') || '[]');
    const idx = users.findIndex(
      u => String((u.employeeId || '')).trim() === String((employeeId || '')).trim()
    );
    if (idx !== -1) {
      users[idx].password = newPassword;
      localStorage.setItem('sheetsUserData', JSON.stringify(users));
    }

    console.log('ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙŠ Ø§Ù„Ø´ÙŠØª | Ø§Ù„ØµÙ:', data.row);
    return true;
  } catch (err) {
    console.error('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙŠ Ø§Ù„Ø´ÙŠØª:', err);
    alert('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙŠ Google Sheet: ' + (err.message || err));
    return false;
  }
}

/* ====== Helpers ====== */
function rowKV(k,v,cls){ 
  return `
    <div style="display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid #eee">
      <span>${k}</span><span class="status-badge ${cls}">${v}</span>
    </div>
  `; 
}

function emptyMsg(txt){
  return `<p style="text-align:center;color:#666;padding:40px">
            <span style="font-size:1.6rem">â„¹ï¸</span><br>${txt}
          </p>`;
}

function updateAllDisplays(){ 
  displayTechnicianRequests(); 
  displaySupervisorRequests(); 
  displayClientRequests(); 
  displayQualityReport(); 
}

function getStatusClass(status){
  switch(status){
    case 'Ø¬Ø¯ÙŠØ¯': return 'status-new';
    case 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©':
    case 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­': return 'status-progress';
    case 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù…Ø´Ø±Ù': return 'status-waiting';
    case 'ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­':
    case 'Ù…ÙƒØªÙ…Ù„': return 'status-completed';
    case 'Ù…Ø¹Ù„Ù‚':
    case 'ÙŠØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©':
    case 'ÙŠØ­ØªØ§Ø¬ Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ù…Ù„':
    case 'Ù…Ø­Ø§Ù„ Ø¥Ù„Ù‰ Ù…ØªØ®ØµØµ': return 'status-pending';
    default: return 'status-new';
  }
}

function deleteRequest(id){
  if (!['quality','dean'].includes(userType)){ 
    alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨Ø§Øª'); 
    return; 
  }
  
  if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ')){
    requests = requests.filter(r => r.id !== id);
    localStorage.setItem('maintenanceRequests', JSON.stringify(requests));
    updateAllDisplays();
    showModal(`
      <div style="text-align:center;padding:20px">
        <div style="font-size:4rem;color:#dc3545;margin-bottom:20px">ğŸ—‘ï¸</div>
        <h3 style="color:#dc3545;margin-bottom:15px">ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!</h3>
      </div>
    `);
  }
}

function showModal(html){ 
  document.getElementById('modalContent').innerHTML = html; 
  document.getElementById('modal').style.display='block'; 
  setTimeout(closeModal,3000); 
}

function closeModal(){ 
  document.getElementById('modal').style.display='none'; 
}

/* ====== Event Listeners ====== */
document.addEventListener('change', e => {
  // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø®Ø§Ù†Ø© "Ø¥Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰..." Ø­Ø³Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø´Ø±Ù
  if (e.target.id && e.target.id.startsWith('supervisorStatus')) {
    const id = parseInt(e.target.id.replace('supervisorStatus',''), 10);
    toggleReferField(id);
  }
});

// ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙŠ Ø§Ù„Ù…Ø­ÙˆÙ„
document.addEventListener('DOMContentLoaded', () => {
  const gregorianInput = document.getElementById('gregorianInput');
  if (gregorianInput) {
    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ ÙƒÙ‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    gregorianInput.value = new Date().toISOString().split('T')[0];
    convertToHijri();
  }
});

/* ====== Export Functions ====== */
function exportToExcel() {
  if (!['quality','dean','supervisor'].includes(userType)) {
    alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    return;
  }

  const workbook = XLSX.utils.book_new();
  
  // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±
  const exportData = requests.map(r => ({
    'Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨': r.number,
    'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„': r.clientName,
    'Ø§Ù„Ù…Ø¨Ù†Ù‰': r.building,
    'Ù†ÙˆØ¹ Ø§Ù„ØµÙŠØ§Ù†Ø©': r.maintenanceType,
    'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„': r.problemType,
    'ÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©': r.problemDescription,
    'Ø§Ù„Ø­Ø§Ù„Ø©': r.status,
    'Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ': r.gregorianDate,
    'Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ': r.hijriDate,
    'Ø§Ù„ÙˆÙ‚Øª': r.time,
    'Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ': r.technicianReport ? r.technicianReport.techName : '',
    'Ø­Ø§Ù„Ø© Ø§Ù„ÙÙ†ÙŠ': r.technicianReport ? r.technicianReport.status : '',
    'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙÙ†ÙŠ': r.technicianReport ? r.technicianReport.notes : '',
    'Ù‚Ø±Ø§Ø± Ø§Ù„Ù…Ø´Ø±Ù': r.supervisorReview ? r.supervisorReview.status : '',
    'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø´Ø±Ù': r.supervisorReview ? r.supervisorReview.notes : '',
    'ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ù…ÙŠÙ„': r.clientEvaluation ? r.clientEvaluation.satisfaction : '',
    'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„': r.clientEvaluation ? r.clientEvaluation.notes : ''
  }));

  const worksheet = XLSX.utils.json_to_sheet(exportData);
  XLSX.utils.book_append_sheet(workbook, worksheet, 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØµÙŠØ§Ù†Ø©');

  // ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ù
  const fileName = `ØªÙ‚Ø±ÙŠØ±_Ø§Ù„ØµÙŠØ§Ù†Ø©_${new Date().toISOString().split('T')[0]}.xlsx`;
  XLSX.writeFile(workbook, fileName);
  
  showModal(`
    <div style="text-align:center;padding:20px">
      <div style="font-size:4rem;color:#43e97b;margin-bottom:20px">ğŸ“Š</div>
      <h3 style="color:#43e97b;margin-bottom:15px">ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!</h3>
      <p style="color:#666">ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù: ${fileName}</p>
    </div>
  `);
}

// Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
document.addEventListener('DOMContentLoaded', () => {
  const userInfo = document.querySelector('.user-info');
  if (userInfo) {
    const exportBtn = document.createElement('button');
    exportBtn.className = 'btn-primary';
    exportBtn.onclick = exportToExcel;
    exportBtn.innerHTML = 'ğŸ“Š ØªØµØ¯ÙŠØ± Excel';
    exportBtn.style.display = 'none';
    exportBtn.id = 'exportBtn';
    userInfo.appendChild(exportBtn);
  }
});

// Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„ØªØµØ¯ÙŠØ± Ù„Ù„Ù…Ø®ÙˆÙ„ÙŠÙ†
function updateExportButtonVisibility() {
  const exportBtn = document.getElementById('exportBtn');
  if (exportBtn) {
    if (['quality','dean','supervisor'].includes(userType)) {
      exportBtn.style.display = 'inline-block';
    } else {
      exportBtn.style.display = 'none';
    }
  }
}

// ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
function setupUserInterface(type) {
  const tabs = {
    'new-request':        document.querySelector('[data-tab="new-request"]'),
    'technician-report':  document.querySelector('[data-tab="technician-report"]'),
    'supervisor-review':  document.querySelector('[data-tab="supervisor-review"]'),
    'client-evaluation':  document.querySelector('[data-tab="client-evaluation"]'),
    'quality-report':     document.querySelector('[data-tab="quality-report"]')
  };
  Object.values(tabs).forEach(t => t && t.classList.add('hidden'));

  switch(type){
    case 'quality':
    case 'dean':
      Object.values(tabs).forEach(t => t && t.classList.remove('hidden')); 
      break;
    case 'supervisor':
      tabs['new-request']?.classList.remove('hidden');
      tabs['supervisor-review']?.classList.remove('hidden');
      tabs['quality-report']?.classList.remove('hidden'); 
      break;
    case 'technician':
      tabs['technician-report']?.classList.remove('hidden'); 
      break;
    case 'employee':
      tabs['new-request']?.classList.remove('hidden');
      tabs['client-evaluation']?.classList.remove('hidden'); 
      break;
  }

  // Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‡Ù„ÙŠÙ†
const userInfo = document.querySelector('.user-info');
if (userInfo && currentUserData && currentUserData.canChangePassword) {
  // ğŸ‘ˆ Ø§Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
  if (!document.getElementById('changePassBtn')) {
    const changePassBtn = document.createElement('button');
    changePassBtn.id = 'changePassBtn';
    changePassBtn.className = 'btn-primary';
    changePassBtn.onclick = changePassword;
    changePassBtn.innerHTML = 'ğŸ”‘ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±';
    changePassBtn.style.marginLeft = '10px';
    userInfo.appendChild(changePassBtn);
  }
}


  // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„ØªØµØ¯ÙŠØ±
  updateExportButtonVisibility();

  let defaultTab = (type === 'technician') ? 'technician-report' : 'new-request';
  const defaultBtn = document.querySelector(`[data-tab="${defaultTab}"]`);
  if (defaultBtn && !defaultBtn.classList.contains('hidden')) {
    showTab(defaultTab, defaultBtn);
  }
}

</script>
<!-- Config loader + server exports (Ù†Ø³Ø®Ø© Ù†Ø¸ÙŠÙØ©) -->
<script>
  // Ø§Ø¬Ø¹Ù„ config Ù…ØªØ§Ø­Ù‹Ø§ Ø¹Ø§Ù„Ù…ÙŠÙ‹Ø§ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
  window.config = window.config || {};

  // Ø­Ù…Ù‘Ù„ config.json ÙˆØ¹Ø¨Ù‘ÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  (async function loadAndApplyConfig(){
    try{
      const res = await fetch("config.json", { cache: "no-cache" });
      const data = await res.json();
      window.config = data || {};

      // 1) Ø§Ø³Ù… Ø§Ù„ÙƒÙ„ÙŠØ©
      const collegeNameElement = document.querySelector('.college-info h1');
      if (collegeNameElement && config.collegeName) {
        collegeNameElement.textContent = config.collegeName;
      }

      // 2) Ø§Ù„Ø´Ø¹Ø§Ø±
      const logoImg = document.querySelector('.college-logo');
      if (logoImg && config.logoPath) {
        logoImg.innerHTML = `<img src="${config.logoPath}" alt="Ø§Ù„Ø´Ø¹Ø§Ø±" style="max-height:100px;">`;
      }

      // 3) Google Sheets Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
      if (document.getElementById('sheetsId') && config.defaultSheetId) {
        document.getElementById('sheetsId').value = config.defaultSheetId;
      }
      if (document.getElementById('sheetsApiKey') && config.defaultApiKey) {
        document.getElementById('sheetsApiKey').value = config.defaultApiKey;
      }

      // 4) ÙÙˆØªØ± Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±
      const developerFooter = document.querySelector('#developerFooter');
      if (developerFooter && config.developer) {
        developerFooter.textContent = `ØªØ·ÙˆÙŠØ±: ${config.developer}`;
      }
    }catch(err){
      console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ config.json:", err);
      alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª:\n" + (err?.message || err));
    }
  })();

  // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© (Ù„Ù† ØªÙØ³ØªØ¯Ø¹Ù‰ Ù‡Ù†Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©â€”ØªÙØ³ØªØ®Ø¯Ù… Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¯ÙˆØ§Ù„ async Ø¨Ø§Ù„Ø£Ø³ÙÙ„)
  async function getLogoDataUrlIfAny(){
    if (config && config.logoPath){
      try{
        // Ø§Ù„Ø¯Ø§Ù„Ø© fetchLogoAsDataURL Ù…ÙØ¹Ø±Ù‘ÙØ© Ù…Ø³Ø¨Ù‚Ù‹Ø§ ÙÙŠ Ù…Ù„ÙÙƒ Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰
        return await fetchLogoAsDataURL(config.logoPath);
      }catch{ return null; }
    }
    return null;
  }

  // â€”â€” ØªØµØ¯ÙŠØ± Excel Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ø¨Ø± Ø§Ù„Ø®Ø§Ø¯Ù… â€”â€”
  async function exportExcelDirect() {
    if (!requests.length) {
      alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.');
      return;
    }

    const latest = requests[requests.length - 1];
    const logoDataUrl = await getLogoDataUrlIfAny();

    const payload = {
      request_id:       latest.number || String(latest.id).padStart(6,'0'),  // C8
      maintenance_type: latest.problemType || '',                             // F8
      location:         latest.building || '',                                // I8
      priority:         latest.maintenanceType || '',                         // D9
      requester_name:   latest.clientName || '',                              // D11
      request_time:     latest.time || '',                                    // D13
      request_date:     latest.gregorianDate || '',                           // H13
      fault_type:       latest.problemType || '',                             // C15
      fault_desc:       latest.problemDescription || '',                      // A19
      technician_name:  latest?.technicianReport?.techName || '',             // C25
      execution_date:   latest?.technicianReport?.gregorianDate || '',        // H26
      supervisor_name:  latest?.supervisorReview?.reviewerName || '',         // C29
      status:           latest.status || '',                                  // C30
      status_date:      latest?.supervisorReview?.gregorianDate || '',        // H31
      requester_name_2: latest.clientName || '',                              // C34
      is_fixed:         latest?.clientEvaluation?.satisfaction === 'Ù†Ø¹Ù…' ? 'Ù†Ø¹Ù…'
                       : latest?.clientEvaluation?.satisfaction === 'Ù„Ø§'  ? 'Ù„Ø§' : '', // C35
      fixed_date:       latest?.clientEvaluation?.gregorianDate || '',        // H36
      logo_data_url:    logoDataUrl || null
    };

    try {
      // Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ config.apiBase Ø§Ø³ØªØ®Ø¯Ù…Ù‡ØŒ ÙˆØ¥Ù„Ø§ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø«Ø§Ø¨Øª
      const apiBase = (config && config.apiBase) ? config.apiBase.replace(/\/+$/,'') : 'https://maintenance-app-olxq.onrender.com';
      const res = await fetch(`${apiBase}/api/export-excel`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const err = await res.json().catch(()=>({error:'unknown'}));
        alert('ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¹Ø¨Ø± Ø§Ù„Ø®Ø§Ø¯Ù…: ' + (err.error || res.status));
        return;
      }

      const blob = await res.blob();
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href = url;
      a.download = `ØªÙ‚Ø±ÙŠØ±_${payload.request_id}.xlsx`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    } catch(e) {
      alert('Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…: ' + e.message);
    }
  }
  window.exportExcelDirect = exportExcelDirect; // Ù„Ù„ØªØ´ØºÙŠÙ„ Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø±

  // â€”â€” Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Google Sheets â€”â€”
  async function saveRequestToSheet(request) {
    try {
      const resp = await fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          secret: APPS_SCRIPT_SECRET,   // ÙŠØ·Ø§Ø¨Ù‚ Ø³ÙƒØ±Ø¨Øª Apps Script
          spreadsheetId: sheets_id,     // Sheet ID Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¨Ø·/Ø§Ù„Ù€localStorage
          sheetName: "Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©",
          request
        })
      });

      const data = await resp.json().catch(()=>({}));
      if (!resp.ok || !data.ok) {
        throw new Error(data.error || `HTTP ${resp.status}`);
      }
      console.log("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Google Sheet:", data);
    } catch (err) {
      console.error("âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ø§Ù„Ø´ÙŠØª:", err);
    }
  }
  window.saveRequestToSheet = saveRequestToSheet; // ØªÙØ³ØªØ¯Ø¹Ù‰ Ø¹Ù†Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
</script>

</body>
</html>
