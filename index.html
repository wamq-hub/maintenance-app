<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>نظام إدارة صيانة الكلية</title>
<style>
/* === Reset & Base === */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Arial','Tahoma',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;line-height:1.6}

/* Login */
.login-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);z-index:1000;display:flex;justify-content:center;align-items:center;padding:20px}
.login-box{background:rgba(255,255,255,.95);padding:40px;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.1);width:100%;max-width:500px;text-align:center}
.login-box h1{color:#4facfe;margin-bottom:30px;font-size:2rem}
.logo{font-size:4rem;margin-bottom:20px}
.google-sheets-section{margin-top:30px;padding-top:20px;border-top:2px solid #4facfe;text-align:right}
.google-sheets-section h4{margin-bottom:15px;color:#333;font-size:1.2rem}
.sheets-input{width:100%;padding:12px;margin:8px 0;border:2px solid #e0e0e0;border-radius:10px;font-size:1rem}
.demo-accounts{margin-top:20px;padding-top:15px;border-top:1px solid #eee;font-size:.9rem;color:#666;text-align:right}

/* User bar */
.user-info-bar{background:#4facfe;color:#fff;padding:10px 30px;display:none;justify-content:space-between;align-items:center;box-shadow:0 2px 10px rgba(0,0,0,.1)}
.user-info{display:flex;align-items:center;gap:20px}
.btn-logout{background:rgba(255,255,255,.2);color:#fff;border:1px solid rgba(255,255,255,.3);padding:8px 16px;border-radius:15px;cursor:pointer;transition:.3s}
.btn-logout:hover{background:rgba(255,255,255,.3)}

/* App shell */
.container{max-width:1200px;margin:0 auto;background:rgba(255,255,255,.95);border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.1);overflow:hidden;display:none}
.header{background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);color:#fff;padding:30px;text-align:center}
.header h1{font-size:2.5rem;margin-bottom:10px;text-shadow:2px 2px 4px rgba(0,0,0,.3)}

/* Tabs */
.nav-tabs{display:flex;background:#f8f9fa;border-bottom:3px solid #4facfe}
.tab-button{flex:1;padding:15px 20px;background:none;border:none;cursor:pointer;font-size:1.1rem;font-weight:bold;transition:.3s;color:#666;display:block}
.tab-button.active{background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);color:#fff;transform:translateY(-2px)}
.tab-button:hover:not(.active){background:#e9ecef;color:#333}
.tab-button.hidden{display:none}

/* Tab content */
.tab-content{display:none;padding:30px;animation:fadeIn .5s ease-in}
.tab-content.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}

/* Forms */
.form-group{margin-bottom:25px}
.form-row{display:flex;gap:20px;flex-wrap:wrap}
.form-col{flex:1;min-width:250px}
label{display:block;margin-bottom:8px;font-weight:bold;color:#333;font-size:1.1rem}
input[type="text"],input[type="email"],input[type="tel"],input[type="password"],select,textarea{width:100%;padding:12px 15px;border:2px solid #e0e0e0;border-radius:10px;font-size:1rem;transition:.3s;background:#fff}
input:focus,select:focus,textarea:focus{outline:none;border-color:#4facfe;box-shadow:0 0 10px rgba(79,172,254,.3);transform:translateY(-1px)}
textarea{min-height:120px;resize:vertical}

/* Radios */
.radio-group{display:flex;gap:20px;flex-wrap:wrap;margin-top:10px}
.radio-item{display:flex;align-items:center;background:#f8f9fa;padding:12px 20px;border-radius:25px;border:2px solid transparent;cursor:pointer;transition:.3s}
.radio-item:hover{background:#e9ecef;transform:translateY(-2px)}
.radio-item input[type="radio"]{margin-left:10px;transform:scale(1.2)}
.radio-item input[type="radio"]:checked + label{color:#4facfe;font-weight:bold}

/* Buttons */
.btn{padding:15px 30px;border:none;border-radius:25px;font-size:1.1rem;font-weight:bold;cursor:pointer;transition:.3s;text-transform:uppercase;letter-spacing:1px}
.btn-primary{background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);color:#fff;box-shadow:0 5px 15px rgba(79,172,254,.4)}
.btn-primary:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(79,172,254,.6)}
.btn-success{background:linear-gradient(135deg,#43e97b 0%,#38f9d7 100%);color:#fff;box-shadow:0 5px 15px rgba(67,233,123,.4)}
.btn-warning{background:linear-gradient(135deg,#fa709a 0%,#fee140 100%);color:#fff;box-shadow:0 5px 15px rgba(250,112,154,.4)}
.btn-danger{background:linear-gradient(135deg,#ff6b6b 0%,#ee5a24 100%);color:#fff;box-shadow:0 5px 15px rgba(255,107,107,.4)}

/* Status */
.status-badge{padding:8px 15px;border-radius:20px;font-weight:bold;font-size:.9rem;display:inline-block;margin:5px}
.status-new{background:#e3f2fd;color:#1976d2}
.status-progress{background:#fff3e0;color:#f57c00}
.status-completed{background:#e8f5e8;color:#388e3c}
.status-pending{background:#fce4ec;color:#c2185b}
.status-waiting{background:#ede7f6;color:#6a1b9a}

/* Cards */
.request-card{background:#fff;border-radius:15px;padding:25px;margin-bottom:20px;box-shadow:0 8px 25px rgba(0,0,0,.1);border-right:5px solid #4facfe;transition:.3s}
.request-card:hover{transform:translateY(-5px);box-shadow:0 15px 35px rgba(0,0,0,.15)}
.request-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:15px;border-bottom:2px solid #f0f0f0}
.request-id{font-size:1.3rem;font-weight:bold;color:#4facfe}
.datetime-display{background:#f8f9fa;padding:10px 15px;border-radius:10px;margin-bottom:15px;border-right:3px solid #4facfe}

/* Stats */
.stats-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px}
.stat-card{background:#fff;padding:25px;border-radius:15px;text-align:center;box-shadow:0 8px 25px rgba(0,0,0,.1);border-top:4px solid;transition:.3s}
.stat-card:hover{transform:translateY(-5px);box-shadow:0 15px 35px rgba(0,0,0,.15)}
.stat-card.total{border-color:#4facfe}
.stat-card.completed{border-color:#43e97b}
.stat-card.progress{border-color:#fa709a}
.stat-card.pending{border-color:#fee140}
.stat-number{font-size:3rem;font-weight:bold;margin-bottom:10px}

/* Modal */
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:1000;backdrop-filter:blur(10px)}
.modal-content{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:30px;border-radius:20px;max-width:600px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.3)}
.close{position:absolute;top:15px;left:15px;font-size:2rem;cursor:pointer;color:#999;transition:.3s}
.close:hover{color:#333}

/* Print & PDF Styles */
@media print{
  body{background:white !important;font-size:12pt}
  .login-screen,.user-info-bar,.nav-tabs,.btn,button{display:none !important}
  .container{box-shadow:none !important;max-width:none !important;margin:0 !important}
  .header{background:white !important;color:#333 !important;border-bottom:2px solid #333}
  .report-header{text-align:center;margin-bottom:30px;border-bottom:3px solid #333;padding-bottom:20px}
  .college-logo{font-size:48pt;margin-bottom:10px}
  .college-info{margin:20px 0;line-height:1.8}
  .print-only{display:block !important}
  .no-print{display:none !important}
  table{border-collapse:collapse;width:100%;margin:20px 0}
  th,td{border:1px solid #333;padding:8px;text-align:center}
  th{background:#f0f0f0}
}
.print-only{display:none}

/* Responsive */
@media (max-width:768px){
 body{padding:10px}
 .form-row{flex-direction:column}
 .radio-group{flex-direction:column}
 .nav-tabs{flex-wrap:wrap}
 .header h1{font-size:1.8rem}
 .stats-container{grid-template-columns:1fr}
 .login-box{padding:20px;margin:10px}
}

/* Animations */
.success-animation{animation:successPulse .6s ease}
@keyframes successPulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}

/* Hijri Date Converter */
.date-converter{background:#f8f9fa;padding:15px;margin:15px 0;border-radius:10px;border-right:3px solid #4facfe}
</style>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
<!-- Print Header -->
<div class="print-only report-header">
  <div id="collegeLogo" class="college-logo"></div>
  <div class="college-info">
    <h1>الكلية التقنية</h1>
    <h2>إدارة الصيانة والخدمات</h2>
    <h3>تقرير طلبات الصيانة</h3>
  </div>
  <div>التاريخ: <span id="printDate"></span></div>
</div>


<!-- Login -->
<div id="loginScreen" class="login-screen">
  <div class="login-box">
    <div class="logo">🎓</div>
    <h1>نظام إدارة صيانة الكلية</h1>
    <form id="loginForm">
      <div class="form-group">
        <label for="username">الرقم الوظيفي</label>
        <input type="text" id="username" placeholder="مثال: 001234" required />
      </div>
      <div class="form-group">
        <label for="password">كلمة المرور</label>
        <input type="password" id="password" required />
      </div>
      <button type="submit" class="btn btn-primary">تسجيل الدخول</button>
    </form>

    <div class="google-sheets-section">
      <h4>🔗 ربط Google Sheets (مرة واحدة فقط)</h4>
      <p style="font-size:0.9rem;color:#666;margin-bottom:10px">
        بعد الربط الأول، سيتم تحميل البيانات تلقائياً في كل مرة
      </p>
      <input type="text" id="sheetsApiKey" class="sheets-input" placeholder="Google API Key (مطلوب للقراءة)" />
      <input type="text" id="sheetsId" class="sheets-input" placeholder="معرف Google Sheet - مثال: 1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms" />
      <button type="button" class="btn btn-primary" onclick="connectGoogleSheets()">ربط البيانات</button>
      <div id="sheetsStatus" style="margin-top:10px;color:#666;font-size:0.9rem"></div>
      
      <div style="background:#f0f8ff;padding:15px;margin:15px 0;border-radius:10px;border:1px solid #4facfe">
        <h5 style="color:#4facfe;margin-bottom:10px">📋 تنسيق Google Sheet المطلوب:</h5>
        <table style="width:100%;font-size:0.85rem;border-collapse:collapse">
          <tr style="background:#4facfe;color:white">
            <th style="padding:5px;border:1px solid #ddd">A - الرقم الوظيفي</th>
            <th style="padding:5px;border:1px solid #ddd">B - الاسم</th>
            <th style="padding:5px;border:1px solid #ddd">C - كلمة المرور</th>
            <th style="padding:5px;border:1px solid #ddd">D - الصلاحية</th>
          </tr>
          <tr>
            <td style="padding:5px;border:1px solid #ddd">000002</td>
            <td style="padding:5px;border:1px solid #ddd">د. محمد العميد</td>
            <td style="padding:5px;border:1px solid #ddd">123456</td>
            <td style="padding:5px;border:1px solid #ddd">dean</td>
          </tr>
          <tr>
            <td style="padding:5px;border:1px solid #ddd">000003</td>
            <td style="padding:5px;border:1px solid #ddd">أحمد المشرف</td>
            <td style="padding:5px;border:1px solid #ddd">123456</td>
            <td style="padding:5px;border:1px solid #ddd">supervisor</td>
          </tr>
        </table>
        <p style="margin-top:10px;font-size:0.8rem;color:#666">
          الصلاحيات المتاحة: dean, supervisor, technician, employee
        </p>
      </div>
    </div>

    <div class="demo-accounts">
      <h4>حساب تجريبي - وكيل ضبط الجودة:</h4>
      <p><strong>الرقم:</strong> 000001 | <strong>كلمة المرور:</strong> quality123</p>
    </div>
  </div>
</div>

<!-- User bar -->
<div id="userInfoBar" class="user-info-bar no-print">
  <div class="user-info">
    <span id="currentUser"></span>
    <button class="btn-primary" onclick="generatePDFReport()">📄 تقرير PDF</button>
    <button class="btn-primary" onclick="exportPDFViaServer()">📄 تقرير PDF (القالب)</button>
    <button class="btn-primary" onclick="exportViaServer()">📥 تقرير Excel (الخادم)</button>
  </div>
  <button class="btn-logout" onclick="logout()">تسجيل الخروج</button>
</div>

<!-- App -->
<div class="container">
  <div class="header">
    <h1>🔧 نظام إدارة طلبات الصيانة</h1>
    <p>نظام متكامل لإدارة ومتابعة طلبات الصيانة</p>
  </div>

  <div class="nav-tabs no-print">
    <button class="tab-button active" data-tab="new-request" onclick="showTab('new-request', this)">طلب جديد</button>
    <button class="tab-button" data-tab="technician-report" onclick="showTab('technician-report', this)">تقرير الفني</button>
    <button class="tab-button" data-tab="supervisor-review" onclick="showTab('supervisor-review', this)">مراجعة المشرف</button>
    <button class="tab-button" data-tab="client-evaluation" onclick="showTab('client-evaluation', this)">تقييم العميل</button>
    <button class="tab-button" data-tab="quality-report" onclick="showTab('quality-report', this)">تقرير الجودة</button>
  </div>

  <!-- طلب جديد -->
  <div id="new-request" class="tab-content active">
    <h2>إنشاء طلب صيانة جديد</h2>
    
    <div class="date-converter">
      <h4>محول التاريخ الهجري/الميلادي</h4>
      <div style="display:flex;gap:20px;margin:10px 0;flex-wrap:wrap">
        <input type="date" id="gregorianInput" onchange="convertToHijri()" />
        <input type="text" id="hijriInput" placeholder="التاريخ الهجري" readonly />
      </div>
    </div>

    <form id="maintenanceForm">
      <div class="datetime-display">
        <strong>رقم الطلب:</strong> <span id="requestNumber"></span> |
        <strong>التاريخ الميلادي:</strong> <span id="gregorianDate"></span> |
        <strong>اليوم:</strong> <span id="dayName"></span> |
        <strong>الوقت:</strong> <span id="currentTime"></span> |
        <strong>التاريخ الهجري:</strong> <span id="hijriDate"></span>
      </div>


      <div class="form-row">
        <div class="form-col">
          <div class="form-group">
            <label>نوع الطلب</label>
            <div class="radio-group">
              <div class="radio-item"><input type="radio" id="electronic" name="requestType" value="إلكتروني" checked /><label for="electronic">إلكتروني</label></div>
              <div class="radio-item"><input type="radio" id="phone" name="requestType" value="هاتف" /><label for="phone">هاتف</label></div>
              <div class="radio-item"><input type="radio" id="email" name="requestType" value="إيميل" /><label for="email">إيميل</label></div>
            </div>
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-col">
          <div class="form-group"><label for="clientName">اسم صاحب الطلب *</label><input type="text" id="clientName" required /></div>
        </div>
        <div class="form-col">
          <div class="form-group"><label for="building">المبنى/الدور *</label><input type="text" id="building" required /></div>
        </div>
      </div>

      <div class="form-group">
        <label>نوع الصيانة</label>
        <div class="radio-group">
          <div class="radio-item"><input type="radio" id="emergency" name="maintenanceType" value="صيانة طارئة" checked /><label for="emergency">صيانة طارئة</label></div>
          <div class="radio-item"><input type="radio" id="preventive" name="maintenanceType" value="صيانة وقائية" /><label for="preventive">صيانة وقائية</label></div>
          <div class="radio-item"><input type="radio" id="periodic" name="maintenanceType" value="صيانة دورية" /><label for="periodic">صيانة دورية</label></div>
        </div>
      </div>

      <div class="form-group">
        <label>نوع العطل</label>
        <div class="radio-group">
          <div class="radio-item"><input type="radio" id="electrical" name="problemType" value="كهربائي" checked /><label for="electrical">كهربائي</label></div>
          <div class="radio-item"><input type="radio" id="ac" name="problemType" value="تكييف" /><label for="ac">تكييف</label></div>
          <div class="radio-item"><input type="radio" id="plumbing" name="problemType" value="سباكة" /><label for="plumbing">سباكة</label></div>
          <div class="radio-item"><input type="radio" id="electronics" name="problemType" value="إلكترونيات" /><label for="electronics">إلكترونيات</label></div>
          <div class="radio-item"><input type="radio" id="other" name="problemType" value="أخرى" /><label for="other">أخرى</label></div>
        </div>
      </div>

      <div class="form-group" id="otherProblemGroup" style="display:none">
        <label for="otherProblem">تحديد نوع العطل الآخر</label>
        <input type="text" id="otherProblem" />
      </div>

      <div class="form-group">
        <label for="problemDescription">وصف العطل *</label>
        <textarea id="problemDescription" placeholder="الرجاء وصف المشكلة بالتفصيل..." required></textarea>
      </div>

      <button type="submit" class="btn btn-primary no-print">إرسال الطلب</button>
    </form>
  </div>

  <!-- تقرير الفني -->
  <div id="technician-report" class="tab-content">
    <h2>تقرير مقاول الصيانة</h2>
    <div id="technicianRequests"></div>
  </div>

  <!-- مراجعة المشرف -->
  <div id="supervisor-review" class="tab-content">
    <h2>مراجعة رئيس/مشرف الصيانة</h2>
    <div id="supervisorRequests"></div>
  </div>

  <!-- تقييم العميل -->
  <div id="client-evaluation" class="tab-content">
    <h2>تقييم صاحب الطلب</h2>
    <div id="clientRequests"></div>
  </div>

  <!-- تقرير الجودة -->
  <div id="quality-report" class="tab-content">
    <h2>📊 تقرير الجودة والإحصائيات</h2>
      <!-- زر إنشاء التقرير -->
  <button onclick="generateExcelFromTemplate()" class="btn btn-primary" style="margin-bottom: 20px;">
    📥 إنشاء تقرير Excel من القالب
  </button>
    <div class="stats-container">
      <div class="stat-card total"><div class="stat-number" id="totalRequests">0</div><div>إجمالي الطلبات</div></div>
      <div class="stat-card completed"><div class="stat-number" id="completedRequests">0</div><div>تم الإصلاح</div></div>
      <div class="stat-card progress"><div class="stat-number" id="progressRequests">0</div><div>قيد المعالجة</div></div>
      <div class="stat-card pending"><div class="stat-number" id="pendingRequests">0</div><div>معلق</div></div>
    </div>
    <div id="detailedReport"></div>
  </div>
</div>

<!-- Modal -->
<div id="modal" class="modal no-print">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <div id="modalContent"></div>
  </div>
</div>

<script>
/* ====== State ====== */
let requests = JSON.parse(localStorage.getItem('maintenanceRequests')) || [];
let requestCounter = parseInt(localStorage.getItem('requestCounter')) || 1;
let currentUser = null;
let userType = null;
let currentUserData = null;



/* ====== Hijri Date Converter ====== */
function gregorianToHijri(gDate) {
  const g = new Date(gDate);
  const gYear = g.getFullYear();
  const gMonth = g.getMonth() + 1;
  const gDay = g.getDate();
  
  // تحويل مبسط للتاريخ الهجري (تقريبي)
  const totalDays = Math.floor((gYear - 622) * 365.25 + gMonth * 30.4375 + gDay - 227015);
  const hYear = Math.floor(totalDays / 354.367) + 1;
  const remainingDays = totalDays % 354.367;
  const hMonth = Math.floor(remainingDays / 29.531) + 1;
  const hDay = Math.floor(remainingDays % 29.531) + 1;
  
  const hijriMonths = [
    'محرم', 'صفر', 'ربيع الأول', 'ربيع الثاني', 'جمادى الأولى', 'جمادى الثانية',
    'رجب', 'شعبان', 'رمضان', 'شوال', 'ذو القعدة', 'ذو الحجة'
  ];
  
  return `${Math.max(1, Math.min(30, hDay))} ${hijriMonths[Math.min(11, Math.max(0, hMonth - 1))]} ${hYear}هـ`;
}

function convertToHijri() {
  const gDate = document.getElementById('gregorianInput').value;
  if (gDate) {
    const hijriDate = gregorianToHijri(gDate);
    document.getElementById('hijriInput').value = hijriDate;
  }
}

/* ====== Google Sheets Integration ====== */
// ====== Google Sheets Integration (حقيقي) ======
let gapi_loaded = false;
let sheets_id = localStorage.getItem('sheets_id') || '';
let sheets_api_key = localStorage.getItem('sheets_api_key') || '';

async function connectGoogleSheets() {

  function normalizeSheetId(input){
    const m = String(input || '').match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
    return m ? m[1] : String(input || '').trim();
  }

  const sheetsIdInputRaw = (document.getElementById('sheetsId')?.value || '').trim();
  const sheetsIdInput    = normalizeSheetId(sheetsIdInputRaw);
  const apiKeyInput      = (document.getElementById('sheetsApiKey')?.value || '').trim();

  if (!sheetsIdInput) { alert('يرجى إدخال معرف Google Sheet'); return; }
  if (!apiKeyInput)   { alert('يرجى إدخال Google API Key');   return; }

  sheets_id      = sheetsIdInput;
  sheets_api_key = apiKeyInput;
  localStorage.setItem('sheets_id', sheets_id);
  localStorage.setItem('sheets_api_key', sheets_api_key);

  // 👈 سطر التعريف المفقود
  const statusEl = document.getElementById('sheetsStatus');

  const showErr = async (resp) => {
    let body = '';
    try { body = await resp.text(); } catch {}
    const msg = body || (`HTTP ${resp.status}`);
    statusEl.textContent = `فشل في ربط Google Sheets: ${msg}`;
    statusEl.style.color = '#ff6b6b';
    console.error('Sheets error:', resp.status, msg);
  };

  try {
    const metaUrl  = `https://sheets.googleapis.com/v4/spreadsheets/${encodeURIComponent(sheets_id)}?key=${encodeURIComponent(sheets_api_key)}`;
    const metaResp = await fetch(metaUrl);
    if (!metaResp.ok) { await showErr(metaResp); return; }
    const meta = await metaResp.json();

    const firstSheet = meta?.sheets?.[0]?.properties?.title;
    if (!firstSheet) {
      statusEl.textContent = 'تعذر الحصول على اسم الورقة الأولى (تأكد أن الشيت يحتوي ورقة واحدة على الأقل)';
      statusEl.style.color = '#ff6b6b';
      return;
    }

    const rangeA1   = `${firstSheet}!A:D`;
    const valuesUrl = `https://sheets.googleapis.com/v4/spreadsheets/${encodeURIComponent(sheets_id)}/values/${encodeURIComponent(rangeA1)}?key=${encodeURIComponent(sheets_api_key)}`;

    const valuesResp = await fetch(valuesUrl);
    if (!valuesResp.ok) { await showErr(valuesResp); return; }

    const valuesJson = await valuesResp.json();
    const rows = valuesJson?.values || [];

    const data         = [];
    const headerWords  = ['الرقم الوظيفي','employeeid','id','empid','emp id'];
    const headerTokens = headerWords.map(w => w.replace(/\s+/g,'').toLowerCase());

    for (let i = 0; i < rows.length; i++) {
      const row = Array.isArray(rows[i]) ? rows[i] : [];
      const [a = '', b = '', c = '', d = ''] = row.map(x => (x ?? '').toString().trim());
      const aNorm = a.replace(/\s+/g,'').toLowerCase();
      if (!a || headerTokens.includes(aNorm)) continue;

      data.push({
        employeeId: a,
        name: b || '',
        password: c || '',
        role: (d || '').toLowerCase(),
        canChangePassword: (d && d.toLowerCase() !== 'quality')
      });
    }

    if (!data.length) {
      statusEl.textContent = 'تم الاتصال لكن لم يتم العثور على بيانات صالحة في الأعمدة A:D (تأكد من تعبئة الصفوف).';
      statusEl.style.color = '#ff6b6b';
      return;
    }

    localStorage.setItem('sheetsUserData', JSON.stringify(data));
    statusEl.textContent = 'تم ربط Google Sheets بنجاح وقراءة البيانات!';
    statusEl.style.color = '#43e97b';
    statusEl.classList.add('success-animation');
    setTimeout(() => statusEl.classList.remove('success-animation'), 600);
  } catch (err) {
    console.error('خطأ غير متوقع:', err);
    statusEl.textContent = `فشل في ربط Google Sheets: ${err?.message || err}`;
    statusEl.style.color = '#ff6b6b';
  }
}

// استبدل هذه الدالة القديمة (المحاكاة) بنسخة بسيطة تسترجع المخزون
async function loadUserDataFromSheets() {
  try {
    const raw = localStorage.getItem('sheetsUserData');
    return raw ? JSON.parse(raw) : [];
  } catch {
    return [];
  }
}


function getUserFromSheets(employeeId, password) {
  const userData = JSON.parse(localStorage.getItem('sheetsUserData') || '[]');
  return userData.find(user => 
    user.employeeId === employeeId && user.password === password
  );
}

/* ====== Boot ====== */
document.addEventListener('DOMContentLoaded', () => {
  const savedUser = localStorage.getItem('currentUser');
  if (savedUser) {
    const u = JSON.parse(savedUser);
    loginUser(u.username, u.type, u.name);
  }

  // إضافة الـSheet ID والـAPI Key الافتراضية إذا ما كانت موجودة
  if (!localStorage.getItem('sheets_id')) {
    localStorage.setItem('sheets_id', '1U78Zgj5y-ay-MQAoN4ZqSzPcywp-rPRxft4DuOdmipQ');
  }
  if (!localStorage.getItem('sheets_api_key')) {
    localStorage.setItem('sheets_api_key', 'AIzaSyCwZ_MetFoLWkrXMAD2UlF8OTUYaynbYXg');
  }

  // تعبئة الحقول تلقائياً من الـlocalStorage
  const savedSheetsId  = localStorage.getItem('sheets_id');
  const savedApiKey    = localStorage.getItem('sheets_api_key');
  if (document.getElementById('sheetsId')) {
    document.getElementById('sheetsId').value = savedSheetsId || '';
  }
  if (document.getElementById('sheetsApiKey')) {
    document.getElementById('sheetsApiKey').value = savedApiKey || '';
  }

  updateDateTime();
  updateRequestNumber();
  setInterval(updateDateTime, 1000);

  // تسجيل الدخول
  document.getElementById('loginForm').addEventListener('submit', e => { 
    e.preventDefault(); 
    handleLogin(); 
  });

  // إظهار/إخفاء نوع العطل الآخر
  document.addEventListener('change', e => {
    if (e.target.name === 'problemType') {
      const g = document.getElementById('otherProblemGroup');
      if (!g) return;
      if (e.target.value === 'أخرى') g.style.display = 'block';
      else { g.style.display = 'none'; document.getElementById('otherProblem').value = ''; }
    }
  });

  // نموذج الطلب
  const maintenanceForm = document.getElementById('maintenanceForm');
  if (maintenanceForm) {
    maintenanceForm.addEventListener('submit', e => { 
      e.preventDefault(); 
      submitMaintenanceRequest(); 
    });
  }

  // تحديث تاريخ الطباعة
  document.getElementById('printDate').textContent = new Date().toLocaleDateString('ar-SA');
});

/* ====== Auth ====== */
function handleLogin() {
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value;
  
  // محاولة تسجيل الدخول من Google Sheets أولاً
  const sheetsUser = getUserFromSheets(username, password);
  if (sheetsUser) {
    currentUserData = sheetsUser;
    return loginUser(username, sheetsUser.role, sheetsUser.name);
  }
  
  alert('بيانات تسجيل الدخول غير صحيحة أو لم يتم ربط Google Sheets');
}

function findUserById(id){
  try{
    const list = JSON.parse(localStorage.getItem('sheetsUserData') || '[]');
    return list.find(u => String(u.employeeId).trim() === String(id).trim());
  }catch{ return null; }
}

function loginUser(username, type, name) {
  currentUser = username;
  userType = type;

  // ✅ عَبِّ currentUserData حتى مع الدخول التلقائي
  const fromSheet = findUserById(username);
  currentUserData = fromSheet || {
    employeeId: username,
    name: name || username,
    role: type,
    canChangePassword: false
  };

  localStorage.setItem('currentUser', JSON.stringify({ username, type, name: currentUserData.name }));

  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('userInfoBar').style.display = 'flex';
  document.getElementById('currentUser').textContent = `${currentUserData.name} (${getUserTypeArabic(type)})`;
  document.querySelector('.container').style.display = 'block';

  setupUserInterface(type);
  updateDateTime();
  updateRequestNumber();
  updateAllDisplays();
}


function logout() { 
  localStorage.removeItem('currentUser'); 
  location.reload(); 
}

function getUserTypeArabic(type){
  switch(type){
    case 'quality': return 'وكيل ضبط الجودة';
    case 'dean': return 'العميد';
    case 'supervisor': return 'مشرف الصيانة';
    case 'technician': return 'فني الصيانة';
    case 'employee': return 'موظف الكلية';
    default: return '';
  }
}

/* ====== UI Tabs & Permissions ====== */

function showTab(tabId, btnEl) {
  const allowed = {
    'quality':    ['new-request','technician-report','supervisor-review','client-evaluation','quality-report'],
    'dean':       ['new-request','technician-report','supervisor-review','client-evaluation','quality-report'],
    'supervisor': ['new-request','supervisor-review','quality-report'],
    'technician': ['technician-report'],
    'employee':   ['new-request','client-evaluation']
  };
  
  if (!allowed[userType] || !allowed[userType].includes(tabId)) { 
    alert('ليس لديك صلاحية للوصول لهذه الصفحة'); 
    return; 
  }

  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));

  const tab = document.getElementById(tabId);
  if (tab) tab.classList.add('active');
  if (btnEl) btnEl.classList.add('active');

  if (tabId === 'technician-report')      displayTechnicianRequests();
  else if (tabId === 'supervisor-review') displaySupervisorRequests();
  else if (tabId === 'client-evaluation') displayClientRequests();
  else if (tabId === 'quality-report')    displayQualityReport();
}

/* ====== Date/Time ====== */
function updateDateTime(){
  const now = new Date();
  const gd = now.toLocaleDateString('ar-SA');
  const hd = gregorianToHijri(now);
  const dn = now.toLocaleDateString('ar-SA',{weekday:'long'});
  const tm = now.toLocaleTimeString('ar-SA',{hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'});
  
  const gEl = document.getElementById('gregorianDate'); if (gEl) gEl.textContent = gd;
  const hEl = document.getElementById('hijriDate');     if (hEl) hEl.textContent = hd;
  const dEl = document.getElementById('dayName');       if (dEl) dEl.textContent = dn;
  const tEl = document.getElementById('currentTime');   if (tEl) tEl.textContent = tm;
}

function updateRequestNumber(){ 
  const el = document.getElementById('requestNumber'); 
  if (el) el.textContent = `#${String(requestCounter).padStart(6,'0')}`; 
}

/* ====== Submit New Request ====== */
async function submitMaintenanceRequest(){
  if (!['quality','dean','supervisor','employee'].includes(userType)) { 
    alert('ليس لديك صلاحية لإنشاء طلبات صيانة'); 
    return; 
  }

  const now = new Date();
  const problemType = document.querySelector('input[name="problemType"]:checked').value;
  const otherProblem = document.getElementById('otherProblem').value;

  let clientName = document.getElementById('clientName').value.trim();
  if (userType === 'employee') {    
    clientName = currentUserData?.name || clientName;
    document.getElementById('clientName').value = clientName;
  }

  const request = {
    id: requestCounter,
    number: `#${String(requestCounter).padStart(6,'0')}`,
    requestType: document.querySelector('input[name="requestType"]:checked').value,
    clientName,
    building: document.getElementById('building').value.trim(),
    maintenanceType: document.querySelector('input[name="maintenanceType"]:checked').value,
    problemType: (problemType === 'أخرى' ? otherProblem.trim() : problemType),
    problemDescription: document.getElementById('problemDescription').value.trim(),
    status: 'جديد',
    createdBy: currentUserData?.name || clientName,   
    createdByType: userType,
    submittedAt: now.toISOString(),
    hijriDate: gregorianToHijri(now),
    gregorianDate: now.toLocaleDateString('ar-SA'),
    dayName: now.toLocaleDateString('ar-SA',{weekday:'long'}),
    time: now.toLocaleTimeString('ar-SA',{hour12:false})
  };

  requests.push(request);
  requestCounter++;
  localStorage.setItem('maintenanceRequests', JSON.stringify(requests));
  localStorage.setItem('requestCounter', String(requestCounter));
  // حفظ نسخة من الطلب في Google Sheets
  await saveRequestToSheet(request);

  document.getElementById('maintenanceForm').reset();
  const otherGroup = document.getElementById('otherProblemGroup'); 
  if (otherGroup) otherGroup.style.display = 'none';
  updateRequestNumber();

  showModal(`
    <div style="text-align:center;padding:20px">
      <div style="font-size:4rem;color:#43e97b;margin-bottom:20px">✅</div>
      <h3 style="color:#43e97b;margin-bottom:15px">تم إرسال الطلب بنجاح!</h3>
      <p style="color:#666;margin-bottom:20px">رقم الطلب: ${request.number}</p>
      <p style="color:#666">سيتم التواصل معك قريباً لمتابعة الطلب</p>
    </div>
  `);
  updateAllDisplays();
}

/* ====== PDF Report Generation ====== */
// استبدل الدوال الموجودة في ملف HTML بهذه النسخ المحسنة

// تحديث دالة generatePDFReport
function generatePDFReport() {
  try {
    // تحديث تاريخ التقرير
    document.getElementById('printDate').textContent = new Date().toLocaleDateString('ar-SA');
    
    // إنشاء محتوى PDF محسن
    createEnhancedReportContent();
    
    // إخفاء العناصر غير المطلوبة للطباعة
    document.body.classList.add('print-mode');
    
    // طباعة التقرير
    setTimeout(() => {
      window.print();
      document.body.classList.remove('print-mode');
    }, 500);
    
  } catch (error) {
    console.error('خطأ في إنشاء تقرير PDF:', error);
    alert('حدث خطأ أثناء إنشاء التقرير');
  }
}

function createEnhancedReportContent() {
  const container = document.querySelector('.container');
  if (!container) return;

  // إنشاء صفحة تقرير منسقة
  const reportHTML = `
    <div class="enhanced-report print-only" style="
      padding: 40px; 
      font-family: 'Arial', 'Tahoma', sans-serif;
      background: white;
      color: black;
      line-height: 1.8;
      page-break-inside: avoid;
    ">
      ${generateReportHeader()}
      ${generateStatsSection()}
      ${generateDetailedTable()}
      ${generateReportFooter()}
    </div>
  `;

  // إضافة التقرير إلى الصفحة
  const existingReport = document.querySelector('.enhanced-report');
  if (existingReport) {
    existingReport.remove();
  }
  
  container.insertAdjacentHTML('beforeend', reportHTML);
}

function generateReportHeader() {
  const currentDate = new Date().toLocaleDateString('ar-SA');
  const currentTime = new Date().toLocaleTimeString('ar-SA', {hour12: false});
  
  return `
    <div style="text-align: center; margin-bottom: 40px; border-bottom: 3px solid #4facfe; padding-bottom: 20px;">
      <div style="font-size: 48px; margin-bottom: 10px;">🎓</div>
      <h1 style="font-size: 24px; color: #1F4E79; margin: 10px 0;">${config.collegeName || 'الكلية التقنية'}</h1>
      <h2 style="font-size: 20px; color: #666; margin: 5px 0;">إدارة الصيانة والخدمات</h2>
      <h3 style="font-size: 18px; color: #4facfe; margin: 15px 0;">تقرير شامل لطلبات الصيانة</h3>
      <div style="font-size: 14px; color: #999; margin-top: 20px;">
        تاريخ الإنشاء: ${currentDate} | الوقت: ${currentTime}
      </div>
    </div>
  `;
}

function generateStatsSection() {
  const total = requests.length;
  const completed = requests.filter(r => r.clientEvaluation && r.status === 'مكتمل').length;
  const progress = requests.filter(r => 
    ['قيد المعالجة', 'جاري الإصلاح', 'تم الإصلاح', 'بانتظار اعتماد المشرف'].includes(r.status)
  ).length;
  const pending = requests.filter(r => 
    ['معلق', 'يحتاج متابعة', 'يحتاج إعادة عمل', 'محال إلى متخصص'].includes(r.status)
  ).length;

  return `
    <div style="margin: 30px 0; page-break-inside: avoid;">
      <h3 style="color: #1F4E79; border-bottom: 2px solid #4facfe; padding-bottom: 10px; margin-bottom: 20px;">
        📊 ملخص الإحصائيات
      </h3>
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin: 20px 0;">
        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center; border-top: 4px solid #4facfe;">
          <div style="font-size: 32px; font-weight: bold; color: #4facfe;">${total}</div>
          <div style="color: #666; margin-top: 5px;">إجمالي الطلبات</div>
        </div>
        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center; border-top: 4px solid #43e97b;">
          <div style="font-size: 32px; font-weight: bold; color: #43e97b;">${completed}</div>
          <div style="color: #666; margin-top: 5px;">تم الإصلاح</div>
        </div>
        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center; border-top: 4px solid #fa709a;">
          <div style="font-size: 32px; font-weight: bold; color: #fa709a;">${progress}</div>
          <div style="color: #666; margin-top: 5px;">قيد المعالجة</div>
        </div>
        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center; border-top: 4px solid #fee140;">
          <div style="font-size: 32px; font-weight: bold; color: #f57c00;">${pending}</div>
          <div style="color: #666; margin-top: 5px;">معلق</div>
        </div>
      </div>
    </div>
  `;
}

function generateDetailedTable() {
  if (!requests.length) {
    return '<p style="text-align: center; color: #666; padding: 40px;">لا توجد بيانات لعرضها</p>';
  }

  const tableRows = requests.map((r, index) => `
    <tr style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'}; page-break-inside: avoid;">
      <td style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-size: 11px;">${r.number}</td>
      <td style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-size: 11px;">${r.clientName}</td>
      <td style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-size: 11px;">${r.building}</td>
      <td style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-size: 11px;">${r.problemType}</td>
      <td style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-size: 11px;">${r.technicianReport ? r.technicianReport.techName : 'لم يتم التعيين'}</td>
      <td style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-size: 11px;">
        <span style="
          padding: 4px 8px; 
          border-radius: 15px; 
          font-size: 10px; 
          font-weight: bold;
          background: ${getStatusColor(r.status)};
          color: white;
        ">${r.status}</span>
      </td>
      <td style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-size: 11px;">${r.gregorianDate}</td>
      <td style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-size: 11px;">${r.hijriDate}</td>
    </tr>
  `).join('');

  return `
    <div style="margin: 30px 0; page-break-inside: avoid;">
      <h3 style="color: #1F4E79; border-bottom: 2px solid #4facfe; padding-bottom: 10px; margin-bottom: 20px;">
        📋 تفاصيل جميع الطلبات
      </h3>
      <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <thead style="display: table-header-group;">
            <tr style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
              <th style="padding: 15px 8px; text-align: center; border: 1px solid #dee2e6; font-weight: bold; font-size: 12px;">رقم الطلب</th>
              <th style="padding: 15px 8px; text-align: center; border: 1px solid #dee2e6; font-weight: bold; font-size: 12px;">العميل</th>
              <th style="padding: 15px 8px; text-align: center; border: 1px solid #dee2e6; font-weight: bold; font-size: 12px;">المبنى</th>
              <th style="padding: 15px 8px; text-align: center; border: 1px solid #dee2e6; font-weight: bold; font-size: 12px;">نوع العطل</th>
              <th style="padding: 15px 8px; text-align: center; border: 1px solid #dee2e6; font-weight: bold; font-size: 12px;">الفني</th>
              <th style="padding: 15px 8px; text-align: center; border: 1px solid #dee2e6; font-weight: bold; font-size: 12px;">الحالة</th>
              <th style="padding: 15px 8px; text-align: center; border: 1px solid #dee2e6; font-weight: bold; font-size: 12px;">التاريخ الميلادي</th>
              <th style="padding: 15px 8px; text-align: center; border: 1px solid #dee2e6; font-weight: bold; font-size: 12px;">التاريخ الهجري</th>
            </tr>
          </thead>
          <tbody>
            ${tableRows}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function getStatusColor(status) {
  switch(status) {
    case 'جديد': return '#2196F3';
    case 'قيد المعالجة':
    case 'جاري الإصلاح': return '#FF9800';
    case 'بانتظار اعتماد المشرف': return '#9C27B0';
    case 'تم الإصلاح':
    case 'مكتمل': return '#4CAF50';
    case 'معلق':
    case 'يحتاج متابعة':
    case 'يحتاج إعادة عمل':
    case 'محال إلى متخصص': return '#F44336';
    default: return '#607D8B';
  }
}

function generateReportFooter() {
  const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
  
  return `
    <div style="margin-top: 40px; border-top: 2px solid #4facfe; padding-top: 20px; page-break-inside: avoid;">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px;">
        <div>
          <h4 style="color: #1F4E79; margin-bottom: 10px;">معلومات التقرير:</h4>
          <p style="margin: 5px 0; color: #666; font-size: 12px;">• تم إنشاء هذا التقرير تلقائياً</p>
          <p style="margin: 5px 0; color: #666; font-size: 12px;">• المعلومات محدثة حتى تاريخ الإنشاء</p>
          <p style="margin: 5px 0; color: #666; font-size: 12px;">• للاستفسارات: إدارة الصيانة</p>
        </div>
        <div style="text-align: left;">
          <h4 style="color: #1F4E79; margin-bottom: 10px;">إعداد التقرير:</h4>
          <p style="margin: 5px 0; color: #666; font-size: 12px;">المستخدم: ${currentUser.name || 'غير محدد'}</p>
          <p style="margin: 5px 0; color: #666; font-size: 12px;">المنصب: ${getUserTypeArabic(currentUser.type || '')}</p>
          <p style="margin: 5px 0; color: #666; font-size: 12px;">التوقيع: ________________</p>
        </div>
      </div>
      
      <div style="text-align: center; margin-top: 30px; color: #999; font-size: 10px;">
        <p>هذا التقرير سري ومخصص للاستخدام الداخلي فقط</p>
        <p style="margin-top: 10px;">© ${new Date().getFullYear()} ${config.collegeName || 'الكلية التقنية'} - إدارة الصيانة والخدمات</p>
      </div>
    </div>
  `;
}

// تحسين تصدير Excel مع تنسيق أفضل
async function exportViaServer(){
  const latest = requests[requests.length - 1];
  if (!latest){
    alert('لا توجد طلبات في النظام لتوليد التقرير.');
    return;
  }

  // الحصول على الشعار كـ data URL
  const logoDataUrl = config?.logoPath ? await fetchLogoAsDataURL(config.logoPath) : null;

  // تحضير البيانات المنسقة
  const payload = {
    request_id:       latest.number || String(latest.id).padStart(6,'0'),
    maintenance_type: latest.problemType || '',
    location:         latest.building || '',
    priority:         latest.maintenanceType || '',
    requester_name:   latest.clientName || '',
    request_time:     latest.time || '',
    request_date:     latest.gregorianDate || '',
    fault_type:       latest.problemType || '',
    fault_desc:       latest.problemDescription || '',
    technician_name:  latest?.technicianReport?.techName || '',
    execution_date:   latest?.technicianReport?.gregorianDate || '',
    supervisor_name:  latest?.supervisorReview?.reviewerName || '',
    status:           latest.status || '',
    status_date:      latest?.supervisorReview?.gregorianDate || '',
    requester_name_2: latest.clientName || '',
    is_fixed:         latest?.clientEvaluation?.satisfaction === 'نعم' ? 'نعم'
                     : latest?.clientEvaluation?.satisfaction === 'لا'  ? 'لا' : '',
    fixed_date: latest?.clientEvaluation?.gregorianDate || '',
    logo_data_url: logoDataUrl || null
    };
    
    try {
      const apiBase = (typeof config !== 'undefined' && config.apiBase) ? config.apiBase.replace(/\/+$/,'') : '';
      const res = await fetch(`${apiBase}/api/export-excel`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });


    if(!res.ok){
      const err = await res.json().catch(()=>({error:'unknown'}));
      alert('تعذر إنشاء التقرير عبر الخادم: ' + (err.error || res.status));
      return;
    }

    const blob = await res.blob();
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href = url;
    a.download = `تقرير_${payload.request_id}.xlsx`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

    showModal(`
      <div style="text-align:center;padding:20px">
        <div style="font-size:4rem;color:#43e97b;margin-bottom:20px">✅</div>
        <h3 style="color:#43e97b;margin-bottom:15px">تم إنشاء التقرير بنجاح!</h3>
        <p style="color:#666">تم تحميل الملف: تقرير_${payload.request_id}.xlsx</p>
      </div>
    `);
    
  } catch(e){
    alert('خطأ عند الاتصال بالخادم: ' + e.message);
  }
}

// دالة تصدير PDF عبر الخادم
async function exportPDFViaServer(){
  const latest = requests[requests.length - 1];
  if (!latest){
    alert('لا توجد طلبات في النظام لتوليد التقرير.');
    return;
  }

  const logoDataUrl = config?.logoPath ? await fetchLogoAsDataURL(config.logoPath) : null;

  const payload = {
    request_id: latest.number || String(latest.id).padStart(6,'0'),
    maintenance_type: latest.problemType || '',
    location: latest.building || '',
    priority: latest.maintenanceType || '',
    requester_name: latest.clientName || '',
    request_time: latest.time || '',
    request_date: latest.gregorianDate || '',
    fault_type: latest.problemType || '',
    fault_desc: latest.problemDescription || '',
    technician_name: latest?.technicianReport?.techName || '',
    execution_date: latest?.technicianReport?.gregorianDate || '',
    supervisor_name: latest?.supervisorReview?.reviewerName || '',
    status: latest.status || '',
    status_date: latest?.supervisorReview?.gregorianDate || '',
    requester_name_2: latest.clientName || '',
    is_fixed: latest?.clientEvaluation?.satisfaction === 'نعم' ? 'نعم'
            : latest?.clientEvaluation?.satisfaction === 'لا'  ? 'لا' : '',
    fixed_date: latest?.clientEvaluation?.gregorianDate || '',
    logo_data_url: logoDataUrl || null
  };

  try{
    const apiBase = (typeof config !== 'undefined' && config.apiBase) ? config.apiBase : '';
    const res = await fetch(`${apiBase}/api/export-pdf`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });

    if(!res.ok){
      const err = await res.json().catch(()=>({error:'unknown'}));
      alert('تعذر إنشاء تقرير PDF: ' + (err.error || res.status));
      return;
    }

    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `تقرير_PDF_${payload.request_id}.pdf`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    
  } catch(e){
    alert('خطأ عند الاتصال بالخادم: ' + e.message);
  }
}
// دالة مساعدة لتحميل الشعار
async function fetchLogoAsDataURL(src){
  try{
    const resp = await fetch(src, {cache:'reload'});
    if(!resp.ok) return null;
    const blob = await resp.blob();
    return await new Promise((resolve, reject) => {
      const fr = new FileReader();
      fr.onload = () => resolve(fr.result);
      fr.onerror = reject;
      fr.readAsDataURL(blob);
    });
  }catch(e){
    console.error('فشل تحميل الشعار:', e);
    return null;
  }
}

// CSS محسن للطباعة
const enhancedPrintCSS = `
<style>
@media print {
  * { 
    -webkit-print-color-adjust: exact !important; 
    color-adjust: exact !important; 
    print-color-adjust: exact !important;
  }
  
  body {
    background: white !important;
    font-size: 12pt !important;
    margin: 0 !important;
    padding: 0 !important;
  }
  
  .login-screen, .user-info-bar, .nav-tabs, .btn, button, .no-print {
    display: none !important;
  }
  
  .container {
    box-shadow: none !important;
    max-width: none !important;
    margin: 0 !important;
    background: white !important;
    border-radius: 0 !important;
  }
  
  .enhanced-report {
    font-size: 11pt !important;
    line-height: 1.4 !important;
    margin: 0 !important;
    padding: 20px !important;
  }
  
  .enhanced-report h1 { 
    font-size: 16pt !important; 
    page-break-after: avoid !important;
  }
  .enhanced-report h2 { 
    font-size: 14pt !important; 
    page-break-after: avoid !important;
  }
  .enhanced-report h3 { 
    font-size: 12pt !important; 
    page-break-after: avoid !important;
  }
  .enhanced-report h4 { 
    font-size: 11pt !important; 
    page-break-after: avoid !important;
  }
  
  .enhanced-report table {
    page-break-inside: auto !important;
    font-size: 10pt !important;
  }
  
  .enhanced-report tr {
    page-break-inside: avoid !important;
    page-break-after: auto !important;
  }
  
  .enhanced-report thead {
    display: table-header-group !important;
  }
  
  .enhanced-report th, .enhanced-report td {
    padding: 8px 4px !important;
    font-size: 9pt !important;
  }
  
  .print-only {
    display: block !important;
  }
  
  @page {
    margin: 1.5cm 1cm;
    size: A4;
  }
}

/* تحسينات إضافية للعرض */
.enhanced-report table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 20px;
}

.enhanced-report th {
  background-color: #4472C4 !important;
  color: white !important;
  font-weight: bold;
  text-align: center;
}

.enhanced-report td {
  text-align: center;
  vertical-align: middle;
}

.enhanced-report tr:nth-child(even) {
  background-color: #f2f2f2 !important;
}

.enhanced-report .stats-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 15px;
  margin: 20px 0;
}

@media screen and (max-width: 768px) {
  .enhanced-report .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media screen and (max-width: 480px) {
  .enhanced-report .stats-grid {
    grid-template-columns: 1fr;
  }
}
</style>
`;

// إضافة CSS للطباعة المحسن
if (!document.getElementById('enhancedPrintStyles')) {
  const styleElement = document.createElement('div');
  styleElement.id = 'enhancedPrintStyles';
  styleElement.innerHTML = enhancedPrintCSS;
  document.head.appendChild(styleElement);
}

// تحديث دالة إنشاء التقرير من القالب
async function generateExcelFromTemplate() {
  try {
    const templatePath = config.reportTemplate || "template.xlsx";

    const response = await fetch(templatePath);
    if (!response.ok) {
      throw new Error(`لا يمكن تحميل القالب: ${response.status}`);
    }
    
    const arrayBuffer = await response.arrayBuffer();
    const workbook = XLSX.read(arrayBuffer, { 
      type: 'array',
      cellStyles: true,
      cellFormulas: true,
      cellDates: true
    });
    
    const sheetName = workbook.SheetNames[0];
    const ws = workbook.Sheets[sheetName];

    // تحقق من وجود طلبات
    if (!requests.length) {
      alert("لا توجد بيانات طلب لتعبئتها في التقرير");
      return;
    }

    // استخدام آخر طلب أو يمكنك السماح للمستخدم بالاختيار
    const latest = requests[requests.length - 1];

    // تعبئة البيانات في الخلايا المناسبة
    const cellMappings = {
      'C8': latest.number,
      'F8': latest.problemType,
      'I8': latest.building,
      'D9': latest.maintenanceType,
      'D11': latest.clientName,
      'D13': latest.time,
      'H13': latest.gregorianDate,
      'C15': latest.problemType,
      'A19': latest.problemDescription,
      'C25': latest?.technicianReport?.techName || '',
      'H26': latest?.technicianReport?.gregorianDate || '',
      'C29': latest?.supervisorReview?.reviewerName || '',
      'C30': latest.status,
      'H31': latest?.supervisorReview?.gregorianDate || '',
      'C34': latest.clientName,
      'C35': latest?.clientEvaluation?.satisfaction === 'نعم' ? 'نعم' 
             : latest?.clientEvaluation?.satisfaction === 'لا' ? 'لا' : '',
      'H36': latest?.clientEvaluation?.gregorianDate || ''
    };

    // تطبيق البيانات على الورقة
    Object.entries(cellMappings).forEach(([cell, value]) => {
      if (!ws[cell]) ws[cell] = {};
      ws[cell].t = "s";
      ws[cell].v = String(value || '');
    });

    // إنشاء اسم ملف منسق
    const timestamp = new Date().toISOString().slice(0, 10);
    const filename = `تقرير_طلب_${latest.number}_${timestamp}.xlsx`;
    
    // حفظ الملف
    XLSX.writeFile(workbook, filename);

    showModal(`
      <div style="text-align:center;padding:20px">
        <div style="font-size:4rem;color:#43e97b;margin-bottom:20px">✅</div>
        <h3 style="color:#43e97b;margin-bottom:15px">تم إنشاء التقرير بنجاح!</h3>
        <p style="color:#666">تم حفظ الملف: ${filename}</p>
        <p style="color:#666;font-size:0.9rem;margin-top:10px">
          رقم الطلب: ${latest.number}<br>
          العميل: ${latest.clientName}<br>
          التاريخ: ${latest.gregorianDate}
        </p>
      </div>
    `);
    
  } catch (err) {
    console.error("خطأ في توليد التقرير:", err);
    alert("حدث خطأ أثناء توليد التقرير:\n" + (err?.message || err));
  }
}
/* ====== Views ====== */
function displayTechnicianRequests(){
  const container = document.getElementById('technicianRequests'); 
  if (!container) return;
  
  let relevant = [];
  if (userType === 'technician') {
    relevant = requests.filter(r =>
      r.status === 'جديد' ||
      (r.technicianReport && r.technicianReport.techName === (currentUserData?.name || ''))
    );
  } else {
    relevant = requests.filter(r =>
      ['جديد','قيد المعالجة','جاري الإصلاح','بانتظار اعتماد المشرف'].includes(r.status)
    );
  }
  
  if (!relevant.length){ 
    container.innerHTML = emptyMsg('لا توجد طلبات جديدة حالياً'); 
    return; 
  }

  container.innerHTML = relevant.map(r => `
    <div class="request-card">
      <div class="request-header">
        <div class="request-id">${r.number}</div>
        <div class="status-badge ${getStatusClass(r.status)}">${r.status}</div>
      </div>
      <div><strong>العميل:</strong> ${r.clientName}</div>
      <div><strong>المبنى:</strong> ${r.building}</div>
      <div><strong>نوع العطل:</strong> ${r.problemType}</div>
      <div><strong>الوصف:</strong> ${r.problemDescription}</div>
      <div><strong>تاريخ الطلب:</strong> ${r.gregorianDate} - ${r.time}</div>
      <div><strong>التاريخ الهجري:</strong> ${r.hijriDate}</div>

      ${r.technicianReport ? `
        <div style="background:#f8f9fa;padding:15px;margin-top:15px;border-radius:10px">
          <h4>تقرير الفني:</h4>
          <div><strong>الفني:</strong> ${r.technicianReport.techName}</div>
          <div><strong>الحالة:</strong> ${r.technicianReport.status}</div>
          <div><strong>التاريخ:</strong> ${r.technicianReport.gregorianDate} - ${r.technicianReport.time}</div>
          <div><strong>التاريخ الهجري:</strong> ${r.technicianReport.hijriDate}</div>
          ${r.technicianReport.notes ? `<div><strong>ملاحظات:</strong> ${r.technicianReport.notes}</div>` : ''}
        </div>
      ` : `
        <div style="margin-top:20px" class="no-print">
          <label for="techName${r.id}">اسم الفني:</label>
          <input type="text" id="techName${r.id}" value="${currentUserData?.name || ''}" readonly style="margin:10px 0">
          <select id="techStatus${r.id}" style="margin:10px 0">
            <option value="قيد المعالجة">قيد المعالجة</option>
            <option value="جاري الإصلاح">جاري الإصلاح</option>
            <option value="تم الإصلاح">تم الإصلاح</option>
            <option value="يحتاج قطع غيار">يحتاج قطع غيار</option>
            <option value="يحتاج متخصص">يحتاج متخصص</option>
          </select>
          <textarea id="techNotes${r.id}" placeholder="ملاحظات الفني..." style="margin:10px 0;min-height:80px"></textarea>
          <button class="btn btn-success" onclick="submitTechnicianReport(${r.id})">تسليم التقرير</button>
        </div>
      `}
    </div>
  `).join('');
}

function displaySupervisorRequests(){
  const container = document.getElementById('supervisorRequests'); 
  if (!container) return;
  
  const list = requests.filter(r => r.technicianReport && !r.supervisorReview);
  if (!list.length){ 
    container.innerHTML = emptyMsg('لا توجد طلبات تحتاج مراجعة'); 
    return; 
  }

  container.innerHTML = list.map(r => `
    <div class="request-card">
      <div class="request-header">
        <div class="request-id">${r.number}</div>
        <div class="status-badge ${getStatusClass(r.status)}">${r.status}</div>
      </div>
      <div><strong>العميل:</strong> ${r.clientName}</div>
      <div><strong>المبنى:</strong> ${r.building}</div>
      <div><strong>نوع العطل:</strong> ${r.problemType}</div>
      <div><strong>التاريخ الهجري:</strong> ${r.hijriDate}</div>

      <div style="background:#e3f2fd;padding:15px;margin:15px 0;border-radius:10px">
        <h4>تقرير الفني:</h4>
        <div><strong>الفني:</strong> ${r.technicianReport.techName}</div>
        <div><strong>الحالة:</strong> ${r.technicianReport.status}</div>
        ${r.technicianReport.notes ? `<div><strong>ملاحظات:</strong> ${r.technicianReport.notes}</div>` : ''}
        <div><strong>تاريخ التقرير:</strong> ${r.technicianReport.gregorianDate} - ${r.technicianReport.time}</div>
        <div><strong>التاريخ الهجري:</strong> ${r.technicianReport.hijriDate}</div>
      </div>

      <div style="margin-top:20px" class="no-print">
        <label>قرار المشرف:</label>
        <select id="supervisorStatus${r.id}" style="margin:10px 0" onchange="toggleReferField(${r.id})">
          <option value="مقبول">مقبول - تم الإصلاح</option>
          <option value="معلق">معلق - يحتاج متابعة</option>
          <option value="مرفوض">مرفوض - يحتاج إعادة عمل</option>
          <option value="إحالة">إحالة إلى متخصص</option>
        </select>
        <textarea id="supervisorNotes${r.id}" placeholder="ملاحظات المشرف..." style="margin:10px 0;min-height:80px"></textarea>
        <input type="text" id="referTo${r.id}" placeholder="إحالة إلى..." style="display:none;margin:10px 0">
        <button class="btn btn-warning" onclick="submitSupervisorReview(${r.id})">اعتماد المراجعة</button>
      </div>
    </div>
  `).join('');
}

function toggleReferField(requestId) {
  const select = document.getElementById(`supervisorStatus${requestId}`);
  const referField = document.getElementById(`referTo${requestId}`);
  
  if (select && referField) {
    if (select.value === 'إحالة') {
      referField.style.display = 'block';
      referField.placeholder = 'اكتب الجهة/المتخصص المُحال إليه';
    } else {
      referField.style.display = 'none';
      referField.value = '';
    }
  }
}

function displayClientRequests(){
  const container = document.getElementById('clientRequests'); 
  if (!container) return;

  let list = [];
  if (userType === 'employee') {
    list = requests.filter(r => 
      r.supervisorReview && 
      !r.clientEvaluation && 
      r.clientName === (currentUserData?.name || '')
    );
  } else {
    list = requests.filter(r => r.supervisorReview && !r.clientEvaluation);
  }
  
  if (!list.length){ 
    container.innerHTML = emptyMsg('لا توجد طلبات تحتاج تقييم'); 
    return; 
  }

  container.innerHTML = list.map(r => `
    <div class="request-card">
      <div class="request-header">
        <div class="request-id">${r.number}</div>
        <div class="status-badge status-completed">${r.supervisorReview.status}</div>
      </div>
      <div><strong>العميل:</strong> ${r.clientName}</div>
      <div><strong>المبنى:</strong> ${r.building}</div>
      <div><strong>نوع العطل:</strong> ${r.problemType}</div>
      <div><strong>حالة الإصلاح:</strong> ${r.supervisorReview.status}</div>
      <div><strong>التاريخ الهجري:</strong> ${r.hijriDate}</div>
      
      <div style="margin-top:20px" class="no-print">
        <label>هل تم إصلاح العطل؟</label>
        <div class="radio-group">
          <div class="radio-item">
            <input type="radio" id="satisfied${r.id}" name="clientSatisfaction${r.id}" value="نعم" />
            <label for="satisfied${r.id}">نعم</label>
          </div>
          <div class="radio-item">
            <input type="radio" id="notSatisfied${r.id}" name="clientSatisfaction${r.id}" value="لا" />
            <label for="notSatisfied${r.id}">لا</label>
          </div>
        </div>
        <textarea id="clientNotes${r.id}" placeholder="ملاحظات إضافية..." style="margin:10px 0"></textarea>
        <button class="btn btn-primary" onclick="submitClientEvaluation(${r.id})">إرسال التقييم</button>
      </div>
    </div>
  `).join('');
}

/* ====== Actions ====== */
function submitTechnicianReport(id){
  if (!['technician','quality','dean'].includes(userType)) {
    alert('يسمح فقط للفني أو الإداريين بتسليم تقرير فني');
    return;
  }
  
  const r = requests.find(x => x.id === id);
  if (!r) return;
  
  const techName = document.getElementById(`techName${id}`).value.trim();
  const techStatus = document.getElementById(`techStatus${id}`).value;
  const techNotes = document.getElementById(`techNotes${id}`).value.trim();

  if (!techName){ 
    alert('يرجى إدخال اسم الفني'); 
    return; 
  }

  const now = new Date();
  const nextStatus = (techStatus === 'تم الإصلاح')
    ? 'بانتظار اعتماد المشرف'
    : techStatus;

  r.technicianReport = {
    techName,
    status: techStatus,
    notes: techNotes,
    submittedAt: now.toISOString(),
    hijriDate: gregorianToHijri(now),
    gregorianDate: now.toLocaleDateString('ar-SA'),
    time: now.toLocaleTimeString('ar-SA',{hour12:false})
  };

  r.status = nextStatus;

  localStorage.setItem('maintenanceRequests', JSON.stringify(requests));

  showModal(`
    <div style="text-align:center;padding:20px">
      <div style="font-size:4rem;color:#43e97b;margin-bottom:20px">✅</div>
      <h3 style="color:#43e97b;margin-bottom:15px">تم تسليم تقرير الفني بنجاح!</h3>
      <p style="color:#666">الطلب رقم: ${r.number}</p>
    </div>
  `);
  displayTechnicianRequests();
  updateAllDisplays();
}

function submitSupervisorReview(id){
  const r = requests.find(x => x.id === id);
  if (!['quality','dean','supervisor'].includes(userType)){ 
    alert('ليس لديك صلاحية لمراجعة التقارير'); 
    return; 
  }

  const status = document.getElementById(`supervisorStatus${id}`).value;
  const notes  = document.getElementById(`supervisorNotes${id}`).value.trim();
  const referTo= document.getElementById(`referTo${id}`).value.trim();

  const now = new Date();
  r.supervisorReview = {
    status, 
    notes, 
    referTo, 
    reviewerName: currentUserData?.name || '',
    submittedAt: now.toISOString(),
    hijriDate: gregorianToHijri(now),
    gregorianDate: now.toLocaleDateString('ar-SA'),
    time: now.toLocaleTimeString('ar-SA',{hour12:false})
  };

  switch(status){
    case 'مقبول': r.status = 'تم الإصلاح'; break;
    case 'معلق': r.status = 'معلق'; break;
    case 'مرفوض': r.status = 'يحتاج إعادة عمل'; break;
    case 'إحالة': r.status = 'محال إلى متخصص'; break;
  }

  localStorage.setItem('maintenanceRequests', JSON.stringify(requests));
  showModal(`
    <div style="text-align:center;padding:20px">
      <div style="font-size:4rem;color:#fa709a;margin-bottom:20px">✅</div>
      <h3 style="color:#fa709a;margin-bottom:15px">تم اعتماد المراجعة بنجاح!</h3>
      <p style="color:#666">الطلب رقم: ${r.number}</p>
    </div>
  `);
  displaySupervisorRequests();
  updateAllDisplays();
}

function submitClientEvaluation(id){
  const r = requests.find(x => x.id === id);
  if (!r) return;
  
  const sat = document.querySelector(`input[name="clientSatisfaction${id}"]:checked`);
  const notes = document.getElementById(`clientNotes${id}`).value.trim();
  
  if (!sat){ 
    alert('يرجى اختيار تقييم الإصلاح'); 
    return; 
  }
  
  if (userType === 'employee' && r.clientName !== (currentUserData?.name || '')) {
    alert('لا يمكنك تقييم طلبات الآخرين'); 
    return; 
  }

  const now = new Date();
  r.clientEvaluation = {
    satisfaction: sat.value, 
    notes,
    evaluatorName: currentUserData?.name || '',
    submittedAt: now.toISOString(),
    hijriDate: gregorianToHijri(now),
    gregorianDate: now.toLocaleDateString('ar-SA'),
    time: now.toLocaleTimeString('ar-SA',{hour12:false})
  };
  
  r.status = (sat.value === 'نعم') ? 'مكتمل' : 'يحتاج متابعة';

  localStorage.setItem('maintenanceRequests', JSON.stringify(requests));
  showModal(`
    <div style="text-align:center;padding:20px">
      <div style="font-size:4rem;color:#4facfe;margin-bottom:20px">✅</div>
      <h3 style="color:#4facfe;margin-bottom:15px">شكراً لك على التقييم!</h3>
      <p style="color:#666">تم تسجيل تقييمك للطلب رقم: ${r.number}</p>
    </div>
  `);
  displayClientRequests();
  updateAllDisplays();
}

/* ====== Quality Report ====== */
function displayQualityReport(){
  if (userType === 'technician'){
    const c = document.getElementById('detailedReport');
    if (c) c.innerHTML = '<p style="text-align:center;color:#666;padding:40px">ليس لديك صلاحية لعرض تقرير الجودة الشامل</p>';
    return;
  }
  
  const total = requests.length;
  const completed = requests.filter(r => r.clientEvaluation && r.status === 'مكتمل').length;
  const progress = requests.filter(r =>
    ['قيد المعالجة','جاري الإصلاح','تم الإصلاح','بانتظار اعتماد المشرف'].includes(r.status)
  ).length;
  const pending  = requests.filter(r =>
    ['معلق','يحتاج متابعة','يحتاج إعادة عمل','محال إلى متخصص'].includes(r.status)
  ).length;

  document.getElementById('totalRequests').textContent = total;
  document.getElementById('completedRequests').textContent = completed;
  document.getElementById('progressRequests').textContent = progress;
  document.getElementById('pendingRequests').textContent = pending;

  const detailed = document.getElementById('detailedReport');
  if (!requests.length){ 
    detailed.innerHTML = emptyMsg('لا توجد بيانات لعرضها'); 
    return; 
  }

  // Groupings
  const byProblem = {};
  const byMaintenance = {};
  const techStats = {};

  requests.forEach(r => {
    byProblem[r.problemType] = (byProblem[r.problemType] || 0) + 1;
    byMaintenance[r.maintenanceType] = (byMaintenance[r.maintenanceType] || 0) + 1;
    if (r.technicianReport){
      const t = r.technicianReport.techName;
      if (!techStats[t]) techStats[t] = { total:0, completed:0 };
      techStats[t].total++;
      if (['مكتمل','تم الإصلاح'].includes(r.status)) techStats[t].completed++;
    }
  });

  const problemCard = `
    <div class="request-card">
      <h3 style="color:#4facfe;margin-bottom:20px">📋 تفصيل حسب نوع العطل</h3>
      ${Object.entries(byProblem).map(([k,v]) => rowKV(k,v,'status-new')).join('')}
    </div>
  `;

  const maintenanceCard = `
    <div class="request-card">
      <h3 style="color:#43e97b;margin-bottom:20px">🔧 تفصيل حسب نوع الصيانة</h3>
      ${Object.entries(byMaintenance).map(([k,v]) => rowKV(k,v,'status-completed')).join('')}
    </div>
  `;

  const techCard = Object.keys(techStats).length ? `
    <div class="request-card">
      <h3 style="color:#764ba2;margin-bottom:20px">🔧 أداء الفنيين</h3>
      ${Object.entries(techStats).map(([tech,st]) => {
        const pct = Math.round((st.completed / st.total)*100);
        const badge = (pct>=80)?'status-completed':(pct>=60)?'status-progress':'status-pending';
        return `
          <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid #eee">
            <span>${tech}</span>
            <div>
              <span class="status-badge status-completed">${st.completed}/${st.total}</span>
              <span class="status-badge ${badge}">${pct}%</span>
            </div>
          </div>
        `;
      }).join('')}
    </div>
  ` : '';

  const table = `
    <div class="request-card" style="margin-top:30px">
      <h3 style="color:#fa709a;margin-bottom:20px">📊 جميع الطلبات</h3>
      <div style="overflow-x:auto">
        <table style="width:100%;border-collapse:collapse">
          <thead>
            <tr style="background:#f8f9fa">
              ${['رقم الطلب','العميل','نوع العطل','الفني','الحالة','التاريخ الميلادي','التاريخ الهجري','إجراءات'].map(h => 
                `<th style="padding:15px;text-align:center;border:1px solid #dee2e6">${h}</th>`
              ).join('')}
            </tr>
          </thead>
          <tbody>
              ${requests.map(r => `
                <tr>
                  <td style="padding:12px;text-align:center;border:1px solid #dee2e6">${r.number}</td>
                  <td style="padding:12px;text-align:center;border:1px solid #dee2e6">${r.clientName}</td>
                  <td style="padding:12px;text-align:center;border:1px solid #dee2e6">${r.problemType}</td>
                  <td style="padding:12px;text-align:center;border:1px solid #dee2e6">${r.technicianReport ? r.technicianReport.techName : 'لم يتم التعيين'}</td>
                  <td style="padding:12px;text-align:center;border:1px solid #dee2e6">
                    <span class="status-badge ${getStatusClass(r.status)}">${r.status}</span>
                  </td>
                  <td style="padding:12px;text-align:center;border:1px solid #dee2e6">${r.gregorianDate}</td>
                  <td style="padding:12px;text-align:center;border:1px solid #dee2e6">${r.hijriDate}</td>
                  <td style="padding:12px;text-align:center;border:1px solid #dee2e6" class="no-print">
                    ${['quality','dean'].includes(userType) ? 
                      `<button class="btn btn-danger" style="padding:5px 10px;margin:2px;font-size:.8rem" onclick="deleteRequest(${r.id})">حذف</button>` : 
                      '-'}
                  </td>
                </tr>
              `).join('')}
            </tbody>
        </table>
      </div>
    </div>
  `;

  detailed.innerHTML = `
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:30px;margin-top:30px">
      ${problemCard}
      ${maintenanceCard}
      ${techCard}
    </div>
    ${table}
  `;
}

/* ====== Password Management ====== */
function changePassword() {
  if (!currentUserData || !currentUserData.canChangePassword) {
    alert('لا يمكنك تغيير كلمة المرور');
    return;
  }
  
  const newPassword = prompt('ادخل كلمة المرور الجديدة:');
  if (!newPassword) return;
  
  const confirmPassword = prompt('تأكيد كلمة المرور الجديدة:');
  if (newPassword !== confirmPassword) {
    alert('كلمات المرور غير متطابقة');
    return;
  }
  
  // تحديث كلمة المرور في البيانات المحلية
  const userData = JSON.parse(localStorage.getItem('sheetsUserData') || '[]');
  const userIndex = userData.findIndex(u => u.employeeId === currentUser);
  
  if (userIndex !== -1) {
    userData[userIndex].password = newPassword;
    localStorage.setItem('sheetsUserData', JSON.stringify(userData));
    
    // في التطبيق الحقيقي، يجب تحديث Google Sheets هنا
    updatePasswordInSheets(currentUser, newPassword);
    
    alert('تم تغيير كلمة المرور بنجاح');
  }
}


// ==== إعدادات الويب-آب (Apps Script) ====
// غيّر فقط الرابط أو السر عند الحاجة
const APPS_SCRIPT_URL    = 'https://script.google.com/macros/s/AKfycbz7Slqwx4zeevaKUpKTqsIyzPbi2M9viyYrVfy5ulOInhq1gMTMTgZuBd4k4Au21YM5/exec';
const APPS_SCRIPT_SECRET = '1193';
const SHEET_NAME         = 'بيانات موظفي نظام الصيانة'; // عدّل الاسم لو ورقتك مختلفة

// تحديث كلمة المرور في Google Sheet عبر Web App
async function updatePasswordInSheets(employeeId, newPassword) {
  try {
    const resp = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      // لا ترسل أي مفاتيح API هنا — فقط السر الخاص بالويب-آب
      body: JSON.stringify({
        secret: APPS_SCRIPT_SECRET,
        spreadsheetId: sheets_id,
        employeeId,
        newPassword,
        sheetName: SHEET_NAME
      })
    });

    // نحاول قراءة الاستجابة دائمًا كـ JSON
    const data = await resp.json().catch(() => ({}));

    if (!resp.ok || !data.ok) {
      const msg = (data && (data.error || data.message)) || `HTTP ${resp.status}`;
      throw new Error(msg);
    }

    // تحديث النسخة المحلية لضمان التزامن الفوري
    const users = JSON.parse(localStorage.getItem('sheetsUserData') || '[]');
    const idx = users.findIndex(
      u => String((u.employeeId || '')).trim() === String((employeeId || '')).trim()
    );
    if (idx !== -1) {
      users[idx].password = newPassword;
      localStorage.setItem('sheetsUserData', JSON.stringify(users));
    }

    console.log('تم تحديث كلمة المرور في الشيت | الصف:', data.row);
    return true;
  } catch (err) {
    console.error('فشل تحديث كلمة المرور في الشيت:', err);
    alert('فشل تحديث كلمة المرور في Google Sheet: ' + (err.message || err));
    return false;
  }
}

/* ====== Helpers ====== */
function rowKV(k,v,cls){ 
  return `
    <div style="display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid #eee">
      <span>${k}</span><span class="status-badge ${cls}">${v}</span>
    </div>
  `; 
}

function emptyMsg(txt){
  return `<p style="text-align:center;color:#666;padding:40px">
            <span style="font-size:1.6rem">ℹ️</span><br>${txt}
          </p>`;
}

function updateAllDisplays(){ 
  displayTechnicianRequests(); 
  displaySupervisorRequests(); 
  displayClientRequests(); 
  displayQualityReport(); 
}

function getStatusClass(status){
  switch(status){
    case 'جديد': return 'status-new';
    case 'قيد المعالجة':
    case 'جاري الإصلاح': return 'status-progress';
    case 'بانتظار اعتماد المشرف': return 'status-waiting';
    case 'تم الإصلاح':
    case 'مكتمل': return 'status-completed';
    case 'معلق':
    case 'يحتاج متابعة':
    case 'يحتاج إعادة عمل':
    case 'محال إلى متخصص': return 'status-pending';
    default: return 'status-new';
  }
}

function deleteRequest(id){
  if (!['quality','dean'].includes(userType)){ 
    alert('ليس لديك صلاحية لحذف الطلبات'); 
    return; 
  }
  
  if (confirm('هل أنت متأكد من حذف هذا الطلب؟')){
    requests = requests.filter(r => r.id !== id);
    localStorage.setItem('maintenanceRequests', JSON.stringify(requests));
    updateAllDisplays();
    showModal(`
      <div style="text-align:center;padding:20px">
        <div style="font-size:4rem;color:#dc3545;margin-bottom:20px">🗑️</div>
        <h3 style="color:#dc3545;margin-bottom:15px">تم حذف الطلب بنجاح!</h3>
      </div>
    `);
  }
}

function showModal(html){ 
  document.getElementById('modalContent').innerHTML = html; 
  document.getElementById('modal').style.display='block'; 
  setTimeout(closeModal,3000); 
}

function closeModal(){ 
  document.getElementById('modal').style.display='none'; 
}

/* ====== Event Listeners ====== */
document.addEventListener('change', e => {
  // إظهار/إخفاء خانة "إحالة إلى..." حسب اختيار المشرف
  if (e.target.id && e.target.id.startsWith('supervisorStatus')) {
    const id = parseInt(e.target.id.replace('supervisorStatus',''), 10);
    toggleReferField(id);
  }
});

// تحديث التاريخ عند تغيير التاريخ في المحول
document.addEventListener('DOMContentLoaded', () => {
  const gregorianInput = document.getElementById('gregorianInput');
  if (gregorianInput) {
    // تعيين التاريخ الحالي كقيمة افتراضية
    gregorianInput.value = new Date().toISOString().split('T')[0];
    convertToHijri();
  }
});

/* ====== Export Functions ====== */
function exportToExcel() {
  if (!['quality','dean','supervisor'].includes(userType)) {
    alert('ليس لديك صلاحية لتصدير البيانات');
    return;
  }

  const workbook = XLSX.utils.book_new();
  
  // إعداد البيانات للتصدير
  const exportData = requests.map(r => ({
    'رقم الطلب': r.number,
    'اسم العميل': r.clientName,
    'المبنى': r.building,
    'نوع الصيانة': r.maintenanceType,
    'نوع العطل': r.problemType,
    'وصف المشكلة': r.problemDescription,
    'الحالة': r.status,
    'التاريخ الميلادي': r.gregorianDate,
    'التاريخ الهجري': r.hijriDate,
    'الوقت': r.time,
    'اسم الفني': r.technicianReport ? r.technicianReport.techName : '',
    'حالة الفني': r.technicianReport ? r.technicianReport.status : '',
    'ملاحظات الفني': r.technicianReport ? r.technicianReport.notes : '',
    'قرار المشرف': r.supervisorReview ? r.supervisorReview.status : '',
    'ملاحظات المشرف': r.supervisorReview ? r.supervisorReview.notes : '',
    'تقييم العميل': r.clientEvaluation ? r.clientEvaluation.satisfaction : '',
    'ملاحظات العميل': r.clientEvaluation ? r.clientEvaluation.notes : ''
  }));

  const worksheet = XLSX.utils.json_to_sheet(exportData);
  XLSX.utils.book_append_sheet(workbook, worksheet, 'تقرير الصيانة');

  // تصدير الملف
  const fileName = `تقرير_الصيانة_${new Date().toISOString().split('T')[0]}.xlsx`;
  XLSX.writeFile(workbook, fileName);
  
  showModal(`
    <div style="text-align:center;padding:20px">
      <div style="font-size:4rem;color:#43e97b;margin-bottom:20px">📊</div>
      <h3 style="color:#43e97b;margin-bottom:15px">تم تصدير التقرير بنجاح!</h3>
      <p style="color:#666">تم حفظ الملف: ${fileName}</p>
    </div>
  `);
}

// إضافة زر التصدير إلى شريط المستخدم
document.addEventListener('DOMContentLoaded', () => {
  const userInfo = document.querySelector('.user-info');
  if (userInfo) {
    const exportBtn = document.createElement('button');
    exportBtn.className = 'btn-primary';
    exportBtn.onclick = exportToExcel;
    exportBtn.innerHTML = '📊 تصدير Excel';
    exportBtn.style.display = 'none';
    exportBtn.id = 'exportBtn';
    userInfo.appendChild(exportBtn);
  }
});

// إظهار زر التصدير للمخولين
function updateExportButtonVisibility() {
  const exportBtn = document.getElementById('exportBtn');
  if (exportBtn) {
    if (['quality','dean','supervisor'].includes(userType)) {
      exportBtn.style.display = 'inline-block';
    } else {
      exportBtn.style.display = 'none';
    }
  }
}

// تحديث واجهة المستخدم بعد تسجيل الدخول
function setupUserInterface(type) {
  const tabs = {
    'new-request':        document.querySelector('[data-tab="new-request"]'),
    'technician-report':  document.querySelector('[data-tab="technician-report"]'),
    'supervisor-review':  document.querySelector('[data-tab="supervisor-review"]'),
    'client-evaluation':  document.querySelector('[data-tab="client-evaluation"]'),
    'quality-report':     document.querySelector('[data-tab="quality-report"]')
  };
  Object.values(tabs).forEach(t => t && t.classList.add('hidden'));

  switch(type){
    case 'quality':
    case 'dean':
      Object.values(tabs).forEach(t => t && t.classList.remove('hidden')); 
      break;
    case 'supervisor':
      tabs['new-request']?.classList.remove('hidden');
      tabs['supervisor-review']?.classList.remove('hidden');
      tabs['quality-report']?.classList.remove('hidden'); 
      break;
    case 'technician':
      tabs['technician-report']?.classList.remove('hidden'); 
      break;
    case 'employee':
      tabs['new-request']?.classList.remove('hidden');
      tabs['client-evaluation']?.classList.remove('hidden'); 
      break;
  }

  // إضافة زر تغيير كلمة المرور للمستخدمين المؤهلين
const userInfo = document.querySelector('.user-info');
if (userInfo && currentUserData && currentUserData.canChangePassword) {
  // 👈 امنع التكرار
  if (!document.getElementById('changePassBtn')) {
    const changePassBtn = document.createElement('button');
    changePassBtn.id = 'changePassBtn';
    changePassBtn.className = 'btn-primary';
    changePassBtn.onclick = changePassword;
    changePassBtn.innerHTML = '🔑 تغيير كلمة المرور';
    changePassBtn.style.marginLeft = '10px';
    userInfo.appendChild(changePassBtn);
  }
}


  // إظهار زر التصدير
  updateExportButtonVisibility();

  let defaultTab = (type === 'technician') ? 'technician-report' : 'new-request';
  const defaultBtn = document.querySelector(`[data-tab="${defaultTab}"]`);
  if (defaultBtn && !defaultBtn.classList.contains('hidden')) {
    showTab(defaultTab, defaultBtn);
  }
}

</script>
<!-- Config loader + server exports (نسخة نظيفة) -->
<script>
  // اجعل config متاحًا عالميًا مرة واحدة فقط
  window.config = window.config || {};

  // حمّل config.json وعبّي الواجهة
  (async function loadAndApplyConfig(){
    try{
      const res = await fetch("config.json", { cache: "no-cache" });
      const data = await res.json();
      window.config = data || {};

      // 1) اسم الكلية
      const collegeNameElement = document.querySelector('.college-info h1');
      if (collegeNameElement && config.collegeName) {
        collegeNameElement.textContent = config.collegeName;
      }

      // 2) الشعار
      const logoImg = document.querySelector('.college-logo');
      if (logoImg && config.logoPath) {
        logoImg.innerHTML = `<img src="${config.logoPath}" alt="الشعار" style="max-height:100px;">`;
      }

      // 3) Google Sheets حقول الربط الافتراضية
      if (document.getElementById('sheetsId') && config.defaultSheetId) {
        document.getElementById('sheetsId').value = config.defaultSheetId;
      }
      if (document.getElementById('sheetsApiKey') && config.defaultApiKey) {
        document.getElementById('sheetsApiKey').value = config.defaultApiKey;
      }

      // 4) فوتر المطوّر
      const developerFooter = document.querySelector('#developerFooter');
      if (developerFooter && config.developer) {
        developerFooter.textContent = `تطوير: ${config.developer}`;
      }
    }catch(err){
      console.error("خطأ في تحميل config.json:", err);
      alert("حدث خطأ أثناء تحميل الإعدادات:\n" + (err?.message || err));
    }
  })();

  // دالة مساعدة (لن تُستدعى هنا مباشرة—تُستخدم داخل الدوال async بالأسفل)
  async function getLogoDataUrlIfAny(){
    if (config && config.logoPath){
      try{
        // الدالة fetchLogoAsDataURL مُعرّفة مسبقًا في ملفك بالأعلى
        return await fetchLogoAsDataURL(config.logoPath);
      }catch{ return null; }
    }
    return null;
  }

  // —— تصدير Excel مباشرة عبر الخادم ——
  async function exportExcelDirect() {
    if (!requests.length) {
      alert('لا توجد طلبات في النظام لتوليد التقرير.');
      return;
    }

    const latest = requests[requests.length - 1];
    const logoDataUrl = await getLogoDataUrlIfAny();

    const payload = {
      request_id:       latest.number || String(latest.id).padStart(6,'0'),  // C8
      maintenance_type: latest.problemType || '',                             // F8
      location:         latest.building || '',                                // I8
      priority:         latest.maintenanceType || '',                         // D9
      requester_name:   latest.clientName || '',                              // D11
      request_time:     latest.time || '',                                    // D13
      request_date:     latest.gregorianDate || '',                           // H13
      fault_type:       latest.problemType || '',                             // C15
      fault_desc:       latest.problemDescription || '',                      // A19
      technician_name:  latest?.technicianReport?.techName || '',             // C25
      execution_date:   latest?.technicianReport?.gregorianDate || '',        // H26
      supervisor_name:  latest?.supervisorReview?.reviewerName || '',         // C29
      status:           latest.status || '',                                  // C30
      status_date:      latest?.supervisorReview?.gregorianDate || '',        // H31
      requester_name_2: latest.clientName || '',                              // C34
      is_fixed:         latest?.clientEvaluation?.satisfaction === 'نعم' ? 'نعم'
                       : latest?.clientEvaluation?.satisfaction === 'لا'  ? 'لا' : '', // C35
      fixed_date:       latest?.clientEvaluation?.gregorianDate || '',        // H36
      logo_data_url:    logoDataUrl || null
    };

    try {
      // لو عندك config.apiBase استخدمه، وإلا العنوان الثابت
      const apiBase = (config && config.apiBase) ? config.apiBase.replace(/\/+$/,'') : 'https://maintenance-app-olxq.onrender.com';
      const res = await fetch(`${apiBase}/api/export-excel`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const err = await res.json().catch(()=>({error:'unknown'}));
        alert('تعذر إنشاء التقرير عبر الخادم: ' + (err.error || res.status));
        return;
      }

      const blob = await res.blob();
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href = url;
      a.download = `تقرير_${payload.request_id}.xlsx`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    } catch(e) {
      alert('خطأ عند الاتصال بالخادم: ' + e.message);
    }
  }
  window.exportExcelDirect = exportExcelDirect; // للتشغيل من الأزرار

  // —— حفظ الطلب في Google Sheets ——
  async function saveRequestToSheet(request) {
    try {
      const resp = await fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          secret: APPS_SCRIPT_SECRET,   // يطابق سكربت Apps Script
          spreadsheetId: sheets_id,     // Sheet ID من شاشة الربط/الـlocalStorage
          sheetName: "طلبات الصيانة",
          request
        })
      });

      const data = await resp.json().catch(()=>({}));
      if (!resp.ok || !data.ok) {
        throw new Error(data.error || `HTTP ${resp.status}`);
      }
      console.log("✅ تم حفظ الطلب في Google Sheet:", data);
    } catch (err) {
      console.error("❌ فشل حفظ الطلب في الشيت:", err);
    }
  }
  window.saveRequestToSheet = saveRequestToSheet; // تُستدعى عند إرسال الطلب
</script>

</body>
</html>
