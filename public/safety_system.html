<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø© - Ø§Ù„Ù…Ù†Ø´Ø£Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ©</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
  background: linear-gradient(135deg, #006341 0%, #00875A 50%, #C8A55C 100%);
  min-height: 100vh;
  direction: rtl;
}

/* Loading & Sync Indicator */
.loading-screen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #006341 0%, #00875A 50%, #C8A55C 100%);
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  z-index: 9999;
  color: white;
}

.spinner {
  width: 50px;
  height: 50px;
  border: 4px solid rgba(255, 255, 255, 0.3);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.sync-indicator {
  position: fixed;
  top: 20px;
  left: 20px;
  background: rgba(255, 255, 255, 0.98);
  padding: 8px 16px;
  border-radius: 25px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  display: flex;
  align-items: center;
  gap: 8px;
  z-index: 1000;
  font-size: 0.85rem;
  opacity: 0;
  transform: translateY(-10px);
  transition: all 0.3s ease;
  pointer-events: none;
  border: 1px solid #e0e0e0;
}

.sync-indicator.show {
  opacity: 1;
  transform: translateY(0);
  pointer-events: auto;
}

.sync-indicator.syncing {
  border-color: #006341; color: #006341;
}

.sync-indicator.success {
  border-color: #27ae60;
  color: #27ae60;
}

.sync-indicator.error {
  border-color: #e74c3c;
  color: #e74c3c;
}

.sync-status-icon {
  width: 18px;
  height: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.sync-time {
  font-size: 0.75rem;
  opacity: 0.7;
  margin-right: 5px;
}

.sync-spinner {
  width: 16px;
  height: 16px;
  border: 2px solid rgba(0, 99, 65, 0.3); 
  border-top-color: #006341;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

/* Login Screen */
.login-screen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #006341 0%, #00875A 50%, #C8A55C 100%);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  padding: 20px;
}

.login-box {
  background: white;
  padding: 40px;
  border-radius: 20px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  max-width: 450px;
  width: 100%;
  text-align: center;
}

.login-box h1 {
  color: #006341;
  margin-bottom: 10px;
  font-size: 2rem;
}

.login-box .subtitle {
  color: #666;
  margin-bottom: 30px;
  font-size: 0.95rem;
}

.logo-icon {
  font-size: 4rem;
  margin-bottom: 20px;
}

.input-group {
  margin-bottom: 20px;
  text-align: right;
}

.input-group label {
  display: block;
  margin-bottom: 8px;
  color: #333;
  font-weight: 500;
}

.input-group input,
.input-group select {
  width: 100%;
  padding: 12px 15px;
  border: 2px solid #e0e0e0;
  border-radius: 10px;
  font-size: 1rem;
  transition: all 0.3s;
}

.input-group input:focus,
.input-group select:focus {
  outline: none;
  border-color: #006341; box-shadow: 0 0 0 3px rgba(0, 99, 65, 0.1);
}

.btn {
  width: 100%;
  padding: 14px;
  background: linear-gradient(135deg, #006341 0%, #C8A55C 100%);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
  margin-top: 10px;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(0, 99, 65, 0.4);
}

.btn:active {
  transform: translateY(0);
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.sheets-config {
  margin-top: 25px;
  padding-top: 20px;
  border-top: 2px solid #eee;
  text-align: right;
}

.sheets-config h4 {
  color: #006341;
  margin-bottom: 15px;
  font-size: 1rem;
}

.sheets-config small {
  display: block;
  color: #888;
  margin-top: 8px;
  line-height: 1.5;
}

/* User Info Bar */
.user-info-bar {
  background: linear-gradient(135deg, #006341 0%, #C8A55C 100%);
  color: white;
  padding: 15px 30px;
  display: none;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.user-info {
  display: flex;
  align-items: center;
  gap: 20px;
}

.user-avatar {
  width: 45px;
  height: 45px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.3rem;
}

.btn-logout {
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.3);
  padding: 8px 20px;
  border-radius: 20px;
  cursor: pointer;
  transition: all 0.3s;
  font-weight: 500;
}

.btn-logout:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: translateY(-2px);
}

/* Container */
.container {
  max-width: 1400px;
  margin: 20px auto;
  background: white;
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  display: none;
}

.header {
  background: linear-gradient(135deg, #006341 0%, #C8A55C 100%);
  color: white;
  padding: 30px;
  text-align: center;
}

.header h1 {
  font-size: 2.2rem;
  margin-bottom: 10px;
}

.header p {
  opacity: 0.9;
  font-size: 1.05rem;
}

/* Navigation Tabs */
.nav-tabs {
  display: flex;
  background: #f8f9fa;
  border-bottom: 2px solid #e0e0e0;
  overflow-x: auto;
}

.nav-tab {
  flex: 1;
  padding: 18px 20px;
  background: transparent;
  border: none;
  cursor: pointer;
  font-size: 1rem;
  font-weight: 500;
  color: #666;
  transition: all 0.3s;
  white-space: nowrap;
  position: relative;
}

.nav-tab:hover {
  background: rgba(0, 99, 65, 0.1);
  color: #006341;
}

.nav-tab.active {
  color: #006341;
  background: white;
}

.nav-tab.active::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(135deg, #006341 0%, #C8A55C 100%);
}

/* Content */
.tab-content {
  display: none;
  padding: 30px;
  animation: fadeIn 0.3s;
}

.tab-content.active {
  display: block;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Form Styling */
.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
  margin-bottom: 25px;
}

.form-group {
  text-align: right;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  color: #333;
  font-weight: 500;
  font-size: 0.95rem;
}

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 12px 15px;
  border: 2px solid #e0e0e0;
  border-radius: 10px;
  font-size: 1rem;
  transition: all 0.3s;
  font-family: inherit;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: #006341;
  box-shadow: 0 0 0 3px rgba(0, 99, 65, 0.1);
}

.form-group input:disabled {
  background: #f5f5f5;
  cursor: not-allowed;
}

.form-group textarea {
  min-height: 100px;
  resize: vertical;
}

/* Image Upload */
.image-upload-container {
  border: 2px dashed #e0e0e0;
  border-radius: 10px;
  padding: 20px;
  text-align: center;
  transition: all 0.3s;
  cursor: pointer;
}

.image-upload-container:hover {
  border-color: #006341;
  background: rgba(0, 99, 65, 0.05);
}

.image-upload-container.has-image {
  border-style: solid;
  border-color: #27ae60;
}

.upload-icon {
  font-size: 3rem;
  margin-bottom: 10px;
  color: #006341;
}

.upload-text {
  color: #666;
  font-size: 0.95rem;
}

.image-preview {
  max-width: 100%;
  max-height: 300px;
  border-radius: 10px;
  margin-top: 15px;
  display: none;
}

.image-preview.show {
  display: block;
}

.remove-image-btn {
  margin-top: 10px;
  padding: 8px 16px;
  background: #e74c3c;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.9rem;
  display: none;
}

.remove-image-btn.show {
  display: inline-block;
}

.remove-image-btn:hover {
  background: #c0392b;
}

/* Buttons */
.btn-primary {
  padding: 12px 30px;
  background: linear-gradient(135deg, #006341 0%, #C8A55C 100%);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  margin-left: 10px;
}

.btn-primary:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(0, 99, 65, 0.4);
}

.btn-primary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}


.btn-home{
  background: rgba(255,255,255,0.2);
  color: white;
  border: 1px solid rgba(255,255,255,0.3);
  padding: 8px 20px;
  border-radius: 20px;
  cursor: pointer;
  transition: all 0.3s;
  font-weight: 500;
  text-decoration: none;
  display: inline-block;
  margin-top: 10px;
}
.btn-home:hover{ transform: translateY(-2px); }



.btn-secondary {
  padding: 12px 30px;
  background: white;
  color: #006341;
  border: 2px solid #006341;
  border-radius: 10px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  margin-left: 10px;
}

.btn-secondary:hover {
  background: #006341;
  color: white;
  transform: translateY(-2px);
}

.btn-success {
  background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}

.btn-danger {
  background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
}

/* Stats Cards */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  background: linear-gradient(135deg, #006341 0%, #C8A55C 100%);
  color: white;
  padding: 25px;
  border-radius: 15px;
  box-shadow: 0 8px 20px rgba(0, 99, 65, 0.3);
  transition: transform 0.3s;
}

.stat-card:hover {
  transform: translateY(-5px);
}

.stat-card h3 {
  font-size: 2.5rem;
  margin-bottom: 10px;
}

.stat-card p {
  font-size: 1.1rem;
  opacity: 0.9;
}

/* Table */
.table-container {
  overflow-x: auto;
  border-radius: 10px;
  border: 1px solid #e0e0e0;
}

table {
  width: 100%;
  border-collapse: collapse;
  background: white;
}

thead {
  background: linear-gradient(135deg, #006341 0%, #C8A55C 100%);
  color: white;
}
th {
  padding: 15px;
  text-align: right;
  font-weight: 600;
  font-size: 0.95rem;
}

td {
  padding: 15px;
  text-align: right;
  border-bottom: 1px solid #f0f0f0;
}

tbody tr:hover {
  background: #f8f9ff;
}

.status-badge {
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 600;
  display: inline-block;
}

.status-pending {
  background: #fff3cd;
  color: #856404;
}

.status-progress {
  background: #cfe2ff;
  color: #084298;
}

.status-completed {
  background: #d1e7dd;
  color: #0a3622;
}

.status-rejected {
  background: #f8d7da;
  color: #721c24;
}

.status-safety {
  background: #fff3cd;
  color: #856404;
  border: 2px solid #ffc107;
}

.timeline-step.safety .timeline-icon {
  background: linear-gradient(135deg, #ffc107, #ff9800);
  color: white;
  box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
}

/* Action Buttons */
.action-buttons {
  display: flex;
  gap: 8px;
  justify-content: center;
  flex-wrap: wrap;
}

.action-btn {
  padding: 6px 12px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.85rem;
  font-weight: 500;
  transition: all 0.2s;
}

.action-btn:hover {
  transform: scale(1.05);
}

.btn-view {
  background: #006341;
  color: white;
}

.btn-edit {
  background: #38ef7d;
  color: white;
}

.btn-delete {
  background: #f45c43;
  color: white;
}

.btn-pdf {
  background: #e74c3c;
  color: white;
}

.btn-excel {
  background: #27ae60;
  color: white;
}

.btn-image {
  background: #3498db;
  color: white;
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 2000;
  justify-content: center;
  align-items: center;
  padding: 20px;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: white;
  padding: 30px;
  border-radius: 20px;
  max-width: 800px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: modalSlideIn 0.3s;
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: scale(0.9);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 2px solid #e0e0e0;
}

.modal-header h2 {
  color: #006341;
  font-size: 1.8rem;
}

.close-modal {
  background: none;
  border: none;
  font-size: 2rem;
  cursor: pointer;
  color: #999;
  transition: color 0.2s;
}

.close-modal:hover {
  color: #333;
}

/* Alert Messages */
.alert {
  padding: 15px 20px;
  border-radius: 10px;
  margin-bottom: 20px;
  font-weight: 500;
  display: none;
  animation: slideDown 0.3s;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(100px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes slideOut {
  from {
    opacity: 1;
    transform: translateX(0);
  }
  to {
    opacity: 0;
    transform: translateX(100px);
  }
}

.alert-success {
  background: #d1e7dd;
  color: #0a3622;
  border: 1px solid #a3cfbb;
}

.alert-error {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f1aeb5;
}

.alert-info {
  background: #cfe2ff;
  color: #084298;
  border: 1px solid #9ec5fe;
}

/* Image Modal */
.image-modal-content {
  max-width: 90vw;
  max-height: 90vh;
}

.image-modal-content img {
  width: 100%;
  height: auto;
  border-radius: 10px;
}

/* ====== Details Cards (Basic Info) ====== */
.details-grid{
  display:grid;
  grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
  gap:14px;
  margin:10px 0 20px;
}
.detail-card{
  background:#fff;
  border:1px solid #eee;
  border-radius:12px;
  padding:14px;
  box-shadow:0 6px 16px rgba(0,0,0,0.06);
  display:flex; align-items:flex-start; gap:10px;
}
.detail-card .dc-ico{
  width:38px;height:38px; border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  background:linear-gradient(135deg,#00634122,#C8A55C22);
  font-size:1.15rem;
}
.detail-card .dc-body{flex:1}
.detail-card .dc-label{
  font-size:.8rem; color:#006341; font-weight:700; margin-bottom:4px;
}
.detail-card .dc-value{
  font-size:.98rem; color:#333; font-weight:600; line-height:1.4;
  word-break: break-word;
}
.detail-card.emph{
  border-color:#00634133; background:linear-gradient(180deg,#f0f8f5,#ffffff);
}
.detail-row-2{ grid-column: 1 / -1; } /* ÙŠÙ…ØªØ¯ Ø¨Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø¨ÙƒØ© */
.detail-status .dc-value .status-badge{
  font-size:.8rem; padding:5px 10px;
}

/* Ø¨Ø·Ø§Ù‚Ø© ØµÙˆØ±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ */
.detail-image{
  display:flex; flex-direction:column; align-items:flex-start;
}
.detail-image img{
  max-width:100%; max-height:280px; border-radius:10px; margin-top:8px; cursor:pointer;
  border:1px solid #eee;
}


/* Responsive */
@media (max-width: 768px) {
  .header h1 {
    font-size: 1.6rem;
  }

  .form-grid {
    grid-template-columns: 1fr;
  }

  .stats-grid {
    grid-template-columns: 1fr;
  }

  .nav-tabs {
    flex-wrap: nowrap;
    overflow-x: auto;
  }

  .modal-content {
    padding: 20px;
  }

  .action-buttons {
    flex-direction: column;
  }

  table {
    font-size: 0.85rem;
  }

  th, td {
    padding: 10px 8px;
  }
}

/* Scrollbar */
::-webkit-scrollbar {
  width: 10px;
  height: 10px;
}

::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 5px;
}

::-webkit-scrollbar-thumb {
  background: linear-gradient(135deg, #006341 0%, #C8A55C 100%);
  border-radius: 5px;
}

::-webkit-scrollbar-thumb:hover {
  background: #005030;
}

.hidden {
  display: none !important;
}


/* Timeline Styles */
.request-timeline {
  margin: 25px 0;
  padding: 20px;
  background: #f8f9fa;
  border-radius: 10px;
  direction: rtl;
}

.timeline-header {
  color: #006341;
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 20px;
  text-align: right;
}

.timeline-container {
  display: flex;
  align-items: flex-start;
  position: relative;
  padding: 10px 0;
}

.timeline-step {
  flex: 1;
  text-align: center;
  position: relative;
  z-index: 1;
}

.timeline-icon {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  margin: 0 auto 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  background: #e0e0e0;
  color: #999;
  border: 3px solid #f8f9fa;
  transition: all 0.3s;
  position: relative;
}

.timeline-step.completed .timeline-icon {
  background: linear-gradient(135deg, #27ae60, #2ecc71);
  color: white;
  box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
}

.timeline-step.active .timeline-icon {
  background: linear-gradient(135deg, #006341, #C8A55C);
  color: white;
  box-shadow: 0 4px 12px rgba(0, 99, 65, 0.4);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

.timeline-step.rejected .timeline-icon {
  background: #e74c3c;
  color: white;
}

.timeline-label {
  font-size: 0.85rem;
  font-weight: 600;
  color: #666;
  margin-bottom: 5px;
}

.timeline-step.completed .timeline-label,
.timeline-step.active .timeline-label {
  color: #333;
}

.timeline-info {
  font-size: 0.75rem;
  color: #999;
  margin-top: 5px;
}

.timeline-step.completed .timeline-info,
.timeline-step.active .timeline-info {
  color: #006341;
}

/* Ø§Ù„Ø®Ø· Ø§Ù„ÙˆØ§ØµÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª */
.timeline-line {
  position: absolute;
  top: 25px;
  right: 0;
  left: 0;
  height: 3px;
  background: #e0e0e0;
  z-index: 0;
}

.timeline-line-progress {
  position: absolute;
  top: 0;
  right: 0;
  height: 100%;
  background: linear-gradient(90deg, #27ae60, #006341);
  transition: width 0.5s ease;
}

/* Progress Percentage */
.timeline-progress {
  text-align: center;
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px solid #e0e0e0;
}

.progress-text {
  font-size: 0.9rem;
  color: #006341;
  font-weight: 600;
}

.progress-bar-container {
  width: 100%;
  height: 8px;
  background: #e0e0e0;
  border-radius: 10px;
  margin-top: 8px;
  overflow: hidden;
}

.progress-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, #006341, #C8A55C);
  border-radius: 10px;
  transition: width 0.5s ease;
}

/* Responsive */
@media (max-width: 768px) {
  .timeline-container {
    flex-direction: column;
    gap: 20px;
  }
  
  .timeline-step {
    display: flex;
    align-items: center;
    gap: 15px;
    text-align: right;
  }
  
  .timeline-icon {
    margin: 0;
    width: 45px;
    height: 45px;
    font-size: 1.3rem;
  }
  
  .timeline-line {
    display: none;
  }
}

.status-deleted {
  background: #eee;
  color: #555;
  border: 1px dashed #bbb;
}

.login-box .btn-home{
  background:#006341;
  color:#fff !important;
  border:none;
  display:block;
  text-align:center;
  margin-top:15px;
}


/* Ø²Ø± Ø§Ø­ØªØ±Ø§ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
.login-actions{
  position: fixed;
  top: 20px;
  left: 20px; /* Ù„Ø£Ø¬Ù„ RTLØŒ Ø§Ù„Ø²Ø± Ø¨ÙŠÙƒÙˆÙ† ÙŠØ³Ø§Ø± Ø£Ø¹Ù„Ù‰ */
  z-index: 1100;
  display: flex;
  gap: 10px;
}
.btn-home-pro{
  background: #ffffff;
  color: #006341;
  border: 2px solid rgba(0,99,65,0.25);
  padding: 10px 18px;
  border-radius: 999px;
  font-weight: 700;
  text-decoration: none;
  box-shadow: 0 8px 24px rgba(0,0,0,0.12);
  transition: transform .2s, box-shadow .2s, background .2s;
}
.btn-home-pro:hover{
  transform: translateY(-2px);
  box-shadow: 0 12px 30px rgba(0,0,0,0.18);
  background: #f9f9ff;
}
.btn-home-pro:active{ transform: translateY(0); }

/* Mini timeline (Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„) */
.mini-flow{display:flex;align-items:center;gap:6px}
.mini-dot{width:8px;height:8px;border-radius:50%}
.mini-dot.pending{background:#ffc107}
.mini-dot.progress{background:#0d6efd}
.mini-dot.completed{background:#28a745}
.mini-dot.rejected{background:#dc3545}
.mini-flow .mini-text{font-size:.78rem;color:#555;font-weight:600}

.action-btn:disabled{
  opacity:.6;
  cursor:not-allowed;
  transform:none;
}


</style>
</head>
<body>

<!-- Loading Screen -->
<div class="loading-screen" id="loadingScreen">
  <div class="spinner"></div>
  <p style="margin-top: 20px; font-size: 1.2rem;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…...</p>
</div>

<!-- Sync Indicator - Ù…Ø­Ø³Ù‘Ù† -->
<div class="sync-indicator" id="syncIndicator">
  <span class="sync-status-icon" id="syncIcon">âŸ³</span>
  <span id="syncText">Ù…ØªØµÙ„</span>
  <span class="sync-time" id="syncTime"></span>
</div>

<!-- Login Screen -->
<div class="login-screen" id="loginScreen">
  <!-- Ø£Ø²Ø±Ø§Ø± Ø£Ø¹Ù„Ù‰ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div class="login-actions">
    <a href="index.html" class="btn-home-pro">â† Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
  </div>

  <div class="login-box">

    <div class="logo-icon">ğŸ›¡ï¸</div>
    <h1>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø©</h1>
    <p class="subtitle">Ø§Ù„Ù…Ø¤Ø³Ø³Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„ØªÙ‚Ù†ÙŠ ÙˆØ§Ù„Ù…Ù‡Ù†ÙŠ - TVTC</p>
    
    <form id="loginForm" onsubmit="login(event)">
      <div class="input-group">
        <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label>
        <input type="text" id="employeeId" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ" required>
      </div>
      
      <div class="input-group">
        <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <input type="password" id="password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
      </div>
      
      <button type="submit" class="btn" id="loginBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </form>

<div class="sheets-config" id="sheetsConfigSection">

      <h4>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Google Sheets</h4>
      <div class="input-group">
        <label>Ø±Ø§Ø¨Ø· Google Apps Script</label>
        <input type="url" id="appsScriptUrl" 
               placeholder="https://script.google.com/macros/s/..."
               value="">
      </div>
      <small>
        ğŸ“ Ø§ØªØ¨Ø¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª ÙÙŠ Ù…Ù„Ù SETUP.md Ù„Ø¥Ù†Ø´Ø§Ø¡ Google Sheets ÙˆØ§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø·
      </small>
    </div>
  </div>
</div>

<!-- User Info Bar -->
<div class="user-info-bar" id="userBar">
  <div class="user-info">
    <div class="user-avatar">ğŸ‘¤</div>
    <div>
      <div id="userName" style="font-weight: 600; font-size: 1.1rem;"></div>
      <div id="userRole" style="opacity: 0.9; font-size: 0.9rem;"></div>
    </div>
  </div>
  
  <a href="index.html" class="btn-home">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
  <button class="btn-logout" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</div>

<!-- Main Container -->
<div class="container" id="mainContainer">
  <div class="header">
    <h1>ğŸ›¡ï¸ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø© - TVTC</h1>
    <p>Ø¥Ø¯Ø§Ø±Ø© Ø´Ø§Ù…Ù„Ø© Ù„Ø¨Ù„Ø§ØºØ§Øª ÙˆÙ…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø© ÙÙŠ Ø§Ù„Ù…Ù†Ø´Ø£Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ©</p>
  </div>

  <!-- Navigation -->
<div class="nav-tabs">
  <button class="nav-tab active" onclick="showTab('new-request')">ğŸ“ Ø¨Ù„Ø§Øº Ø³Ù„Ø§Ù…Ø© Ø¬Ø¯ÙŠØ¯</button>
  <button class="nav-tab" onclick="showTab('safety-review-1')">ğŸ¦º Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø© (Ø£ÙˆÙ„ÙŠØ©)</button>
  <button class="nav-tab" onclick="showTab('supervisor-review')">âœ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø´Ø±Ù (ØªØ¹ÙŠÙŠÙ† ÙÙ†ÙŠ/Ù‚Ø±Ø§Ø±)</button>
  <button class="nav-tab" onclick="showTab('technician-report')">ğŸ”§ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙÙ†ÙŠ</button>
  <button class="nav-tab" onclick="showTab('safety-review-2')">ğŸ¦º Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø© (Ù†Ù‡Ø§Ø¦ÙŠØ©)</button>
  <button class="nav-tab" onclick="showTab('client-feedback')">â­ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
  <button class="nav-tab" onclick="showTab('my-requests')">ğŸ“ Ø·Ù„Ø¨Ø§ØªÙŠ</button>
  <button class="nav-tab" onclick="showTab('quality-report')">ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¬ÙˆØ¯Ø©</button>
</div>


  <!-- Tab: New Request -->
  <div class="tab-content active" id="new-request">
    <h2 style="color: #006341; margin-bottom: 25px;">ğŸ“ Ù†Ù…ÙˆØ°Ø¬ Ø¨Ù„Ø§Øº Ø³Ù„Ø§Ù…Ø© Ø¬Ø¯ÙŠØ¯</h2>
    
    <div class="alert alert-success" id="newRequestAlert"></div>
    
    <form id="newRequestForm" onsubmit="submitNewRequest(event)">
      <div class="form-grid">
        <div class="form-group">
          <label>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</label>
          <input type="text" id="requestId" disabled>
        </div>
        
        <div class="form-group">
          <label>Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨</label>
          <select id="requestType" required>
            <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨</option>
            <option value="Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</option>
            <option value="Ù‡Ø§ØªÙ">Ù‡Ø§ØªÙ</option>
            <option value="Ø§ÙŠÙ…ÙŠÙ„">Ø§ÙŠÙ…ÙŠÙ„</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Ø§Ù„Ù…Ø¨Ù†Ù‰</label>
          <input type="text" id="building" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¨Ù†Ù‰ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© - Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø£ÙˆÙ„" required>
        </div>
        
        <div class="form-group">
          <label>ØªØµÙ†ÙŠÙ Ø§Ù„Ø¨Ù„Ø§Øº</label>
          <select id="maintenanceType" required>
            <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØµÙŠØ§Ù†Ø©</option>
            <option value="Ø·Ø§Ø±Ø¦ - Ø®Ø·Ø± Ø¹Ø§Ù„ÙŠ">Ø·Ø§Ø±Ø¦ - Ø®Ø·Ø± Ø¹Ø§Ù„ÙŠ</option>
            <option value="ØµÙŠØ§Ù†Ø© ÙˆÙ‚Ø§Ø¦ÙŠØ©">ØµÙŠØ§Ù†Ø© ÙˆÙ‚Ø§Ø¦ÙŠØ©</option>
            <option value="ØµÙŠØ§Ù†Ø© Ø¯ÙˆØ±ÙŠØ©">ØµÙŠØ§Ù†Ø© Ø¯ÙˆØ±ÙŠØ©</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Ø§Ø³Ù… ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨</label>
          <input type="text" id="requesterName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required>
        </div>
        
        <div class="form-group">
          <label>Ø§Ù„ÙˆÙ‚Øª</label>
          <input type="text" id="requestTime" disabled>
        </div>
        
        <div class="form-group">
          <label>Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ</label>
          <input type="text" id="requestDate" disabled>
        </div>
        
        <div class="form-group">
          <label>Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ</label>
          <input type="text" id="hijriDate" disabled>
        </div>
        
        <div class="form-group">
          <label>Ø§Ù„ÙŠÙˆÙ…</label>
          <input type="text" id="requestDay" disabled>
        </div>
        
        <div class="form-group">
          <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©/Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø©</label>
          <select id="faultType" onchange="toggleOtherFault()" required>
            <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„</option>
            <option value="Ø­Ø±ÙŠÙ‚ ÙˆØ¥Ù†Ø°Ø§Ø±">Ø­Ø±ÙŠÙ‚ ÙˆØ¥Ù†Ø°Ø§Ø±</option>
            <option value="ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ">ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ</option>
            <option value="Ø¥Ù†Ø´Ø§Ø¦ÙŠ">Ø¥Ù†Ø´Ø§Ø¦ÙŠ</option>
            <option value="Ù…Ø®Ø§Ø±Ø¬ Ø·ÙˆØ§Ø±Ø¦">Ù…Ø®Ø§Ø±Ø¬ Ø·ÙˆØ§Ø±Ø¦</option>
            <option value="Ù…Ø¹Ø¯Ø§Øª Ø­Ù…Ø§ÙŠØ©">Ù…Ø¹Ø¯Ø§Øª Ø­Ù…Ø§ÙŠØ© Ø´Ø®ØµÙŠØ©</option>
            <option value="Ù…ÙˆØ§Ø¯ Ø®Ø·Ø±Ø©">Ù…ÙˆØ§Ø¯ Ø®Ø·Ø±Ø©</option>
            <option value="Ø³Ù„ÙˆÙƒÙŠØ§Øª Ø®Ø·Ø±Ø©">Ø³Ù„ÙˆÙƒÙŠØ§Øª Ø®Ø·Ø±Ø©</option>
            <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
          </select>
        </div>
        
        <div class="form-group hidden" id="otherFaultDiv">
          <label>Ø­Ø¯Ø¯ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„</label>
          <input type="text" id="otherFault" placeholder="Ø§ÙƒØªØ¨ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„">
        </div>
      </div>
      
      <div class="form-group">
        <label>ÙˆØµÙ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø£Ùˆ Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø©</label>
        <textarea id="faultDescription" placeholder="Ø§ÙƒØªØ¨ ÙˆØµÙØ§Ù‹ ØªÙØµÙŠÙ„ÙŠØ§Ù‹ Ù„Ù„Ø¹Ø·Ù„..." required></textarea>
      </div>
      
      <div class="form-group">
        <label>ğŸ“· ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© (Ø¥Ù„Ø²Ø§Ù…ÙŠ)</label>
        <div class="image-upload-container" id="uploadContainer" onclick="document.getElementById('imageUpload').click()">
          <div class="upload-icon">ğŸ“¸</div>
          <div class="upload-text">Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø·Ù„</div>
          <div class="upload-text" style="font-size: 0.85rem; color: #999; margin-top: 5px;">
            (JPG, PNG, GIF - Ø­Ø¯ Ø£Ù‚ØµÙ‰ 2MB)
          </div>
          <img id="imagePreview" class="image-preview" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©">
          <input type="file" id="imageUpload" accept="image/*" style="display: none;" onchange="handleImageUpload(event)" required>
          <button type="button" class="remove-image-btn" id="removeImageBtn" onclick="event.stopPropagation(); removeImage()">
            âŒ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø©
          </button>
        </div>
      </div>
      
      <button type="submit" class="btn-primary" id="submitRequestBtn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
      <button type="reset" class="btn-secondary" onclick="resetForm()">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
    </form>
  </div>


<!-- Tab: Safety Review 1 -->
<div class="tab-content" id="safety-review-1">
  <h2 style="color: #ffc107; margin-bottom: 25px;">ğŸ¦º Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø© (Ø£ÙˆÙ„ÙŠØ©)</h2>
  <div class="alert alert-success" id="safetyAlert1"></div>
  <div class="table-container" style="margin-bottom: 30px;">
    <table>
      <thead>
        <tr>
          <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
          <th>ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨</th>
          <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„</th>
          <th>Ø§Ù„Ù…Ø¨Ù†Ù‰</th>
          <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          <th>ØµÙˆØ±Ø©</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr>
      </thead>
      <tbody id="safetyReviewTable1"></tbody>
    </table>
  </div>
</div>

<!-- Tab: Supervisor Review -->
<div class="tab-content" id="supervisor-review">
  <h2 style="color: #006341; margin-bottom: 25px;">âœ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø´Ø±Ù</h2>
  <div class="alert alert-success" id="supervisorAlert"></div>
  <div class="table-container" style="margin-bottom: 30px;">
    <table>
      <thead>
        <tr>
          <th>Ø§Ù„Ù…Ø³Ø§Ø±</th>
          <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
          <th>ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨</th>
          <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„</th>
          <th>Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ</th>
          <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          <th>ØµÙˆØ±Ø©</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr>
      </thead>
      <tbody id="technicianReportsTable"></tbody>
    </table>
  </div>
</div>

<!-- Tab: Technician Report -->
<div class="tab-content" id="technician-report">
  <h2 style="color: #006341; margin-bottom: 25px;">ğŸ”§ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙÙ†ÙŠ</h2>
  <div class="alert alert-success" id="technicianAlert"></div>
  <div class="table-container" style="margin-bottom: 30px;">
    <table>
      <thead>
        <tr>
          <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
          <th>ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨</th>
          <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„</th>
          <th>Ø§Ù„Ù…Ø¨Ù†Ù‰</th>
          <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          <th>ØµÙˆØ±Ø©</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th>Ø§Ù„Ù…Ø³Ø§Ø±</th>
          <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr>
      </thead>
      <tbody id="pendingRequestsTable"></tbody>
    </table>
  </div>
</div>

<!-- Tab: Safety Review 2 -->
<div class="tab-content" id="safety-review-2">
  <h2 style="color: #ffc107; margin-bottom: 25px;">ğŸ¦º Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø© (Ù†Ù‡Ø§Ø¦ÙŠØ©)</h2>
  <div class="alert alert-success" id="safetyAlert2"></div>
  <div class="table-container" style="margin-bottom: 30px;">
    <table>
      <thead>
        <tr>
          <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
          <th>ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨</th>
          <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„</th>
          <th>Ø§Ù„ÙÙ†ÙŠ</th>
          <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          <th>ØµÙˆØ±Ø©</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr>
      </thead>
      <tbody id="safetyReviewTable2"></tbody>
    </table>
  </div>
</div>

  <!-- Tab: Client Feedback -->
  <div class="tab-content" id="client-feedback">
    <h2 style="color: #006341; margin-bottom: 25px;">â­ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
    
    <div class="alert alert-success" id="clientAlert"></div>
    
    <div class="table-container" style="margin-bottom: 30px;">
      <table>
       <thead>
            <tr>
              <th>Ø§Ù„Ù…Ø³Ø§Ø±</th>
              <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
              <th>ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨</th>
              <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„</th>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>ØµÙˆØ±Ø©</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
        <tbody id="approvedRequestsTable"></tbody>
      </table>
    </div>
  </div>

  <!-- Tab: Quality Report -->
  <div class="tab-content" id="quality-report">
    <h2 style="color: #006341; margin-bottom: 25px;">ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¬ÙˆØ¯Ø© ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
    
    <div class="stats-grid">
      <div class="stat-card">
        <h3 id="totalRequests">0</h3>
        <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p>
      </div>
      <div class="stat-card">
        <p>Ø¨Ù„Ø§ØºØ§Øª Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</p>
      </div>
      <div class="stat-card">
        <p>Ø¨Ù„Ø§ØºØ§Øª ØªÙ…Øª Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡Ø§</p>
      </div>
      <div class="stat-card">
        <h3 id="rejectedRequests">0</h3>
        <p>Ø·Ù„Ø¨Ø§Øª Ù…Ø±ÙÙˆØ¶Ø©</p>
      </div>
    </div>
    
    <div style="margin-bottom: 20px;">
      <button class="btn-primary btn-excel" onclick="exportToExcel()">ğŸ“Š ØªØµØ¯ÙŠØ± Excel</button>
      <button class="btn-primary btn-success" onclick="exportAllWithTemplates()">ğŸ“‹ ØªØµØ¯ÙŠØ± Ø§Ù„ÙƒÙ„ Ø¨Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</button>
      <button class="btn-primary btn-pdf" onclick="exportToPDF()">ğŸ“„ ØªØµØ¯ÙŠØ± PDF</button>
      <button class="btn-secondary" onclick="printReport()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
    </div>
    
    <div class="table-container">
      <table>
          <thead>
            <tr>
              <th>Ø§Ù„Ù…Ø³Ø§Ø±</th>
              <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
              <th>ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨</th>
              <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„</th>
              <th>Ø§Ù„Ù…Ø¨Ù†Ù‰</th>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø§Ù„ÙÙ†ÙŠ</th>
              <th>Ø§Ù„Ù…Ø´Ø±Ù</th>
              <th>ØµÙˆØ±Ø©</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</th>
              <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
        <tbody id="allRequestsTable"></tbody>
      </table>
    </div>
  </div>
  <!-- Tab: My Requests -->
<div class="tab-content" id="my-requests">
  <h2 style="color: #006341; margin-bottom: 25px;">ğŸ“ Ø·Ù„Ø¨Ø§ØªÙŠ</h2>
  <div class="alert alert-info" id="myRequestsAlert" style="display:none"></div>

  <div class="table-container" style="margin-bottom: 30px;">
    <table>
      <thead>
        <tr>
          <th>Ø§Ù„Ù…Ø³Ø§Ø±</th>
          <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
          <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„</th>
          <th>Ø§Ù„Ù…Ø¨Ù†Ù‰</th>
          <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr>
      </thead>
      <tbody id="myRequestsTable"></tbody>
    </table>
  </div>
</div>
</div>

<!-- Modals will be added here by JavaScript -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
// Global Variables
let currentUser = null;
let requests = [];
let users = [];
let appsScriptUrl = '';
let techRepairImage = null;
let uploadedImage = null;
let techniciansLoaded = false;
let techniciansLoading = false;


function requestScope() {
  return {
    name: currentUser?.name || '',
    role: currentUser?.role || ''
  };
}


// ========================================
// ===== Ø¥Ø¶Ø§ÙØ§Øª Ø¬Ø¯ÙŠØ¯Ø© ØªØ¨Ø¯Ø£ Ù…Ù† Ù‡Ù†Ø§ =====
// ========================================

// ===== helper: map status â†’ badge class =====
function getStatusClass(s){
  s = (s||'').trim();
  if (['Ù…Ø­Ø°ÙˆÙ'].includes(s)) return 'deleted';
  if (['Ù…Ø±ÙÙˆØ¶','ØºÙŠØ± Ù…ÙƒØªÙ…Ù„','Ù…Ù„ØºÙŠ'].includes(s)) return 'rejected';
  if (['Ù…ÙƒØªÙ…Ù„'].includes(s)) return 'completed';
  if (['Ù…Ø­ÙˆÙ‘Ù„ Ù„Ù„ÙÙ†ÙŠ','Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©','ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©','Ù…Ø¹ØªÙ…Ø¯',
       'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³Ù„Ø§Ù…Ø© (Ù†Ù‡Ø§Ø¦ÙŠØ©)','Ù…Ø¹ØªÙ…Ø¯ Ù…Ù† Ø§Ù„Ø³Ù„Ø§Ù…Ø© (Ù†Ù‡Ø§Ø¦ÙŠØ©)'].includes(s)) return 'progress';
  if (['Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³Ù„Ø§Ù…Ø© (Ø£ÙˆÙ„ÙŠØ©)','Ù…Ø¹ØªÙ…Ø¯ Ù…Ù† Ø§Ù„Ø³Ù„Ø§Ù…Ø© (Ø£ÙˆÙ„ÙŠØ©)'].includes(s)) return 'safety'; // â† Ø¬Ø¯ÙŠØ¯
  return 'pending';
}


// 1ï¸âƒ£ Ù†Ø¸Ø§Ù… Queue Ø§Ù„Ø¨Ø³ÙŠØ·
const syncQueue = {
  queue: [],
  processing: false,

  load() {
    try {
      this.queue = JSON.parse(localStorage.getItem('syncQueue') || '[]');
    } catch {
      this.queue = [];
    }
  },

  save() {
    localStorage.setItem('syncQueue', JSON.stringify(this.queue));
  },

  add(operation) {
    this.queue.push({
      id: Date.now(),
      type: operation.type,
      data: operation.data,
      attempts: 0,
      timestamp: new Date().toISOString()
    });
    this.save();
    this.process();
  },


  // âœ… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
  async retryWithBackoff(operation, attempt = 0) {
    const maxAttempts = 3;
    const baseDelay = 2000;
    
    try {
      if (operation.type === 'add') {
        return await callAppsScript('addRequest', operation.data, false);
      } else if (operation.type === 'update') {
        return await callAppsScript('updateRequest', operation.data, false);
      } else if (operation.type === 'delete') {
        return await callAppsScript('softDeleteRequest', operation.data, false);
      }
    } catch (error) {
      if (attempt < maxAttempts) {
        const delay = baseDelay * Math.pow(2, attempt);
        console.log(`â³ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ${attempt + 1}/${maxAttempts} Ø¨Ø¹Ø¯ ${delay}ms`);
        await new Promise(resolve => setTimeout(resolve, delay));
        return this.retryWithBackoff(operation, attempt + 1);
      }
      throw error;
    }
  },

async process() {
    if (this.processing || this.queue.length === 0) return;
    
    this.processing = true;
    const totalItems = this.queue.length;
    
    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
    showSyncIndicator('syncing', `â³ Ù…Ø²Ø§Ù…Ù†Ø© ${totalItems} Ø¹Ù…Ù„ÙŠØ©...`, false);

    let successCount = 0;
    let failCount = 0;

    while (this.queue.length > 0) {
      const item = this.queue[0];
      
      try {
        await this.retryWithBackoff(item);
        
        this.queue.shift();
        successCount++;
        this.save();
        
        // Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„ Ù…ØªÙƒØ±Ø±Ø© Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙØ±Ø¯ÙŠØ©
        // ÙÙ‚Ø· Ù†Ø³Ø¬Ù„ ÙÙŠ Console
        const remaining = this.queue.length;
        if (remaining > 0) {
          console.log(`âœ“ ${successCount}/${totalItems} - Ù…ØªØ¨Ù‚ÙŠ ${remaining}`);
        }
        
      } catch (error) {
        console.error('ÙØ´Ù„Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ø¹Ø¯ ÙƒÙ„ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª:', error);
        item.attempts = (item.attempts || 0) + 1;
        
        if (item.attempts >= 3) {
          console.error('âŒ Ø¹Ù…Ù„ÙŠØ© ÙØ´Ù„Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹:', item);
          this.queue.shift();
          failCount++;
          // Ù†Ø³Ø¬Ù„ Ø§Ù„ÙØ´Ù„ Ù„ÙƒÙ† Ø¨Ø¯ÙˆÙ† Ø±Ø³Ø§Ù„Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ©
          console.warn(`âš ï¸ ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ©: ${item.type} (ID: ${item.data?.id || 'N/A'})`);
        } else {
          break;
        }
        this.save();
      }
    }

    this.processing = false;
    
    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù†Ù‡Ø§Ø¦ÙŠØ© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
    if (this.queue.length === 0) {
      if (failCount > 0) {
        showSyncIndicator('error', `âœ“ ${successCount} Ù†Ø¬Ø­Øª â€¢ âœ— ${failCount} ÙØ´Ù„Øª`, true);
      } else {
        showSyncIndicator('success', `âœ“ ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø© ${successCount} Ø¹Ù…Ù„ÙŠØ©`, true);
      }
    } else {
      showSyncIndicator('error', `âš ï¸ Ù…ØªØ¨Ù‚ÙŠ ${this.queue.length} - Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø©...`, true);
    }
  }
};

// 2ï¸âƒ£ Ø¶ØºØ· Ø§Ù„ØµÙˆØ±
async function compressImage(file) {
  return new Promise((resolve, reject) => {
    // âŒ (Ø³Ø·Ø± Ø®Ø§Ø·Ø¦ Ø³Ø§Ø¨Ù‚Ù‹Ø§) ÙƒØ§Ù† ÙŠÙ…Ù†Ø¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©:
    // if (file.size > 2 * 1024 * 1024) { reject(new Error('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹')); return; }

    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const maxSize = 800; // ØªØµØºÙŠØ± Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ù‚ØµÙˆÙ‰

        let w = img.width;
        let h = img.height;

        if (w > h && w > maxSize) {
          h = (h * maxSize) / w;
          w = maxSize;
        } else if (h > maxSize) {
          w = (w * maxSize) / h;
          h = maxSize;
        }

        canvas.width = w;
        canvas.height = h;

        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);

        // JPEG Ø¨Ø¬ÙˆØ¯Ø© Ù…Ù†Ø§Ø³Ø¨Ø©
        const dataUrl = canvas.toDataURL('image/jpeg', 0.85);

        resolve(dataUrl);
      };
      img.onerror = () => reject(new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©'));
      img.src = e.target.result;
    };
    reader.onerror = () => reject(new Error('ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù'));
    reader.readAsDataURL(file);
  });
}

// ===== Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© =====

// User Roles
const ROLES = {
  QUALITY_MANAGER: 'ÙˆÙƒÙŠÙ„ Ø¶Ø¨Ø· Ø§Ù„Ø¬ÙˆØ¯Ø©',
  SUPERVISOR: 'Ù…Ø´Ø±Ù Ø§Ù„ØµÙŠØ§Ù†Ø©',
  TECHNICIAN: 'ÙÙ†ÙŠ Ø§Ù„ØµÙŠØ§Ù†Ø©',
  EMPLOYEE: 'Ù…ÙˆØ¸Ù',
  DEAN: 'Ø§Ù„Ø¹Ù…ÙŠØ¯',  // â† Ø£Ø¶Ù ÙØ§ØµÙ„Ø© Ù‡Ù†Ø§
  SAFETY_OFFICER: 'Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø³Ù„Ø§Ù…Ø©'
};

// ===== [NEW] Lifecycle constants =====

const STATUS = {
  WAIT_SAFETY_1: 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³Ù„Ø§Ù…Ø© (Ø£ÙˆÙ„ÙŠØ©)',  // â† Ø¬Ø¯ÙŠØ¯
  SAFETY_APPROVED_1: 'Ù…Ø¹ØªÙ…Ø¯ Ù…Ù† Ø§Ù„Ø³Ù„Ø§Ù…Ø© (Ø£ÙˆÙ„ÙŠØ©)',  // â† Ø¬Ø¯ÙŠØ¯
  WAIT_SUP: 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø´Ø±Ù',
  ASSIGNED: 'Ù…Ø­ÙˆÙ‘Ù„ Ù„Ù„ÙÙ†ÙŠ',
  TECH_REVIEW: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©',
  NEEDS_REVIEW: 'ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©',
  WAIT_SAFETY_2: 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³Ù„Ø§Ù…Ø© (Ù†Ù‡Ø§Ø¦ÙŠØ©)',  // â† Ø¬Ø¯ÙŠØ¯
  SAFETY_APPROVED_2: 'Ù…Ø¹ØªÙ…Ø¯ Ù…Ù† Ø§Ù„Ø³Ù„Ø§Ù…Ø© (Ù†Ù‡Ø§Ø¦ÙŠØ©)',  // â† Ø¬Ø¯ÙŠØ¯
  APPROVED: 'Ù…Ø¹ØªÙ…Ø¯',
  COMPLETED: 'Ù…ÙƒØªÙ…Ù„',
  REJECTED: 'Ù…Ø±ÙÙˆØ¶',
  NOT_FIXED: 'ØºÙŠØ± Ù…ÙƒØªÙ…Ù„',
  CANCELED: 'Ù…Ù„ØºÙŠ',
  DELETED: 'Ù…Ø­Ø°ÙˆÙ'
};
const ROLE = ROLES; // ÙƒÙ…Ø§ Ø¨Ø§Ù„ÙƒÙˆØ¯


// Hijri Conversion
function toHijri(gregorianDate) {
  const gDate = new Date(gregorianDate);
  const gYear = gDate.getFullYear();
  const gMonth = gDate.getMonth() + 1;
  const gDay = gDate.getDate();
  
  const hYear = Math.floor((gYear - 622) * 1.030684);
  const hMonth = Math.floor((gMonth + (gDay / 30)) * 1.030684) % 12 || 12;
  const hDay = Math.floor((gDay * 1.030684) % 30) || 1;
  
  const arabicMonths = [
    'Ù…Ø­Ø±Ù…', 'ØµÙØ±', 'Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„', 'Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø«Ø§Ù†ÙŠ', 'Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø£ÙˆÙ„Ù‰', 'Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø«Ø§Ù†ÙŠØ©',
    'Ø±Ø¬Ø¨', 'Ø´Ø¹Ø¨Ø§Ù†', 'Ø±Ù…Ø¶Ø§Ù†', 'Ø´ÙˆØ§Ù„', 'Ø°Ùˆ Ø§Ù„Ù‚Ø¹Ø¯Ø©', 'Ø°Ùˆ Ø§Ù„Ø­Ø¬Ø©'
  ];
  
  return `${hDay} ${arabicMonths[hMonth - 1]} ${hYear}Ù‡Ù€`;
}

// Get Arabic Day
function getArabicDay(date) {
  const days = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
  return days[new Date(date).getDay()];
}

function showNotification(msg, type='info'){
  console[type==='error'?'error':'log']('NOTIFY:', msg);
}

function loadRequestsFromStorage(){
  try{ requests = JSON.parse(localStorage.getItem('requests')||'[]'); }catch{ requests=[]; }
}
function saveRequestsToStorage(){
  try{ localStorage.setItem('requests', JSON.stringify(requests||[])); }catch{}
}


function exportToExcel(){ alert('ØªØµØ¯ÙŠØ± Excel: Ù„Ù… ÙŠÙÙ†ÙÙ‘Ø° Ø¨Ø¹Ø¯'); }
function exportAllWithTemplates(){ alert('ØªØµØ¯ÙŠØ± Ø¨Ø§Ù„Ù†Ù…Ø§Ø°Ø¬: Ù„Ù… ÙŠÙÙ†ÙÙ‘Ø° Ø¨Ø¹Ø¯'); }
function exportToPDF(){ alert('ØªØµØ¯ÙŠØ± PDF: Ù„Ù… ÙŠÙÙ†ÙÙ‘Ø° Ø¨Ø¹Ø¯'); }
function printReport(){ window.print(); }


// ===== config.json loader =====
let CONFIG = null;

async function loadConfig() {
  try {
    const res = await fetch('config.json', { cache: 'no-store' });
    if (!res.ok) throw new Error('config fetch failed');
    CONFIG = await res.json();
    localStorage.setItem('systemConfig', JSON.stringify(CONFIG));
    applyConfig(CONFIG);
  } catch (e) {
    const cached = localStorage.getItem('systemConfig');
    if (cached) {
      CONFIG = JSON.parse(cached);
      applyConfig(CONFIG);
    }
  }
}

function applyConfig(cfg) {
  try {
    if (cfg?.theme) {
      document.documentElement.style.setProperty('--primary', cfg.theme.primaryColor);
      document.documentElement.style.setProperty('--secondary', cfg.theme.secondaryColor);
    }
  } catch(e){}

  // âœ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­: Ø§Ø­ÙØ¸ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ localStorage
  if (cfg?.googleSheets?.enabled && cfg.googleSheets.appsScriptUrl) {
    appsScriptUrl = cfg.googleSheets.appsScriptUrl;
    localStorage.setItem('appsScriptUrl', appsScriptUrl);  // â† Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±
    
    const input = document.getElementById('appsScriptUrl');
    if (input) input.value = appsScriptUrl;

    const section = document.getElementById('sheetsConfigSection');
    if (section) section.style.display = 'none';
  }
}

// Initialize
window.onload = async function() {
  await loadConfig();
  // âœ… ØªØ­Ù…ÙŠÙ„ Queue Ù…Ù† localStorage
  syncQueue.load();

  const savedUrl = localStorage.getItem('appsScriptUrl');
  if (!appsScriptUrl && savedUrl) {
    appsScriptUrl = savedUrl;
  }

  loadRequestsFromStorage();
  updateNextRequestId();
  setCurrentDateTime();

  const savedUser = localStorage.getItem('currentUser');
  if (savedUser && (appsScriptUrl || (CONFIG?.advanced?.offlineMode))) {
    currentUser = JSON.parse(savedUser);
       
    showMainApp();
  }

  setTimeout(() => {
    document.getElementById('loadingScreen').style.display = 'none';
  }, 1000);

  createModals();
};


// Create Modals
function createModals() {
  const modalsHTML = `
    <!-- Technician Report Modal -->
    <div class="modal" id="technicianModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>ğŸ”§ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙÙ†ÙŠ</h2>
          <button class="close-modal" onclick="closeModal('technicianModal')">&times;</button>
        </div>
        
        <form id="technicianForm" onsubmit="submitTechnicianReport(event)">
          <input type="hidden" id="techRequestId">
          
          <div class="form-group">
            <label>Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ</label>
            <input type="text" id="technicianName" required>
          </div>
          
          <div class="form-group">
            <label>Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„</label>
            <select id="workStatus" required>
              <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©</option>
              <option value="ØªÙ…Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©">ØªÙ…Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</option>
              <option value="Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</option>
              <option value="ØªØ­Øª Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©">ØªØ­Øª Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</option>
              <option value="ÙŠØªØ·Ù„Ø¨ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©">ÙŠØªØ·Ù„Ø¨ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</option>
              <option value="ÙŠØ­ØªØ§Ø¬ Ù‚Ø·Ø¹ ØºÙŠØ§Ø±">ÙŠØ­ØªØ§Ø¬ Ù‚Ø·Ø¹ ØºÙŠØ§Ø±</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙÙ†ÙŠ</label>
            <textarea id="technicianNotes" placeholder="Ø£Ø¶Ù Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù‡Ù†Ø§..." required></textarea>
          </div>
          <div class="form-group">
            <label>ğŸ“· ØµÙˆØ±Ø© Ø§Ù„Ø¥ØµÙ„Ø§Ø­ (Ø¥Ù„Ø²Ø§Ù…ÙŠ)</label>
            <div class="image-upload-container" id="techUploadContainer" onclick="document.getElementById('techRepairImage').click()">
              <div class="upload-icon">ğŸ“¸</div>
              <div class="upload-text">Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø¥ØµÙ„Ø§Ø­</div>
              <img id="techRepairImagePreview" class="image-preview" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© ØµÙˆØ±Ø© Ø§Ù„Ø¥ØµÙ„Ø§Ø­">
              <input type="file" id="techRepairImage" accept="image/*" style="display: none;" onchange="handleTechImageUpload(event)" required>
              <button type="button" class="remove-image-btn" id="removeTechImageBtn" onclick="event.stopPropagation(); removeTechImage()">
                âŒ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø©
              </button>
            </div>
          </div>
          <button type="submit" class="btn-primary">Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
          <button type="button" class="btn-secondary" onclick="closeModal('technicianModal')">Ø¥Ù„ØºØ§Ø¡</button>
        </form>
      </div>
    </div>

    <!-- Supervisor Review Modal -->
    <!-- Safety Review Modal 1 (Ù…Ø±Ø§Ø¬Ø¹Ø© Ø£ÙˆÙ„ÙŠØ©) -->
<div class="modal" id="safetyModal1">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ğŸ¦º Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø© (Ø£ÙˆÙ„ÙŠØ©)</h2>
      <button class="close-modal" onclick="closeModal('safetyModal1')">&times;</button>
    </div>
    
    <form id="safetyForm1" onsubmit="submitSafetyReview1(event)">
      <input type="hidden" id="safetyRequestId1">
      
      <div class="form-group">
        <label>Ø§Ø³Ù… Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø³Ù„Ø§Ù…Ø©</label>
        <input type="text" id="safetyOfficerName1" required>
      </div>
      
      <div class="form-group">
        <label>Ù‚Ø±Ø§Ø± Ø§Ù„Ø³Ù„Ø§Ù…Ø©</label>
        <select id="safetyDecision1" required>
          <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø±Ø§Ø±</option>
          <option value="Ø¢Ù…Ù† Ù„Ù„ØªÙ†ÙÙŠØ°">âœ… Ø¢Ù…Ù† Ù„Ù„ØªÙ†ÙÙŠØ°</option>
          <option value="ÙŠØ­ØªØ§Ø¬ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ù„Ø§Ù…Ø©">âš ï¸ ÙŠØ­ØªØ§Ø¬ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ù„Ø§Ù…Ø©</option>
          <option value="ØºÙŠØ± Ø¢Ù…Ù† - Ù…Ø±ÙÙˆØ¶">âŒ ØºÙŠØ± Ø¢Ù…Ù† - Ù…Ø±ÙÙˆØ¶</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø©</label>
        <textarea id="safetyNotes1" placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø© ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©..." required></textarea>
      </div>
      
      <button type="submit" class="btn-primary">Ø­ÙØ¸ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
      <button type="button" class="btn-secondary" onclick="closeModal('safetyModal1')">Ø¥Ù„ØºØ§Ø¡</button>
    </form>
  </div>
</div>

<!-- Safety Review Modal 2 (Ù…Ø±Ø§Ø¬Ø¹Ø© Ù†Ù‡Ø§Ø¦ÙŠØ©) -->
<div class="modal" id="safetyModal2">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ğŸ¦º Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø© (Ù†Ù‡Ø§Ø¦ÙŠØ©)</h2>
      <button class="close-modal" onclick="closeModal('safetyModal2')">&times;</button>
    </div>
    
    <form id="safetyForm2" onsubmit="submitSafetyReview2(event)">
      <input type="hidden" id="safetyRequestId2">
      
      <div class="form-group">
        <label>Ø§Ø³Ù… Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø³Ù„Ø§Ù…Ø©</label>
        <input type="text" id="safetyOfficerName2" required>
      </div>
      
      <div class="form-group">
        <label>Ù‚Ø±Ø§Ø± Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</label>
        <select id="safetyDecision2" required>
          <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø±Ø§Ø±</option>
          <option value="Ù…Ø¹ØªÙ…Ø¯ - Ø§Ù„Ø¹Ù…Ù„ Ù…Ø·Ø§Ø¨Ù‚">âœ… Ù…Ø¹ØªÙ…Ø¯ - Ø§Ù„Ø¹Ù…Ù„ Ù…Ø·Ø§Ø¨Ù‚</option>
          <option value="Ù…Ø¹ØªÙ…Ø¯ Ù…Ø¹ Ù…Ù„Ø§Ø­Ø¸Ø§Øª">âš ï¸ Ù…Ø¹ØªÙ…Ø¯ Ù…Ø¹ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</option>
          <option value="ØºÙŠØ± Ù…Ø¹ØªÙ…Ø¯">âŒ ØºÙŠØ± Ù…Ø¹ØªÙ…Ø¯</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</label>
        <textarea id="safetyNotes2" placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©..." required></textarea>
      </div>
      
      <button type="submit" class="btn-primary">Ø­ÙØ¸ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</button>
      <button type="button" class="btn-secondary" onclick="closeModal('safetyModal2')">Ø¥Ù„ØºØ§Ø¡</button>
    </form>
  </div>
</div>
    <div class="modal" id="supervisorModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>âœ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø´Ø±Ù</h2>
          <button class="close-modal" onclick="closeModal('supervisorModal')">&times;</button>
        </div>
        
        <form id="supervisorForm" onsubmit="submitSupervisorReview(event)">
          <input type="hidden" id="supRequestId">
          
          <div class="form-group">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±Ù</label>
            <input type="text" id="supervisorName" required>
          </div>
          
          <div class="form-group" id="decisionBlock" style="display:none">
          <label>Ù‚Ø±Ø§Ø± Ø§Ù„Ù…Ø´Ø±Ù</label>
          <select id="supervisorDecision">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø±Ø§Ø±</option>
            <option value="Ù…Ø¹ØªÙ…Ø¯">Ù…Ø¹ØªÙ…Ø¯</option>
            <option value="ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©">ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
          </select>
        </div>

          <!-- Ø¯Ø§Ø®Ù„ #supervisorModalØŒ Ø¨Ø¹Ø¯ Ù‚Ø³Ù… Ù‚Ø±Ø§Ø± Ø§Ù„Ù…Ø´Ø±Ù -->
          <div class="form-group">
            <label>ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ†ÙŠ (Ù…Ù† ÙˆØ±Ù‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†)</label>
            <select id="assignedTechnicianSelect">
              <option value="">â€” Ø§Ø®ØªØ± Ø§Ù„ÙÙ†ÙŠ â€”</option>
            </select>
            <small style="color:#888">ØªÙØ¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Google Sheets (Ø§Ù„Ø¯ÙˆØ± = ÙÙ†ÙŠ Ø§Ù„ØµÙŠØ§Ù†Ø©). ÙˆÙ„Ùˆ ØªØ¹Ø°Ù‘Ø±ØŒ ÙŠØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù…Ø­Ù„ÙŠÙ‹Ø§.</small>
          </div>

          
          <div class="form-group">
            <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø´Ø±Ù</label>
            <textarea id="supervisorNotes" placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ù‡Ù†Ø§..." required></textarea>
          </div>
          
          <button type="submit" class="btn-primary">Ø­ÙØ¸ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
          <button type="button" class="btn-secondary" onclick="closeModal('supervisorModal')">Ø¥Ù„ØºØ§Ø¡</button>
        </form>
      </div>
    </div>

    <!-- Client Feedback Modal -->
    <div class="modal" id="clientModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>â­ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
          <button class="close-modal" onclick="closeModal('clientModal')">&times;</button>
        </div>
        
        <form id="clientForm" onsubmit="submitClientFeedback(event)">
          <input type="hidden" id="clientRequestId">
          
          <div class="form-group">
            <label>Ù‡Ù„ ØªÙ…Øª Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©ØŸ</label>
            <select id="isFixed" required>
              <option value="">Ø§Ø®ØªØ±</option>
              <option value="Ù†Ø¹Ù…">Ù†Ø¹Ù…</option>
              <option value="Ù„Ø§">Ù„Ø§</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø±Ø¶Ø§</label>
            <select id="satisfactionLevel" required>
              <option value="">Ø§Ø®ØªØ± Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø±Ø¶Ø§</option>
              <option value="Ù…Ù…ØªØ§Ø²">Ù…Ù…ØªØ§Ø² â­â­â­â­â­</option>
              <option value="Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹">Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹ â­â­â­â­</option>
              <option value="Ø¬ÙŠØ¯">Ø¬ÙŠØ¯ â­â­â­</option>
              <option value="Ù…Ù‚Ø¨ÙˆÙ„">Ù…Ù‚Ø¨ÙˆÙ„ â­â­</option>
              <option value="Ø¶Ø¹ÙŠÙ">Ø¶Ø¹ÙŠÙ â­</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
            <textarea id="clientNotes" placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ø£Ùˆ Ø§Ù‚ØªØ±Ø§Ø­Ø§ØªÙƒ..."></textarea>
          </div>
          
          <button type="submit" class="btn-primary">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
          <button type="button" class="btn-secondary" onclick="closeModal('clientModal')">Ø¥Ù„ØºØ§Ø¡</button>
        </form>
      </div>
    </div>

    <!-- View Details Modal -->
    <div class="modal" id="viewModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h2>
          <button class="close-modal" onclick="closeModal('viewModal')">&times;</button>
        </div>
        <div id="viewDetailsContent"></div>
        <button class="btn-secondary" onclick="closeModal('viewModal')">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>

    <!-- Image Modal -->
    <div class="modal" id="imageModal">
      <div class="modal-content image-modal-content">
        <div class="modal-header">
          <h2>ğŸ“· ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø·Ù„</h2>
          <button class="close-modal" onclick="closeModal('imageModal')">&times;</button>
        </div>
        <img id="modalImage" style="width: 100%; height: auto; border-radius: 10px;" alt="ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø·Ù„">
      </div>
    </div>
        <!-- Client Actions Modal (Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø¹Ù…ÙŠÙ„ ÙÙ‚Ø·) -->
      <div class="modal" id="clientActionsModal">
        <div class="modal-content">
          <div class="modal-header">
            <h2>ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨</h2>
            <button class="close-modal" onclick="closeModal('clientActionsModal')">&times;</button>
          </div>
          <form id="clientActionsForm" onsubmit="submitClientAction(event)">
            <input type="hidden" id="clientActionRequestId">
            <div class="form-group">
              <label>Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø°Ù</label>
              <textarea id="clientActionReason" placeholder="Ø§Ø°ÙƒØ± Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø°Ù..." required></textarea>
            </div>
            <button type="submit" class="btn-primary btn-danger">Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨</button>
            <button type="button" class="btn-secondary" onclick="closeModal('clientActionsModal')">Ø¥Ù„ØºØ§Ø¡</button>
          </form>
        </div>
      </div>

  `
  ;
  
  document.body.insertAdjacentHTML('beforeend', modalsHTML);
}

// Handle Image Upload

async function handleImageUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  if (!file.type.startsWith('image/')) {
    alert('âŒ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø®ØªØ§Ø± Ù„ÙŠØ³ ØµÙˆØ±Ø©');
    event.target.value = '';
    return;
  }
  
  try {
    showNotification('Ø¬Ø§Ø±ÙŠ Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø©...', 'info');
    
    uploadedImage = await compressImage(file);
    
    document.getElementById('imagePreview').src = uploadedImage;
    document.getElementById('imagePreview').classList.add('show');
    document.getElementById('removeImageBtn').classList.add('show');
    document.getElementById('uploadContainer').classList.add('has-image');
    
    showNotification('âœ“ ØªÙ… ØªØ­Ø³ÙŠÙ† Ø§Ù„ØµÙˆØ±Ø©', 'success');
  } catch (error) {
    alert('âŒ ' + error.message);
    event.target.value = '';
  }
}

function normalizeName(s=''){
  return s.replace(/\s+/g,' ').replace(/Ù€/g,'').trim();
}

// Remove Image
function removeImage() {
  uploadedImage = null;
  document.getElementById('imageUpload').value = '';
  document.getElementById('imagePreview').classList.remove('show');
  document.getElementById('removeImageBtn').classList.remove('show');
  document.getElementById('uploadContainer').classList.remove('has-image');
}

// Handle Tech Image Upload
// Handle Tech Image Upload - Ù…Ø­Ø³Ù‘Ù† Ù…Ø¹ Ø¶ØºØ·
async function handleTechImageUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  if (!file.type.startsWith('image/')) {
    alert('âŒ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø®ØªØ§Ø± Ù„ÙŠØ³ ØµÙˆØ±Ø©');
    event.target.value = '';
    return;
  }
  
  try {
    showNotification('Ø¬Ø§Ø±ÙŠ Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø©...', 'info');
    
    techRepairImage = await compressImage(file);
    
    document.getElementById('techRepairImagePreview').src = techRepairImage;
    document.getElementById('techRepairImagePreview').classList.add('show');
    document.getElementById('removeTechImageBtn').classList.add('show');
    document.getElementById('techUploadContainer').classList.add('has-image');
    
    showNotification('âœ“ ØªÙ… ØªØ­Ø³ÙŠÙ† Ø§Ù„ØµÙˆØ±Ø©', 'success');
  } catch (error) {
    alert('âŒ ' + error.message);
    event.target.value = '';
  }
}

// Remove Tech Image
function removeTechImage() {
  techRepairImage = null;
  document.getElementById('techRepairImage').value = '';
  document.getElementById('techRepairImagePreview').classList.remove('show');
  document.getElementById('removeTechImageBtn').classList.remove('show');
  document.getElementById('techUploadContainer').classList.remove('has-image');
}





// View Image
async function viewImage(imageData) {
  if (!imageData) { alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø©'); return; }

  const modal = document.getElementById('imageModal');
  const modalImage = document.getElementById('modalImage');

  // Ø£Ø¹Ø·ÙÙ†Ø§ Ø±Ø§Ø¨Ø·Ù‹Ø§ ØµØ§Ù„Ø­Ù‹Ø§ Ù„Ù„Ø¹Ø±Ø¶
  const resolved = resolveImageSrc(imageData);
  modalImage.removeAttribute('onerror'); // Ù†Ø¸Ø§ÙØ©
  modalImage.src = '';                   // ÙØ±Ø¶ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
  modalImage.src = resolved;

  // Ù„Ùˆ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Ù…Ø«Ù„Ù‹Ø§ Ø®ØµÙˆØµÙŠØ© Ø§Ù„Ù…Ù„Ù Ø£Ùˆ ØµÙŠØºØ© ØºØ±ÙŠØ¨Ø©)
  modalImage.onerror = () => {
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ø®ÙŠØ±Ø© Ø¨Ù†Ù…Ø· googleusercontent
    const m = resolved.match(/[?&]id=([a-zA-Z0-9_-]{25,})/);
    if (m && m[1]) {
      modalImage.onerror = null;
      modalImage.src = `https://lh3.googleusercontent.com/d/${m[1]}=w1600-h1600`;
    } else {
      alert('ØªØ¹Ø°Ù‘Ø± Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø©. ØªØ£ÙƒØ¯ Ø£Ù† Ù…Ù„Ù Google Drive â€œAnyone with the linkâ€.');
    }
  };

  modal.classList.add('active');
}



async function sendAuditToSheet(evt) {
  try {
    if (!appsScriptUrl) return;
    // Ù†ØªÙˆÙ‚Ø¹ Ø£Ù† GAS Ù„Ø¯ÙŠÙ‡ Ø£ÙƒØ´Ù† logEvent ÙŠØ­ÙØ¸ ÙÙŠ ÙˆØ±Ù‚Ø© Logs
    await callAppsScript('logEvent', evt, false);
  } catch (e) {
    console.warn('ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø¬Ù„ Ù„Ù„Ø´ÙŠØª Ø§Ù„Ø¢Ù†ØŒ Ø³ÙŠØªÙ… ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø­Ø¯Ø« ÙÙ‚Ø·:', e);
  }
}

// Google Sheets Integration

// Google Sheets Integration
// Ø§Ø³ØªØ¨Ø¯Ù„ Ø¯Ø§Ù„Ø© callAppsScript ÙƒØ§Ù…Ù„Ø© Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø©

// Ø§Ø³ØªØ¨Ø¯Ù„ Ø£ÙŠ Ù†Ø³Ø®Ø© Ø³Ø§Ø¨Ù‚Ø© Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø©
async function callAppsScript(action, data, showIndicator = true) {
  if (!appsScriptUrl) { console.warn('Apps Script URL ÙØ§Ø±Øº'); return null; }
  if (showIndicator && action !== 'getImageBase64') showSyncIndicator('syncing','Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...');

  try {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 90000);

    const res = await fetch(appsScriptUrl, {
      method: 'POST',
      // ğŸ‘‡ Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… application/json (Ù‡Ø°Ø§ Ø§Ù„Ø°ÙŠ ÙŠØ³Ø¨Ù‘Ø¨ preflight)
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      // Ø£Ø±Ø³Ù„ Ù†Øµ Ø¹Ø§Ø¯ÙŠ (Ø³ÙŠÙÙƒÙ‘Ù‡ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ù€ JSON.parse)
      body: JSON.stringify({ action, data }),
      signal: controller.signal,
      // mode: 'cors' Ø£Ùˆ Ø§ØªØ±ÙƒÙ‡Ø§ Ø§ÙØªØ±Ø§Ø¶ÙŠ- ÙƒÙ„Ø§Ù‡Ù…Ø§ OK Ø¨Ø¹Ø¯ Ø¬Ø¹Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø³ÙŠØ·
    });

    clearTimeout(timeoutId);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();
    if (showIndicator && action !== 'getImageBase64') showSyncIndicator('success','Ù…ØªØ²Ø§Ù…Ù†');
    return json;

  } catch (err) {
    console.error('Ø®Ø·Ø£ fetch:', err);
    if (showIndicator && action !== 'getImageBase64') showSyncIndicator('error','ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„');
    alert(`Ø®Ø·Ø£: ${err.message}\n\nØªØ£ÙƒØ¯ Ù…Ù†:\n1) URL ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù€ /exec\n2) Ø§Ù„Ù†Ø´Ø±: Anyone\n3) Ø­ÙØ¸Øª Ø¢Ø®Ø± Ù†Ø´Ø±`);
    return null;
  }
}


// Ø¥Ù†Ø´Ø§Ø¡ Timeline Ù„Ù„Ø·Ù„Ø¨
function generateTimeline(req) {
  const st = (req.status || '').trim();

  const submittedDone = true;
  
  // Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
  const safety1Done = ['Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø´Ø±Ù','Ù…Ø­ÙˆÙ‘Ù„ Ù„Ù„ÙÙ†ÙŠ','Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©','ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©',
                        'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³Ù„Ø§Ù…Ø© (Ù†Ù‡Ø§Ø¦ÙŠØ©)','Ù…Ø¹ØªÙ…Ø¯','Ù…ÙƒØªÙ…Ù„','ØºÙŠØ± Ù…ÙƒØªÙ…Ù„','Ù…Ù„ØºÙŠ'].includes(st)
                       || !!(req.safetyOfficerName1);

  const sup1Done = ['Ù…Ø­ÙˆÙ‘Ù„ Ù„Ù„ÙÙ†ÙŠ','Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©','ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©','Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³Ù„Ø§Ù…Ø© (Ù†Ù‡Ø§Ø¦ÙŠØ©)',
                    'Ù…Ø¹ØªÙ…Ø¯','Ù…ÙƒØªÙ…Ù„','ØºÙŠØ± Ù…ÙƒØªÙ…Ù„','Ù…Ù„ØºÙŠ'].includes(st)
                   || !!(req.supervisorName || req.assignedTechnicianName);

  const techDone = ['Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©','ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©','Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³Ù„Ø§Ù…Ø© (Ù†Ù‡Ø§Ø¦ÙŠØ©)',
                    'Ù…Ø¹ØªÙ…Ø¯','Ù…ÙƒØªÙ…Ù„','ØºÙŠØ± Ù…ÙƒØªÙ…Ù„'].includes(st)
                   || !!(req.technicianName || req.workStatus);

  const sup2Done = ['Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³Ù„Ø§Ù…Ø© (Ù†Ù‡Ø§Ø¦ÙŠØ©)','Ù…Ø¹ØªÙ…Ø¯','Ù…ÙƒØªÙ…Ù„','ØºÙŠØ± Ù…ÙƒØªÙ…Ù„'].includes(st)
                   || (req.supervisorDecision === 'Ù…Ø¹ØªÙ…Ø¯');

  // Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
  const safety2Done = ['Ù…Ø¹ØªÙ…Ø¯','Ù…ÙƒØªÙ…Ù„','ØºÙŠØ± Ù…ÙƒØªÙ…Ù„','Ù…Ù„ØºÙŠ'].includes(st)
                      || !!(req.safetyOfficerName2);

  const clientDone = ['Ù…ÙƒØªÙ…Ù„','ØºÙŠØ± Ù…ÙƒØªÙ…Ù„','Ù…Ù„ØºÙŠ'].includes(st)
                     || !!(req.isFixed || req.cancelReason);

  const completedDone = ['Ù…ÙƒØªÙ…Ù„','Ù…Ù„ØºÙŠ','ØºÙŠØ± Ù…ÙƒØªÙ…Ù„'].includes(st);

  const stages = [
    { id:'submitted', icon:'ğŸ“', label:'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„', done: submittedDone,
      info: req.createdBy ? `${req.createdBy}<br>${req.date||''}` : (req.date||'') },

    { id:'safety1', icon:'ğŸ¦º', label:'Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø© (Ø£ÙˆÙ„ÙŠØ©)', done: safety1Done,
      info: req.safetyDecision1 ? `${req.safetyOfficerName1||'-'}<br>${req.safetyDecision1}` : 
            (safety1Done ? 'ØªÙ…Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' : 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³Ù„Ø§Ù…Ø©') },

    { id:'sup1', icon:'âœ…', label:'Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø´Ø±Ù', done: sup1Done,
      info: req.assignedTechnicianName ? `Ø­ÙÙˆÙÙ‘Ù„ Ø¥Ù„Ù‰: ${req.assignedTechnicianName}` : 
            (sup1Done ? 'ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…' : 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø´Ø±Ù') },

    { id:'tech', icon:'ğŸ”§', label:'ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙÙ†ÙŠ', done: techDone,
  info: techDone ? `${req.technicianName||req.assignedTechnicianName||'-'}<br>${req.workStatus||''}` : 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ±' },


    { id:'sup2', icon:'âœ…', label:'Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø´Ø±Ù (Ù‚Ø±Ø§Ø±)', done: sup2Done,
      info: sup2Done ? `${req.supervisorName||'-'}<br>${req.supervisorDecision||'Ù…Ø¹ØªÙ…Ø¯'}` : 
            'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù‚Ø±Ø§Ø±' },

    { id:'safety2', icon:'ğŸ¦º', label:'Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø© (Ù†Ù‡Ø§Ø¦ÙŠØ©)', done: safety2Done,
      info: req.safetyDecision2 ? `${req.safetyOfficerName2||'-'}<br>${req.safetyDecision2}` : 
            (safety2Done ? 'ØªÙ…Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' : 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©') },

    { id:'client', icon:'â­', label:'ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ù…ÙŠÙ„', done: clientDone,
      info: req.cancelReason ? `Ù…Ù„ØºÙŠ: ${req.cancelReason}` :
            (req.isFixed ? `${req.isFixed}<br>${req.satisfactionLevel||''}` : 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…') },

    { id:'completed', icon:(st==='Ù…Ù„ØºÙŠ'?'â›”':'ğŸ‰'), 
      label:(st==='Ù…Ù„ØºÙŠ'?'Ù…Ù„ØºÙŠ': (st==='ØºÙŠØ± Ù…ÙƒØªÙ…Ù„'?'ØºÙŠØ± Ù…ÙƒØªÙ…Ù„':'Ù…ÙƒØªÙ…Ù„')),
      done: completedDone, info: completedDone ? (st==='Ù…Ù„ØºÙŠ'?(req.cancelReason||''): 'ØªÙ… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²') : '' }
  ];

  const doneCount = stages.filter(s => s.done).length;
  const idxActive = Math.min(doneCount, stages.length - 1);
  const lineProgress = idxActive>0 ? (idxActive/(stages.length-1))*100 : 0;
  const progress = Math.round((doneCount/stages.length)*100);

  let html = '<div class="request-timeline">';
  html += '<div class="timeline-header">ğŸ“ Ù…Ø³Ø§Ø± Ø§Ù„Ø·Ù„Ø¨</div>';
  html += '<div class="timeline-container">';
  html += `<div class="timeline-line"><div class="timeline-line-progress" style="width:${lineProgress}%"></div></div>`;

  stages.forEach((stage, i) => {
    let cls = 'timeline-step';
    if (stage.done) cls += ' completed';
    else if (i === idxActive) cls += ' active';
    if (stage.id === 'safety1' || stage.id === 'safety2') cls += ' safety';
    if (st === 'Ù…Ù„ØºÙŠ' && (stage.id==='client' || stage.id==='completed')) cls += ' rejected';

    html += `<div class="${cls}">
      <div class="timeline-icon">${stage.icon}</div>
      <div class="timeline-label">${stage.label}</div>
      <div class="timeline-info">${stage.info||''}</div>
    </div>`;
  });

  html += '</div>';
  html += `<div class="timeline-progress">
    <div class="progress-text">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²: ${progress}%</div>
    <div class="progress-bar-container"><div class="progress-bar-fill" style="width:${progress}%"></div></div>
  </div></div>`;
  return html;
}
// ÙŠØ­ÙˆÙ‘Ù„ ØµÙÙˆÙ Ø§Ù„Ø´ÙŠØª (Ø±Ø¤ÙˆØ³ Ø¹Ø±Ø¨ÙŠØ©) Ø¥Ù„Ù‰ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Ù…ÙØ§ØªÙŠØ­ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©)
function normalizeDriveImageUrl(url) {
  if (!url) return '';
  const fileId = extractDriveId(url);
  // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ø§Ø¨Ø· Ø£Ø­Ø¯Ø« ÙˆØ£Ø³Ø±Ø¹
  return fileId ? `https://lh3.googleusercontent.com/d/${fileId}=w1600-h1600` : url;
}

// ===== helpers for Drive images =====

// ÙŠØ³ØªØ®Ø±Ø¬ fileId Ù…Ù† Ø£ÙŠ Ø´ÙƒÙ„ Ø±Ø§Ø¨Ø· Drive
function extractDriveId(url) {
  if (!url) return null;
  const patterns = [
    /\/file\/d\/([a-zA-Z0-9_-]+)/,
    /[?&]id=([a-zA-Z0-9_-]+)/,
    /\/d\/([a-zA-Z0-9_-]+)(?:[/?#]|$)/,
    /^([a-zA-Z0-9_-]{15,})$/ // Ù…Ø¹Ø±Ù‘Ù ÙÙ‚Ø·
  ];
  for (const p of patterns) {
    const m = url.match(p);
    if (m && m[1]) return m[1];
  }
  return null;
}

function resolveImageSrc(src='') {
  if (!src) return '';
  if (src.startsWith('data:image/')) return src; // Base64

  // Ø¬Ø±Ù‘Ø¨ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù€ id
  const id = extractDriveId(src);
  if (id) {
    // Ø±Ø§Ø¨Ø· Ø¹Ø±Ø¶ Ù…Ø¨Ø§Ø´Ø± Ø³Ø±ÙŠØ¹
    return `https://lh3.googleusercontent.com/d/${id}=w1600-h1600`;
  }

  // Ø±Ø§Ø¨Ø· http Ø¹Ø§Ø¯ÙŠ
  if (/^https?:\/\//i.test(src)) return src;

  return src;
}


// ÙŠØ·Ù„Ø¨ Ù…Ù† Apps Script ØªØ­ÙˆÙŠÙ„ ØµÙˆØ±Ø© Drive Ø¥Ù„Ù‰ dataURL (Base64)
// ÙŠØªØ·Ù„Ø¨ Ø¥Ø¶Ø§ÙØ© Ø£ÙƒØ´Ù† getImageBase64 ÙÙŠ Ø§Ù„Ø³ÙƒØ±Ø¨Øª (Ø§Ù†Ø¸Ø± Ø§Ù„Ù‚Ø³Ù… 3 Ø¨Ø§Ù„Ø£Ø³ÙÙ„)
async function getDriveImageAsDataURL(url) {
  const fileId = extractDriveId(url);
  if (!fileId) return null;
  
  try {
    const result = await callAppsScript('getImageBase64', { fileId: fileId });
    return (result && result.ok && result.dataUrl) ? result.dataUrl : null;
  } catch (err) {
    console.error('Ø®Ø·Ø£ ÙÙŠ getDriveImageAsDataURL:', err);
    return null;
  }
}

// Ø¨Ø¯ÙŠÙ„ Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØµÙØ­ (Ù‚Ø¯ ÙŠÙØ´Ù„ Ø¨Ø³Ø¨Ø¨ CORS Ù…Ø¹ Ø±ÙˆØ§Ø¨Ø· Drive)
async function urlToDataURL(url) {
  const res = await fetch(url);  // Ù‚Ø¯ ÙŠØ±Ù…ÙŠ CORS
  const blob = await res.blob();
  return await new Promise((resolve) => {
    const fr = new FileReader();
    fr.onload = () => resolve(fr.result); // data:image/...;base64,...
    fr.readAsDataURL(blob);
  });
}


function mapArabicRowToModel(ar) {
  const rawUrl =
    ar['Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©'] || ar['ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø·Ù„'] || ar['Ø§Ù„ØµÙˆØ±Ø©'] ||
    ar['Image URL'] || ar['imageUrl'] || '';
  const rawB64 =
    ar['ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø·Ù„ (Base64)'] || ar['Base64'] || ar['image'] || '';
  const repairUrl =
    ar['Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ø¥ØµÙ„Ø§Ø­'] || ar['ØµÙˆØ±Ø© Ø§Ù„Ø¥ØµÙ„Ø§Ø­ (Ø±Ø§Ø¨Ø·)'] || ar['repairImageUrl'] || '';
  const repairB64 =
    ar['ØµÙˆØ±Ø© Ø§Ù„Ø¥ØµÙ„Ø§Ø­ (Base64)'] || ar['repairImage'] || '';

  return {
    id: (ar['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨'] || '').toString(),
    type: ar['Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨'] || '',
    building: ar['Ø§Ù„Ù…Ø¨Ù†Ù‰'] || '',
    maintenanceType: ar['Ù†ÙˆØ¹ Ø§Ù„ØµÙŠØ§Ù†Ø©'] || '',
    requesterName: ar['Ø§Ø³Ù… ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨'] || '',
    time: ar['Ø§Ù„ÙˆÙ‚Øª'] || '',
    date: ar['Ø§Ù„ØªØ§Ø±ÙŠØ®'] || '',
    hijriDate: ar['Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ'] || '',
    day: ar['Ø§Ù„ÙŠÙˆÙ…'] || '',
    faultType: ar['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„'] || '',
    faultDescription: ar['ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„'] || '',
    image: rawB64 || '',
    imageUrl: normalizeDriveImageUrl(rawUrl),
    repairImage: repairB64 || '',
    repairImageUrl: normalizeDriveImageUrl(repairUrl),
    status: (ar['Ø§Ù„Ø­Ø§Ù„Ø©'] || 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³Ù„Ø§Ù…Ø© (Ø£ÙˆÙ„ÙŠØ©)').trim(), // âœ… Ø§Ù„ØªØµØ­ÙŠØ­
    technicianName: ar['Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ'] || '',
    workStatus: ar['Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„'] || '',
    technicianNotes: ar['Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙÙ†ÙŠ'] || '',
    supervisorName: ar['Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±Ù'] || '',
    supervisorDecision: ar['Ù‚Ø±Ø§Ø± Ø§Ù„Ù…Ø´Ø±Ù'] || '',
    supervisorNotes: ar['Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø´Ø±Ù'] || '',
    isFixed: ar['ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­'] || '',
    satisfactionLevel: ar['Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø±Ø¶Ø§'] || '',
    clientNotes: ar['Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„'] || '',
    createdAt: ar['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡'] || '',
    assignedTechnicianName: ar['Ø§Ù„ÙÙ†ÙŠ Ø§Ù„Ù…Ø¹ÙŠÙ‘Ù†'] || ''
  };
}


// Show Sync Indicator

// ===== Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ =====
let lastSyncTime = null;

const SyncIndicatorManager = {
  timeout: null,
  currentStatus: null,
  isVisible: false,
  lastUpdate: 0,
  minDisplayTime: 800, // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ø¹Ø±Ø¶ ÙƒÙ„ Ø±Ø³Ø§Ù„Ø© (milliseconds)
  
  show(status, message = '', autoHide = true) {
    const now = Date.now();
    
    // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø© Ø¬Ø¯Ø§Ù‹ (Debounce)
    if (this.currentStatus === status && (now - this.lastUpdate) < 500) {
      return;
    }
    
    this.lastUpdate = now;
    this.currentStatus = status;
    
    const indicator = document.getElementById('syncIndicator');
    const text = document.getElementById('syncText');
    const icon = document.getElementById('syncIcon');
    const timeEl = document.getElementById('syncTime');
    
    if (!indicator) return;
    
    // Ø§Ù…Ø³Ø­ Ø£ÙŠ timeout Ø³Ø§Ø¨Ù‚
    if (this.timeout) {
      clearTimeout(this.timeout);
      this.timeout = null;
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ØªÙˆÙ‰
    indicator.className = `sync-indicator show ${status}`;
    text.textContent = message || this._getDefaultMessage(status);
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
    if (status === 'syncing') {
      icon.innerHTML = '<div class="sync-spinner"></div>';
      timeEl.textContent = '';
    } else if (status === 'success') {
      icon.textContent = 'âœ“';
      lastSyncTime = new Date();
      this._updateTime();
    } else if (status === 'error') {
      icon.textContent = 'âœ—';
      timeEl.textContent = '';
    }
    
    this.isVisible = true;
    
    // Ø¥Ø®ÙØ§Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
    if (autoHide && status !== 'syncing') {
      const hideDelay = status === 'error' ? 4000 : 2500;
      this.timeout = setTimeout(() => {
        this.hide();
      }, Math.max(hideDelay, this.minDisplayTime));
    }
  },
  
  hide() {
    const indicator = document.getElementById('syncIndicator');
    if (indicator) {
      indicator.classList.remove('show');
    }
    this.isVisible = false;
    this.currentStatus = null;
  },
  
  _getDefaultMessage(status) {
    const messages = {
      'syncing': 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...',
      'success': 'Ù…ØªØ²Ø§Ù…Ù†',
      'error': 'ÙØ´Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©'
    };
    return messages[status] || '';
  },
  
  _updateTime() {
    const timeEl = document.getElementById('syncTime');
    if (!lastSyncTime || !timeEl) return;
    
    const diff = Math.floor((new Date() - lastSyncTime) / 1000);
    if (diff < 60) {
      timeEl.textContent = 'Ø§Ù„Ø¢Ù†';
    } else if (diff < 3600) {
      timeEl.textContent = `Ù‚Ø¨Ù„ ${Math.floor(diff / 60)} Ø¯`;
    } else {
      timeEl.textContent = lastSyncTime.toLocaleTimeString('ar-SA', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
    }
  }
};

// Ø¯Ø§Ù„Ø© wrapper Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…
function showSyncIndicator(status, message = '', autoHide = true) {
  SyncIndicatorManager.show(status, message, autoHide);
}

// ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± Ù…Ø²Ø§Ù…Ù†Ø©
function updateSyncTime() {
  SyncIndicatorManager._updateTime();
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
setInterval(updateSyncTime, 60000);

// Sync with Sheets
async function syncWithSheets() {
  if (!appsScriptUrl) {
    alert('âš ï¸ ÙŠØ¬Ø¨ ØªÙƒÙˆÙŠÙ† Ø±Ø§Ø¨Ø· Google Apps Script Ø£ÙˆÙ„Ø§Ù‹');
    return;
  }
  
  showSyncIndicator('syncing');
  
  // Save all requests to Sheets
  for (const request of requests) {
    await callAppsScript('addRequest', request);
  }
  
  alert('âœ“ ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Google Sheets Ø¨Ù†Ø¬Ø§Ø­!');
}

async function pullFromSheets() {
  if (!appsScriptUrl) {
    alert('âš ï¸ Ø§Ø¶Ø¨Ø· Ø±Ø§Ø¨Ø· Google Apps Script Ø£ÙˆÙ„Ø§Ù‹');
    return;
  }
  showNotification('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø³Ø­Ø¨ Ù…Ù† Google Sheets...', 'info');

  const res = await callAppsScript('getRequests', requestScope());
  if (!res) { alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø³Ø­Ø¨'); return; }

  // Ø§Ù„Ø³ÙƒØ±Ø¨Øª ÙŠØ¹ÙŠØ¯ {success:true, data:[...]}
  const rows = (res.data || []);
  if (!Array.isArray(rows)) {
    alert('ØµÙŠØºØ© Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø© Ù…Ù† Ø§Ù„Ø´ÙŠØª');
    return;
  }

  // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±Ø¤ÙˆØ³ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¥Ù„Ù‰ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  requests = rows
  .map(mapArabicRowToModel)
  .map(r => ({
    ...r,
    requesterName: r.requesterName || r.createdBy || ''  // â† Ù‡Ù†Ø§ Ø§Ù„ØªØµØ­ÙŠØ­
  }));

  saveRequestsToStorage();
  refreshAllTables();
  showNotification(`ØªÙ… Ø§Ù„Ø³Ø­Ø¨ØŒ ÙˆØ¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: ${requests.length}`, 'success');
}



// Login

async function login(e) {
  e.preventDefault();

  const loginBtn = document.getElementById('loginBtn');
  loginBtn.disabled = true;
  loginBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';

  const employeeId = document.getElementById('employeeId').value.trim();
  const password   = document.getElementById('password').value.trim();
  const scriptUrl  = document.getElementById('appsScriptUrl').value.trim();

  try {
    // Ù„Ùˆ Ø§Ù„ÙƒÙˆÙ†ÙÙ‚ Ù…Ø§ Ø¹Ø·Ø§Ù†Ø§ URL: Ø®Ø°Ù‡ Ù…Ù† Ø§Ù„Ø­Ù‚Ù„ ÙˆØ§Ø­ÙØ¸Ù‡
    if (!appsScriptUrl && scriptUrl) {
      appsScriptUrl = scriptUrl;
      localStorage.setItem('appsScriptUrl', scriptUrl);
    }
    // ÙØ±Ø¶ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙƒØªØ¨ URL Ø¬Ø¯ÙŠØ¯
    if (scriptUrl) {
      appsScriptUrl = scriptUrl;
      localStorage.setItem('appsScriptUrl', scriptUrl);
    }

    const gsEnabled = CONFIG?.googleSheets?.enabled === true;
    const offlineOK = CONFIG?.advanced?.offlineMode === true;

    if (gsEnabled && !appsScriptUrl && !offlineOK) {
      alert('âš ï¸ Ø±Ø¬Ø§Ø¡Ù‹ Ø¶Ø¨Ø· Ø±Ø§Ø¨Ø· Google Apps Script (Ø£Ùˆ ÙØ¹Ù‘Ù„ ÙˆØ¶Ø¹ Ø§Ù„Ø£ÙˆÙÙ„Ø§ÙŠÙ† ÙÙŠ config.json)');
      loginBtn.disabled = false;
      loginBtn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
      return;
    }

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø¹Ø¨Ø± GAS
    const res = await callAppsScript('login', { id: employeeId, password });
    if (!res || !res.ok || !res.user) {
      alert(res && res.message ? res.message : 'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
      loginBtn.disabled = false;
      loginBtn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
      return;
    }

    currentUser = {
      id: res.user.id,
      name: res.user.name,
      role: res.user.role,
      email: res.user.email,
      specialty: res.user.specialty || ''
    };
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    loginBtn.textContent = 'ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„';
    showMainApp();

  } catch (error) {
    console.error('Login error:', error);
    alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
    loginBtn.disabled = false;
    loginBtn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
  }
}


// Logout
function logout() {
  if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
    currentUser = null;
    localStorage.removeItem('currentUser');
    location.reload();
  }
}

// Show Main App
async function showMainApp() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('userBar').style.display = 'flex';
  document.getElementById('mainContainer').style.display = 'block';

  document.getElementById('userName').textContent = currentUser.name;
  document.getElementById('userRole').textContent = currentUser.role;

  setupPermissions();
  lockRequesterToCurrentUser();

  // âœ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…ÙˆØ­Ø¯Ø© Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
  const hasPending = syncQueue.queue.length > 0;
  
  if (hasPending) {
    showSyncIndicator('syncing', `â³ Ù…Ø²Ø§Ù…Ù†Ø© ${syncQueue.queue.length} Ø¹Ù…Ù„ÙŠØ©...`, false);
    await syncQueue.process();
  }
  
  // Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨ØµÙ…Øª (Ù„Ø£Ù† Queue Ø¹Ø§Ù„Ø¬Ù‡Ø§ Ø¨Ø§Ù„ÙØ¹Ù„)
  await autoSync(true);
  await loadTechnicians();

  refreshAllTables();
}

// ===== [NEW] Transition rules =====
const TRANSITIONS = {
  submitNew:      { from:[null],             to:STATUS.WAIT_SUP,    by:[ROLE.EMPLOYEE],    must: ['image'] },

  supAssign:      { from:[STATUS.WAIT_SUP, STATUS.NEEDS_REVIEW, STATUS.TECH_REVIEW],
                    to:STATUS.ASSIGNED,     by:[ROLE.SUPERVISOR, ROLE.QUALITY_MANAGER, ROLE.DEAN],
                    must: ['assignedTechnicianName'] },

  techReport:     { from:[STATUS.ASSIGNED],  to:STATUS.TECH_REVIEW, by:[ROLE.TECHNICIAN, ROLE.SUPERVISOR],
                    must: ['workStatus','technicianNotes','repairImage'] },

  supApprove:     { from:[STATUS.TECH_REVIEW], to:STATUS.APPROVED,  by:[ROLE.SUPERVISOR, ROLE.QUALITY_MANAGER, ROLE.DEAN],
                    must: [], post: ['requireTechnicianAssignedOrBlock'] },

  supReject:      { from:[STATUS.TECH_REVIEW, STATUS.WAIT_SUP], to:STATUS.REJECTED,
                    by:[ROLE.SUPERVISOR, ROLE.QUALITY_MANAGER, ROLE.DEAN] },

  supNeedsReview: { from:[STATUS.TECH_REVIEW, STATUS.WAIT_SUP], to:STATUS.NEEDS_REVIEW,
                    by:[ROLE.SUPERVISOR, ROLE.QUALITY_MANAGER, ROLE.DEAN] },

  clientFeedbackYes: { from:[STATUS.APPROVED], to:STATUS.COMPLETED, by:[ROLE.EMPLOYEE] },
  clientFeedbackNo:  { from:[STATUS.APPROVED], to:STATUS.NOT_FIXED, by:[ROLE.EMPLOYEE] },

  clientRedirect: { from:[STATUS.ASSIGNED, STATUS.NEEDS_REVIEW, STATUS.TECH_REVIEW, STATUS.APPROVED],
                    to:STATUS.WAIT_SUP, by:[ROLE.EMPLOYEE],
                    must: ['redirectReason'], post: ['clearAssignedTechnician'] },

  clientCancel:   { from:[STATUS.WAIT_SUP, STATUS.ASSIGNED, STATUS.NEEDS_REVIEW],
                    to:STATUS.CANCELED, by:[ROLE.EMPLOYEE], must: ['cancelReason'] },

          softDelete: { 
          from:['*'], 
          to: STATUS.DELETED, 
          by:[ROLE.SUPERVISOR, ROLE.QUALITY_MANAGER, ROLE.DEAN, ROLE.EMPLOYEE], 
          must: ['deleteReason'] 
        },


        assignTechnician: { 
          from:[STATUS.WAIT_SUP, STATUS.NEEDS_REVIEW, STATUS.TECH_REVIEW],
          to: STATUS.ASSIGNED,
          by:[ROLE.SUPERVISOR, ROLE.QUALITY_MANAGER, ROLE.DEAN],
          must: ['assignedTechnicianName']
        },

        supervisorDecision: {
          from:[STATUS.TECH_REVIEW, STATUS.WAIT_SUP],
          to: STATUS.APPROVED, // ØµÙˆØ±ÙŠØ› Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØ¹Ù„ÙŠ ÙÙŠ switch
          by:[ROLE.SUPERVISOR, ROLE.QUALITY_MANAGER, ROLE.DEAN],
          must: ['decision'],
          post: ['requireTechnicianAssignedOrBlock']
        },

};

// ===== [NEW] Guards & post hooks =====
function canTransition({action, from, byRole, payload}) {
  const rule = TRANSITIONS[action]; if (!rule) return [false,'Action ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…'];
  if (rule.from[0] !== '*' && !rule.from.includes(from)) return [false,'Ø§Ù†ØªÙ‚Ø§Ù„ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø©'];
  if (!rule.by.includes(byRole)) return [false,'ØµÙ„Ø§Ø­ÙŠØ© ØºÙŠØ± ÙƒØ§ÙÙŠØ©'];
  if (rule.must?.some(k => !payload?.[k])) return [false,`Ù†ÙˆØ§Ù‚Øµ: ${rule.must.filter(k=>!payload?.[k]).join(', ')}`];
  return [true, null];
}

function applyPostHooks(rule, req, payload) {
  const posts = rule.post || [];
  if (posts.includes('requireTechnicianAssignedOrBlock') && !req.assignedTechnicianName) {
    throw new Error('ÙŠØ¬Ø¨ ØªØ¹ÙŠÙŠÙ† ÙÙ†ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯');
  }
  if (posts.includes('clearAssignedTechnician')) {
    req.assignedTechnicianName = '';
  }
}


// =======================================================
// Ø¯Ø§Ù„Ù‘Ø© Ø¥Ø¯Ø§Ø±Ø© Ù…Ø³Ø§Ø± Ø§Ù„Ø·Ù„Ø¨ + Ø³Ø¬Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª (Audit Trail)
// =======================================================
// Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ø§Øª:
// updateRequestLifecycle({
//   requestId: '000123',
//   action: 'assignTechnician' | 'reassignTechnician' | 'techReport' | 'supervisorDecision' | 'clientFeedback' | 'softDelete',
//   actor: currentUser?.name,
//   role:  currentUser?.role,               // Ù…Ù† ROLES
//   payload: {...}                          // Ø­Ù‚ÙˆÙ„ Ø¥Ø¶Ø§ÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡
// });
// Ø§Ù„Ø¯Ø§Ù„Ø© ØªØ­Ø¯Ù‘Ø« Ø§Ù„Ø·Ù„Ø¨ Ù…Ø­Ù„ÙŠÙ‹Ø§ØŒ ØªØ­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø²Ù…Ù†ÙŠØŒ ÙˆØªØ¶ÙŠÙ Ø¹Ù…Ù„ÙŠØ© Ù…Ø²Ø§Ù…Ù†Ø© syncQueue ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.
// =======================================================




function updateRequestLifecycle({ requestId, action, actor, role, payload = {} }) {
  if (!requestId || !action) {
    console.warn('updateRequestLifecycle: requestId/action Ù…ÙÙ‚ÙˆØ¯');
    return { ok:false, message:'requestId/action required' };
  }

  // Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ù„Ø¨
  const idx = requests.findIndex(r => r.id === requestId);
  if (idx === -1) return { ok:false, message:'Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯' };

  const req = requests[idx];
  const before = JSON.parse(JSON.stringify(req));           // Ù†Ø³Ø®Ø© Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
  const nowISO = new Date().toISOString();

  // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø³Ø¬Ù„ ØªØ¹Ø¯ÙŠÙ„Ø§Øª
  if (!Array.isArray(req.audit)) req.audit = [];

  // Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ØµØºÙŠØ±Ø©
    const pushAudit = (evt) => {
      const record = {
        ts: nowISO,
        actor: actor || '',
        role:  role  || '',
        action,
        fromStatus: evt.fromStatus ?? (req.status || ''),
        toStatus:   evt.toStatus   ?? (req.status || ''),
        reason:     evt.reason     ?? '',
        changes:    evt.changes    ?? {},
        requestId:  req.id,
        requester:  req.requesterName || '',
        building:   req.building || '',
      };
      // Ø®Ø²Ù‘Ù† Ù…Ø­Ù„ÙŠÙ‹Ø§
      req.audit.push(record);
      // Ø£Ø±Ø³Ù„ Ù†Ø³Ø®Ø© Ù„Ù„Ø´ÙŠØª (ÙˆØ±Ù‚Ø© Logs)
      sendAuditToSheet(record);
    };


  const applyChanges = (changesObj) => {
    Object.entries(changesObj || {}).forEach(([k,v]) => { req[k] = v; });
  };

  // Ù‚ÙŠÙˆØ¯ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø¨Ø³Ø·Ø©
  const isSupervisor = role === ROLES.SUPERVISOR || role === ROLES.QUALITY_MANAGER || role === ROLES.DEAN;
  const isTechnician = role === ROLES.TECHNICIAN;
  const isEmployee   = role === ROLES.EMPLOYEE;

  // Ø§Ù†ØªÙ‚Ø§Ù„Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© ÙˆÙÙ‚ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡
      const rule = TRANSITIONS[action];
    const [ok, err] = canTransition({
      action,
      from: (req.status || null),
      byRole: role,
      payload
    });
    if (!ok) return { ok:false, message: err };

    let toStatus = rule.to;

  let reason   = '';

  switch (action) {
    // 1) ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ†ÙŠ (Ø£ÙˆÙ„ Ù…Ø±Ø©) Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø´Ø±Ù
      case 'assignTechnician': {
        if (!isSupervisor) return { ok:false, message:'Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø·' };
        const techName = payload.technicianName || payload.assignedTechnicianName;
        if (!techName) return { ok:false, message:'ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ' };

        applyChanges({
          assignedTechnicianName: techName,
          technicianName: techName,            // â† Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±
          supervisorName: actor || req.supervisorName || '',
          supervisorDecision: req.supervisorDecision || '',
          supervisorNotes: payload.supervisorNotes || req.supervisorNotes || '',
          supUpdatedAt: nowISO
        });

        toStatus = 'Ù…Ø­ÙˆÙ‘Ù„ Ù„Ù„ÙÙ†ÙŠ';
        applyChanges({ status: toStatus });
        break;
      }


    // 2) Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ†ÙŠ Ù„Ø§Ø­Ù‚Ù‹Ø§ (Ø¨ÙƒÙ„ Ø³Ù‡ÙˆÙ„Ø©) Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø´Ø±Ù
    case 'reassignTechnician': {
      if (!isSupervisor) return { ok:false, message:'Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø·' };
      const newTech = payload.technicianName || payload.assignedTechnicianName;
      if (!newTech) return { ok:false, message:'ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯' };

      // Ø§Ø­ÙØ¸ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø§Øª
      if (!Array.isArray(req.reassignments)) req.reassignments = [];
      req.reassignments.push({
        from: req.assignedTechnicianName || '',
        to: newTech,
        ts: nowISO,
        by: actor || ''
      });

      applyChanges({
        assignedTechnicianName: newTech,
        supervisorName: actor || req.supervisorName || '',
        supervisorNotes: payload.supervisorNotes || req.supervisorNotes || '',
        supUpdatedAt: nowISO
      });

      // Ù†Ø¨Ù‚ÙŠ Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ â€œÙ…Ø­ÙˆÙ‘Ù„ Ù„Ù„ÙÙ†ÙŠâ€ Ø¥Ù† ÙƒØ§Ù† Ù…Ø³Ø§Ø± Ø§Ù„ÙÙ†ÙŠ Ù„Ù… ÙŠÙƒØªÙ…Ù„
      if (req.status !== 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' && req.status !== 'Ù…ÙƒØªÙ…Ù„') {
        toStatus = 'Ù…Ø­ÙˆÙ‘Ù„ Ù„Ù„ÙÙ†ÙŠ';
        applyChanges({ status: toStatus });
      }
      break;
    }

    // 3) ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙÙ†ÙŠ
    case 'techReport': {
      if (!isTechnician && !isSupervisor)
        return { ok:false, message:'Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙÙ†ÙŠ Ø£Ùˆ Ø§Ù„Ù…Ø´Ø±Ù' };

      if (!payload.workStatus || !payload.technicianNotes)
        return { ok:false, message:'Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„ ÙˆÙ…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙÙ†ÙŠ' };

      applyChanges({
        technicianName: payload.technicianName || req.technicianName || actor || '',
        workStatus: payload.workStatus,
        technicianNotes: payload.technicianNotes,
        repairImage: payload.repairImage || req.repairImage || '',
        techUpdatedAt: nowISO
      });

      // Ø¨Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ ØªÙ‚Ø±ÙŠØ± ÙÙ†ÙŠØŒ ÙŠØ±Ø¬Ø¹ Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø´Ø±Ù
      toStatus = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©';
      applyChanges({ status: toStatus });
      break;
    }

    // 4) Ù‚Ø±Ø§Ø± Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (Ø§Ø¹ØªÙ…Ø§Ø¯/Ø±ÙØ¶/ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©)
    case 'supervisorDecision': {
      const isSupervisor = role === ROLES.SUPERVISOR || role === ROLES.QUALITY_MANAGER || role === ROLES.DEAN;
      if (!isSupervisor) return { ok:false, message:'Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø·' };
      if (!payload.decision) return { ok:false, message:'Ø­Ø¯Ø¯ Ø§Ù„Ù‚Ø±Ø§Ø±' };
      if (payload.decision === 'Ù…Ø¹ØªÙ…Ø¯' && !(req.assignedTechnicianName||'').trim()) {
        return { ok:false, message:'ÙŠØ¬Ø¨ ØªØ¹ÙŠÙŠÙ† ÙÙ†ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯' };
      }

      applyChanges({
        supervisorName: actor || req.supervisorName || '',
        supervisorDecision: payload.decision, // 'Ù…Ø¹ØªÙ…Ø¯' | 'Ù…Ø±ÙÙˆØ¶' | 'ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©'
        supervisorNotes: payload.supervisorNotes || req.supervisorNotes || '',
        supUpdatedAt: nowISO
      });

      // âœ… Ø¶Ø¨Ø· Ø§Ù„Ø­Ø§Ù„Ø© Ù‡Ù†Ø§ ÙÙ‚Ø·ØŒ Ø¨Ø¯ÙˆÙ† ØªØ¹Ø¯ÙŠÙ„ Ø®Ø§Ø±Ø¬ÙŠ Ù„Ø§Ø­Ù‚Ù‹Ø§
      if (payload.decision === 'Ù…Ø±ÙÙˆØ¶') {
        toStatus = STATUS.REJECTED; // 'Ù…Ø±ÙÙˆØ¶'
      } else if (payload.decision === 'Ù…Ø¹ØªÙ…Ø¯') {
        // Ø¨Ø¹Ø¯ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù…Ø´Ø±Ù â†’ ØªØ°Ù‡Ø¨ Ù„Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
        toStatus = STATUS.WAIT_SAFETY_2; // 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³Ù„Ø§Ù…Ø© (Ù†Ù‡Ø§Ø¦ÙŠØ©)'
      } else {
        toStatus = STATUS.NEEDS_REVIEW; // 'ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©'
      }

      applyChanges({ status: toStatus });
      break;
    }

    // 5) ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ù…ÙŠÙ„
    case 'clientFeedback': {
      if (!isEmployee && !isSupervisor) {
        // Ø¹Ø§Ø¯Ø© ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨ Ø£Ùˆ Ø§Ù„Ù…Ø´Ø±Ù Ø¨Ø§Ù„Ù†ÙŠØ§Ø¨Ø©
        return { ok:false, message:'Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù„ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨ Ø£Ùˆ Ø§Ù„Ù…Ø´Ø±Ù' };
      }
      if (!payload.isFixed) return { ok:false, message:'Ø­Ø¯Ø¯: Ù‡Ù„ ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­ØŸ' };

      applyChanges({
        isFixed: payload.isFixed,                                 // 'Ù†Ø¹Ù…' | 'Ù„Ø§'
        satisfactionLevel: payload.satisfactionLevel || '',
        clientNotes: payload.clientNotes || '',
        clientUpdatedAt: nowISO
      });

      toStatus = (payload.isFixed === 'Ù†Ø¹Ù…') ? 'Ù…ÙƒØªÙ…Ù„' : 'ØºÙŠØ± Ù…ÙƒØªÙ…Ù„';
      applyChanges({ status: toStatus });
      break;
    }

    // 6) Ø­Ø°Ù (ØªØ­ÙˆÙŠÙ„ Ù„Ù…Ø­Ø°ÙˆÙ + Ø³Ø¨Ø¨)
    case 'softDelete': {
        // Ù„Ùˆ Ù…ÙˆØ¸Ù: Ù„Ø§ ÙŠØ­Ø°Ù Ø¥Ù„Ø§ Ø·Ù„Ø¨Ù‡
        if (role === ROLES.EMPLOYEE && (req.requesterName||'') !== (currentUser?.name||'')) {
          return { ok:false, message:'Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ø·Ù„Ø¨ Ù„ÙŠØ³ Ù…Ù„ÙƒÙƒ' };
        }
        const reason = (payload.deleteReason || payload.reason || '').toString().trim();
        if (!reason) return { ok:false, message:'ÙŠØ¬Ø¨ ØªÙˆØ«ÙŠÙ‚ Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø°Ù' };

        toStatus = 'Ù…Ø­Ø°ÙˆÙ';
        applyChanges({
          status: 'Ù…Ø­Ø°ÙˆÙ',
          deletedAt: nowISO,
          deletedBy: actor || '',
          deleteReason: reason
        });

        syncQueue.add({ type:'delete', data:{ id: req.id, reason } });

        try { applyPostHooks(rule, req, payload); } catch(e){ return { ok:false, message: e.message }; }

        pushAudit({ fromStatus: before.status, toStatus, reason, changes:{ deleteReason: reason } });
        saveRequestsToStorage();
        refreshAllTables();
        return { ok:true, request: req };
      }


        // 7) Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ù…Ù† ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±Ù Ù…Ø¹ Ø³Ø¨Ø¨
      case 'clientRedirect': {
        if (role !== ROLES.EMPLOYEE && role !== ROLES.SUPERVISOR) {
          return { ok:false, message:'Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù…ØªØ§Ø­ Ù„ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨ (Ø£Ùˆ Ø§Ù„Ù…Ø´Ø±Ù Ø¨Ø§Ù„Ù†ÙŠØ§Ø¨Ø©)' };
        }
        const r = (payload.redirectReason || payload.reason || '').trim();
        if (!r) return { ok:false, message:'Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø³Ø¨Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡' };
        if ((req.status||'').trim() === STATUS.WAIT_SUP) {
          return { ok:false, message:'Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ø¯Ù‰ Ø§Ù„Ù…Ø´Ø±Ù' };
        }
        req.cycleNo = (req.cycleNo||0) + 1;
        if (req.cycleNo > 2) {
          return { ok:false, message:'ØªÙ… Ø¨Ù„ÙˆØº Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù…Ù† Ù…Ø±Ø§Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡' };
        }

        toStatus = STATUS.WAIT_SUP; // â† Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
        applyChanges({
          redirectReason: r,
          status: toStatus,
          assignedTechnicianName: '', // ØªÙØ±ÙŠØº Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ù„ÙŠÙØ¹Ø§Ø¯ Ø§Ù„ØªÙˆØ²ÙŠØ¹
          supUpdatedAt: nowISO
        });
        break;
      }



    // 8) Ø¥Ù„ØºØ§Ø¡ Ù…Ù† ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø¹ Ø³Ø¨Ø¨
    case 'clientCancel': {
      if (role !== ROLES.EMPLOYEE && role !== ROLES.SUPERVISOR) {
        return { ok:false, message:'Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù…ØªØ§Ø­ Ù„ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨ (Ø£Ùˆ Ø§Ù„Ù…Ø´Ø±Ù Ø¨Ø§Ù„Ù†ÙŠØ§Ø¨Ø©)' };
      }
      const r = (payload.cancelReason || payload.reason || '').trim();
      if (!r) return { ok:false, message:'Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡' };

      toStatus = 'Ù…Ù„ØºÙŠ';
      applyChanges({
        status: 'Ù…Ù„ØºÙŠ',
        cancelReason: r,
        canceledAt: nowISO,
        canceledBy: actor || ''
      });

      // Ø§Ø¯ÙØ¹ ØªØ­Ø¯ÙŠØ« Ù„Ù„Ø´ÙŠØª
      syncQueue.add({ type:'update', data: req });

      pushAudit({ fromStatus: before.status, toStatus, reason: r, changes:{ cancelReason:r } });
      saveRequestsToStorage();
      refreshAllTables();
      return { ok:true, request: req };
    }


    default:
      return { ok:false, message:'Action ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø©' };
  }

  // Ø§Ø®ØªÙ„Ø§ÙØ§Øª Ø¨Ø³ÙŠØ·Ø© Ù„Ù„ØªÙˆØ«ÙŠÙ‚
  const changes = diffObject(before, req, [
    'assignedTechnicianName','technicianName','workStatus','technicianNotes','repairImage',
    'supervisorName','supervisorDecision','supervisorNotes',
    'isFixed','satisfactionLevel','clientNotes','status'
  ]);

  pushAudit({ fromStatus: before.status, toStatus, changes });

  // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ ÙˆØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø©
  saveRequestsToStorage();
  refreshAllTables();

  // Ø§Ù„Ø¯ÙØ¹ Ø¥Ù„Ù‰ GAS (add/update Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©)
  const opType = (action === 'assignTechnician' || action === 'reassignTechnician' || action === 'techReport' || action === 'supervisorDecision' || action === 'clientFeedback')
    ? 'update' : 'add';

  syncQueue.add({ type: opType, data: req });

  return { ok:true, request: req };
}

// ====== Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª ======
function diffObject(prev, next, keysWhitelist = []) {
  const changes = {};
  const keys = keysWhitelist.length ? keysWhitelist : Array.from(new Set([...Object.keys(prev||{}), ...Object.keys(next||{})]));
  keys.forEach(k => {
    const a = prev?.[k];
    const b = next?.[k];
    if (JSON.stringify(a) !== JSON.stringify(b)) {
      changes[k] = { from: a, to: b };
    }
  });
  return changes;
}


// Auto Sync - Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
// âœ… ØªØ²Ø§Ù…Ù† Ù…ÙˆØ­Ù‘Ø¯: Ø§Ù„Ø´ÙŠØª Ù‡Ùˆ Ù…ØµØ¯Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø©
async function autoSync(silent = false) {
  if (!appsScriptUrl) return;

  // 1) Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù‘Ù‚Ø© Ø£ÙˆÙ„Ø§Ù‹ (Ù„Ùˆ ÙÙŠÙ‡ Queue)
  if (syncQueue.queue.length > 0) {
    if (!silent) showSyncIndicator('syncing', `â³ Ù…Ø¹Ø§Ù„Ø¬Ø© ${syncQueue.queue.length} Ø¹Ù…Ù„ÙŠØ©...`, false);
    try {
      await syncQueue.process();
    } catch (e) {
      console.warn('ØªØ¹Ø°Ù‘Ø± Ø¥ÙØ±Ø§Øº Ø§Ù„ØµÙ ÙƒØ§Ù…Ù„Ø§Ù‹ Ø§Ù„Ø¢Ù†ØŒ Ø³Ù†ÙƒÙ…Ù„ Ø§Ù„Ø³Ø­Ø¨ Ù…Ù† Ø§Ù„Ø´ÙŠØª', e);
    }
  }

  if (!silent) showSyncIndicator('syncing', 'â†“ Ø³Ø­Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', false);

  try {
    const res = await callAppsScript('getRequests', requestScope(), false);
    if (!res || !Array.isArray(res.data)) {
      if (!silent) showSyncIndicator('error', 'âœ— ÙØ´Ù„ Ø§Ù„Ø³Ø­Ø¨ Ù…Ù† Ø§Ù„Ø´ÙŠØª');
      return;
    }

    // 2) ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¥Ù„Ù‰ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    let sheetRequests = res.data.map(mapArabicRowToModel).map(r => ({
      ...r,
      requesterName: r.requesterName || r.createdBy || '',
    }));

    // 3) Ø§Ø®ØªÙŠØ§Ø±ÙŠ: ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù…Ø­Ø°ÙˆÙ Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„Ø¹Ø±Ø¶ (Ø£Ùˆ Ø§ØªØ±ÙƒÙ‡ Ø¥Ù† ØªØ­Ø¨ Ø¥Ø¸Ù‡Ø§Ø±Ù‡)
    // Ø¥Ù† Ø±ØºØ¨Øª Ø¨Ø¥Ø®ÙØ§Ø¦Ù‡ ØªÙ…Ø§Ù…Ù‹Ø§ Ù…Ù† Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„:
    // sheetRequests = sheetRequests.filter(r => r.status !== 'Ù…Ø­Ø°ÙˆÙ');

    // 4) Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙƒØ§Ù…Ù„ Ù„Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© (Ø¨Ø¯ÙˆÙ† Ø¯Ù…Ø¬ Ø¹ÙƒØ³ÙŠ)
    requests = sheetRequests;
    saveRequestsToStorage();
    refreshAllTables();
    updateNextRequestId();

    requests = (requests || []).map(r => ({
  ...r,
      // Ù„Ùˆ ÙˆØ§Ø­Ø¯ Ù…Ù†Ù‡Ù… ÙØ§Ø¶ÙŠØŒ Ø¹Ø¨Ù‘ÙŠÙ‡ Ù…Ù† Ø§Ù„Ø¢Ø®Ø±
      assignedTechnicianName: r.assignedTechnicianName || r.technicianName || '',
      technicianName: r.technicianName || r.assignedTechnicianName || ''
    }));

    if (!silent) showSyncIndicator('success', 'âœ“ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ø¯Ù‘Ø«Ø©');

  } catch (err) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©:', err);
    if (!silent) showSyncIndicator('error', 'âœ— ÙØ´Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©');
  }
}

// Setup Permissions
function setupPermissions() {
  const tabsBtns = document.querySelectorAll('.nav-tab');
  tabsBtns.forEach(tab => tab.style.display = 'none');

  const show = (id) => {
    const btn = document.querySelector(`[onclick="showTab('${id}')"]`);
    if (btn) btn.style.display = 'block';
  };

  const role = (currentUser?.role || '').trim();

  if (role === ROLES.QUALITY_MANAGER || role === ROLES.DEAN) {
    // ÙŠØ´ÙˆÙ ÙƒÙ„ Ø´ÙŠØ¡
    ['new-request','safety-review-1','supervisor-review','technician-report','safety-review-2','client-feedback','my-requests','quality-report']
      .forEach(show);
    showTab('safety-review-1');
    return;
  }

  if (role === ROLES.SAFETY_OFFICER) {
    // Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø³Ù„Ø§Ù…Ø©: Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ØªÙŠÙ† + Ø§Ù„Ø¬ÙˆØ¯Ø©
    ['safety-review-1','safety-review-2','quality-report'].forEach(show);
    showTab('safety-review-1');
    return;
  }

  if (role === ROLES.SUPERVISOR) {
    // Ù…Ø´Ø±Ù Ø§Ù„ØµÙŠØ§Ù†Ø©: ØªØ¹ÙŠÙŠÙ† ÙÙ†ÙŠ/Ù‚Ø±Ø§Ø± + Ø§Ù„Ø¬ÙˆØ¯Ø©
    ['supervisor-review','quality-report'].forEach(show);
    showTab('supervisor-review');
    return;
  }

  if (role === ROLES.TECHNICIAN) {
    // Ø§Ù„ÙÙ†ÙŠ: ÙÙ‚Ø· ØªÙ‚Ø§Ø±ÙŠØ±Ù‡
    ['technician-report'].forEach(show);
    showTab('technician-report');
    return;
  }

  // Ø§Ù„Ù…ÙˆØ¸Ù (ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨)
  if (role === ROLES.EMPLOYEE) {
    ['new-request','my-requests','client-feedback'].forEach(show);
    showTab('my-requests');
  }
}

// Show Tab
function showTab(tabId) {
  // ÙØ¹Ù‘Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
  document.querySelectorAll('.tab-content').forEach(c => {
    c.classList.toggle('active', c.id === tabId);
  });

  // ÙØ¹Ù‘Ù„ Ø²Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚
  document.querySelectorAll('.nav-tab').forEach(btn => {
    const isMatch = btn.getAttribute('onclick') === `showTab('${tabId}')`;
    btn.classList.toggle('active', isMatch);
  });

  refreshAllTables();
}


// Set Current DateTime
function setCurrentDateTime() {
  const now = new Date();
  const time = now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
  const date = now.toLocaleDateString('ar-SA');
  const hijri = toHijri(now);
  const day = getArabicDay(now);
  
  document.getElementById('requestTime').value = time;
  document.getElementById('requestDate').value = date;
  document.getElementById('hijriDate').value = hijri;
  document.getElementById('requestDay').value = day;
}

// Update Request ID

function updateNextRequestId() {
  const idInput = document.getElementById('requestId');
  if (!idInput) return;

  const list = Array.isArray(requests) ? requests : [];
  const maxId = list.reduce((max, r) => {
    const n = parseInt((r?.id || '0').toString().replace(/\D+/g, ''), 10);
    return Number.isFinite(n) && n > max ? n : max;
    // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ùˆ ØªØ³ØªØ®Ø¯Ù… IDs ØºÙŠØ± Ø±Ù‚Ù…ÙŠØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŒ Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø¨Ù…ÙˆÙ„Ù‘Ø¯ UUID Ù…Ù† Ø¬Ù‡Ø© Ø§Ù„Ø´ÙŠØª
  }, 0);

  const nextId = (maxId + 1).toString().padStart(6, '0');
  idInput.value = nextId;
}

// Toggle Other Fault
function toggleOtherFault() {
  const faultType = document.getElementById('faultType').value;
  const otherDiv = document.getElementById('otherFaultDiv');
  
  if (faultType === 'Ø£Ø®Ø±Ù‰') {
    otherDiv.classList.remove('hidden');
    document.getElementById('otherFault').required = true;
  } else {
    otherDiv.classList.add('hidden');
    document.getElementById('otherFault').required = false;
  }
}

// Reset Form
function resetForm() {
  removeImage();
  updateNextRequestId();
  setCurrentDateTime();
}

// Submit New Request

// âœ… Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨: Ø§Ù„Ø´ÙŠØª Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
async function submitNewRequest(e) {
  e.preventDefault();

  const submitBtn = document.getElementById('submitRequestBtn');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';

  if (!uploadedImage) {
    alert('âŒ ÙŠØ¬Ø¨ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø·Ù„ Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨');
    submitBtn.disabled = false;
    submitBtn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨';
    return;
  }

  const faultType = document.getElementById('faultType').value;
  const finalFaultType = faultType === 'Ø£Ø®Ø±Ù‰' ? document.getElementById('otherFault').value : faultType;
  const requesterNameFinal = currentUser?.name || '';

const request = {
  id: document.getElementById('requestId').value,
  type: document.getElementById('requestType').value,
  building: document.getElementById('building').value,
  maintenanceType: document.getElementById('maintenanceType').value,
  requesterName: requesterNameFinal,
  time: document.getElementById('requestTime').value,
  date: document.getElementById('requestDate').value,
  hijriDate: document.getElementById('hijriDate').value,
  day: document.getElementById('requestDay').value,
  faultType: finalFaultType,
  faultDescription: document.getElementById('faultDescription').value,
  image: uploadedImage || '',
  status: 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³Ù„Ø§Ù…Ø© (Ø£ÙˆÙ„ÙŠØ©)',  // â† Ø§Ù„ØªØµØ­ÙŠØ­
  createdAt: new Date().toISOString(),
  createdBy: currentUser?.name || ''
};

  try {
    // 1) Ø­Ø§ÙˆÙ„ Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø´ÙŠØª Ù…Ø¨Ø§Ø´Ø±Ø©
    const res = await callAppsScript('addRequest', request);
    if (!res || res.ok !== true) throw new Error(res?.message || 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø´ÙŠØª');

    // 2) Ø¨Ø¹Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ø´ÙŠØª: Ø§Ø³Ø­Ø¨ Ù†Ø³Ø®Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙƒØ§Ù…Ù„Ø© (Ù…ØµØ¯Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø©)
    await autoSync(true);

    showAlert('newRequestAlert', 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨Ù„Ø§Øº Ø¨Ù†Ø¬Ø§Ø­! Ø±Ù‚Ù… Ø§Ù„Ø¨Ù„Ø§Øº: ' + request.id, 'success');


  } catch (err) {
    console.warn('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø¢Ù†ØŒ Ø³Ù†Ø¶ÙŠÙÙ‡ Ù„Ù„ØµÙ:', err.message);

    // 3) ØµÙ Ø§Ù†ØªØ¸Ø§Ø± (Offline-first) + Ø¥Ø¯Ø±Ø§Ø¬ Ù…Ø­Ù„ÙŠ Ù…Ø¤Ù‚Øª Ø­ØªÙ‰ Ù„Ø§ ÙŠØ¶ÙŠØ¹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    requests.push(request);
    saveRequestsToStorage();
    refreshAllTables();

    syncQueue.add({ type: 'add', data: request });
    showAlert('newRequestAlert', 'ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙˆØ³ÙŠØªÙ… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ ØªÙˆÙØ± Ø§Ù„Ø§ØªØµØ§Ù„', 'info');
  }

  // 4) Ù†Ø¸Ø§ÙØ© ÙˆØ§Ø¬Ù‡Ø©
  document.getElementById('newRequestForm').reset();
  removeImage();
  updateNextRequestId();
  setCurrentDateTime();
  lockRequesterToCurrentUser();
  showTab('my-requests'); // âœ… ØªØ­ÙˆÙŠÙ„ ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø·Ù„Ø¨Ù‡

  const a = document.getElementById('myRequestsAlert');
  if (a) {
    a.textContent = 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ! ÙŠÙ…ÙƒÙ†Ùƒ Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø³Ø§Ø±Ù‡ Ù…Ù† Ù‡Ù†Ø§.';
    a.style.display = 'block';
    setTimeout(() => a.style.display = 'none', 4000);
  }

  submitBtn.disabled = false;
  submitBtn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨';

  setTimeout(() => { document.getElementById('newRequestAlert').style.display = 'none'; }, 5000);
}


// Open Technician Modal
function openTechnicianModal(requestId) {
  document.getElementById('techRequestId').value = requestId;
  document.getElementById('technicianName').value = currentUser.name;
  
  // Ø§Ù…Ø³Ø­ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
  techRepairImage = null;
  document.getElementById('techRepairImagePreview').classList.remove('show');
  document.getElementById('removeTechImageBtn').classList.remove('show');
  document.getElementById('techUploadContainer').classList.remove('has-image');
  document.getElementById('techRepairImage').value = '';
  
  document.getElementById('technicianModal').classList.add('active');
}

// Submit Technician Report
async function submitTechnicianReport(e) {
  e.preventDefault();
  
  const requestId = document.getElementById('techRequestId').value;

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØµÙˆØ±Ø© Ø§Ù„Ø¥ØµÙ„Ø§Ø­
      if (!techRepairImage) {
        alert('âŒ ÙŠØ¬Ø¨ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
        return;
      }
      const request = requests.find(r => r.id === requestId);
      
      const res = updateRequestLifecycle({
      requestId,
      action: 'techReport',
      actor: currentUser?.name,
      role:  currentUser?.role,
      payload: {
        technicianName: document.getElementById('technicianName').value,
        workStatus: document.getElementById('workStatus').value,
        technicianNotes: document.getElementById('technicianNotes').value,
        repairImage: techRepairImage
      }
    });
    if(!res.ok){ alert(res.message); return; }

    closeModal('technicianModal');
    techRepairImage = null;
    showAlert('technicianAlert', 'ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!', 'success');
    document.getElementById('technicianForm').reset();
    refreshAllTables();
    setTimeout(()=>{ document.getElementById('technicianAlert').style.display='none'; },3000);

}

// Open Supervisor Modal
async function openSupervisorModal(requestId) {
  if (techniciansLoading || !techniciansLoaded) {
    showNotification('â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙ†ÙŠÙŠÙ†...', 'info');
    if (!techniciansLoading && !techniciansLoaded) { try { await loadTechnicians(); } catch(_){} }
    if (!techniciansLoaded) return;
  }

  const req = requests.find(r => r.id === requestId);
  document.getElementById('supRequestId').value = requestId;
  document.getElementById('supervisorName').value = currentUser.name;

  // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙÙ†ÙŠÙŠÙ† Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„
  populateTechnicianSelect(req?.faultType || '');

  // Ù„Ùˆ ÙÙŠÙ‡ ÙÙ†ÙŠ Ù…Ø¹ÙŠÙ‘ÙÙ† Ù…Ø³Ø¨Ù‚Ù‹Ø§ØŒ Ø§Ø®ØªÙØ±Ù’Ù‡
  const sel = document.getElementById('assignedTechnicianSelect');
  sel.value = req?.assignedTechnicianName || '';

  // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø±Ø§Ø±: ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯Ù…Ø§ Ø§Ù„Ø­Ø§Ù„Ø© "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©"
  const decisionBlock = document.getElementById('decisionBlock');
  const inTechReview = (req?.status || '').trim() === 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©';
  decisionBlock.style.display = inTechReview ? 'block' : 'none';

  // Ù„Ùˆ Ù…Ùˆ "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©" ÙØ¶Ù‘ÙŠ Ø§Ù„Ù‚Ø±Ø§Ø±
  if (!inTechReview) document.getElementById('supervisorDecision').value = '';

  document.getElementById('supervisorModal').classList.add('active');
}




// Submit Supervisor Review

async function submitSupervisorReview(e) {
  e.preventDefault();
  const requestId = document.getElementById('supRequestId').value;
  const notes     = document.getElementById('supervisorNotes').value;
  const chosenTech= (document.getElementById('assignedTechnicianSelect')?.value || '').trim();
  const decision  = (document.getElementById('supervisorDecision')?.value || '').trim();

  const req = requests.find(r => r.id === requestId);
  const cur = (req?.status || '').trim();

  // 1) Ù„Ùˆ Ù…Ùˆ "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©": Ù†Ø³Ù…Ø­ ÙÙ‚Ø· Ø¨Ø§Ù„ØªØ¹ÙŠÙŠÙ†
  if (cur !== 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©') {
    if (!chosenTech) { alert('Ø§Ø®ØªØ± Ø§Ù„ÙÙ†ÙŠ Ø£ÙˆÙ„Ø§Ù‹'); return; }
    const r1 = updateRequestLifecycle({
      requestId,
      action: 'assignTechnician',
      actor: currentUser?.name,
      role:  currentUser?.role,
      payload: { assignedTechnicianName: chosenTech, supervisorNotes: notes }
    });
    if (!r1.ok) { alert(r1.message); return; }
    closeModal('supervisorModal');
    showAlert('supervisorAlert','ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„ÙÙ†ÙŠ Ø¨Ù†Ø¬Ø§Ø­','success');
    return;
  }

  // 2) Ù„Ùˆ Ù†Ø­Ù† ÙÙŠ "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©": Ø§Ù„Ù‚Ø±Ø§Ø± ÙÙ‚Ø·
  if (!decision) { alert('Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø±Ø§Ø± (Ù…Ø¹ØªÙ…Ø¯ / ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©)'); return; }

const r2 = updateRequestLifecycle({
  requestId,
  action: 'supervisorDecision',
  actor: currentUser?.name,
  role:  currentUser?.role,
  payload: { decision, supervisorNotes: notes }
});

if (!r2.ok) { alert(r2.message); return; }

  closeModal('supervisorModal');
  showAlert('supervisorAlert','ØªÙ… Ø­ÙØ¸ Ù‚Ø±Ø§Ø± Ø§Ù„Ù…Ø´Ø±Ù','success');
}

// Open Safety Modal 1
function openSafetyModal1(requestId) {
  document.getElementById('safetyRequestId1').value = requestId;
  document.getElementById('safetyOfficerName1').value = currentUser.name;
  document.getElementById('safetyModal1').classList.add('active');
}

// Submit Safety Review 1
async function submitSafetyReview1(e) {
  e.preventDefault();
  
  const requestId = document.getElementById('safetyRequestId1').value;
  const decision = document.getElementById('safetyDecision1').value;
  const notes = document.getElementById('safetyNotes1').value;
  const request = requests.find(r => r.id === requestId);
  
  if (request) {
    request.safetyOfficerName1 = document.getElementById('safetyOfficerName1').value;
    request.safetyDecision1 = decision;
    request.safetyNotes1 = notes;
    request.safety1UpdatedAt = new Date().toISOString();
    

    if (decision === 'ØºÙŠØ± Ø¢Ù…Ù† - Ù…Ø±ÙÙˆØ¶') {
      request.status = 'Ù…Ø±ÙÙˆØ¶';
    } else {
      // Ø¢Ù…Ù† Ù„Ù„ØªÙ†ÙÙŠØ° Ø£Ùˆ ÙŠØ­ØªØ§Ø¬ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ù„Ø§Ù…Ø© â†’ Ù„Ù„Ù…Ø´Ø±Ù Ù…Ø¹ Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø©
      request.status = 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø´Ø±Ù';
    }
    
    saveRequestsToStorage();
    refreshAllTables();
    
    syncQueue.add({ type: 'update', data: request });
    
    closeModal('safetyModal1');
    showAlert('supervisorAlert', 'ØªÙ… Ø­ÙØ¸ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
    document.getElementById('safetyForm1').reset();
  }
}

// Open Safety Modal 2
function openSafetyModal2(requestId) {
  document.getElementById('safetyRequestId2').value = requestId;
  document.getElementById('safetyOfficerName2').value = currentUser.name;
  document.getElementById('safetyModal2').classList.add('active');
}

// Submit Safety Review 2
async function submitSafetyReview2(e) {
  e.preventDefault();
  
  const requestId = document.getElementById('safetyRequestId2').value;
  const decision = document.getElementById('safetyDecision2').value;
  const notes = document.getElementById('safetyNotes2').value;
  const request = requests.find(r => r.id === requestId);
  
  if (request) {
    request.safetyOfficerName2 = document.getElementById('safetyOfficerName2').value;
    request.safetyDecision2 = decision;
    request.safetyNotes2 = notes;
    request.safety2UpdatedAt = new Date().toISOString();
    
    if (decision === 'ØºÙŠØ± Ù…Ø¹ØªÙ…Ø¯') {
      request.status = 'Ù…Ø±ÙÙˆØ¶';
    } else {
      request.status = 'Ù…Ø¹ØªÙ…Ø¯';
    }
    
    saveRequestsToStorage();
    refreshAllTables();
    
    syncQueue.add({ type: 'update', data: request });
    
    closeModal('safetyModal2');
    showAlert('supervisorAlert', 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ù„Ø³Ù„Ø§Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
    document.getElementById('safetyForm2').reset();
  }
}

// Open Client Modal
function openClientModal(requestId) {
  document.getElementById('clientRequestId').value = requestId;
  document.getElementById('clientModal').classList.add('active');
}

// Submit Client Feedback
async function submitClientFeedback(e) {
  e.preventDefault();
  
  const requestId = document.getElementById('clientRequestId').value;
  const request = requests.find(r => r.id === requestId);
  
  if (request) {
    request.isFixed = document.getElementById('isFixed').value;
    request.satisfactionLevel = document.getElementById('satisfactionLevel').value;
    request.clientNotes = document.getElementById('clientNotes').value;
    request.status = request.isFixed === 'Ù†Ø¹Ù…' ? 'Ù…ÙƒØªÙ…Ù„' : 'ØºÙŠØ± Ù…ÙƒØªÙ…Ù„';
    request.clientUpdatedAt = new Date().toISOString();
    
    saveRequestsToStorage();
    refreshAllTables();
    
    syncQueue.add({
      type: 'update',
      data: request
    });
    
    closeModal('clientModal');
    showAlert('clientAlert', 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­! Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ', 'success');
    refreshAllTables();
    
    document.getElementById('clientForm').reset();
    
    setTimeout(() => {
      document.getElementById('clientAlert').style.display = 'none';
    }, 3000);
  }
}

// View Request Details

function detailCard({icon='â„¹ï¸', label='', value='-', extraClass=''}) {
  return `
    <div class="detail-card ${extraClass}">
      <div class="dc-ico">${icon}</div>
      <div class="dc-body">
        <div class="dc-label">${label}</div>
        <div class="dc-value">${value || '-'}</div>
      </div>
    </div>
  `;
}

function buildBasicInfoSection(req){
  const stClass = getStatusClass(req.status);
  const statusBadge = `<span class="status-badge status-${stClass}">${req.status||'-'}</span>`;
  const imgSrc = resolveImageSrc(req._faultImageResolved || req.image || req.imageUrl || '');


  return `
    <div class="details-grid">
      ${detailCard({icon:'ğŸ”¢', label:'Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨', value:req.id, extraClass:'emph'})}
      ${detailCard({icon:'ğŸ“¥', label:'Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨', value:req.type})}
      ${detailCard({icon:'ğŸ¢', label:'Ø§Ù„Ù…Ø¨Ù†Ù‰', value:req.building})}
      ${detailCard({icon:'ğŸ› ï¸', label:'Ù†ÙˆØ¹ Ø§Ù„ØµÙŠØ§Ù†Ø©', value:req.maintenanceType})}
      ${detailCard({icon:'ğŸ‘¤', label:'ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨', value:req.requesterName})}
      ${detailCard({icon:'ğŸ“…', label:'Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù…ÙŠÙ„Ø§Ø¯ÙŠ/Ù‡Ø¬Ø±ÙŠ)', value:`${req.date||'-'} â€” ${req.hijriDate||'-'}`})}
      ${detailCard({icon:'â°', label:'Ø§Ù„ÙˆÙ‚Øª', value:req.time})}
      ${detailCard({icon:'ğŸ—“ï¸', label:'Ø§Ù„ÙŠÙˆÙ…', value:req.day})}
      ${detailCard({icon:'âš¡', label:'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„', value:req.faultType})}
      ${detailCard({icon:'ğŸ‘¨â€ğŸ”§', label:'Ø§Ù„ÙÙ†ÙŠ Ø§Ù„Ù…Ø¹ÙŠÙ‘Ù†', value:req.assignedTechnicianName || req.technicianName || '-'})}
      ${detailCard({icon:'ğŸ“Œ', label:'Ø§Ù„Ø­Ø§Ù„Ø©', value:statusBadge, extraClass:'detail-status'})}
      ${detailCard({icon:'ğŸ“', label:'ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„', value:(req.faultDescription||'â€”'), extraClass:'detail-row-2'})}
      ${ imgSrc ? `
        <div class="detail-card detail-image detail-row-2">
          <div class="dc-ico">ğŸ“·</div>
          <div class="dc-body">
            <div class="dc-label">ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø·Ù„</div>
            <img src="${imgSrc}" alt="ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø·Ù„" onclick="viewImage('${imgSrc.replace(/'/g, "\\'")}')">
          </div>
        </div>` : '' }
    </div>
  `;
}


async function viewRequest(requestId) {
  const request = requests.find(r => r.id === requestId);
  if (!request) return;
  
  document.getElementById('viewDetailsContent').innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div><p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„...</p></div>';
  document.getElementById('viewModal').classList.add('active');
  
  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±
  let faultImageData = request.image || '';
  let repairImageData = request.repairImage || '';

  // Ø®Ø²Ù‘Ù† Ù†Ø³Ø®Ù‹Ø§ Ù…Ø­Ù„ÙˆÙ„Ø© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ ÙÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
request._faultImageResolved  = faultImageData || request.image || request.imageUrl || '';
request._repairImageResolved = repairImageData || request.repairImage || request.repairImageUrl || '';

  
  if (!faultImageData && request.imageUrl) {
    faultImageData = await getDriveImageAsDataURL(request.imageUrl) || request.imageUrl;
  }
  if (!repairImageData && request.repairImageUrl) {
    repairImageData = await getDriveImageAsDataURL(request.repairImageUrl) || request.repairImageUrl;
  }
  
  // Ø¨Ù†Ø§Ø¡ HTML Ù…Ø¹ Timeline Ø£ÙˆÙ„Ø§Ù‹
  let html = '<div style="text-align: right;">';

// Ø§Ù„Ù…Ø³Ø§Ø± Ø£ÙˆÙ„Ù‹Ø§
html += generateTimeline(request);

// === ØªÙØ§ØµÙŠÙ„ Ø£Ø³Ø§Ø³ÙŠØ© (Ø¨Ù†ÙØ³ Ø±ÙˆØ­ Ø§Ù„Ù…Ø³Ø§Ø±) ===
html += '<h3 style="color: #006341; margin: 25px 0 12px;">ğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h3>';
html += buildBasicInfoSection(request);

// ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙÙ†ÙŠ
// ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙÙ†ÙŠ
if (request.technicianName || request.workStatus || request.technicianNotes) {
  html += '<hr style="margin: 22px 0;">';
  html += '<h3 style="color: #006341; margin-bottom: 12px;">ğŸ”§ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙÙ†ÙŠ</h3>';

  const repImg = resolveImageSrc(request._repairImageResolved || request.repairImage || request.repairImageUrl || '');

  html += `
    <div class="details-grid">
      ${detailCard({icon:'ğŸ‘¨â€ğŸ”§', label:'Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ', value:request.technicianName||'-'})}
      ${detailCard({icon:'ğŸ“Š', label:'Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„', value:request.workStatus||'-'})}
      ${detailCard({icon:'ğŸ—’ï¸', label:'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙÙ†ÙŠ', value:request.technicianNotes||'â€”', extraClass:'detail-row-2'})}
      ${ repImg ? `
        <div class="detail-card detail-image detail-row-2">
          <div class="dc-ico">ğŸª›</div>
          <div class="dc-body">
            <div class="dc-label">ØµÙˆØ±Ø© Ø§Ù„Ø¥ØµÙ„Ø§Ø­</div>
            <img src="${repImg}" alt="ØµÙˆØ±Ø© Ø§Ù„Ø¥ØµÙ„Ø§Ø­" onclick="viewImage('${repImg.replace(/'/g, "\\'")}')">
          </div>
        </div>` : ''
      }
    </div>
  `;
}


// Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø´Ø±Ù
if (request.supervisorName) {
  html += '<hr style="margin: 22px 0;">';
  html += '<h3 style="color: #006341; margin-bottom: 12px;">âœ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø´Ø±Ù</h3>';
  html += `
    <div class="details-grid">
      ${detailCard({icon:'ğŸ§‘â€ğŸ’¼', label:'Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±Ù', value:request.supervisorName})}
      ${detailCard({icon:'âœ”ï¸', label:'Ø§Ù„Ù‚Ø±Ø§Ø±', value:request.supervisorDecision})}
      ${detailCard({icon:'ğŸ—’ï¸', label:'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø´Ø±Ù', value:request.supervisorNotes, extraClass:'detail-row-2'})}
    </div>
  `;
}
  
// Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
if (request.safetyOfficerName1) {
  html += '<hr style="margin: 22px 0;">';
  html += '<h3 style="color: #ffc107; margin-bottom: 12px;">ğŸ¦º Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø© (Ø£ÙˆÙ„ÙŠØ©)</h3>';
  html += `
    <div class="details-grid">
      ${detailCard({icon:'ğŸ¦º', label:'Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø³Ù„Ø§Ù…Ø©', value:request.safetyOfficerName1})}
      ${detailCard({icon:'âœ”ï¸', label:'Ø§Ù„Ù‚Ø±Ø§Ø±', value:request.safetyDecision1})}
      ${detailCard({icon:'ğŸ—’ï¸', label:'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø©', value:request.safetyNotes1, extraClass:'detail-row-2'})}
    </div>
  `;
}

// Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
if (request.safetyOfficerName2) {
  html += '<hr style="margin: 22px 0;">';
  html += '<h3 style="color: #ffc107; margin-bottom: 12px;">ğŸ¦º Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø© (Ù†Ù‡Ø§Ø¦ÙŠØ©)</h3>';
  html += `
    <div class="details-grid">
      ${detailCard({icon:'ğŸ¦º', label:'Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø³Ù„Ø§Ù…Ø©', value:request.safetyOfficerName2})}
      ${detailCard({icon:'âœ”ï¸', label:'Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ', value:request.safetyDecision2})}
      ${detailCard({icon:'ğŸ—’ï¸', label:'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©', value:request.safetyNotes2, extraClass:'detail-row-2'})}
    </div>
  `;
}

// ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ù…ÙŠÙ„ / Ø£Ø³Ø¨Ø§Ø¨
if (request.isFixed || request.redirectReason || request.cancelReason) {
  html += '<hr style="margin: 22px 0;">';
  html += '<h3 style="color: #006341; margin-bottom: 12px;">â­ ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨ (ØªÙ‚ÙŠÙŠÙ…/Ø¥Ø¬Ø±Ø§Ø¡)</h3>';
  html += `
    <div class="details-grid">
      ${ request.isFixed ? detailCard({icon:'ğŸ› ï¸', label:'ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­', value:request.isFixed}) : '' }
      ${ request.satisfactionLevel ? detailCard({icon:'ğŸŒŸ', label:'Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø±Ø¶Ø§', value:request.satisfactionLevel}) : '' }
      ${ request.clientNotes ? detailCard({icon:'ğŸ’¬', label:'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„', value:request.clientNotes, extraClass:'detail-row-2'}) : '' }
      ${ request.redirectReason ? detailCard({icon:'â†©ï¸', label:'Ø³Ø¨Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡', value:request.redirectReason, extraClass:'detail-row-2'}) : '' }
      ${ request.cancelReason ? detailCard({icon:'â›”', label:'Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡', value:request.cancelReason, extraClass:'detail-row-2'}) : '' }
    </div>
  `;
}

html += '</div>';
document.getElementById('viewDetailsContent').innerHTML = html;
}

// Delete Request

// âœ… Ø­Ø°Ù/ØªØ¹Ù„ÙŠÙ… Ù…Ø­Ø°ÙˆÙ: Ø§Ù„Ø´ÙŠØª Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ (Ù…Ø¹ ØµÙ Ø§Ù†ØªØ¸Ø§Ø± Ø¹Ù†Ø¯ Ø§Ù„ÙØ´Ù„)
async function deleteRequest(requestId){
  const reason = prompt('Ø£Ø¯Ø®Ù„ Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø°Ù (Ø³ÙŠÙØ­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„):');
  if (!reason || !reason.trim()) return;

  const res = updateRequestLifecycle({
    requestId,
    action: 'softDelete',
    actor: currentUser?.name,
    role:  currentUser?.role,
    payload: { deleteReason: reason.trim() }
  });

  if(!res.ok){ alert(res.message||'ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­Ø°Ù'); return; }

  alert('ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ "Ù…Ø­Ø°ÙˆÙ". Ø³ÙŠØªÙ… Ø¯ÙØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¥Ù„Ù‰ Google Sheets Ø¹Ø¨Ø± Ø§Ù„Ù€ Queue.');
}





function openClientActionsModal(requestId) {
  document.getElementById('clientActionRequestId').value = requestId;
  document.getElementById('clientActionReason').value = '';
  document.getElementById('clientActionsModal').classList.add('active');
}

async function submitClientAction(e) {
  e.preventDefault();
  const id = document.getElementById('clientActionRequestId').value;
  const reason = (document.getElementById('clientActionReason').value||'').trim();
  if (!id || !reason) return;

  // ØªÙ†ÙÙŠØ° Ø­Ø°Ù Ù†Ø§Ø¹Ù… Ø¨Ø§Ø³Ù… ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨
  const res = updateRequestLifecycle({
    requestId: id,
    action: 'softDelete',
    actor: currentUser?.name,
    role:  currentUser?.role,
    payload: { deleteReason: reason }
  });

  if (res.ok) {
    showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ ÙˆÙˆÙØ«Ù‘Ù‚ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„.', 'success');
  } else {
    showNotification(res.message||'ØªØ¹Ø°Ù‘Ø± Ø§Ù„ØªÙ†ÙÙŠØ°', 'error');
  }
  closeModal('clientActionsModal');
}



function renderMiniTimeline(req){
  // Ù…Ø±Ø§Ø­Ù„Ù†Ø§: Ù…Ø±Ø³ÙÙ„ â†’ ØªÙ‚Ø±ÙŠØ± ÙÙ†ÙŠ â†’ Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ø´Ø±Ù â†’ ØªÙ‚ÙŠÙŠÙ… Ø¹Ù…ÙŠÙ„ â†’ Ù…ÙƒØªÙ…Ù„/Ù…Ø±ÙÙˆØ¶
  const hasTech = !!req.technicianName;
  const hasSup  = !!req.supervisorName;
  const hasCli  = !!req.isFixed;

  // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù„ÙˆÙ†
  const statClass = getStatusClass(req.status); // pending/progress/completed/rejected

  // Ù†Øµ Ù…Ø®ØªØµØ±
  let label = 'Ù…Ø±Ø³ÙÙ„';
  if (req.status === 'Ù…Ø±ÙÙˆØ¶' || req.status === 'ØºÙŠØ± Ù…ÙƒØªÙ…Ù„') label = 'Ù…Ø±ÙÙˆØ¶';
  else if (req.status === 'Ù…ÙƒØªÙ…Ù„') label = 'Ù…ÙƒØªÙ…Ù„';
  else if (req.status === 'Ù…Ø¹ØªÙ…Ø¯') label = 'Ù…Ø¹ØªÙ…Ø¯';
  else if (req.status === 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©') label = 'Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ø´Ø±Ù';
  else if (hasTech) label = 'ØªÙ‚Ø±ÙŠØ± ÙÙ†ÙŠ';

  // Ù†Ù‚Ø§Ø· Ù…ØµØºÙ‘Ø±Ø© ØªÙˆØ¶Ù‘Ø­ Ø£ÙŠÙ† ÙˆØµÙ„
  // pending â†’ progress â†’ completed/rejected
  let dot1 = 'pending', dot2 = 'pending', dot3 = 'pending', dot4 = 'pending';
  // Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ†ÙŠ
  if (hasTech) dot2 = 'progress';
  // Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø´Ø±Ù
  if (hasSup) dot3 = 'progress';
  // Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„
  if (hasCli) dot4 = 'progress';
  // Ù„Ùˆ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù…ÙƒØªÙ…Ù„Ø© Ø£Ùˆ Ù…Ø±ÙÙˆØ¶Ø© Ø­ÙˆÙ‘Ù„ Ø¢Ø®Ø± Ù†Ù‚Ø·Ø© Ù„ØªÙ„Ùƒ Ø§Ù„Ø­Ø§Ù„Ø©
  if (statClass === 'completed') dot4 = 'completed';
  if (statClass === 'rejected')  dot4 = 'rejected';
  // Ù„Ùˆ Ù„Ø³Ø§ â€œØ¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©â€ Ø®Ù„Ù‘ÙŠ dot3 Ø£Ùˆ dot2 Ø£Ø²Ø±Ù‚ (progress)
  if (statClass === 'progress' && !hasCli) {
    if (hasSup) dot3 = 'progress';
    else if (hasTech) dot2 = 'progress';
  }

  return `
    <div class="mini-flow" title="Ø§Ù„Ù…Ø³Ø§Ø±: ${label}">
      <span class="mini-dot ${dot1}"></span>
      <span class="mini-dot ${dot2}"></span>
      <span class="mini-dot ${dot3}"></span>
      <span class="mini-dot ${dot4}"></span>
      <span class="mini-text">${label}</span>
    </div>
  `;
}


// ======== Ø¬Ù„Ø¨ Ø§Ù„ÙŠÙˆØ²Ø±Ø§Øª Ù…Ù† Google Sheets + ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙ†ÙŠÙŠÙ† ========

// ÙŠØªÙˆÙ‚Ø¹ Ø§Ù„Ù€ GAS ÙŠØ±Ø¬Ù‘Ø¹: { ok:true, users:[{name, role, specialty}] }
// Ø£Ùˆ ÙŠØ±Ø¬Ù‘Ø¹ Ø±Ø¤ÙˆØ³ Ø¹Ø±Ø¨ÙŠØ©: Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ø¯ÙˆØ±/Ø§Ù„ØªØ®ØµØµ
function normalizeUsers(rawUsers) {
  if (!Array.isArray(rawUsers)) return [];
  return rawUsers.map(u => {
    const name = u.name || u['Ø§Ù„Ø§Ø³Ù…'] || '';
    const role = u.role || u['Ø§Ù„Ø¯ÙˆØ±'] || '';
    const specialty = u.specialty || u['Ø§Ù„ØªØ®ØµØµ'] || '';
    return { name, role, specialty };
  });
}

// Ø¬Ù„Ø¨ Ù…Ù† Ø§Ù„Ø³ÙƒØ±Ø¨Øª
async function fetchUsersFromSheets() {
  if (!appsScriptUrl) return [];
  const res = await callAppsScript('getUsers', {});
  if (!res || res.ok !== true) return [];
  return normalizeUsers(res.users || res.data || []);
}

// fallback Ù…Ø­Ù„ÙŠ Ù„Ùˆ ÙØ´Ù„ Ø§Ù„Ø´ÙŠØª
function fallbackTechs() {
  return [
    { name: 'Ø®Ø§Ù„Ø¯ Ø¹Ù„ÙŠ',     role: ROLES.TECHNICIAN, specialty: 'ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ' },
    { name: 'Ø³Ø¹ÙŠØ¯ Ø§Ù„Ù‚Ø­Ø·Ø§Ù†ÙŠ', role: ROLES.TECHNICIAN, specialty: 'ØªÙƒÙŠÙŠÙ' },
    { name: 'Ù…Ø§Ø¬Ø¯ Ø­Ù…ÙˆØ¯',     role: ROLES.TECHNICIAN, specialty: 'Ø³Ø¨Ø§ÙƒØ©' },
    { name: 'Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø³Ø§Ù„Ù…',  role: ROLES.TECHNICIAN, specialty: 'Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª' },
  ];
}

// ØªØ®Ø²ÙŠÙ†/ØªØ­Ù…ÙŠÙ„ ÙƒØ§Ø´ Ù…Ø­Ù„ÙŠ
function saveUsersCache(u){ try{ localStorage.setItem('usersCache', JSON.stringify(u||[])); }catch{} }
function loadUsersCache(){ try{ return JSON.parse(localStorage.getItem('usersCache')||'[]'); }catch{ return []; } }

// Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙÙŠ ÙƒÙˆØ¯Ùƒ: ØªÙÙ†Ø§Ø¯Ù‰ Ø¯Ø§Ø®Ù„ showMainApp()
async function loadTechnicians() {
  // Ø¨Ø¯Ø§ÙŠØ©: Ø¹Ù„ÙÙ‘Ù… Ø¥Ù†Ù†Ø§ Ø¨Ø¯Ø£Ù†Ø§ Ø§Ù„ØªØ­Ù…ÙŠÙ„
  techniciansLoading = true;
  techniciansLoaded  = false;

  // Ø¬Ø±Ù‘Ø¨ Ù…Ù† Ø§Ù„ÙƒØ§Ø´ Ø£ÙˆÙ„Ù‹Ø§ (ØªØ³Ø±ÙŠØ¹)
  let cached = loadUsersCache();
  if (cached.length) users = cached;

  // Ø­Ø§ÙˆÙ„ Ø¬Ù„Ø¨ Ø£Ø­Ø¯Ø« Ù†Ø³Ø®Ø© Ù…Ù† Ø§Ù„Ø´ÙŠØª
  let fromSheets = [];
  try {
    fromSheets = await fetchUsersFromSheets();
  } catch (e) {
    console.warn('fetchUsersFromSheets error:', e);
  }

  if (fromSheets.length) {
    users = fromSheets;
    saveUsersCache(users);
  } else if (!users.length) {
    // Ø¥Ù† Ù…Ø§ ÙÙŠÙ‡ Ø´ÙŠØª ÙˆÙ„Ø§ ÙƒØ§Ø´: Ø§Ø³ØªØ®Ø¯Ù… Ù‚Ø§Ø¦Ù…Ø© Ù…Ø­Ù„ÙŠØ© ØªØ¬Ø±ÙŠØ¨ÙŠØ©
    users = fallbackTechs();
    saveUsersCache(users);
    // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ù†Ø¨Ù‘Ù‡ Ø¥Ù†Ù†Ø§ Ø§Ø³ØªØ®Ø¯Ù…Ù†Ø§ Ù‚Ø§Ø¦Ù…Ø© Ù…Ø­Ù„ÙŠØ©
    console.warn('âš ï¸ ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¬Ù„Ø¨ Ù…Ù† Ø§Ù„Ø´ÙŠØª â€” ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚Ø§Ø¦Ù…Ø© Ù…Ø­Ù„ÙŠØ©.');
  }

  // Ù†Ù‡Ø§ÙŠØ©: Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ØªØ­Ù…ÙŠÙ„
  techniciansLoaded  = true;
  techniciansLoading = false;

  // ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¯ÙˆÙ† Ø±Ø³Ø§Ø¦Ù„ Ù…Ù†Ø¨Ø«Ù‚Ø© Ù…ØªÙƒØ±Ø±Ø©
  console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙ†ÙŠÙŠÙ†:', users.length);
}
// Ø®Ø±ÙŠØ·Ø© Ø¨Ø³ÙŠØ·Ø© Ø¨ÙŠÙ† Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„ ÙˆØªØ®ØµØµ Ø§Ù„ÙÙ†ÙŠ
function mapFaultToSpecialty(faultType) {
  const t = (faultType||'').trim();
  if (t.includes('ÙƒÙ‡Ø±Ø¨')) return 'ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ';
  if (t.includes('ØªÙƒÙŠÙŠÙ')) return 'ØªÙƒÙŠÙŠÙ';
  if (t.includes('Ø³Ø¨Ø§Ùƒ') || t.includes('Ø³Ø¨Ø§ÙƒØ©')) return 'Ø³Ø¨Ø§ÙƒØ©';
  if (t.includes('Ø§Ù„ÙƒØªØ±ÙˆÙ†')) return 'Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª';
  // ØºÙŠØ± Ø°Ù„Ùƒ: Ø±Ø¬Ù‘Ø¹ ÙØ§Ø±Øº Ø¹Ø´Ø§Ù† Ù†Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„ÙÙ†ÙŠÙŠÙ†
  return '';
}

// Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙÙŠ ÙƒÙˆØ¯Ùƒ: ØªÙÙ†Ø§Ø¯Ù‰ ÙÙŠ openSupervisorModal(requestId)
function populateTechnicianSelect(faultType) {
  const sel = document.getElementById('assignedTechnicianSelect');
  if (!sel) return;

  // ÙÙ„ØªØ±Ø© Ø§Ù„ÙÙ†ÙŠÙŠÙ† ÙÙ‚Ø·
  const allTechs = (users || []).filter(u => (u.role||'').trim() === ROLES.TECHNICIAN);

  // ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„ØªØ®ØµØµ Ø¥Ù† Ø£Ù…ÙƒÙ†
  const spec = mapFaultToSpecialty(faultType);
  let list = allTechs;
  if (spec) {
    const s = spec.trim();
    list = allTechs.filter(u => (u.specialty||'').includes(s));
    // Ù„Ùˆ Ù…Ø§ ÙˆØ¬Ø¯Ù†Ø§ Ø£Ø­Ø¯ Ø¨Ø§Ù„ØªØ®ØµØµØŒ Ø§Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ù…ÙŠØ¹ Ø¨Ø¯Ù„ Ù…Ø§ ØªØªØ±ÙƒÙ‡Ø§ ÙØ§Ø¶ÙŠØ©
    if (!list.length) list = allTechs;
  }

  // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
  sel.innerHTML = '<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„ÙÙ†ÙŠ â€”</option>';
  list.forEach(t => {
    const opt = document.createElement('option');
    opt.value = t.name;
    opt.textContent = t.specialty ? `${t.name} â€” ${t.specialty}` : t.name;
    sel.appendChild(opt);
  });
}

// (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø²Ø± ÙØ­Øµ Ø³Ø±ÙŠØ¹ ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„
window.debugCheckUsers = function() {
  const techs = (users||[]).filter(u => (u.role||'').trim() === ROLES.TECHNICIAN);
  console.log('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:', users.length);
  console.log('Ø¹Ø¯Ø¯ Ø§Ù„ÙÙ†ÙŠÙŠÙ†:', techs.length, techs);
  alert(`ØªÙ… Ø§Ù„Ø¬Ù„Ø¨.\nØ¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: ${users.length}\nØ¹Ø¯Ø¯ Ø§Ù„ÙÙ†ÙŠÙŠÙ†: ${techs.length}`);
};

function getVisibleRequests() {
  const list = Array.isArray(requests) ? requests : [];
  if (!currentUser) return list;

  const role = (currentUser.role || '').trim();
  if (role === ROLES.EMPLOYEE) {
    return list.filter(r => (r.requesterName || '') === (currentUser.name || ''));
  }
  if (role === ROLES.TECHNICIAN) {
    const me = normalizeName(currentUser.name || '');
    return list.filter(r => {
      const a = normalizeName(r.assignedTechnicianName || '');
      const t = normalizeName(r.technicianName || '');
      return a === me || t === me;
    });
  }
  // Ø§Ù„Ù…Ø´Ø±Ù/Ø§Ù„Ø¬ÙˆØ¯Ø©/Ø§Ù„Ø¹Ù…ÙŠØ¯ ÙŠØ´ÙˆÙÙˆÙ† Ø§Ù„ÙƒÙ„
  return list;
}


// Refresh All Tables
// Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ 4 Ø¯ÙˆØ§Ù„ ÙÙŠ ÙƒÙ„ Ù…Ø±Ø©ØŒ ÙŠÙ…ÙƒÙ† ØªØ­Ø³ÙŠÙ†Ù‡Ø§:
function refreshAllTables() {
  if (!currentUser) return;
  refreshSafetyReviewTable1();     // â† Ø¬Ø¯ÙŠØ¯
  refreshSafetyReviewTable2();     // â† Ø¬Ø¯ÙŠØ¯
  refreshPendingRequestsTable();
  refreshTechnicianReportsTable();
  refreshApprovedRequestsTable();
  refreshAllRequestsTable();
  refreshMyRequestsTable();
  updateStatistics();
}


// Refresh Pending Requests Table
function refreshPendingRequestsTable() {
  const tbody = document.getElementById('pendingRequestsTable');

  // Ø§Ù„ÙÙ†ÙŠÙŠÙ† ÙŠØ´ØªØºÙ„ÙˆØ§ Ø¹Ù„Ù‰ "Ù…Ø­ÙˆÙ‘Ù„ Ù„Ù„ÙÙ†ÙŠ"
  const list = getVisibleRequests().filter(r => r.status === 'Ù…Ø­ÙˆÙ‘Ù„ Ù„Ù„ÙÙ†ÙŠ');

  if (list.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 30px; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø­ÙˆÙ‘Ù„Ø© Ù„Ùƒ</td></tr>';
    return;
  }

  tbody.innerHTML = list.map(req => `
    <tr>
      <td>${req.id}</td>
      <td>${req.requesterName}</td>
      <td>${req.faultType}</td>
      <td>${req.building}</td>
      <td>${req.date}</td>
      <td>${
        resolveImageSrc(req.image || req.imageUrl)
          ? '<button class="action-btn btn-image" onclick="viewImage(\'' + resolveImageSrc(req.image || req.imageUrl).replace(/'/g, "\\'") + '\')">ğŸ“·</button>'
          : '-'
      }</td>
      <td><span class="status-badge status-progress">${req.status}</span></td>
      <td>${renderMiniTimeline(req)}</td>
      <td>
        <div class="action-buttons">
          <button class="action-btn btn-view" onclick="viewRequest('${req.id}')">Ù…Ø³Ø§Ø±</button>
          <button class="action-btn btn-edit" onclick="openTechnicianModal('${req.id}')">Ù…Ø¹Ø§Ù„Ø¬Ø©</button>
        </div>
      </td>
    </tr>
  `).join('');
}



// Refresh Technician Reports Table
function refreshTechnicianReportsTable() {
  const tbody = document.getElementById('technicianReportsTable');

  // Ø§Ù„Ù…Ø´Ø±Ù ÙŠØ´ÙˆÙ: Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø´Ø±Ù + ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø© + Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
  const list = getVisibleRequests().filter(r =>
    ['Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø´Ø±Ù','ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©','Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©'].includes((r.status||'').trim())
  );

  if (!list.length) {
    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 30px; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</td></tr>';
    return;
  }

  tbody.innerHTML = list.map(req => `
    <tr>
      <td>${renderMiniTimeline(req)}</td>
      <td>${req.id} ${req.redirectReason ? '<span title="ØªØ¹Ù„ÙŠÙ‚ Ø¹Ù…ÙŠÙ„" style="margin-right:6px;display:inline-block;padding:2px 8px;border-radius:12px;background:#fff3cd;color:#856404;font-size:.78rem;font-weight:700">ğŸ’¬</span>' : ''}</td>
      <td>${req.requesterName}</td>
      <td>${req.faultType}</td>
      <td>${req.assignedTechnicianName || req.technicianName || '-'}</td>
      <td>${req.date}</td>
      <td>${
        resolveImageSrc(req.image || req.imageUrl)
          ? '<button class="action-btn btn-image" onclick="viewImage(\'' + resolveImageSrc(req.image || req.imageUrl).replace(/'/g,"\\'") + '\')">ğŸ“·</button>'
          : '-'
      }</td>
      <td><span class="status-badge status-${getStatusClass(req.status)}">${req.status}</span></td>
      <td>
        <div class="action-buttons">
          <button class="action-btn btn-view" onclick="viewRequest('${req.id}')">Ù…Ø³Ø§Ø±</button>
          <button class="action-btn btn-edit" 
        ${techniciansLoading || !techniciansLoaded ? 'disabled title="â³ Ø§Ù†ØªØ¸Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙ†ÙŠÙŠÙ†..."' : ''}
                onclick="openSupervisorModal('${req.id}')">
          ${techniciansLoading || !techniciansLoaded ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...' : 'Ù…Ø±Ø§Ø¬Ø¹Ø©/ØªØ¹ÙŠÙŠÙ†'}
        </button>
        </div>
      </td>
    </tr>
  `).join('');
}

// Refresh Safety Review Table 1
function refreshSafetyReviewTable1() {
  const tbody = document.getElementById('safetyReviewTable1');
  const list = getVisibleRequests().filter(r => r.status === 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³Ù„Ø§Ù…Ø© (Ø£ÙˆÙ„ÙŠØ©)');

  if (!list.length) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</td></tr>';
    return;
  }

  tbody.innerHTML = list.map(req => `
    <tr>
      <td>${req.id}</td>
      <td>${req.requesterName}</td>
      <td>${req.faultType}</td>
      <td>${req.building}</td>
      <td>${req.date}</td>
      <td>${resolveImageSrc(req.image || req.imageUrl) ? 
        '<button class="action-btn btn-image" onclick="viewImage(\'' + 
        resolveImageSrc(req.image || req.imageUrl).replace(/'/g,"\\'") + '\')">ğŸ“·</button>' : '-'}</td>
      <td><span class="status-badge status-safety">${req.status}</span></td>
      <td>
        <div class="action-buttons">
          <button class="action-btn btn-view" onclick="viewRequest('${req.id}')">Ù…Ø³Ø§Ø±</button>
          <button class="action-btn btn-edit" style="background:#ffc107" onclick="openSafetyModal1('${req.id}')">Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
        </div>
      </td>
    </tr>
  `).join('');
}

// Refresh Safety Review Table 2
function refreshSafetyReviewTable2() {
  const tbody = document.getElementById('safetyReviewTable2');
  const list = getVisibleRequests().filter(r => r.status === 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³Ù„Ø§Ù…Ø© (Ù†Ù‡Ø§Ø¦ÙŠØ©)');

  if (!list.length) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</td></tr>';
    return;
  }

  tbody.innerHTML = list.map(req => `
    <tr>
      <td>${req.id}</td>
      <td>${req.requesterName}</td>
      <td>${req.faultType}</td>
      <td>${req.assignedTechnicianName || req.technicianName || '-'}</td>
      <td>${req.date}</td>
      <td>${resolveImageSrc(req.image || req.imageUrl) ? 
        '<button class="action-btn btn-image" onclick="viewImage(\'' + 
        resolveImageSrc(req.image || req.imageUrl).replace(/'/g,"\\'") + '\')">ğŸ“·</button>' : '-'}</td>
      <td><span class="status-badge status-safety">${req.status}</span></td>
      <td>
        <div class="action-buttons">
          <button class="action-btn btn-view" onclick="viewRequest('${req.id}')">Ù…Ø³Ø§Ø±</button>
          <button class="action-btn btn-edit" style="background:#ffc107" onclick="openSafetyModal2('${req.id}')">Ù…Ø±Ø§Ø¬Ø¹Ø© Ù†Ù‡Ø§Ø¦ÙŠØ©</button>
        </div>
      </td>
    </tr>
  `).join('');
}

// ÙŠØ±Ø¨Ø· Ø­Ù‚Ù„ "Ø§Ø³Ù… ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨" Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆÙŠÙ‚ÙÙ„ Ø§Ù„Ø­Ù‚Ù„
function lockRequesterToCurrentUser() {
  const nameInput = document.getElementById('requesterName');
  if (!nameInput) return;

  // ØªØ¹Ø¨Ø¦Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… + Ù‚ÙÙ„ Ø§Ù„Ø­Ù‚Ù„
  nameInput.value = currentUser?.name || '';
  nameInput.disabled = true;
  nameInput.readOnly = true;
  nameInput.placeholder = 'ÙŠÙØ¹Ø¨Ù‘Ø£ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¯Ø®ÙˆÙ„';
  nameInput.title = 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ ÙŠÙØ­Ø¯Ù‘ÙØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙŠ Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„';

  // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø­Ù‚Ù„ Ø¨ØµØ±ÙŠÙ‹Ø§ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) â€” Ø§Ø­Ø°Ù Ø§Ù„Ø³Ø·Ø±ÙŠÙ† Ø§Ù„ØªØ§Ù„ÙŠÙŠÙ† Ù„Ùˆ ØªØ­Ø¨ ØªØ¨Ù‚ÙŠÙ‡ Ø¸Ø§Ù‡Ø±Ù‹Ø§
  const group = nameInput.closest('.form-group');
  if (group) group.style.display = 'none';
}

// ÙŠÙØ±Ø¬Ø¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø±Ø¦ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±




// Refresh Approved Requests Table
function refreshApprovedRequestsTable() {
  const tbody = document.getElementById('approvedRequestsTable');
  const list = getVisibleRequests().filter(r => (r.status||'').trim() === 'Ù…Ø¹ØªÙ…Ø¯');

  if (!list.length) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹ØªÙ…Ø¯Ø© Ù„Ù„ØªÙ‚ÙŠÙŠÙ…</td></tr>';
    return;
  }

  tbody.innerHTML = list.map(req => `
    <tr>
      <td>${renderMiniTimeline(req)}</td>
      <td>${req.id}</td>
      <td>${req.requesterName || '-'}</td>
      <td>${req.faultType || '-'}</td>
      <td>${req.date || '-'}</td>
      <td>${
        resolveImageSrc(req.image || req.imageUrl)
          ? '<button class="action-btn btn-image" onclick="viewImage(\'' + resolveImageSrc(req.image || req.imageUrl).replace(/'/g,"\\'") + '\')">ğŸ“·</button>'
          : '-'
      }</td>
      <td><span class="status-badge status-${getStatusClass(req.status)}">${req.status}</span></td>
      <td>
        <div class="action-buttons">
          <button class="action-btn btn-view" onclick="viewRequest('${req.id}')">Ù…Ø³Ø§Ø±</button>
          <button class="action-btn btn-edit" onclick="openClientModal('${req.id}')">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
        </div>
      </td>
    </tr>
  `).join('');
}

function refreshMyRequestsTable() {
  const tbody = document.getElementById('myRequestsTable');
  const list = getVisibleRequests().filter(r => true); // getVisibleRequests ÙŠØ­ØµØ± Ø§Ù„Ù…ÙˆØ¸Ù ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§

  if (!list.length) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:30px;color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</td></tr>';
    return;
  }

  tbody.innerHTML = list.map(req => `
    <tr>
      <td>${renderMiniTimeline(req)}</td>
      <td>${req.id}</td>
      <td>${req.faultType}</td>
      <td>${req.building}</td>
      <td>${req.date}</td>
      <td><span class="status-badge status-${getStatusClass(req.status)}">${req.status}</span></td>
      <td>
        <div class="action-buttons">
          <button class="action-btn btn-view" onclick="viewRequest('${req.id}')">ØªÙØ§ØµÙŠÙ„</button>
          ${
            (req.status !== 'Ù…ÙƒØªÙ…Ù„' && req.status !== 'Ù…Ø±ÙÙˆØ¶' && req.status !== 'Ù…Ù„ØºÙŠ' && req.status !== 'Ù…Ø­Ø°ÙˆÙ')
            ? `<button class="action-btn btn-delete" onclick="openClientActionsModal('${req.id}')">Ø­Ø°Ù</button>`
            : ''
          }
        </div>
      </td>
    </tr>
  `).join('');
}


// === Template via relative URL ===
const TEMPLATE_URL = './templates/maintenance_template.xlsx';

// Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ â† Ø§Ù„Ø®Ù„Ø§ÙŠØ§ (Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ø­Ø³Ø¨ ØªÙ…Ø¨Ù„ÙŠØªÙƒ)
const TEMPLATE_CELL_MAP = {
  'C8':   r => r.id,
  'F8':   r => r.type,
  'I8':   r => r.building,
  'D9':   r => r.maintenanceType,
  'D11':  r => r.requesterName,
  'D13':  r => r.time,
  'H13':  r => r.date,             // Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ
  'C15':  r => r.faultType,
  'A19':  r => r.faultDescription,
  'C25':  r => r.assignedTechnicianName || r.technicianName || '',
  'H26':  r => r.techDate || r.date || '',
  'C29':  r => r.supervisorName || '',
  'C30':  r => r.status || '',
  'H31':  r => r.supDate || r.date || '',
  'C34':  r => r.requesterName || '',
  'C35':  r => r.isFixed || '',
  'H36':  r => r.clientDate || r.date || ''
};

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ…Ø¨Ù„ÙŠØª Ù…Ù† Ù…Ù„Ù Ù…Ø¬Ø§ÙˆØ± (ÙˆÙŠÙØ®Ø²Ù‘Ù† Ø¨Ø§Ù„Ø°Ø§ÙƒØ±Ø©)
let __templateArrayBuffer = null;
async function loadTemplateArrayBuffer() {
  if (__templateArrayBuffer) return __templateArrayBuffer;
  const res = await fetch(TEMPLATE_URL);
  if (!res.ok) throw new Error('ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„ØªÙ…Ø¨Ù„ÙŠØª');
  __templateArrayBuffer = await res.arrayBuffer();
  return __templateArrayBuffer;
}

function dataURLToBase64(dataURL) {
  return (dataURL || '').split(',')[1] || '';
}

// ØªØ¹Ø¨Ø¦Ø© Ø®Ù„Ø§ÙŠØ§ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
function fillTemplateCells(ws, request) {
  for (const cell in TEMPLATE_CELL_MAP) {
    const getter = TEMPLATE_CELL_MAP[cell];
    const val = (typeof getter === 'function') ? getter(request) : (request[getter] ?? '');
    const c = ws.getCell(cell);
    c.value = (val == null ? '' : val);
    c.alignment = Object.assign({}, c.alignment, { readingOrder: 'rtl' });
  }
}

// Ø¥Ø¯Ø±Ø§Ø¬ ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø·Ù„ ÙÙŠ Ù†Ø·Ø§Ù‚ Ù…Ø­Ø¯Ø¯ (Ø§Ø¶Ø¨Ø· Ø§Ù„Ù…ÙƒØ§Ù† Ø­Ø³Ø¨ ØªÙ…Ø¨Ù„ÙŠØªÙƒ)
// Ø¥Ø¯Ø±Ø§Ø¬ ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø·Ù„ Ø¯Ø§Ø®Ù„ Ø§Ù„ØªÙ…Ø¨Ù„ÙŠØª (ÙŠØ¯Ø¹Ù… imageUrl Ø¹Ø¨Ø± Apps Script)
async function tryInsertFaultImage(wb, ws, request) {
  // Ù†Ø­Ø§ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ dataURL Ø§Ù„Ù…Ø®Ø²Ù‘Ù† Ù…Ø­Ù„ÙŠÙ‹Ø§
  let dataUrl = request.image || '';
  // Ø¥Ù† Ù„Ù… ØªØªÙˆÙØ± ÙˆØ­ØµÙ„Ù†Ø§ Ø¹Ù„Ù‰ imageUrl Ù…Ù† DriveØŒ Ø­ÙˆÙ‘Ù„Ù‡Ø§ Ø¥Ù„Ù‰ Base64
  if (!dataUrl && request.imageUrl) {
    dataUrl = await getDriveImageAsDataURL(request.imageUrl);
    if (!dataUrl) {
      try { dataUrl = await urlToDataURL(request.imageUrl); } catch(_) {}
    }
  }
  if (!dataUrl) return; // Ù„Ø§ ØµÙˆØ±Ø©

  try {
    const base64 = (dataUrl.split(',')[1] || '');
    const ext = dataUrl.startsWith('data:image/png') ? 'png' : 'jpeg';
    const imgId = wb.addImage({ base64, extension: ext });
    // Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø­Ø³Ø¨ ØªÙ…Ø¨Ù„ÙŠØªÙƒ
    ws.addImage(imgId, { tl: { col: 7, row: 18 }, br: { col: 11, row: 28 } });
  } catch (e) {
    console.warn('ØªØ¹Ø°Ù‘Ø± Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„ØµÙˆØ±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ØªÙ…Ø¨Ù„ÙŠØª:', e);
  }
}



// Refresh All Requests Table
function refreshAllRequestsTable() {
  const tbody = document.getElementById('allRequestsTable');
  const list = getVisibleRequests();

  if (!list.length) {
    tbody.innerHTML = '<tr><td colspan="12" style="text-align:center;padding:30px;color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
    return;
  }

  tbody.innerHTML = list.map(req => `
    <tr>
      <td>${renderMiniTimeline(req)}</td>
      <td>${req.id}</td>
      <td>${req.requesterName || '-'}</td>
      <td>${req.faultType || '-'}</td>
      <td>${req.building || '-'}</td>
      <td>${req.date || '-'}</td>
      <td>${req.assignedTechnicianName || req.technicianName || '-'}</td>
      <td>${req.supervisorName || '-'}</td>
      <td>${
        resolveImageSrc(req.image || req.imageUrl)
          ? '<button class="action-btn btn-image" onclick="viewImage(\'' + resolveImageSrc(req.image || req.imageUrl).replace(/'/g,"\\'") + '\')">ğŸ“·</button>'
          : '-'
      }</td>
      <td><span class="status-badge status-${getStatusClass(req.status)}">${req.status}</span></td>
      <td>${req.satisfactionLevel || '-'}</td>
      <td>
        <div class="action-buttons">
          <button class="action-btn btn-view" onclick="viewRequest('${req.id}')">ØªÙØ§ØµÙŠÙ„</button>
          <button class="action-btn btn-pdf" onclick="/* TODO: pdf for ${req.id} */ alert('Ù‚Ø±ÙŠØ¨Ù‹Ø§ PDF Ù„Ø·Ù„Ø¨ ${req.id}')">PDF</button>
        </div>
      </td>
    </tr>
  `).join('');
}



// Update Statistics
function updateStatistics() {
  const list = Array.isArray(requests) ? requests : [];

  const total = list.length;

  // Ù†Ø¹ØªØ¨Ø± â€œØªÙ…Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©â€ = Ù…ÙƒØªÙ…Ù„ ÙÙ‚Ø·
  const completed = list.filter(r => (r.status||'').trim() === 'Ù…ÙƒØªÙ…Ù„').length;

  // Ù†Ø¹ØªØ¨Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© = Ù…ÙƒØªÙ…Ù„/Ù…Ø±ÙÙˆØ¶/Ù…Ù„ØºÙŠ/Ù…Ø­Ø°ÙˆÙ/ØºÙŠØ± Ù…ÙƒØªÙ…Ù„
  const terminalStatuses = new Set(['Ù…ÙƒØªÙ…Ù„','Ù…Ø±ÙÙˆØ¶','Ù…Ù„ØºÙŠ','Ù…Ø­Ø°ÙˆÙ','ØºÙŠØ± Ù…ÙƒØªÙ…Ù„']);
  const inProgress = list.filter(r => !terminalStatuses.has((r.status||'').trim())).length;

  const rejected = list.filter(r => (r.status||'').trim() === 'Ù…Ø±ÙÙˆØ¶').length;

  const el = id => document.getElementById(id);

  if (el('totalRequests'))     el('totalRequests').textContent = String(total);
  if (el('rejectedRequests'))  el('rejectedRequests').textContent = String(rejected);
  if (el('inProgressCount'))   el('inProgressCount').textContent = String(inProgress);
  if (el('completedCount'))    el('completedCount').textContent = String(completed);
}



// Export to Excel
function exportToExcel() {
  if (requests.length === 0) {
    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
    return;
  }
  
  const data = requests.map(req => ({
    'Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨': req.id,
    'ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨': req.requesterName,
    'Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨': req.type,
    'Ø§Ù„Ù…Ø¨Ù†Ù‰': req.building,
    'Ù†ÙˆØ¹ Ø§Ù„ØµÙŠØ§Ù†Ø©': req.maintenanceType,
    'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„': req.faultType,
    'ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„': req.faultDescription,
    'Ø§Ù„ØªØ§Ø±ÙŠØ®': req.date,
    'Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ': req.hijriDate,
    'Ø§Ù„ÙˆÙ‚Øª': req.time,
    'Ø§Ù„ÙŠÙˆÙ…': req.day,
    'Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ': req.assignedTechnicianName || req.technicianName || '-',
    'Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„': req.workStatus || '-',
    'Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±Ù': req.supervisorName || '-',
    'Ù‚Ø±Ø§Ø± Ø§Ù„Ù…Ø´Ø±Ù': req.supervisorDecision || '-',
    'ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­': req.isFixed || '-',
    'Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø±Ø¶Ø§': req.satisfactionLevel || '-',
    'Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©': req.status,
    'ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ØµÙˆØ±Ø©': (req.image || req.imageUrl) ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'
  }));
  
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØµÙŠØ§Ù†Ø©');
  
  const fileName = `ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø³Ù„Ø§Ù…Ø©_TVTC_${new Date().toLocaleDateString('ar-SA').replace(/\//g, '-')}.xlsx`;
  XLSX.writeFile(wb, fileName);
}

// Export to PDF
function exportToPDF() {
  if (requests.length === 0) {
    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
    return;
  }
  
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('l', 'mm', 'a4');
  
  //doc.setLanguage('ar');
  doc.setR2L(true);
  
  doc.setFontSize(20);
  doc.setTextColor(102, 126, 234);
  doc.text('ğŸ”§', 15, 15);
  
  doc.setFontSize(18);
  doc.setTextColor(0, 0, 0);
  doc.text('ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø´Ø§Ù…Ù„', doc.internal.pageSize.width / 2, 20, { align: 'center' });
  
  doc.setFontSize(12);
  doc.text(`Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString('ar-SA')}`, doc.internal.pageSize.width - 15, 15, { align: 'right' });
  
  const tableData = requests.map(req => [
    req.id,
    req.requesterName,
    req.faultType,
    req.building,
    req.date,
    req.technicianName || '-',
    req.supervisorName || '-',
    req.status,
    (req.image || req.imageUrl) ? 'âœ“' : '-'
  ]);
  
  doc.autoTable({
    startY: 30,
    head: [['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨', 'ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨', 'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„', 'Ø§Ù„Ù…Ø¨Ù†Ù‰', 'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ù„ÙÙ†ÙŠ', 'Ø§Ù„Ù…Ø´Ø±Ù', 'Ø§Ù„Ø­Ø§Ù„Ø©', 'ØµÙˆØ±Ø©']],
    body: tableData,
    styles: {
      font: 'helvetica',
      fontSize: 10,
      halign: 'center'
    },
    headStyles: {
      fillColor: [102, 126, 234],
      textColor: 255,
      fontStyle: 'bold'
    },
    alternateRowStyles: {
      fillColor: [245, 245, 250]
    }
  });
  
  const pageCount = doc.internal.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(10);
    doc.setTextColor(150);
    doc.text(
      `ØµÙØ­Ø© ${i} Ù…Ù† ${pageCount}`,
      doc.internal.pageSize.width / 2,
      doc.internal.pageSize.height - 10,
      { align: 'center' }
    );
  }
  
  const fileName = `ØªÙ‚Ø±ÙŠØ±_Ø§Ù„ØµÙŠØ§Ù†Ø©_${new Date().toLocaleDateString('ar-SA').replace(/\//g, '-')}.pdf`;
  doc.save(fileName);
}

// Export All Requests with Templates
// Export All Requests with Templates (Ù†Ø³Ø®Ø© Ù…ÙØ­Ø³Ù‘Ù†Ø©)
async function exportAllWithTemplates() {
  if (requests.length === 0) { alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª'); return; }

  showNotification('Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬...', 'info');

  // 1) Ø­Ù…Ù‘Ù„ Ø§Ù„ØªÙ…Ø¨Ù„ÙŠØª ÙƒÙ€ ArrayBuffer
  const ab = await loadTemplateArrayBuffer();

  // 2) Ø§ÙØªØ­ Ø§Ù„ØªÙ…Ø¨Ù„ÙŠØª ÙƒÙ€ Workbook Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„Ù†Ø³Ø® Ù…Ù†Ù‡
  const baseWb = new ExcelJS.Workbook();
  await baseWb.xlsx.load(ab);
  const baseSheet = baseWb.worksheets[0];

  // 3) Ø£Ù†Ø´Ø¦ Ù…Ù„Ù Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬
  const outWb = new ExcelJS.Workbook();

  // 4) ÙƒØ±Ø± Ø¹Ù„Ù‰ ÙƒÙ„ Ø·Ù„Ø¨ ÙˆØ£Ù†Ø´Ø¦ ÙˆØ±Ù‚Ø© Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ØªÙ…Ø¨Ù„ÙŠØª
  for (const req of requests) {
    const sheetName = `Ø·Ù„Ø¨_${req.id}`.substring(0, 31);
    const ws = outWb.addWorksheet(sheetName);

    // Ø§Ù†Ø³Ø® Ø´ÙƒÙ„ Ø§Ù„ØªÙ…Ø¨Ù„ÙŠØª (Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆØ±Ù‚Ø©+Ø§Ù„Ø¯Ù…Ø¬+Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª+Ø§Ù„Ø£Ù†Ù…Ø§Ø·)
    cloneTemplateTo(baseSheet, ws);

    // Ø¹Ø¨Ù‘Ø¦ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ø¨Ø§Ù„Ù‚ÙŠÙ…
    fillTemplateCells(ws, req);

    // Ø¥Ù† Ø±ØºØ¨Øª Ø¨Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„ØµÙˆØ±Ø© Ø¯Ø§Ø®Ù„ ÙƒÙ„ Ù†Ù…ÙˆØ°Ø¬ØŒ ÙÙƒ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚:
    // await tryInsertFaultImage(outWb, ws, req);
  }

  // 5) Ø£Ù†Ø´Ø¦ Ø§Ù„Ù…Ù„Ù Ù„Ù„ØªØ­Ù…ÙŠÙ„
  const fileName = `Ù†Ù…Ø§Ø°Ø¬_Ø§Ù„ØµÙŠØ§Ù†Ø©_${new Date().toLocaleDateString('ar-SA').replace(/\//g, '-')}.xlsx`;
  const outBuf = await outWb.xlsx.writeBuffer();
  const blob = new Blob([outBuf], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = fileName;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);

  showNotification(`ØªÙ… ØªØµØ¯ÙŠØ± ${requests.length} Ù†Ù…ÙˆØ°Ø¬ Ù…Ù† Ø§Ù„ØªÙ…Ø¨Ù„ÙŠØª!`, 'success');
}

// ÙŠÙ†Ø³Ø® ÙˆØ±Ù‚Ø© Ø§Ù„ØªÙ…Ø¨Ù„ÙŠØª Ø¥Ù„Ù‰ ÙˆØ±Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¯Ù…Ø¬ ÙˆØ§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª
function cloneTemplateTo(srcSheet, dstSheet) {
  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©/Ø§Ù„ÙˆØ±Ù‚Ø©/Ø§Ù„Ø¹Ø±Ø¶ (ØªØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ RTL ÙˆØ§Ù„Ù‡ÙˆØ§Ù…Ø´â€¦)
  dstSheet.pageSetup = JSON.parse(JSON.stringify(srcSheet.pageSetup || {}));
  dstSheet.properties = JSON.parse(JSON.stringify(srcSheet.properties || {}));
  dstSheet.views = JSON.parse(JSON.stringify(srcSheet.views || []));

  // Ø£Ø¹Ù…Ø¯Ø©: Ø§Ù„Ø¹Ø±Ø¶ØŒ Ø§Ù„Ø¥Ø®ÙØ§Ø¡ØŒ Ù…Ø³ØªÙˆÙŠØ§Øª outline
  if (srcSheet.columns) {
    dstSheet.columns = srcSheet.columns.map(col => ({
      key: col.key,
      width: col.width,
      hidden: col.hidden,
      outlineLevel: col.outlineLevel
    }));
  }

  // Ù†Ø³Ø® Ø§Ù„Ù‚ÙŠÙ… ÙˆØ§Ù„Ø£Ù†Ù…Ø§Ø· ØµÙØ§Ù‹ Ø¨ØµÙ
  srcSheet.eachRow({ includeEmpty: true }, (row, r) => {
    const newRow = dstSheet.getRow(r);
    newRow.height = row.height; // Ù…Ù‡Ù…

    row.eachCell({ includeEmpty: true }, (cell, c) => {
      const nc = newRow.getCell(c);

      // Ø§Ù„Ù‚ÙŠÙ…Ø© (Ù‚Ø¯ ØªÙƒÙˆÙ† Ù†Øµ/ØµÙŠØºØ©/Øºâ€¦)
      nc.value = cell.value;

      // Ù†Ø³Ø® Ø§Ù„Ø£Ù†Ù…Ø§Ø· (font, alignment, border, fill, numFmt, protection)
      if (cell.style) {
        nc.style = JSON.parse(JSON.stringify(cell.style));
      }

      // Ø§Ø­ØªÙŠØ§Ø· Ù„Ù‚Ø±Ø§Ø¡Ø© RTL Ù„Ùˆ Ù…Ø§ ÙƒØ§Ù†Øª ÙÙŠ Ø§Ù„ØªÙ…Ø¨Ù„ÙŠØª
      nc.alignment = Object.assign({}, nc.alignment, { readingOrder: 'rtl' });
    });
  });

  // Ù†Ø³Ø® Ø§Ù„Ø¯Ù…Ø¬ (merged cells)
  // ExcelJS ÙŠØ®Ø²Ù† Ø§Ù„Ø¯Ù…Ø¬ Ø¯Ø§Ø®Ù„ÙŠÙ‹Ø§Ø› Ù†Ø¯Ø¹Ù… Ø§Ù„Ø´ÙƒÙ„ÙŠÙ† (Set Ø£Ùˆ Array)
  if (srcSheet._merges && typeof srcSheet._merges.forEach === 'function') {
    srcSheet._merges.forEach(range => dstSheet.mergeCells(range));
  } else if (Array.isArray(srcSheet._merges)) {
    srcSheet._merges.forEach(range => dstSheet.mergeCells(range));
  }
}



// Export Single Request with Template
async function exportWithTemplate(requestId) {
  const request = requests.find(r => r.id === requestId);
  if (!request) { alert('Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return; }

  showNotification('Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù†Ù…ÙˆØ°Ø¬...', 'info');

  // 1) Ø­Ù…Ù„ Ø§Ù„ØªÙ…Ø¨Ù„ÙŠØª
  const ab = await loadTemplateArrayBuffer();

  // 2) Ø§ÙØªØ­ Ø§Ù„ØªÙ…Ø¨Ù„ÙŠØª
  const wb = new ExcelJS.Workbook();
  await wb.xlsx.load(ab);

  // 3) Ø§Ø®ØªØ± Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ (Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„ÙˆØ±Ù‚Ø© Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ø§Ø³Ù… Ù…Ø­Ø¯Ø¯)
  const ws = wb.worksheets[0]; // Ø£Ùˆ wb.getWorksheet('Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØµÙŠØ§Ù†Ø©');

  // 4) Ø¹Ø¨Ù‘Ø¦ Ø§Ù„Ø®Ù„Ø§ÙŠØ§
  fillTemplateCells(ws, request);

  // 5) (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø£Ø¯Ø±Ø¬ ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø·Ù„ ÙÙŠ Ù…ÙƒØ§Ù†Ù‡Ø§
   // await tryInsertFaultImage(wb, ws, request);

  // 6) Ø­Ù…Ù‘Ù„ Ø§Ù„Ù…Ù„Ù Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
  const fileName = `Ù†Ù…ÙˆØ°Ø¬_Ø·Ù„Ø¨_ØµÙŠØ§Ù†Ø©_${request.id}.xlsx`;
  const outBuf = await wb.xlsx.writeBuffer();
  const blob = new Blob([outBuf], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = fileName;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);

  showNotification('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù…Ù† Ø§Ù„ØªÙ…Ø¨Ù„ÙŠØª Ø¨Ù†Ø¬Ø§Ø­!', 'success');
}

// Notification Helper
function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#3498db'};
    color: white;
    padding: 15px 25px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 10000;
    animation: slideIn 0.3s ease;
    font-weight: 500;
  `;
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

// Export Single PDF

// Export Single PDF (ÙŠØ¯Ø¹Ù… imageUrl Ù…Ù† Drive Ø¨ØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ø¥Ù„Ù‰ Base64)
// Export Single PDF (ÙŠØ¯Ø¹Ù… imageUrl Ù…Ù† Drive Ø¨ØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ø¥Ù„Ù‰ Base64)
// === Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ø¯Ø§Ù„Ø© ÙƒØ§Ù…Ù„Ø© Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø© ===
async function exportSinglePDF(requestId) {
  const req = requests.find(r => r.id === requestId);
  if (!req) { alert('Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return; }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'mm', 'a4');
  doc.setR2L(true);

  const pageW = doc.internal.pageSize.getWidth();
  const pageH = doc.internal.pageSize.getHeight();
  let y = 20;

  // Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø©
  doc.setFontSize(20);
  doc.setTextColor(102, 126, 234);
  doc.text('ğŸ”§', 15, y);
  doc.setFontSize(16);
  doc.setTextColor(0, 0, 0);
  doc.text(`Ù†Ù…ÙˆØ°Ø¬ Ø£Ù…Ø± Ø¹Ù…Ù„ (ØµÙŠØ§Ù†Ø©) - Ø±Ù‚Ù… ${req.id}`, pageW / 2, y, { align: 'center' });
  y += 12;

  doc.setFontSize(11);
  const row = (label, value) => {
    doc.text(`${label}: ${value || '-'}`, pageW - 15, y, { align: 'right' });
    y += 7;
  };

  row('Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨', req.type);
  row('Ø§Ù„Ù…Ø¨Ù†Ù‰', req.building);
  row('Ù†ÙˆØ¹ Ø§Ù„ØµÙŠØ§Ù†Ø©', req.maintenanceType);
  row('ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨', req.requesterName);
  row('Ø§Ù„ØªØ§Ø±ÙŠØ®', `${req.date || '-'} â€” ${req.hijriDate || '-'}`);
  row('Ø§Ù„ÙˆÙ‚Øª', req.time || '-');

  // ÙØ§ØµÙ„
  y += 2; doc.setDrawColor(220); doc.line(15, y, pageW - 15, y); y += 6;

  // ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„ (Ø¨ØªÙØ§Ù)
  doc.setTextColor(102, 126, 234);
  doc.text('ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„', pageW - 15, y, { align: 'right' }); y += 6;
  doc.setTextColor(0, 0, 0);
  const desc = doc.splitTextToSize(req.faultDescription || '-', pageW - 30);
  doc.text(desc, pageW - 15, y, { align: 'right' });
  y += Math.min(40, desc.length * 6);

  // Ù…Ù„Ø®Øµ Ø§Ù„ØªÙ†ÙÙŠØ°/Ø§Ù„Ø­Ø§Ù„Ø§Øª
  y += 4;
  doc.setTextColor(102, 126, 234);
  doc.text('Ù…Ù„Ø®Øµ Ø§Ù„ØªÙ†ÙÙŠØ°', pageW - 15, y, { align: 'right' }); y += 6;
  doc.setTextColor(0, 0, 0);
  [
    `Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${req.status || '-'}`,
    `Ø§Ù„ÙÙ†ÙŠ Ø§Ù„Ù…Ø¹ÙŠÙ‘Ù†: ${req.assignedTechnicianName || req.technicianName || '-'}`,
    `Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„: ${req.workStatus || '-'}`,
    `Ø§Ù„Ù…Ø´Ø±Ù: ${req.supervisorName || '-'}`,
    `Ù‚Ø±Ø§Ø± Ø§Ù„Ù…Ø´Ø±Ù: ${req.supervisorDecision || '-'}`,
    `ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­: ${req.isFixed || '-'}`,
    `Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø±Ø¶Ø§: ${req.satisfactionLevel || '-'}`
  ].forEach(line => { doc.text(line, pageW - 15, y, { align: 'right' }); y += 6; });

  // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ø¯Ø±Ø§Ø¬ ØµÙˆØ±Ø© (Base64 ÙÙ‚Ø·)
  async function addImageBlock(title, dataUrl) {
    if (!dataUrl) return;
    const imgW = 80, imgH = 60;

    if (y + imgH + 20 > pageH) { doc.addPage(); y = 20; }
    doc.setTextColor(102, 126, 234);
    doc.text(title, pageW - 15, y, { align: 'right' }); y += 6;
    doc.setTextColor(0, 0, 0);

    try {
      const ext = dataUrl.startsWith('data:image/png') ? 'PNG' : 'JPEG';
      doc.addImage(dataUrl, ext, pageW - 15 - imgW, y, imgW, imgH);
      y += imgH + 6;
    } catch (e) {
      console.warn('addImage error:', e);
    }
  }

  // ØªØ¬Ù‡ÙŠØ² ØµÙˆØ± Ø§Ù„Ø¹Ø·Ù„ ÙˆØ§Ù„Ø¥ØµÙ„Ø§Ø­ (Base64 Ø¥Ù† Ø£Ù…ÙƒÙ†)
  let faultData = req.image || '';
  if (!faultData && req.imageUrl) {
    faultData =
      (await getDriveImageAsDataURL(req.imageUrl)) ||
      (await (async () => { try { return await urlToDataURL(req.imageUrl); } catch { return ''; } })());
  }
  await addImageBlock('ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø·Ù„', faultData);

  let repairData = req.repairImage || '';
  if (!repairData && req.repairImageUrl) {
    repairData =
      (await getDriveImageAsDataURL(req.repairImageUrl)) ||
      (await (async () => { try { return await urlToDataURL(req.repairImageUrl); } catch { return ''; } })());
  }
  await addImageBlock('ØµÙˆØ±Ø© Ø§Ù„Ø¥ØµÙ„Ø§Ø­', repairData);

  // ØªØ°ÙŠÙŠÙ„ Ø§Ù„ØµÙØ­Ø§Øª
  const pageCount = doc.internal.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(9);
    doc.setTextColor(150);
    doc.text(`ØµÙØ­Ø© ${i} Ù…Ù† ${pageCount}`, pageW / 2, pageH - 10, { align: 'center' });
  }

  doc.save(`Ù†Ù…ÙˆØ°Ø¬_Ø¨Ù„Ø§Øº_Ø³Ù„Ø§Ù…Ø©_${req.id}.pdf`);
}

// Print Report
function printReport() {
  window.print();
}



// Close modal when clicking outside
window.onclick = function(event) {
  if (event.target.classList.contains('modal')) {
    event.target.classList.remove('active');
  }
};

// Storage Functions
// Storage Functions
function saveRequestsToStorage() {
  try { localStorage.setItem('requests', JSON.stringify(requests || [])); } catch {}
}

function loadRequestsFromStorage() {
  try { requests = JSON.parse(localStorage.getItem('requests') || '[]'); } catch { requests = []; }
}

function showAlert(elId, msg, type='success') {
  const el = document.getElementById(elId);
  if (!el) return;
  el.className = `alert alert-${type}`;
  el.textContent = msg;
  el.style.display = 'block';
  setTimeout(()=>{ el.style.display='none'; }, 4000);
}

function closeModal(id) {
  const m = document.getElementById(id);
  if (m) m.classList.remove('active');
}



// Auto-save and sync
setInterval(() => {
  if (currentUser && appsScriptUrl) {
    saveRequestsToStorage();
    // Optional: Auto-sync with Sheets
    // syncWithSheets();
  }
}, 30000);

// Update time every minute
setInterval(() => {
  if (currentUser) {
    setCurrentDateTime();
  }
}, 60000);

// Ø²Ø± Ù…Ø¤Ù‚Øª Ù„Ù„Ù…Ø³Ø­ Ø§Ù„Ø³Ø±ÙŠØ¹
function clearLocalRequestsCache() {
  localStorage.removeItem('maintenanceRequests');
  requests = [];
  refreshAllTables();
  showNotification('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©. Ø­Ø¯Ù‘Ø«/Ø£Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.', 'success');
}

// Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚
setInterval(async () => {
  if (currentUser && appsScriptUrl) {
    await autoSync(true); // Ø³Ø­Ø¨ Ù…Ù† Ø§Ù„Ø´ÙŠØª ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø¨ØµÙ…Øª
  }
}, 5 * 60 * 1000);


// Ù…Ø¹Ø§Ù„Ø¬Ø© Queue Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
// âœ… Ù…Ø¹Ø§Ù„Ø¬Ø© Queue Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª - Ù…Ø­Ø³Ù‘Ù†
window.addEventListener('online', async () => {
  showSyncIndicator('syncing', 'ğŸŒ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„...', false);
  
  if (syncQueue.queue.length > 0) {
    console.log(`ğŸ”„ Ù…Ø¹Ø§Ù„Ø¬Ø© ${syncQueue.queue.length} Ø¹Ù…Ù„ÙŠØ© Ù…Ø¹Ù„Ù‚Ø©...`);
    await syncQueue.process();
  }
  
  // Ù…Ø²Ø§Ù…Ù†Ø© ÙƒØ§Ù…Ù„Ø© Ø¨Ø¹Ø¯ Queue
  if (currentUser && appsScriptUrl) {
    await autoSync(true); // silent mode
  }
});

window.addEventListener('offline', () => {
  showSyncIndicator('error', 'âš ï¸ Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„', true);
  console.warn('âš ï¸ ÙˆØ¶Ø¹ Offline: Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø³ØªÙØ¶Ø§Ù Ø¥Ù„Ù‰ Queue');
});



// âœ… Ø¯Ø§Ù„Ø© Ù…Ø±Ø§Ù‚Ø¨Ø© Queue (Ù„Ù„ØªØ·ÙˆÙŠØ± ÙˆØ§Ù„Ø§Ø®ØªØ¨Ø§Ø±)
window.checkSyncQueue = function() {
  console.log('ğŸ“Š Ø­Ø§Ù„Ø© Queue:');
  console.log('- Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª:', syncQueue.queue.length);
  console.log('- Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©:', syncQueue.processing);
  console.log('- Ø§Ù„ØªÙØ§ØµÙŠÙ„:', syncQueue.queue);
  
  if (syncQueue.queue.length > 0) {
    console.log('\nğŸ’¡ Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©ØŒ Ø§ÙƒØªØ¨: syncQueue.process()');
  }
  
  alert(`ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©:\n\n` +
        `Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©: ${syncQueue.queue.length}\n` +
        `Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©: ${syncQueue.processing ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}\n\n` +
        `ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© ÙÙŠ Console`);
};

window.addEventListener('error', (event) => {
  console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:', event.error);
  showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…. ØªØ­Ù‚Ù‚ Ù…Ù† Console', 'error');
});

window.addEventListener('unhandledrejection', (event) => {
  console.error('Promise Ù…Ø±ÙÙˆØ¶:', event.reason);
  showNotification('ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†Ø©', 'error');
});

</script>

</body>
</html>