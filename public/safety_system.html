<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>نظام إدارة السلامة - المنشأة التدريبية</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
  background: linear-gradient(135deg, #006341 0%, #00875A 50%, #C8A55C 100%);
  min-height: 100vh;
  direction: rtl;
}

/* Loading & Sync Indicator */
.loading-screen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #006341 0%, #00875A 50%, #C8A55C 100%);
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  z-index: 9999;
  color: white;
}

.spinner {
  width: 50px;
  height: 50px;
  border: 4px solid rgba(255, 255, 255, 0.3);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.sync-indicator {
  position: fixed;
  top: 20px;
  left: 20px;
  background: rgba(255, 255, 255, 0.98);
  padding: 8px 16px;
  border-radius: 25px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  display: flex;
  align-items: center;
  gap: 8px;
  z-index: 1000;
  font-size: 0.85rem;
  opacity: 0;
  transform: translateY(-10px);
  transition: all 0.3s ease;
  pointer-events: none;
  border: 1px solid #e0e0e0;
}

.sync-indicator.show {
  opacity: 1;
  transform: translateY(0);
  pointer-events: auto;
}

.sync-indicator.syncing {
  border-color: #006341; color: #006341;
}

.sync-indicator.success {
  border-color: #27ae60;
  color: #27ae60;
}

.sync-indicator.error {
  border-color: #e74c3c;
  color: #e74c3c;
}

.sync-status-icon {
  width: 18px;
  height: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.sync-time {
  font-size: 0.75rem;
  opacity: 0.7;
  margin-right: 5px;
}

.sync-spinner {
  width: 16px;
  height: 16px;
  border: 2px solid rgba(0, 99, 65, 0.3); 
  border-top-color: #006341;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

/* Login Screen */
.login-screen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #006341 0%, #00875A 50%, #C8A55C 100%);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  padding: 20px;
}

.login-box {
  background: white;
  padding: 40px;
  border-radius: 20px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  max-width: 450px;
  width: 100%;
  text-align: center;
}

.login-box h1 {
  color: #006341;
  margin-bottom: 10px;
  font-size: 2rem;
}

.login-box .subtitle {
  color: #666;
  margin-bottom: 30px;
  font-size: 0.95rem;
}

.logo-icon {
  font-size: 4rem;
  margin-bottom: 20px;
}

.input-group {
  margin-bottom: 20px;
  text-align: right;
}

.input-group label {
  display: block;
  margin-bottom: 8px;
  color: #333;
  font-weight: 500;
}

.input-group input,
.input-group select {
  width: 100%;
  padding: 12px 15px;
  border: 2px solid #e0e0e0;
  border-radius: 10px;
  font-size: 1rem;
  transition: all 0.3s;
}

.input-group input:focus,
.input-group select:focus {
  outline: none;
  border-color: #006341; box-shadow: 0 0 0 3px rgba(0, 99, 65, 0.1);
}

.btn {
  width: 100%;
  padding: 14px;
  background: linear-gradient(135deg, #006341 0%, #C8A55C 100%);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
  margin-top: 10px;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(0, 99, 65, 0.4);
}

.btn:active {
  transform: translateY(0);
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.sheets-config {
  margin-top: 25px;
  padding-top: 20px;
  border-top: 2px solid #eee;
  text-align: right;
}

.sheets-config h4 {
  color: #006341;
  margin-bottom: 15px;
  font-size: 1rem;
}

.sheets-config small {
  display: block;
  color: #888;
  margin-top: 8px;
  line-height: 1.5;
}

/* User Info Bar */
.user-info-bar {
  background: linear-gradient(135deg, #006341 0%, #C8A55C 100%);
  color: white;
  padding: 15px 30px;
  display: none;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.user-info {
  display: flex;
  align-items: center;
  gap: 20px;
}

.user-avatar {
  width: 45px;
  height: 45px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.3rem;
}

.btn-logout {
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.3);
  padding: 8px 20px;
  border-radius: 20px;
  cursor: pointer;
  transition: all 0.3s;
  font-weight: 500;
}

.btn-logout:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: translateY(-2px);
}

/* Container */
.container {
  max-width: 1400px;
  margin: 20px auto;
  background: white;
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  display: none;
}

.header {
  background: linear-gradient(135deg, #006341 0%, #C8A55C 100%);
  color: white;
  padding: 30px;
  text-align: center;
}

.header h1 {
  font-size: 2.2rem;
  margin-bottom: 10px;
}

.header p {
  opacity: 0.9;
  font-size: 1.05rem;
}

/* Navigation Tabs */
.nav-tabs {
  display: flex;
  background: #f8f9fa;
  border-bottom: 2px solid #e0e0e0;
  overflow-x: auto;
}

.nav-tab {
  flex: 1;
  padding: 18px 20px;
  background: transparent;
  border: none;
  cursor: pointer;
  font-size: 1rem;
  font-weight: 500;
  color: #666;
  transition: all 0.3s;
  white-space: nowrap;
  position: relative;
}

.nav-tab:hover {
  background: rgba(0, 99, 65, 0.1);
  color: #006341;
}

.nav-tab.active {
  color: #006341;
  background: white;
}

.nav-tab.active::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(135deg, #006341 0%, #C8A55C 100%);
}

/* Content */
.tab-content {
  display: none;
  padding: 30px;
  animation: fadeIn 0.3s;
}

.tab-content.active {
  display: block;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Form Styling */
.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
  margin-bottom: 25px;
}

.form-group {
  text-align: right;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  color: #333;
  font-weight: 500;
  font-size: 0.95rem;
}

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 12px 15px;
  border: 2px solid #e0e0e0;
  border-radius: 10px;
  font-size: 1rem;
  transition: all 0.3s;
  font-family: inherit;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: #006341;
  box-shadow: 0 0 0 3px rgba(0, 99, 65, 0.1);
}

.form-group input:disabled {
  background: #f5f5f5;
  cursor: not-allowed;
}

.form-group textarea {
  min-height: 100px;
  resize: vertical;
}

/* Image Upload */
.image-upload-container {
  border: 2px dashed #e0e0e0;
  border-radius: 10px;
  padding: 20px;
  text-align: center;
  transition: all 0.3s;
  cursor: pointer;
}

.image-upload-container:hover {
  border-color: #006341;
  background: rgba(0, 99, 65, 0.05);
}

.image-upload-container.has-image {
  border-style: solid;
  border-color: #27ae60;
}

.upload-icon {
  font-size: 3rem;
  margin-bottom: 10px;
  color: #006341;
}

.upload-text {
  color: #666;
  font-size: 0.95rem;
}

.image-preview {
  max-width: 100%;
  max-height: 300px;
  border-radius: 10px;
  margin-top: 15px;
  display: none;
}

.image-preview.show {
  display: block;
}

.remove-image-btn {
  margin-top: 10px;
  padding: 8px 16px;
  background: #e74c3c;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.9rem;
  display: none;
}

.remove-image-btn.show {
  display: inline-block;
}

.remove-image-btn:hover {
  background: #c0392b;
}

/* Buttons */
.btn-primary {
  padding: 12px 30px;
  background: linear-gradient(135deg, #006341 0%, #C8A55C 100%);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  margin-left: 10px;
}

.btn-primary:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(0, 99, 65, 0.4);
}

.btn-primary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}


.btn-home{
  background: rgba(255,255,255,0.2);
  color: white;
  border: 1px solid rgba(255,255,255,0.3);
  padding: 8px 20px;
  border-radius: 20px;
  cursor: pointer;
  transition: all 0.3s;
  font-weight: 500;
  text-decoration: none;
  display: inline-block;
  margin-top: 10px;
}
.btn-home:hover{ transform: translateY(-2px); }



.btn-secondary {
  padding: 12px 30px;
  background: white;
  color: #006341;
  border: 2px solid #006341;
  border-radius: 10px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  margin-left: 10px;
}

.btn-secondary:hover {
  background: #006341;
  color: white;
  transform: translateY(-2px);
}

.btn-success {
  background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}

.btn-danger {
  background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
}

/* Stats Cards */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  background: linear-gradient(135deg, #006341 0%, #C8A55C 100%);
  color: white;
  padding: 25px;
  border-radius: 15px;
  box-shadow: 0 8px 20px rgba(0, 99, 65, 0.3);
  transition: transform 0.3s;
}

.stat-card:hover {
  transform: translateY(-5px);
}

.stat-card h3 {
  font-size: 2.5rem;
  margin-bottom: 10px;
}

.stat-card p {
  font-size: 1.1rem;
  opacity: 0.9;
}

/* Table */
.table-container {
  overflow-x: auto;
  border-radius: 10px;
  border: 1px solid #e0e0e0;
}

table {
  width: 100%;
  border-collapse: collapse;
  background: white;
}

thead {
  background: linear-gradient(135deg, #006341 0%, #C8A55C 100%);
  color: white;
}
th {
  padding: 15px;
  text-align: right;
  font-weight: 600;
  font-size: 0.95rem;
}

td {
  padding: 15px;
  text-align: right;
  border-bottom: 1px solid #f0f0f0;
}

tbody tr:hover {
  background: #f8f9ff;
}

.status-badge {
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 600;
  display: inline-block;
}

.status-pending {
  background: #fff3cd;
  color: #856404;
}

.status-progress {
  background: #cfe2ff;
  color: #084298;
}

.status-completed {
  background: #d1e7dd;
  color: #0a3622;
}

.status-rejected {
  background: #f8d7da;
  color: #721c24;
}

.status-safety {
  background: #fff3cd;
  color: #856404;
  border: 2px solid #ffc107;
}

.timeline-step.safety .timeline-icon {
  background: linear-gradient(135deg, #ffc107, #ff9800);
  color: white;
  box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
}

/* Action Buttons */
.action-buttons {
  display: flex;
  gap: 8px;
  justify-content: center;
  flex-wrap: wrap;
}

.action-btn {
  padding: 6px 12px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.85rem;
  font-weight: 500;
  transition: all 0.2s;
}

.action-btn:hover {
  transform: scale(1.05);
}

.btn-view {
  background: #006341;
  color: white;
}

.btn-edit {
  background: #38ef7d;
  color: white;
}

.btn-delete {
  background: #f45c43;
  color: white;
}

.btn-pdf {
  background: #e74c3c;
  color: white;
}

.btn-excel {
  background: #27ae60;
  color: white;
}

.btn-image {
  background: #3498db;
  color: white;
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 2000;
  justify-content: center;
  align-items: center;
  padding: 20px;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: white;
  padding: 30px;
  border-radius: 20px;
  max-width: 800px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: modalSlideIn 0.3s;
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: scale(0.9);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 2px solid #e0e0e0;
}

.modal-header h2 {
  color: #006341;
  font-size: 1.8rem;
}

.close-modal {
  background: none;
  border: none;
  font-size: 2rem;
  cursor: pointer;
  color: #999;
  transition: color 0.2s;
}

.close-modal:hover {
  color: #333;
}

/* Alert Messages */
.alert {
  padding: 15px 20px;
  border-radius: 10px;
  margin-bottom: 20px;
  font-weight: 500;
  display: none;
  animation: slideDown 0.3s;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(100px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes slideOut {
  from {
    opacity: 1;
    transform: translateX(0);
  }
  to {
    opacity: 0;
    transform: translateX(100px);
  }
}

.alert-success {
  background: #d1e7dd;
  color: #0a3622;
  border: 1px solid #a3cfbb;
}

.alert-error {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f1aeb5;
}

.alert-info {
  background: #cfe2ff;
  color: #084298;
  border: 1px solid #9ec5fe;
}

/* Image Modal */
.image-modal-content {
  max-width: 90vw;
  max-height: 90vh;
}

.image-modal-content img {
  width: 100%;
  height: auto;
  border-radius: 10px;
}

/* ====== Details Cards (Basic Info) ====== */
.details-grid{
  display:grid;
  grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
  gap:14px;
  margin:10px 0 20px;
}
.detail-card{
  background:#fff;
  border:1px solid #eee;
  border-radius:12px;
  padding:14px;
  box-shadow:0 6px 16px rgba(0,0,0,0.06);
  display:flex; align-items:flex-start; gap:10px;
}
.detail-card .dc-ico{
  width:38px;height:38px; border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  background:linear-gradient(135deg,#00634122,#C8A55C22);
  font-size:1.15rem;
}
.detail-card .dc-body{flex:1}
.detail-card .dc-label{
  font-size:.8rem; color:#006341; font-weight:700; margin-bottom:4px;
}
.detail-card .dc-value{
  font-size:.98rem; color:#333; font-weight:600; line-height:1.4;
  word-break: break-word;
}
.detail-card.emph{
  border-color:#00634133; background:linear-gradient(180deg,#f0f8f5,#ffffff);
}
.detail-row-2{ grid-column: 1 / -1; } /* يمتد بعرض الشبكة */
.detail-status .dc-value .status-badge{
  font-size:.8rem; padding:5px 10px;
}

/* بطاقة صورة داخل التفاصيل */
.detail-image{
  display:flex; flex-direction:column; align-items:flex-start;
}
.detail-image img{
  max-width:100%; max-height:280px; border-radius:10px; margin-top:8px; cursor:pointer;
  border:1px solid #eee;
}


/* Responsive */
@media (max-width: 768px) {
  .header h1 {
    font-size: 1.6rem;
  }

  .form-grid {
    grid-template-columns: 1fr;
  }

  .stats-grid {
    grid-template-columns: 1fr;
  }

  .nav-tabs {
    flex-wrap: nowrap;
    overflow-x: auto;
  }

  .modal-content {
    padding: 20px;
  }

  .action-buttons {
    flex-direction: column;
  }

  table {
    font-size: 0.85rem;
  }

  th, td {
    padding: 10px 8px;
  }
}

/* Scrollbar */
::-webkit-scrollbar {
  width: 10px;
  height: 10px;
}

::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 5px;
}

::-webkit-scrollbar-thumb {
  background: linear-gradient(135deg, #006341 0%, #C8A55C 100%);
  border-radius: 5px;
}

::-webkit-scrollbar-thumb:hover {
  background: #005030;
}

.hidden {
  display: none !important;
}


/* Timeline Styles */
.request-timeline {
  margin: 25px 0;
  padding: 20px;
  background: #f8f9fa;
  border-radius: 10px;
  direction: rtl;
}

.timeline-header {
  color: #006341;
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 20px;
  text-align: right;
}

.timeline-container {
  display: flex;
  align-items: flex-start;
  position: relative;
  padding: 10px 0;
}

.timeline-step {
  flex: 1;
  text-align: center;
  position: relative;
  z-index: 1;
}

.timeline-icon {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  margin: 0 auto 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  background: #e0e0e0;
  color: #999;
  border: 3px solid #f8f9fa;
  transition: all 0.3s;
  position: relative;
}

.timeline-step.completed .timeline-icon {
  background: linear-gradient(135deg, #27ae60, #2ecc71);
  color: white;
  box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
}

.timeline-step.active .timeline-icon {
  background: linear-gradient(135deg, #006341, #C8A55C);
  color: white;
  box-shadow: 0 4px 12px rgba(0, 99, 65, 0.4);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

.timeline-step.rejected .timeline-icon {
  background: #e74c3c;
  color: white;
}

.timeline-label {
  font-size: 0.85rem;
  font-weight: 600;
  color: #666;
  margin-bottom: 5px;
}

.timeline-step.completed .timeline-label,
.timeline-step.active .timeline-label {
  color: #333;
}

.timeline-info {
  font-size: 0.75rem;
  color: #999;
  margin-top: 5px;
}

.timeline-step.completed .timeline-info,
.timeline-step.active .timeline-info {
  color: #006341;
}

/* الخط الواصل بين الأيقونات */
.timeline-line {
  position: absolute;
  top: 25px;
  right: 0;
  left: 0;
  height: 3px;
  background: #e0e0e0;
  z-index: 0;
}

.timeline-line-progress {
  position: absolute;
  top: 0;
  right: 0;
  height: 100%;
  background: linear-gradient(90deg, #27ae60, #006341);
  transition: width 0.5s ease;
}

/* Progress Percentage */
.timeline-progress {
  text-align: center;
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px solid #e0e0e0;
}

.progress-text {
  font-size: 0.9rem;
  color: #006341;
  font-weight: 600;
}

.progress-bar-container {
  width: 100%;
  height: 8px;
  background: #e0e0e0;
  border-radius: 10px;
  margin-top: 8px;
  overflow: hidden;
}

.progress-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, #006341, #C8A55C);
  border-radius: 10px;
  transition: width 0.5s ease;
}

/* Responsive */
@media (max-width: 768px) {
  .timeline-container {
    flex-direction: column;
    gap: 20px;
  }
  
  .timeline-step {
    display: flex;
    align-items: center;
    gap: 15px;
    text-align: right;
  }
  
  .timeline-icon {
    margin: 0;
    width: 45px;
    height: 45px;
    font-size: 1.3rem;
  }
  
  .timeline-line {
    display: none;
  }
}

.status-deleted {
  background: #eee;
  color: #555;
  border: 1px dashed #bbb;
}

.login-box .btn-home{
  background:#006341;
  color:#fff !important;
  border:none;
  display:block;
  text-align:center;
  margin-top:15px;
}


/* زر احترافي أعلى شاشة الدخول */
.login-actions{
  position: fixed;
  top: 20px;
  left: 20px; /* لأجل RTL، الزر بيكون يسار أعلى */
  z-index: 1100;
  display: flex;
  gap: 10px;
}
.btn-home-pro{
  background: #ffffff;
  color: #006341;
  border: 2px solid rgba(0,99,65,0.25);
  padding: 10px 18px;
  border-radius: 999px;
  font-weight: 700;
  text-decoration: none;
  box-shadow: 0 8px 24px rgba(0,0,0,0.12);
  transition: transform .2s, box-shadow .2s, background .2s;
}
.btn-home-pro:hover{
  transform: translateY(-2px);
  box-shadow: 0 12px 30px rgba(0,0,0,0.18);
  background: #f9f9ff;
}
.btn-home-pro:active{ transform: translateY(0); }

/* Mini timeline (داخل الجدول) */
.mini-flow{display:flex;align-items:center;gap:6px}
.mini-dot{width:8px;height:8px;border-radius:50%}
.mini-dot.pending{background:#ffc107}
.mini-dot.progress{background:#0d6efd}
.mini-dot.completed{background:#28a745}
.mini-dot.rejected{background:#dc3545}
.mini-flow .mini-text{font-size:.78rem;color:#555;font-weight:600}

.action-btn:disabled{
  opacity:.6;
  cursor:not-allowed;
  transform:none;
}


</style>
</head>
<body>

<!-- Loading Screen -->
<div class="loading-screen" id="loadingScreen">
  <div class="spinner"></div>
  <p style="margin-top: 20px; font-size: 1.2rem;">جاري تحميل النظام...</p>
</div>

<!-- Sync Indicator - محسّن -->
<div class="sync-indicator" id="syncIndicator">
  <span class="sync-status-icon" id="syncIcon">⟳</span>
  <span id="syncText">متصل</span>
  <span class="sync-time" id="syncTime"></span>
</div>

<!-- Login Screen -->
<div class="login-screen" id="loginScreen">
  <!-- أزرار أعلى شاشة الدخول -->
  <div class="login-actions">
    <a href="index.html" class="btn-home-pro">← الرجوع للصفحة الرئيسية</a>
  </div>

  <div class="login-box">

    <div class="logo-icon">🛡️</div>
    <h1>نظام إدارة السلامة</h1>
    <p class="subtitle">المؤسسة العامة للتدريب التقني والمهني - TVTC</p>
    
    <form id="loginForm" onsubmit="login(event)">
      <div class="input-group">
        <label>الرقم الوظيفي</label>
        <input type="text" id="employeeId" placeholder="أدخل الرقم الوظيفي" required>
      </div>
      
      <div class="input-group">
        <label>كلمة المرور</label>
        <input type="password" id="password" placeholder="أدخل كلمة المرور" required>
      </div>
      
      <button type="submit" class="btn" id="loginBtn">تسجيل الدخول</button>
    </form>

<div class="sheets-config" id="sheetsConfigSection">

      <h4>⚙️ إعدادات Google Sheets</h4>
      <div class="input-group">
        <label>رابط Google Apps Script</label>
        <input type="url" id="appsScriptUrl" 
               placeholder="https://script.google.com/macros/s/..."
               value="">
      </div>
      <small>
        📝 اتبع التعليمات في ملف SETUP.md لإنشاء Google Sheets والحصول على الرابط
      </small>
    </div>
  </div>
</div>

<!-- User Info Bar -->
<div class="user-info-bar" id="userBar">
  <div class="user-info">
    <div class="user-avatar">👤</div>
    <div>
      <div id="userName" style="font-weight: 600; font-size: 1.1rem;"></div>
      <div id="userRole" style="opacity: 0.9; font-size: 0.9rem;"></div>
    </div>
  </div>
  
  <a href="index.html" class="btn-home">الصفحة الرئيسية</a>
  <button class="btn-logout" onclick="logout()">تسجيل الخروج</button>
</div>

<!-- Main Container -->
<div class="container" id="mainContainer">
  <div class="header">
    <h1>🛡️ نظام إدارة السلامة - TVTC</h1>
    <p>إدارة شاملة لبلاغات وملاحظات السلامة في المنشأة التدريبية</p>
  </div>

  <!-- Navigation -->
<div class="nav-tabs">
  <button class="nav-tab active" onclick="showTab('new-request')">📝 بلاغ سلامة جديد</button>
  <button class="nav-tab" onclick="showTab('safety-review-1')">🦺 مراجعة السلامة (أولية)</button>
  <button class="nav-tab" onclick="showTab('supervisor-review')">✅ مراجعة المشرف (تعيين فني/قرار)</button>
  <button class="nav-tab" onclick="showTab('technician-report')">🔧 تقرير الفني</button>
  <button class="nav-tab" onclick="showTab('safety-review-2')">🦺 مراجعة السلامة (نهائية)</button>
  <button class="nav-tab" onclick="showTab('client-feedback')">⭐ تقييم العميل</button>
  <button class="nav-tab" onclick="showTab('my-requests')">📁 طلباتي</button>
  <button class="nav-tab" onclick="showTab('quality-report')">📊 تقرير الجودة</button>
</div>


  <!-- Tab: New Request -->
  <div class="tab-content active" id="new-request">
    <h2 style="color: #006341; margin-bottom: 25px;">📝 نموذج بلاغ سلامة جديد</h2>
    
    <div class="alert alert-success" id="newRequestAlert"></div>
    
    <form id="newRequestForm" onsubmit="submitNewRequest(event)">
      <div class="form-grid">
        <div class="form-group">
          <label>رقم الطلب</label>
          <input type="text" id="requestId" disabled>
        </div>
        
        <div class="form-group">
          <label>نوع الطلب</label>
          <select id="requestType" required>
            <option value="">اختر نوع الطلب</option>
            <option value="الكتروني">الكتروني</option>
            <option value="هاتف">هاتف</option>
            <option value="ايميل">ايميل</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>المبنى</label>
          <input type="text" id="building" placeholder="مثال: مبنى الإدارة - الدور الأول" required>
        </div>
        
        <div class="form-group">
          <label>تصنيف البلاغ</label>
          <select id="maintenanceType" required>
            <option value="">اختر نوع الصيانة</option>
            <option value="طارئ - خطر عالي">طارئ - خطر عالي</option>
            <option value="صيانة وقائية">صيانة وقائية</option>
            <option value="صيانة دورية">صيانة دورية</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>اسم صاحب الطلب</label>
          <input type="text" id="requesterName" placeholder="الاسم الكامل" required>
        </div>
        
        <div class="form-group">
          <label>الوقت</label>
          <input type="text" id="requestTime" disabled>
        </div>
        
        <div class="form-group">
          <label>التاريخ الميلادي</label>
          <input type="text" id="requestDate" disabled>
        </div>
        
        <div class="form-group">
          <label>التاريخ الهجري</label>
          <input type="text" id="hijriDate" disabled>
        </div>
        
        <div class="form-group">
          <label>اليوم</label>
          <input type="text" id="requestDay" disabled>
        </div>
        
        <div class="form-group">
          <label>نوع الملاحظة/المخاطرة</label>
          <select id="faultType" onchange="toggleOtherFault()" required>
            <option value="">اختر نوع العطل</option>
            <option value="حريق وإنذار">حريق وإنذار</option>
            <option value="كهربائي">كهربائي</option>
            <option value="إنشائي">إنشائي</option>
            <option value="مخارج طوارئ">مخارج طوارئ</option>
            <option value="معدات حماية">معدات حماية شخصية</option>
            <option value="مواد خطرة">مواد خطرة</option>
            <option value="سلوكيات خطرة">سلوكيات خطرة</option>
            <option value="أخرى">أخرى</option>
          </select>
        </div>
        
        <div class="form-group hidden" id="otherFaultDiv">
          <label>حدد نوع العطل</label>
          <input type="text" id="otherFault" placeholder="اكتب نوع العطل">
        </div>
      </div>
      
      <div class="form-group">
        <label>وصف الملاحظة أو المخاطرة</label>
        <textarea id="faultDescription" placeholder="اكتب وصفاً تفصيلياً للعطل..." required></textarea>
      </div>
      
      <div class="form-group">
        <label>📷 صورة الملاحظة (إلزامي)</label>
        <div class="image-upload-container" id="uploadContainer" onclick="document.getElementById('imageUpload').click()">
          <div class="upload-icon">📸</div>
          <div class="upload-text">اضغط هنا لرفع صورة العطل</div>
          <div class="upload-text" style="font-size: 0.85rem; color: #999; margin-top: 5px;">
            (JPG, PNG, GIF - حد أقصى 2MB)
          </div>
          <img id="imagePreview" class="image-preview" alt="معاينة الصورة">
          <input type="file" id="imageUpload" accept="image/*" style="display: none;" onchange="handleImageUpload(event)" required>
          <button type="button" class="remove-image-btn" id="removeImageBtn" onclick="event.stopPropagation(); removeImage()">
            ❌ إزالة الصورة
          </button>
        </div>
      </div>
      
      <button type="submit" class="btn-primary" id="submitRequestBtn">إرسال الطلب</button>
      <button type="reset" class="btn-secondary" onclick="resetForm()">إعادة تعيين</button>
    </form>
  </div>


<!-- Tab: Safety Review 1 -->
<div class="tab-content" id="safety-review-1">
  <h2 style="color: #ffc107; margin-bottom: 25px;">🦺 مراجعة السلامة (أولية)</h2>
  <div class="alert alert-success" id="safetyAlert1"></div>
  <div class="table-container" style="margin-bottom: 30px;">
    <table>
      <thead>
        <tr>
          <th>رقم الطلب</th>
          <th>صاحب الطلب</th>
          <th>نوع العطل</th>
          <th>المبنى</th>
          <th>التاريخ</th>
          <th>صورة</th>
          <th>الحالة</th>
          <th>الإجراءات</th>
        </tr>
      </thead>
      <tbody id="safetyReviewTable1"></tbody>
    </table>
  </div>
</div>

<!-- Tab: Supervisor Review -->
<div class="tab-content" id="supervisor-review">
  <h2 style="color: #006341; margin-bottom: 25px;">✅ مراجعة المشرف</h2>
  <div class="alert alert-success" id="supervisorAlert"></div>
  <div class="table-container" style="margin-bottom: 30px;">
    <table>
      <thead>
        <tr>
          <th>المسار</th>
          <th>رقم الطلب</th>
          <th>صاحب الطلب</th>
          <th>نوع العطل</th>
          <th>اسم الفني</th>
          <th>التاريخ</th>
          <th>صورة</th>
          <th>الحالة</th>
          <th>الإجراءات</th>
        </tr>
      </thead>
      <tbody id="technicianReportsTable"></tbody>
    </table>
  </div>
</div>

<!-- Tab: Technician Report -->
<div class="tab-content" id="technician-report">
  <h2 style="color: #006341; margin-bottom: 25px;">🔧 تقرير الفني</h2>
  <div class="alert alert-success" id="technicianAlert"></div>
  <div class="table-container" style="margin-bottom: 30px;">
    <table>
      <thead>
        <tr>
          <th>رقم الطلب</th>
          <th>صاحب الطلب</th>
          <th>نوع العطل</th>
          <th>المبنى</th>
          <th>التاريخ</th>
          <th>صورة</th>
          <th>الحالة</th>
          <th>المسار</th>
          <th>الإجراءات</th>
        </tr>
      </thead>
      <tbody id="pendingRequestsTable"></tbody>
    </table>
  </div>
</div>

<!-- Tab: Safety Review 2 -->
<div class="tab-content" id="safety-review-2">
  <h2 style="color: #ffc107; margin-bottom: 25px;">🦺 مراجعة السلامة (نهائية)</h2>
  <div class="alert alert-success" id="safetyAlert2"></div>
  <div class="table-container" style="margin-bottom: 30px;">
    <table>
      <thead>
        <tr>
          <th>رقم الطلب</th>
          <th>صاحب الطلب</th>
          <th>نوع العطل</th>
          <th>الفني</th>
          <th>التاريخ</th>
          <th>صورة</th>
          <th>الحالة</th>
          <th>الإجراءات</th>
        </tr>
      </thead>
      <tbody id="safetyReviewTable2"></tbody>
    </table>
  </div>
</div>

  <!-- Tab: Client Feedback -->
  <div class="tab-content" id="client-feedback">
    <h2 style="color: #006341; margin-bottom: 25px;">⭐ تقييم العميل</h2>
    
    <div class="alert alert-success" id="clientAlert"></div>
    
    <div class="table-container" style="margin-bottom: 30px;">
      <table>
       <thead>
            <tr>
              <th>المسار</th>
              <th>رقم الطلب</th>
              <th>صاحب الطلب</th>
              <th>نوع العطل</th>
              <th>التاريخ</th>
              <th>صورة</th>
              <th>الحالة</th>
              <th>الإجراءات</th>
            </tr>
          </thead>
        <tbody id="approvedRequestsTable"></tbody>
      </table>
    </div>
  </div>

  <!-- Tab: Quality Report -->
  <div class="tab-content" id="quality-report">
    <h2 style="color: #006341; margin-bottom: 25px;">📊 تقرير الجودة والإحصائيات</h2>
    
    <div class="stats-grid">
      <div class="stat-card">
        <h3 id="totalRequests">0</h3>
        <p>إجمالي الطلبات</p>
      </div>
      <div class="stat-card">
        <p>بلاغات قيد المعالجة</p>
      </div>
      <div class="stat-card">
        <p>بلاغات تمت معالجتها</p>
      </div>
      <div class="stat-card">
        <h3 id="rejectedRequests">0</h3>
        <p>طلبات مرفوضة</p>
      </div>
    </div>
    
    <div style="margin-bottom: 20px;">
      <button class="btn-primary btn-excel" onclick="exportToExcel()">📊 تصدير Excel</button>
      <button class="btn-primary btn-success" onclick="exportAllWithTemplates()">📋 تصدير الكل بالنموذج</button>
      <button class="btn-primary btn-pdf" onclick="exportToPDF()">📄 تصدير PDF</button>
      <button class="btn-secondary" onclick="printReport()">🖨️ طباعة</button>
    </div>
    
    <div class="table-container">
      <table>
          <thead>
            <tr>
              <th>المسار</th>
              <th>رقم الطلب</th>
              <th>صاحب الطلب</th>
              <th>نوع العطل</th>
              <th>المبنى</th>
              <th>التاريخ</th>
              <th>الفني</th>
              <th>المشرف</th>
              <th>صورة</th>
              <th>الحالة</th>
              <th>التقييم</th>
              <th>الإجراءات</th>
            </tr>
          </thead>
        <tbody id="allRequestsTable"></tbody>
      </table>
    </div>
  </div>
  <!-- Tab: My Requests -->
<div class="tab-content" id="my-requests">
  <h2 style="color: #006341; margin-bottom: 25px;">📁 طلباتي</h2>
  <div class="alert alert-info" id="myRequestsAlert" style="display:none"></div>

  <div class="table-container" style="margin-bottom: 30px;">
    <table>
      <thead>
        <tr>
          <th>المسار</th>
          <th>رقم الطلب</th>
          <th>نوع العطل</th>
          <th>المبنى</th>
          <th>التاريخ</th>
          <th>الحالة</th>
          <th>الإجراءات</th>
        </tr>
      </thead>
      <tbody id="myRequestsTable"></tbody>
    </table>
  </div>
</div>
</div>

<!-- Modals will be added here by JavaScript -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
// Global Variables
let currentUser = null;
let requests = [];
let users = [];
let appsScriptUrl = '';
let techRepairImage = null;
let uploadedImage = null;
let techniciansLoaded = false;
let techniciansLoading = false;


function requestScope() {
  return {
    name: currentUser?.name || '',
    role: currentUser?.role || ''
  };
}


// ========================================
// ===== إضافات جديدة تبدأ من هنا =====
// ========================================

// ===== helper: map status → badge class =====
function getStatusClass(s){
  s = (s||'').trim();
  if (['محذوف'].includes(s)) return 'deleted';
  if (['مرفوض','غير مكتمل','ملغي'].includes(s)) return 'rejected';
  if (['مكتمل'].includes(s)) return 'completed';
  if (['محوّل للفني','جاري المراجعة','يحتاج مراجعة','معتمد',
       'بانتظار السلامة (نهائية)','معتمد من السلامة (نهائية)'].includes(s)) return 'progress';
  if (['بانتظار السلامة (أولية)','معتمد من السلامة (أولية)'].includes(s)) return 'safety'; // ← جديد
  return 'pending';
}


// 1️⃣ نظام Queue البسيط
const syncQueue = {
  queue: [],
  processing: false,

  load() {
    try {
      this.queue = JSON.parse(localStorage.getItem('syncQueue') || '[]');
    } catch {
      this.queue = [];
    }
  },

  save() {
    localStorage.setItem('syncQueue', JSON.stringify(this.queue));
  },

  add(operation) {
    this.queue.push({
      id: Date.now(),
      type: operation.type,
      data: operation.data,
      attempts: 0,
      timestamp: new Date().toISOString()
    });
    this.save();
    this.process();
  },


  // ✅ الدالة الجديدة
  async retryWithBackoff(operation, attempt = 0) {
    const maxAttempts = 3;
    const baseDelay = 2000;
    
    try {
      if (operation.type === 'add') {
        return await callAppsScript('addRequest', operation.data, false);
      } else if (operation.type === 'update') {
        return await callAppsScript('updateRequest', operation.data, false);
      } else if (operation.type === 'delete') {
        return await callAppsScript('softDeleteRequest', operation.data, false);
      }
    } catch (error) {
      if (attempt < maxAttempts) {
        const delay = baseDelay * Math.pow(2, attempt);
        console.log(`⏳ إعادة المحاولة ${attempt + 1}/${maxAttempts} بعد ${delay}ms`);
        await new Promise(resolve => setTimeout(resolve, delay));
        return this.retryWithBackoff(operation, attempt + 1);
      }
      throw error;
    }
  },

async process() {
    if (this.processing || this.queue.length === 0) return;
    
    this.processing = true;
    const totalItems = this.queue.length;
    
    // عرض رسالة واحدة فقط في البداية
    showSyncIndicator('syncing', `⏳ مزامنة ${totalItems} عملية...`, false);

    let successCount = 0;
    let failCount = 0;

    while (this.queue.length > 0) {
      const item = this.queue[0];
      
      try {
        await this.retryWithBackoff(item);
        
        this.queue.shift();
        successCount++;
        this.save();
        
        // لا نعرض رسائل متكررة للعمليات الفردية
        // فقط نسجل في Console
        const remaining = this.queue.length;
        if (remaining > 0) {
          console.log(`✓ ${successCount}/${totalItems} - متبقي ${remaining}`);
        }
        
      } catch (error) {
        console.error('فشلت العملية بعد كل المحاولات:', error);
        item.attempts = (item.attempts || 0) + 1;
        
        if (item.attempts >= 3) {
          console.error('❌ عملية فشلت نهائياً:', item);
          this.queue.shift();
          failCount++;
          // نسجل الفشل لكن بدون رسالة منبثقة لكل عملية
          console.warn(`⚠️ فشلت عملية: ${item.type} (ID: ${item.data?.id || 'N/A'})`);
        } else {
          break;
        }
        this.save();
      }
    }

    this.processing = false;
    
    // عرض رسالة نهائية واحدة فقط
    if (this.queue.length === 0) {
      if (failCount > 0) {
        showSyncIndicator('error', `✓ ${successCount} نجحت • ✗ ${failCount} فشلت`, true);
      } else {
        showSyncIndicator('success', `✓ تمت مزامنة ${successCount} عملية`, true);
      }
    } else {
      showSyncIndicator('error', `⚠️ متبقي ${this.queue.length} - إعادة محاولة...`, true);
    }
  }
};

// 2️⃣ ضغط الصور
async function compressImage(file) {
  return new Promise((resolve, reject) => {
    // ❌ (سطر خاطئ سابقًا) كان يمنع الملفات الكبيرة:
    // if (file.size > 2 * 1024 * 1024) { reject(new Error('حجم الصورة كبير جداً')); return; }

    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const maxSize = 800; // تصغير الأبعاد القصوى

        let w = img.width;
        let h = img.height;

        if (w > h && w > maxSize) {
          h = (h * maxSize) / w;
          w = maxSize;
        } else if (h > maxSize) {
          w = (w * maxSize) / h;
          h = maxSize;
        }

        canvas.width = w;
        canvas.height = h;

        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);

        // JPEG بجودة مناسبة
        const dataUrl = canvas.toDataURL('image/jpeg', 0.85);

        resolve(dataUrl);
      };
      img.onerror = () => reject(new Error('فشل تحميل الصورة'));
      img.src = e.target.result;
    };
    reader.onerror = () => reject(new Error('فشل قراءة الملف'));
    reader.readAsDataURL(file);
  });
}

// ===== نهاية الإضافات الجديدة =====

// User Roles
const ROLES = {
  QUALITY_MANAGER: 'وكيل ضبط الجودة',
  SUPERVISOR: 'مشرف الصيانة',
  TECHNICIAN: 'فني الصيانة',
  EMPLOYEE: 'موظف',
  DEAN: 'العميد',  // ← أضف فاصلة هنا
  SAFETY_OFFICER: 'مسؤول السلامة'
};

// ===== [NEW] Lifecycle constants =====

const STATUS = {
  WAIT_SAFETY_1: 'بانتظار السلامة (أولية)',  // ← جديد
  SAFETY_APPROVED_1: 'معتمد من السلامة (أولية)',  // ← جديد
  WAIT_SUP: 'بانتظار المشرف',
  ASSIGNED: 'محوّل للفني',
  TECH_REVIEW: 'جاري المراجعة',
  NEEDS_REVIEW: 'يحتاج مراجعة',
  WAIT_SAFETY_2: 'بانتظار السلامة (نهائية)',  // ← جديد
  SAFETY_APPROVED_2: 'معتمد من السلامة (نهائية)',  // ← جديد
  APPROVED: 'معتمد',
  COMPLETED: 'مكتمل',
  REJECTED: 'مرفوض',
  NOT_FIXED: 'غير مكتمل',
  CANCELED: 'ملغي',
  DELETED: 'محذوف'
};
const ROLE = ROLES; // كما بالكود


// Hijri Conversion
function toHijri(gregorianDate) {
  const gDate = new Date(gregorianDate);
  const gYear = gDate.getFullYear();
  const gMonth = gDate.getMonth() + 1;
  const gDay = gDate.getDate();
  
  const hYear = Math.floor((gYear - 622) * 1.030684);
  const hMonth = Math.floor((gMonth + (gDay / 30)) * 1.030684) % 12 || 12;
  const hDay = Math.floor((gDay * 1.030684) % 30) || 1;
  
  const arabicMonths = [
    'محرم', 'صفر', 'ربيع الأول', 'ربيع الثاني', 'جمادى الأولى', 'جمادى الثانية',
    'رجب', 'شعبان', 'رمضان', 'شوال', 'ذو القعدة', 'ذو الحجة'
  ];
  
  return `${hDay} ${arabicMonths[hMonth - 1]} ${hYear}هـ`;
}

// Get Arabic Day
function getArabicDay(date) {
  const days = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
  return days[new Date(date).getDay()];
}

function showNotification(msg, type='info'){
  console[type==='error'?'error':'log']('NOTIFY:', msg);
}

function loadRequestsFromStorage(){
  try{ requests = JSON.parse(localStorage.getItem('requests')||'[]'); }catch{ requests=[]; }
}
function saveRequestsToStorage(){
  try{ localStorage.setItem('requests', JSON.stringify(requests||[])); }catch{}
}


function exportToExcel(){ alert('تصدير Excel: لم يُنفّذ بعد'); }
function exportAllWithTemplates(){ alert('تصدير بالنماذج: لم يُنفّذ بعد'); }
function exportToPDF(){ alert('تصدير PDF: لم يُنفّذ بعد'); }
function printReport(){ window.print(); }


// ===== config.json loader =====
let CONFIG = null;

async function loadConfig() {
  try {
    const res = await fetch('config.json', { cache: 'no-store' });
    if (!res.ok) throw new Error('config fetch failed');
    CONFIG = await res.json();
    localStorage.setItem('systemConfig', JSON.stringify(CONFIG));
    applyConfig(CONFIG);
  } catch (e) {
    const cached = localStorage.getItem('systemConfig');
    if (cached) {
      CONFIG = JSON.parse(cached);
      applyConfig(CONFIG);
    }
  }
}

function applyConfig(cfg) {
  try {
    if (cfg?.theme) {
      document.documentElement.style.setProperty('--primary', cfg.theme.primaryColor);
      document.documentElement.style.setProperty('--secondary', cfg.theme.secondaryColor);
    }
  } catch(e){}

  // ✅ الإصلاح: احفظ الرابط في localStorage
  if (cfg?.googleSheets?.enabled && cfg.googleSheets.appsScriptUrl) {
    appsScriptUrl = cfg.googleSheets.appsScriptUrl;
    localStorage.setItem('appsScriptUrl', appsScriptUrl);  // ← أضف هذا السطر
    
    const input = document.getElementById('appsScriptUrl');
    if (input) input.value = appsScriptUrl;

    const section = document.getElementById('sheetsConfigSection');
    if (section) section.style.display = 'none';
  }
}

// Initialize
window.onload = async function() {
  await loadConfig();
  // ✅ تحميل Queue من localStorage
  syncQueue.load();

  const savedUrl = localStorage.getItem('appsScriptUrl');
  if (!appsScriptUrl && savedUrl) {
    appsScriptUrl = savedUrl;
  }

  loadRequestsFromStorage();
  updateNextRequestId();
  setCurrentDateTime();

  const savedUser = localStorage.getItem('currentUser');
  if (savedUser && (appsScriptUrl || (CONFIG?.advanced?.offlineMode))) {
    currentUser = JSON.parse(savedUser);
       
    showMainApp();
  }

  setTimeout(() => {
    document.getElementById('loadingScreen').style.display = 'none';
  }, 1000);

  createModals();
};


// Create Modals
function createModals() {
  const modalsHTML = `
    <!-- Technician Report Modal -->
    <div class="modal" id="technicianModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>🔧 تقرير الفني</h2>
          <button class="close-modal" onclick="closeModal('technicianModal')">&times;</button>
        </div>
        
        <form id="technicianForm" onsubmit="submitTechnicianReport(event)">
          <input type="hidden" id="techRequestId">
          
          <div class="form-group">
            <label>اسم الفني</label>
            <input type="text" id="technicianName" required>
          </div>
          
          <div class="form-group">
            <label>حالة العمل</label>
            <select id="workStatus" required>
              <option value="">اختر الحالة</option>
              <option value="تمت المعالجة">تمت المعالجة</option>
              <option value="جاري المعالجة">جاري المعالجة</option>
              <option value="تحت المتابعة">تحت المتابعة</option>
              <option value="يتطلب إجراءات إضافية">يتطلب إجراءات إضافية</option>
              <option value="يحتاج قطع غيار">يحتاج قطع غيار</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>ملاحظات الفني</label>
            <textarea id="technicianNotes" placeholder="أضف أي ملاحظات هنا..." required></textarea>
          </div>
          <div class="form-group">
            <label>📷 صورة الإصلاح (إلزامي)</label>
            <div class="image-upload-container" id="techUploadContainer" onclick="document.getElementById('techRepairImage').click()">
              <div class="upload-icon">📸</div>
              <div class="upload-text">اضغط لرفع صورة الإصلاح</div>
              <img id="techRepairImagePreview" class="image-preview" alt="معاينة صورة الإصلاح">
              <input type="file" id="techRepairImage" accept="image/*" style="display: none;" onchange="handleTechImageUpload(event)" required>
              <button type="button" class="remove-image-btn" id="removeTechImageBtn" onclick="event.stopPropagation(); removeTechImage()">
                ❌ إزالة الصورة
              </button>
            </div>
          </div>
          <button type="submit" class="btn-primary">حفظ التقرير</button>
          <button type="button" class="btn-secondary" onclick="closeModal('technicianModal')">إلغاء</button>
        </form>
      </div>
    </div>

    <!-- Supervisor Review Modal -->
    <!-- Safety Review Modal 1 (مراجعة أولية) -->
<div class="modal" id="safetyModal1">
  <div class="modal-content">
    <div class="modal-header">
      <h2>🦺 مراجعة السلامة (أولية)</h2>
      <button class="close-modal" onclick="closeModal('safetyModal1')">&times;</button>
    </div>
    
    <form id="safetyForm1" onsubmit="submitSafetyReview1(event)">
      <input type="hidden" id="safetyRequestId1">
      
      <div class="form-group">
        <label>اسم مسؤول السلامة</label>
        <input type="text" id="safetyOfficerName1" required>
      </div>
      
      <div class="form-group">
        <label>قرار السلامة</label>
        <select id="safetyDecision1" required>
          <option value="">اختر القرار</option>
          <option value="آمن للتنفيذ">✅ آمن للتنفيذ</option>
          <option value="يحتاج إجراءات سلامة">⚠️ يحتاج إجراءات سلامة</option>
          <option value="غير آمن - مرفوض">❌ غير آمن - مرفوض</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>ملاحظات السلامة</label>
        <textarea id="safetyNotes1" placeholder="أضف ملاحظات السلامة والإجراءات المطلوبة..." required></textarea>
      </div>
      
      <button type="submit" class="btn-primary">حفظ المراجعة</button>
      <button type="button" class="btn-secondary" onclick="closeModal('safetyModal1')">إلغاء</button>
    </form>
  </div>
</div>

<!-- Safety Review Modal 2 (مراجعة نهائية) -->
<div class="modal" id="safetyModal2">
  <div class="modal-content">
    <div class="modal-header">
      <h2>🦺 مراجعة السلامة (نهائية)</h2>
      <button class="close-modal" onclick="closeModal('safetyModal2')">&times;</button>
    </div>
    
    <form id="safetyForm2" onsubmit="submitSafetyReview2(event)">
      <input type="hidden" id="safetyRequestId2">
      
      <div class="form-group">
        <label>اسم مسؤول السلامة</label>
        <input type="text" id="safetyOfficerName2" required>
      </div>
      
      <div class="form-group">
        <label>قرار السلامة النهائي</label>
        <select id="safetyDecision2" required>
          <option value="">اختر القرار</option>
          <option value="معتمد - العمل مطابق">✅ معتمد - العمل مطابق</option>
          <option value="معتمد مع ملاحظات">⚠️ معتمد مع ملاحظات</option>
          <option value="غير معتمد">❌ غير معتمد</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>ملاحظات السلامة النهائية</label>
        <textarea id="safetyNotes2" placeholder="أضف ملاحظات السلامة النهائية..." required></textarea>
      </div>
      
      <button type="submit" class="btn-primary">حفظ المراجعة النهائية</button>
      <button type="button" class="btn-secondary" onclick="closeModal('safetyModal2')">إلغاء</button>
    </form>
  </div>
</div>
    <div class="modal" id="supervisorModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>✅ مراجعة المشرف</h2>
          <button class="close-modal" onclick="closeModal('supervisorModal')">&times;</button>
        </div>
        
        <form id="supervisorForm" onsubmit="submitSupervisorReview(event)">
          <input type="hidden" id="supRequestId">
          
          <div class="form-group">
            <label>اسم المشرف</label>
            <input type="text" id="supervisorName" required>
          </div>
          
          <div class="form-group" id="decisionBlock" style="display:none">
          <label>قرار المشرف</label>
          <select id="supervisorDecision">
            <option value="">اختر القرار</option>
            <option value="معتمد">معتمد</option>
            <option value="يحتاج مراجعة">يحتاج مراجعة</option>
          </select>
        </div>

          <!-- داخل #supervisorModal، بعد قسم قرار المشرف -->
          <div class="form-group">
            <label>تعيين الفني (من ورقة المستخدمين)</label>
            <select id="assignedTechnicianSelect">
              <option value="">— اختر الفني —</option>
            </select>
            <small style="color:#888">تُجلب الأسماء تلقائيًا من Google Sheets (الدور = فني الصيانة). ولو تعذّر، يتم الاعتماد على قائمة تجريبية محليًا.</small>
          </div>

          
          <div class="form-group">
            <label>ملاحظات المشرف</label>
            <textarea id="supervisorNotes" placeholder="أضف ملاحظاتك هنا..." required></textarea>
          </div>
          
          <button type="submit" class="btn-primary">حفظ المراجعة</button>
          <button type="button" class="btn-secondary" onclick="closeModal('supervisorModal')">إلغاء</button>
        </form>
      </div>
    </div>

    <!-- Client Feedback Modal -->
    <div class="modal" id="clientModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>⭐ تقييم العميل</h2>
          <button class="close-modal" onclick="closeModal('clientModal')">&times;</button>
        </div>
        
        <form id="clientForm" onsubmit="submitClientFeedback(event)">
          <input type="hidden" id="clientRequestId">
          
          <div class="form-group">
            <label>هل تمت معالجة الملاحظة؟</label>
            <select id="isFixed" required>
              <option value="">اختر</option>
              <option value="نعم">نعم</option>
              <option value="لا">لا</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>مستوى الرضا</label>
            <select id="satisfactionLevel" required>
              <option value="">اختر مستوى الرضا</option>
              <option value="ممتاز">ممتاز ⭐⭐⭐⭐⭐</option>
              <option value="جيد جداً">جيد جداً ⭐⭐⭐⭐</option>
              <option value="جيد">جيد ⭐⭐⭐</option>
              <option value="مقبول">مقبول ⭐⭐</option>
              <option value="ضعيف">ضعيف ⭐</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>ملاحظات العميل</label>
            <textarea id="clientNotes" placeholder="أضف ملاحظاتك أو اقتراحاتك..."></textarea>
          </div>
          
          <button type="submit" class="btn-primary">إرسال التقييم</button>
          <button type="button" class="btn-secondary" onclick="closeModal('clientModal')">إلغاء</button>
        </form>
      </div>
    </div>

    <!-- View Details Modal -->
    <div class="modal" id="viewModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>📋 تفاصيل الطلب</h2>
          <button class="close-modal" onclick="closeModal('viewModal')">&times;</button>
        </div>
        <div id="viewDetailsContent"></div>
        <button class="btn-secondary" onclick="closeModal('viewModal')">إغلاق</button>
      </div>
    </div>

    <!-- Image Modal -->
    <div class="modal" id="imageModal">
      <div class="modal-content image-modal-content">
        <div class="modal-header">
          <h2>📷 صورة العطل</h2>
          <button class="close-modal" onclick="closeModal('imageModal')">&times;</button>
        </div>
        <img id="modalImage" style="width: 100%; height: auto; border-radius: 10px;" alt="صورة العطل">
      </div>
    </div>
        <!-- Client Actions Modal (حذف الطلب للعميل فقط) -->
      <div class="modal" id="clientActionsModal">
        <div class="modal-content">
          <div class="modal-header">
            <h2>🗑️ حذف الطلب</h2>
            <button class="close-modal" onclick="closeModal('clientActionsModal')">&times;</button>
          </div>
          <form id="clientActionsForm" onsubmit="submitClientAction(event)">
            <input type="hidden" id="clientActionRequestId">
            <div class="form-group">
              <label>سبب الحذف</label>
              <textarea id="clientActionReason" placeholder="اذكر سبب الحذف..." required></textarea>
            </div>
            <button type="submit" class="btn-primary btn-danger">حذف الطلب</button>
            <button type="button" class="btn-secondary" onclick="closeModal('clientActionsModal')">إلغاء</button>
          </form>
        </div>
      </div>

  `
  ;
  
  document.body.insertAdjacentHTML('beforeend', modalsHTML);
}

// Handle Image Upload

async function handleImageUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  if (!file.type.startsWith('image/')) {
    alert('❌ الملف المختار ليس صورة');
    event.target.value = '';
    return;
  }
  
  try {
    showNotification('جاري ضغط الصورة...', 'info');
    
    uploadedImage = await compressImage(file);
    
    document.getElementById('imagePreview').src = uploadedImage;
    document.getElementById('imagePreview').classList.add('show');
    document.getElementById('removeImageBtn').classList.add('show');
    document.getElementById('uploadContainer').classList.add('has-image');
    
    showNotification('✓ تم تحسين الصورة', 'success');
  } catch (error) {
    alert('❌ ' + error.message);
    event.target.value = '';
  }
}

function normalizeName(s=''){
  return s.replace(/\s+/g,' ').replace(/ـ/g,'').trim();
}

// Remove Image
function removeImage() {
  uploadedImage = null;
  document.getElementById('imageUpload').value = '';
  document.getElementById('imagePreview').classList.remove('show');
  document.getElementById('removeImageBtn').classList.remove('show');
  document.getElementById('uploadContainer').classList.remove('has-image');
}

// Handle Tech Image Upload
// Handle Tech Image Upload - محسّن مع ضغط
async function handleTechImageUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  if (!file.type.startsWith('image/')) {
    alert('❌ الملف المختار ليس صورة');
    event.target.value = '';
    return;
  }
  
  try {
    showNotification('جاري ضغط الصورة...', 'info');
    
    techRepairImage = await compressImage(file);
    
    document.getElementById('techRepairImagePreview').src = techRepairImage;
    document.getElementById('techRepairImagePreview').classList.add('show');
    document.getElementById('removeTechImageBtn').classList.add('show');
    document.getElementById('techUploadContainer').classList.add('has-image');
    
    showNotification('✓ تم تحسين الصورة', 'success');
  } catch (error) {
    alert('❌ ' + error.message);
    event.target.value = '';
  }
}

// Remove Tech Image
function removeTechImage() {
  techRepairImage = null;
  document.getElementById('techRepairImage').value = '';
  document.getElementById('techRepairImagePreview').classList.remove('show');
  document.getElementById('removeTechImageBtn').classList.remove('show');
  document.getElementById('techUploadContainer').classList.remove('has-image');
}





// View Image
async function viewImage(imageData) {
  if (!imageData) { alert('لا توجد صورة'); return; }

  const modal = document.getElementById('imageModal');
  const modalImage = document.getElementById('modalImage');

  // أعطِنا رابطًا صالحًا للعرض
  const resolved = resolveImageSrc(imageData);
  modalImage.removeAttribute('onerror'); // نظافة
  modalImage.src = '';                   // فرض إعادة التحميل
  modalImage.src = resolved;

  // لو فشل التحميل (مثلًا خصوصية الملف أو صيغة غريبة)
  modalImage.onerror = () => {
    // محاولة أخيرة بنمط googleusercontent
    const m = resolved.match(/[?&]id=([a-zA-Z0-9_-]{25,})/);
    if (m && m[1]) {
      modalImage.onerror = null;
      modalImage.src = `https://lh3.googleusercontent.com/d/${m[1]}=w1600-h1600`;
    } else {
      alert('تعذّر عرض الصورة. تأكد أن ملف Google Drive “Anyone with the link”.');
    }
  };

  modal.classList.add('active');
}



async function sendAuditToSheet(evt) {
  try {
    if (!appsScriptUrl) return;
    // نتوقع أن GAS لديه أكشن logEvent يحفظ في ورقة Logs
    await callAppsScript('logEvent', evt, false);
  } catch (e) {
    console.warn('تعذر إرسال السجل للشيت الآن، سيتم تجاهل الحدث فقط:', e);
  }
}

// Google Sheets Integration

// Google Sheets Integration
// استبدل دالة callAppsScript كاملة بهذه النسخة

// استبدل أي نسخة سابقة بهذه النسخة
async function callAppsScript(action, data, showIndicator = true) {
  if (!appsScriptUrl) { console.warn('Apps Script URL فارغ'); return null; }
  if (showIndicator && action !== 'getImageBase64') showSyncIndicator('syncing','جاري المزامنة...');

  try {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 90000);

    const res = await fetch(appsScriptUrl, {
      method: 'POST',
      // 👇 لا تستخدم application/json (هذا الذي يسبّب preflight)
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      // أرسل نص عادي (سيفكّه السيرفر بـ JSON.parse)
      body: JSON.stringify({ action, data }),
      signal: controller.signal,
      // mode: 'cors' أو اتركها افتراضي- كلاهما OK بعد جعل الطلب بسيط
    });

    clearTimeout(timeoutId);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();
    if (showIndicator && action !== 'getImageBase64') showSyncIndicator('success','متزامن');
    return json;

  } catch (err) {
    console.error('خطأ fetch:', err);
    if (showIndicator && action !== 'getImageBase64') showSyncIndicator('error','فشل الاتصال');
    alert(`خطأ: ${err.message}\n\nتأكد من:\n1) URL ينتهي بـ /exec\n2) النشر: Anyone\n3) حفظت آخر نشر`);
    return null;
  }
}


// إنشاء Timeline للطلب
function generateTimeline(req) {
  const st = (req.status || '').trim();

  const submittedDone = true;
  
  // مراجعة السلامة الأولية
  const safety1Done = ['بانتظار المشرف','محوّل للفني','جاري المراجعة','يحتاج مراجعة',
                        'بانتظار السلامة (نهائية)','معتمد','مكتمل','غير مكتمل','ملغي'].includes(st)
                       || !!(req.safetyOfficerName1);

  const sup1Done = ['محوّل للفني','جاري المراجعة','يحتاج مراجعة','بانتظار السلامة (نهائية)',
                    'معتمد','مكتمل','غير مكتمل','ملغي'].includes(st)
                   || !!(req.supervisorName || req.assignedTechnicianName);

  const techDone = ['جاري المراجعة','يحتاج مراجعة','بانتظار السلامة (نهائية)',
                    'معتمد','مكتمل','غير مكتمل'].includes(st)
                   || !!(req.technicianName || req.workStatus);

  const sup2Done = ['بانتظار السلامة (نهائية)','معتمد','مكتمل','غير مكتمل'].includes(st)
                   || (req.supervisorDecision === 'معتمد');

  // مراجعة السلامة النهائية
  const safety2Done = ['معتمد','مكتمل','غير مكتمل','ملغي'].includes(st)
                      || !!(req.safetyOfficerName2);

  const clientDone = ['مكتمل','غير مكتمل','ملغي'].includes(st)
                     || !!(req.isFixed || req.cancelReason);

  const completedDone = ['مكتمل','ملغي','غير مكتمل'].includes(st);

  const stages = [
    { id:'submitted', icon:'📝', label:'تم الإرسال', done: submittedDone,
      info: req.createdBy ? `${req.createdBy}<br>${req.date||''}` : (req.date||'') },

    { id:'safety1', icon:'🦺', label:'مراجعة السلامة (أولية)', done: safety1Done,
      info: req.safetyDecision1 ? `${req.safetyOfficerName1||'-'}<br>${req.safetyDecision1}` : 
            (safety1Done ? 'تمت المراجعة' : 'بانتظار السلامة') },

    { id:'sup1', icon:'✅', label:'مراجعة المشرف', done: sup1Done,
      info: req.assignedTechnicianName ? `حُوِّل إلى: ${req.assignedTechnicianName}` : 
            (sup1Done ? 'تم الاستلام' : 'بانتظار المشرف') },

    { id:'tech', icon:'🔧', label:'تقرير الفني', done: techDone,
  info: techDone ? `${req.technicianName||req.assignedTechnicianName||'-'}<br>${req.workStatus||''}` : 'بانتظار التقرير' },


    { id:'sup2', icon:'✅', label:'مراجعة المشرف (قرار)', done: sup2Done,
      info: sup2Done ? `${req.supervisorName||'-'}<br>${req.supervisorDecision||'معتمد'}` : 
            'بانتظار القرار' },

    { id:'safety2', icon:'🦺', label:'مراجعة السلامة (نهائية)', done: safety2Done,
      info: req.safetyDecision2 ? `${req.safetyOfficerName2||'-'}<br>${req.safetyDecision2}` : 
            (safety2Done ? 'تمت المراجعة' : 'بانتظار السلامة النهائية') },

    { id:'client', icon:'⭐', label:'تقييم العميل', done: clientDone,
      info: req.cancelReason ? `ملغي: ${req.cancelReason}` :
            (req.isFixed ? `${req.isFixed}<br>${req.satisfactionLevel||''}` : 'بانتظار التقييم') },

    { id:'completed', icon:(st==='ملغي'?'⛔':'🎉'), 
      label:(st==='ملغي'?'ملغي': (st==='غير مكتمل'?'غير مكتمل':'مكتمل')),
      done: completedDone, info: completedDone ? (st==='ملغي'?(req.cancelReason||''): 'تم الإنجاز') : '' }
  ];

  const doneCount = stages.filter(s => s.done).length;
  const idxActive = Math.min(doneCount, stages.length - 1);
  const lineProgress = idxActive>0 ? (idxActive/(stages.length-1))*100 : 0;
  const progress = Math.round((doneCount/stages.length)*100);

  let html = '<div class="request-timeline">';
  html += '<div class="timeline-header">📍 مسار الطلب</div>';
  html += '<div class="timeline-container">';
  html += `<div class="timeline-line"><div class="timeline-line-progress" style="width:${lineProgress}%"></div></div>`;

  stages.forEach((stage, i) => {
    let cls = 'timeline-step';
    if (stage.done) cls += ' completed';
    else if (i === idxActive) cls += ' active';
    if (stage.id === 'safety1' || stage.id === 'safety2') cls += ' safety';
    if (st === 'ملغي' && (stage.id==='client' || stage.id==='completed')) cls += ' rejected';

    html += `<div class="${cls}">
      <div class="timeline-icon">${stage.icon}</div>
      <div class="timeline-label">${stage.label}</div>
      <div class="timeline-info">${stage.info||''}</div>
    </div>`;
  });

  html += '</div>';
  html += `<div class="timeline-progress">
    <div class="progress-text">نسبة الإنجاز: ${progress}%</div>
    <div class="progress-bar-container"><div class="progress-bar-fill" style="width:${progress}%"></div></div>
  </div></div>`;
  return html;
}
// يحوّل صفوف الشيت (رؤوس عربية) إلى نموذج الواجهة (مفاتيح إنجليزية)
function normalizeDriveImageUrl(url) {
  if (!url) return '';
  const fileId = extractDriveId(url);
  // ✅ استخدام رابط أحدث وأسرع
  return fileId ? `https://lh3.googleusercontent.com/d/${fileId}=w1600-h1600` : url;
}

// ===== helpers for Drive images =====

// يستخرج fileId من أي شكل رابط Drive
function extractDriveId(url) {
  if (!url) return null;
  const patterns = [
    /\/file\/d\/([a-zA-Z0-9_-]+)/,
    /[?&]id=([a-zA-Z0-9_-]+)/,
    /\/d\/([a-zA-Z0-9_-]+)(?:[/?#]|$)/,
    /^([a-zA-Z0-9_-]{15,})$/ // معرّف فقط
  ];
  for (const p of patterns) {
    const m = url.match(p);
    if (m && m[1]) return m[1];
  }
  return null;
}

function resolveImageSrc(src='') {
  if (!src) return '';
  if (src.startsWith('data:image/')) return src; // Base64

  // جرّب استخراج الـ id
  const id = extractDriveId(src);
  if (id) {
    // رابط عرض مباشر سريع
    return `https://lh3.googleusercontent.com/d/${id}=w1600-h1600`;
  }

  // رابط http عادي
  if (/^https?:\/\//i.test(src)) return src;

  return src;
}


// يطلب من Apps Script تحويل صورة Drive إلى dataURL (Base64)
// يتطلب إضافة أكشن getImageBase64 في السكربت (انظر القسم 3 بالأسفل)
async function getDriveImageAsDataURL(url) {
  const fileId = extractDriveId(url);
  if (!fileId) return null;
  
  try {
    const result = await callAppsScript('getImageBase64', { fileId: fileId });
    return (result && result.ok && result.dataUrl) ? result.dataUrl : null;
  } catch (err) {
    console.error('خطأ في getDriveImageAsDataURL:', err);
    return null;
  }
}

// بديل احتياطي داخل المتصفح (قد يفشل بسبب CORS مع روابط Drive)
async function urlToDataURL(url) {
  const res = await fetch(url);  // قد يرمي CORS
  const blob = await res.blob();
  return await new Promise((resolve) => {
    const fr = new FileReader();
    fr.onload = () => resolve(fr.result); // data:image/...;base64,...
    fr.readAsDataURL(blob);
  });
}


function mapArabicRowToModel(ar) {
  const rawUrl =
    ar['رابط الصورة'] || ar['صورة العطل'] || ar['الصورة'] ||
    ar['Image URL'] || ar['imageUrl'] || '';
  const rawB64 =
    ar['صورة العطل (Base64)'] || ar['Base64'] || ar['image'] || '';
  const repairUrl =
    ar['رابط صورة الإصلاح'] || ar['صورة الإصلاح (رابط)'] || ar['repairImageUrl'] || '';
  const repairB64 =
    ar['صورة الإصلاح (Base64)'] || ar['repairImage'] || '';

  return {
    id: (ar['رقم الطلب'] || '').toString(),
    type: ar['نوع الطلب'] || '',
    building: ar['المبنى'] || '',
    maintenanceType: ar['نوع الصيانة'] || '',
    requesterName: ar['اسم صاحب الطلب'] || '',
    time: ar['الوقت'] || '',
    date: ar['التاريخ'] || '',
    hijriDate: ar['التاريخ الهجري'] || '',
    day: ar['اليوم'] || '',
    faultType: ar['نوع العطل'] || '',
    faultDescription: ar['وصف العطل'] || '',
    image: rawB64 || '',
    imageUrl: normalizeDriveImageUrl(rawUrl),
    repairImage: repairB64 || '',
    repairImageUrl: normalizeDriveImageUrl(repairUrl),
    status: (ar['الحالة'] || 'بانتظار السلامة (أولية)').trim(), // ✅ التصحيح
    technicianName: ar['اسم الفني'] || '',
    workStatus: ar['حالة العمل'] || '',
    technicianNotes: ar['ملاحظات الفني'] || '',
    supervisorName: ar['اسم المشرف'] || '',
    supervisorDecision: ar['قرار المشرف'] || '',
    supervisorNotes: ar['ملاحظات المشرف'] || '',
    isFixed: ar['تم الإصلاح'] || '',
    satisfactionLevel: ar['مستوى الرضا'] || '',
    clientNotes: ar['ملاحظات العميل'] || '',
    createdAt: ar['تاريخ الإنشاء'] || '',
    assignedTechnicianName: ar['الفني المعيّن'] || ''
  };
}


// Show Sync Indicator

// ===== نظام إدارة المؤشرات الاحترافي =====
let lastSyncTime = null;

const SyncIndicatorManager = {
  timeout: null,
  currentStatus: null,
  isVisible: false,
  lastUpdate: 0,
  minDisplayTime: 800, // الحد الأدنى لعرض كل رسالة (milliseconds)
  
  show(status, message = '', autoHide = true) {
    const now = Date.now();
    
    // تجاهل التحديثات المتكررة جداً (Debounce)
    if (this.currentStatus === status && (now - this.lastUpdate) < 500) {
      return;
    }
    
    this.lastUpdate = now;
    this.currentStatus = status;
    
    const indicator = document.getElementById('syncIndicator');
    const text = document.getElementById('syncText');
    const icon = document.getElementById('syncIcon');
    const timeEl = document.getElementById('syncTime');
    
    if (!indicator) return;
    
    // امسح أي timeout سابق
    if (this.timeout) {
      clearTimeout(this.timeout);
      this.timeout = null;
    }
    
    // تحديث المحتوى
    indicator.className = `sync-indicator show ${status}`;
    text.textContent = message || this._getDefaultMessage(status);
    
    // تحديث الأيقونة
    if (status === 'syncing') {
      icon.innerHTML = '<div class="sync-spinner"></div>';
      timeEl.textContent = '';
    } else if (status === 'success') {
      icon.textContent = '✓';
      lastSyncTime = new Date();
      this._updateTime();
    } else if (status === 'error') {
      icon.textContent = '✗';
      timeEl.textContent = '';
    }
    
    this.isVisible = true;
    
    // إخفاء تلقائي بعد المدة المناسبة
    if (autoHide && status !== 'syncing') {
      const hideDelay = status === 'error' ? 4000 : 2500;
      this.timeout = setTimeout(() => {
        this.hide();
      }, Math.max(hideDelay, this.minDisplayTime));
    }
  },
  
  hide() {
    const indicator = document.getElementById('syncIndicator');
    if (indicator) {
      indicator.classList.remove('show');
    }
    this.isVisible = false;
    this.currentStatus = null;
  },
  
  _getDefaultMessage(status) {
    const messages = {
      'syncing': 'جاري المزامنة...',
      'success': 'متزامن',
      'error': 'فشلت المزامنة'
    };
    return messages[status] || '';
  },
  
  _updateTime() {
    const timeEl = document.getElementById('syncTime');
    if (!lastSyncTime || !timeEl) return;
    
    const diff = Math.floor((new Date() - lastSyncTime) / 1000);
    if (diff < 60) {
      timeEl.textContent = 'الآن';
    } else if (diff < 3600) {
      timeEl.textContent = `قبل ${Math.floor(diff / 60)} د`;
    } else {
      timeEl.textContent = lastSyncTime.toLocaleTimeString('ar-SA', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
    }
  }
};

// دالة wrapper للتوافق مع الكود القديم
function showSyncIndicator(status, message = '', autoHide = true) {
  SyncIndicatorManager.show(status, message, autoHide);
}

// تحديث وقت آخر مزامنة
function updateSyncTime() {
  SyncIndicatorManager._updateTime();
}

// تحديث الوقت كل دقيقة
setInterval(updateSyncTime, 60000);

// Sync with Sheets
async function syncWithSheets() {
  if (!appsScriptUrl) {
    alert('⚠️ يجب تكوين رابط Google Apps Script أولاً');
    return;
  }
  
  showSyncIndicator('syncing');
  
  // Save all requests to Sheets
  for (const request of requests) {
    await callAppsScript('addRequest', request);
  }
  
  alert('✓ تمت المزامنة مع Google Sheets بنجاح!');
}

async function pullFromSheets() {
  if (!appsScriptUrl) {
    alert('⚠️ اضبط رابط Google Apps Script أولاً');
    return;
  }
  showNotification('جاري السحب من Google Sheets...', 'info');

  const res = await callAppsScript('getRequests', requestScope());
  if (!res) { alert('تعذّر السحب'); return; }

  // السكربت يعيد {success:true, data:[...]}
  const rows = (res.data || []);
  if (!Array.isArray(rows)) {
    alert('صيغة بيانات غير متوقعة من الشيت');
    return;
  }

  // تحويل الرؤوس العربية إلى نموذج الواجهة
  requests = rows
  .map(mapArabicRowToModel)
  .map(r => ({
    ...r,
    requesterName: r.requesterName || r.createdBy || ''  // ← هنا التصحيح
  }));

  saveRequestsToStorage();
  refreshAllTables();
  showNotification(`تم السحب، وعدد الطلبات: ${requests.length}`, 'success');
}



// Login

async function login(e) {
  e.preventDefault();

  const loginBtn = document.getElementById('loginBtn');
  loginBtn.disabled = true;
  loginBtn.textContent = 'جاري التحقق...';

  const employeeId = document.getElementById('employeeId').value.trim();
  const password   = document.getElementById('password').value.trim();
  const scriptUrl  = document.getElementById('appsScriptUrl').value.trim();

  try {
    // لو الكونفق ما عطانا URL: خذه من الحقل واحفظه
    if (!appsScriptUrl && scriptUrl) {
      appsScriptUrl = scriptUrl;
      localStorage.setItem('appsScriptUrl', scriptUrl);
    }
    // فرض التحديث لو المستخدم كتب URL جديد
    if (scriptUrl) {
      appsScriptUrl = scriptUrl;
      localStorage.setItem('appsScriptUrl', scriptUrl);
    }

    const gsEnabled = CONFIG?.googleSheets?.enabled === true;
    const offlineOK = CONFIG?.advanced?.offlineMode === true;

    if (gsEnabled && !appsScriptUrl && !offlineOK) {
      alert('⚠️ رجاءً ضبط رابط Google Apps Script (أو فعّل وضع الأوفلاين في config.json)');
      loginBtn.disabled = false;
      loginBtn.textContent = 'تسجيل الدخول';
      return;
    }

    // تسجيل الدخول الحقيقي عبر GAS
    const res = await callAppsScript('login', { id: employeeId, password });
    if (!res || !res.ok || !res.user) {
      alert(res && res.message ? res.message : 'فشل تسجيل الدخول');
      loginBtn.disabled = false;
      loginBtn.textContent = 'تسجيل الدخول';
      return;
    }

    currentUser = {
      id: res.user.id,
      name: res.user.name,
      role: res.user.role,
      email: res.user.email,
      specialty: res.user.specialty || ''
    };
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    loginBtn.textContent = 'تم الدخول';
    showMainApp();

  } catch (error) {
    console.error('Login error:', error);
    alert('❌ حدث خطأ أثناء تسجيل الدخول');
    loginBtn.disabled = false;
    loginBtn.textContent = 'تسجيل الدخول';
  }
}


// Logout
function logout() {
  if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
    currentUser = null;
    localStorage.removeItem('currentUser');
    location.reload();
  }
}

// Show Main App
async function showMainApp() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('userBar').style.display = 'flex';
  document.getElementById('mainContainer').style.display = 'block';

  document.getElementById('userName').textContent = currentUser.name;
  document.getElementById('userRole').textContent = currentUser.role;

  setupPermissions();
  lockRequesterToCurrentUser();

  // ✅ معالجة موحدة للمزامنة عند الدخول
  const hasPending = syncQueue.queue.length > 0;
  
  if (hasPending) {
    showSyncIndicator('syncing', `⏳ مزامنة ${syncQueue.queue.length} عملية...`, false);
    await syncQueue.process();
  }
  
  // مزامنة تلقائية بصمت (لأن Queue عالجها بالفعل)
  await autoSync(true);
  await loadTechnicians();

  refreshAllTables();
}

// ===== [NEW] Transition rules =====
const TRANSITIONS = {
  submitNew:      { from:[null],             to:STATUS.WAIT_SUP,    by:[ROLE.EMPLOYEE],    must: ['image'] },

  supAssign:      { from:[STATUS.WAIT_SUP, STATUS.NEEDS_REVIEW, STATUS.TECH_REVIEW],
                    to:STATUS.ASSIGNED,     by:[ROLE.SUPERVISOR, ROLE.QUALITY_MANAGER, ROLE.DEAN],
                    must: ['assignedTechnicianName'] },

  techReport:     { from:[STATUS.ASSIGNED],  to:STATUS.TECH_REVIEW, by:[ROLE.TECHNICIAN, ROLE.SUPERVISOR],
                    must: ['workStatus','technicianNotes','repairImage'] },

  supApprove:     { from:[STATUS.TECH_REVIEW], to:STATUS.APPROVED,  by:[ROLE.SUPERVISOR, ROLE.QUALITY_MANAGER, ROLE.DEAN],
                    must: [], post: ['requireTechnicianAssignedOrBlock'] },

  supReject:      { from:[STATUS.TECH_REVIEW, STATUS.WAIT_SUP], to:STATUS.REJECTED,
                    by:[ROLE.SUPERVISOR, ROLE.QUALITY_MANAGER, ROLE.DEAN] },

  supNeedsReview: { from:[STATUS.TECH_REVIEW, STATUS.WAIT_SUP], to:STATUS.NEEDS_REVIEW,
                    by:[ROLE.SUPERVISOR, ROLE.QUALITY_MANAGER, ROLE.DEAN] },

  clientFeedbackYes: { from:[STATUS.APPROVED], to:STATUS.COMPLETED, by:[ROLE.EMPLOYEE] },
  clientFeedbackNo:  { from:[STATUS.APPROVED], to:STATUS.NOT_FIXED, by:[ROLE.EMPLOYEE] },

  clientRedirect: { from:[STATUS.ASSIGNED, STATUS.NEEDS_REVIEW, STATUS.TECH_REVIEW, STATUS.APPROVED],
                    to:STATUS.WAIT_SUP, by:[ROLE.EMPLOYEE],
                    must: ['redirectReason'], post: ['clearAssignedTechnician'] },

  clientCancel:   { from:[STATUS.WAIT_SUP, STATUS.ASSIGNED, STATUS.NEEDS_REVIEW],
                    to:STATUS.CANCELED, by:[ROLE.EMPLOYEE], must: ['cancelReason'] },

          softDelete: { 
          from:['*'], 
          to: STATUS.DELETED, 
          by:[ROLE.SUPERVISOR, ROLE.QUALITY_MANAGER, ROLE.DEAN, ROLE.EMPLOYEE], 
          must: ['deleteReason'] 
        },


        assignTechnician: { 
          from:[STATUS.WAIT_SUP, STATUS.NEEDS_REVIEW, STATUS.TECH_REVIEW],
          to: STATUS.ASSIGNED,
          by:[ROLE.SUPERVISOR, ROLE.QUALITY_MANAGER, ROLE.DEAN],
          must: ['assignedTechnicianName']
        },

        supervisorDecision: {
          from:[STATUS.TECH_REVIEW, STATUS.WAIT_SUP],
          to: STATUS.APPROVED, // صوري؛ التحديد الفعلي في switch
          by:[ROLE.SUPERVISOR, ROLE.QUALITY_MANAGER, ROLE.DEAN],
          must: ['decision'],
          post: ['requireTechnicianAssignedOrBlock']
        },

};

// ===== [NEW] Guards & post hooks =====
function canTransition({action, from, byRole, payload}) {
  const rule = TRANSITIONS[action]; if (!rule) return [false,'Action غير مدعوم'];
  if (rule.from[0] !== '*' && !rule.from.includes(from)) return [false,'انتقال غير مسموح من هذه الحالة'];
  if (!rule.by.includes(byRole)) return [false,'صلاحية غير كافية'];
  if (rule.must?.some(k => !payload?.[k])) return [false,`نواقص: ${rule.must.filter(k=>!payload?.[k]).join(', ')}`];
  return [true, null];
}

function applyPostHooks(rule, req, payload) {
  const posts = rule.post || [];
  if (posts.includes('requireTechnicianAssignedOrBlock') && !req.assignedTechnicianName) {
    throw new Error('يجب تعيين فني قبل الاعتماد');
  }
  if (posts.includes('clearAssignedTechnician')) {
    req.assignedTechnicianName = '';
  }
}


// =======================================================
// دالّة إدارة مسار الطلب + سجل التعديلات (Audit Trail)
// =======================================================
// الاستخدامات:
// updateRequestLifecycle({
//   requestId: '000123',
//   action: 'assignTechnician' | 'reassignTechnician' | 'techReport' | 'supervisorDecision' | 'clientFeedback' | 'softDelete',
//   actor: currentUser?.name,
//   role:  currentUser?.role,               // من ROLES
//   payload: {...}                          // حقول إضافية حسب الإجراء
// });
// الدالة تحدّث الطلب محليًا، تحفظ السجل الزمني، وتضيف عملية مزامنة syncQueue تلقائيًا.
// =======================================================




function updateRequestLifecycle({ requestId, action, actor, role, payload = {} }) {
  if (!requestId || !action) {
    console.warn('updateRequestLifecycle: requestId/action مفقود');
    return { ok:false, message:'requestId/action required' };
  }

  // ابحث عن الطلب
  const idx = requests.findIndex(r => r.id === requestId);
  if (idx === -1) return { ok:false, message:'الطلب غير موجود' };

  const req = requests[idx];
  const before = JSON.parse(JSON.stringify(req));           // نسخة للمقارنة
  const nowISO = new Date().toISOString();

  // تأكد من وجود سجل تعديلات
  if (!Array.isArray(req.audit)) req.audit = [];

  // أدوات مساعدة صغيرة
    const pushAudit = (evt) => {
      const record = {
        ts: nowISO,
        actor: actor || '',
        role:  role  || '',
        action,
        fromStatus: evt.fromStatus ?? (req.status || ''),
        toStatus:   evt.toStatus   ?? (req.status || ''),
        reason:     evt.reason     ?? '',
        changes:    evt.changes    ?? {},
        requestId:  req.id,
        requester:  req.requesterName || '',
        building:   req.building || '',
      };
      // خزّن محليًا
      req.audit.push(record);
      // أرسل نسخة للشيت (ورقة Logs)
      sendAuditToSheet(record);
    };


  const applyChanges = (changesObj) => {
    Object.entries(changesObj || {}).forEach(([k,v]) => { req[k] = v; });
  };

  // قيود صلاحيات مبسطة
  const isSupervisor = role === ROLES.SUPERVISOR || role === ROLES.QUALITY_MANAGER || role === ROLES.DEAN;
  const isTechnician = role === ROLES.TECHNICIAN;
  const isEmployee   = role === ROLES.EMPLOYEE;

  // انتقالات الحالة وفق الإجراء
      const rule = TRANSITIONS[action];
    const [ok, err] = canTransition({
      action,
      from: (req.status || null),
      byRole: role,
      payload
    });
    if (!ok) return { ok:false, message: err };

    let toStatus = rule.to;

  let reason   = '';

  switch (action) {
    // 1) تعيين الفني (أول مرة) بواسطة المشرف
      case 'assignTechnician': {
        if (!isSupervisor) return { ok:false, message:'الصلاحية للمشرف فقط' };
        const techName = payload.technicianName || payload.assignedTechnicianName;
        if (!techName) return { ok:false, message:'يجب تحديد اسم الفني' };

        applyChanges({
          assignedTechnicianName: techName,
          technicianName: techName,            // ← أضف هذا السطر
          supervisorName: actor || req.supervisorName || '',
          supervisorDecision: req.supervisorDecision || '',
          supervisorNotes: payload.supervisorNotes || req.supervisorNotes || '',
          supUpdatedAt: nowISO
        });

        toStatus = 'محوّل للفني';
        applyChanges({ status: toStatus });
        break;
      }


    // 2) إعادة تعيين الفني لاحقًا (بكل سهولة) بواسطة المشرف
    case 'reassignTechnician': {
      if (!isSupervisor) return { ok:false, message:'الصلاحية للمشرف فقط' };
      const newTech = payload.technicianName || payload.assignedTechnicianName;
      if (!newTech) return { ok:false, message:'يجب تحديد اسم الفني الجديد' };

      // احفظ تاريخ الإعادات
      if (!Array.isArray(req.reassignments)) req.reassignments = [];
      req.reassignments.push({
        from: req.assignedTechnicianName || '',
        to: newTech,
        ts: nowISO,
        by: actor || ''
      });

      applyChanges({
        assignedTechnicianName: newTech,
        supervisorName: actor || req.supervisorName || '',
        supervisorNotes: payload.supervisorNotes || req.supervisorNotes || '',
        supUpdatedAt: nowISO
      });

      // نبقي الحالة في “محوّل للفني” إن كان مسار الفني لم يكتمل
      if (req.status !== 'جاري المراجعة' && req.status !== 'مكتمل') {
        toStatus = 'محوّل للفني';
        applyChanges({ status: toStatus });
      }
      break;
    }

    // 3) تقرير الفني
    case 'techReport': {
      if (!isTechnician && !isSupervisor)
        return { ok:false, message:'الصلاحية للفني أو المشرف' };

      if (!payload.workStatus || !payload.technicianNotes)
        return { ok:false, message:'الرجاء تعبئة حالة العمل وملاحظات الفني' };

      applyChanges({
        technicianName: payload.technicianName || req.technicianName || actor || '',
        workStatus: payload.workStatus,
        technicianNotes: payload.technicianNotes,
        repairImage: payload.repairImage || req.repairImage || '',
        techUpdatedAt: nowISO
      });

      // بعد إدخال تقرير فني، يرجع لمراجعة المشرف
      toStatus = 'جاري المراجعة';
      applyChanges({ status: toStatus });
      break;
    }

    // 4) قرار المشرف النهائي (اعتماد/رفض/يحتاج مراجعة)
    case 'supervisorDecision': {
      const isSupervisor = role === ROLES.SUPERVISOR || role === ROLES.QUALITY_MANAGER || role === ROLES.DEAN;
      if (!isSupervisor) return { ok:false, message:'الصلاحية للمشرف فقط' };
      if (!payload.decision) return { ok:false, message:'حدد القرار' };
      if (payload.decision === 'معتمد' && !(req.assignedTechnicianName||'').trim()) {
        return { ok:false, message:'يجب تعيين فني قبل الاعتماد' };
      }

      applyChanges({
        supervisorName: actor || req.supervisorName || '',
        supervisorDecision: payload.decision, // 'معتمد' | 'مرفوض' | 'يحتاج مراجعة'
        supervisorNotes: payload.supervisorNotes || req.supervisorNotes || '',
        supUpdatedAt: nowISO
      });

      // ✅ ضبط الحالة هنا فقط، بدون تعديل خارجي لاحقًا
      if (payload.decision === 'مرفوض') {
        toStatus = STATUS.REJECTED; // 'مرفوض'
      } else if (payload.decision === 'معتمد') {
        // بعد اعتماد المشرف → تذهب للسلامة النهائية
        toStatus = STATUS.WAIT_SAFETY_2; // 'بانتظار السلامة (نهائية)'
      } else {
        toStatus = STATUS.NEEDS_REVIEW; // 'يحتاج مراجعة'
      }

      applyChanges({ status: toStatus });
      break;
    }

    // 5) تقييم العميل
    case 'clientFeedback': {
      if (!isEmployee && !isSupervisor) {
        // عادة صاحب الطلب أو المشرف بالنيابة
        return { ok:false, message:'الصلاحية لصاحب الطلب أو المشرف' };
      }
      if (!payload.isFixed) return { ok:false, message:'حدد: هل تم الإصلاح؟' };

      applyChanges({
        isFixed: payload.isFixed,                                 // 'نعم' | 'لا'
        satisfactionLevel: payload.satisfactionLevel || '',
        clientNotes: payload.clientNotes || '',
        clientUpdatedAt: nowISO
      });

      toStatus = (payload.isFixed === 'نعم') ? 'مكتمل' : 'غير مكتمل';
      applyChanges({ status: toStatus });
      break;
    }

    // 6) حذف (تحويل لمحذوف + سبب)
    case 'softDelete': {
        // لو موظف: لا يحذف إلا طلبه
        if (role === ROLES.EMPLOYEE && (req.requesterName||'') !== (currentUser?.name||'')) {
          return { ok:false, message:'لا يمكنك حذف طلب ليس ملكك' };
        }
        const reason = (payload.deleteReason || payload.reason || '').toString().trim();
        if (!reason) return { ok:false, message:'يجب توثيق سبب الحذف' };

        toStatus = 'محذوف';
        applyChanges({
          status: 'محذوف',
          deletedAt: nowISO,
          deletedBy: actor || '',
          deleteReason: reason
        });

        syncQueue.add({ type:'delete', data:{ id: req.id, reason } });

        try { applyPostHooks(rule, req, payload); } catch(e){ return { ok:false, message: e.message }; }

        pushAudit({ fromStatus: before.status, toStatus, reason, changes:{ deleteReason: reason } });
        saveRequestsToStorage();
        refreshAllTables();
        return { ok:true, request: req };
      }


        // 7) إعادة توجيه من صاحب الطلب إلى المشرف مع سبب
      case 'clientRedirect': {
        if (role !== ROLES.EMPLOYEE && role !== ROLES.SUPERVISOR) {
          return { ok:false, message:'الإجراء متاح لصاحب الطلب (أو المشرف بالنيابة)' };
        }
        const r = (payload.redirectReason || payload.reason || '').trim();
        if (!r) return { ok:false, message:'الرجاء كتابة سبب إعادة التوجيه' };
        if ((req.status||'').trim() === STATUS.WAIT_SUP) {
          return { ok:false, message:'الطلب بالفعل لدى المشرف' };
        }
        req.cycleNo = (req.cycleNo||0) + 1;
        if (req.cycleNo > 2) {
          return { ok:false, message:'تم بلوغ الحد الأقصى من مرات إعادة التوجيه' };
        }

        toStatus = STATUS.WAIT_SUP; // ← الحالة الصحيحة
        applyChanges({
          redirectReason: r,
          status: toStatus,
          assignedTechnicianName: '', // تفريغ التعيين ليُعاد التوزيع
          supUpdatedAt: nowISO
        });
        break;
      }



    // 8) إلغاء من صاحب الطلب مع سبب
    case 'clientCancel': {
      if (role !== ROLES.EMPLOYEE && role !== ROLES.SUPERVISOR) {
        return { ok:false, message:'الإجراء متاح لصاحب الطلب (أو المشرف بالنيابة)' };
      }
      const r = (payload.cancelReason || payload.reason || '').trim();
      if (!r) return { ok:false, message:'الرجاء كتابة سبب الإلغاء' };

      toStatus = 'ملغي';
      applyChanges({
        status: 'ملغي',
        cancelReason: r,
        canceledAt: nowISO,
        canceledBy: actor || ''
      });

      // ادفع تحديث للشيت
      syncQueue.add({ type:'update', data: req });

      pushAudit({ fromStatus: before.status, toStatus, reason: r, changes:{ cancelReason:r } });
      saveRequestsToStorage();
      refreshAllTables();
      return { ok:true, request: req };
    }


    default:
      return { ok:false, message:'Action غير مدعومة' };
  }

  // اختلافات بسيطة للتوثيق
  const changes = diffObject(before, req, [
    'assignedTechnicianName','technicianName','workStatus','technicianNotes','repairImage',
    'supervisorName','supervisorDecision','supervisorNotes',
    'isFixed','satisfactionLevel','clientNotes','status'
  ]);

  pushAudit({ fromStatus: before.status, toStatus, changes });

  // حفظ محلي وتحديث واجهة
  saveRequestsToStorage();
  refreshAllTables();

  // الدفع إلى GAS (add/update حسب الحالة)
  const opType = (action === 'assignTechnician' || action === 'reassignTechnician' || action === 'techReport' || action === 'supervisorDecision' || action === 'clientFeedback')
    ? 'update' : 'add';

  syncQueue.add({ type: opType, data: req });

  return { ok:true, request: req };
}

// ====== دالة مساعدة لاستخراج الفروقات ======
function diffObject(prev, next, keysWhitelist = []) {
  const changes = {};
  const keys = keysWhitelist.length ? keysWhitelist : Array.from(new Set([...Object.keys(prev||{}), ...Object.keys(next||{})]));
  keys.forEach(k => {
    const a = prev?.[k];
    const b = next?.[k];
    if (JSON.stringify(a) !== JSON.stringify(b)) {
      changes[k] = { from: a, to: b };
    }
  });
  return changes;
}


// Auto Sync - المزامنة التلقائية
// ✅ تزامن موحّد: الشيت هو مصدر الحقيقة
async function autoSync(silent = false) {
  if (!appsScriptUrl) return;

  // 1) عالج العمليات المعلّقة أولاً (لو فيه Queue)
  if (syncQueue.queue.length > 0) {
    if (!silent) showSyncIndicator('syncing', `⏳ معالجة ${syncQueue.queue.length} عملية...`, false);
    try {
      await syncQueue.process();
    } catch (e) {
      console.warn('تعذّر إفراغ الصف كاملاً الآن، سنكمل السحب من الشيت', e);
    }
  }

  if (!silent) showSyncIndicator('syncing', '↓ سحب البيانات...', false);

  try {
    const res = await callAppsScript('getRequests', requestScope(), false);
    if (!res || !Array.isArray(res.data)) {
      if (!silent) showSyncIndicator('error', '✗ فشل السحب من الشيت');
      return;
    }

    // 2) تحويل الصفوف العربية إلى نموذج الواجهة
    let sheetRequests = res.data.map(mapArabicRowToModel).map(r => ({
      ...r,
      requesterName: r.requesterName || r.createdBy || '',
    }));

    // 3) اختياري: تجاهل المحذوف نهائيًا من العرض (أو اتركه إن تحب إظهاره)
    // إن رغبت بإخفائه تمامًا من الجداول:
    // sheetRequests = sheetRequests.filter(r => r.status !== 'محذوف');

    // 4) استبدال كامل للنسخة المحلية (بدون دمج عكسي)
    requests = sheetRequests;
    saveRequestsToStorage();
    refreshAllTables();
    updateNextRequestId();

    requests = (requests || []).map(r => ({
  ...r,
      // لو واحد منهم فاضي، عبّيه من الآخر
      assignedTechnicianName: r.assignedTechnicianName || r.technicianName || '',
      technicianName: r.technicianName || r.assignedTechnicianName || ''
    }));

    if (!silent) showSyncIndicator('success', '✓ البيانات محدّثة');

  } catch (err) {
    console.error('خطأ في المزامنة:', err);
    if (!silent) showSyncIndicator('error', '✗ فشلت المزامنة');
  }
}

// Setup Permissions
function setupPermissions() {
  const tabsBtns = document.querySelectorAll('.nav-tab');
  tabsBtns.forEach(tab => tab.style.display = 'none');

  const show = (id) => {
    const btn = document.querySelector(`[onclick="showTab('${id}')"]`);
    if (btn) btn.style.display = 'block';
  };

  const role = (currentUser?.role || '').trim();

  if (role === ROLES.QUALITY_MANAGER || role === ROLES.DEAN) {
    // يشوف كل شيء
    ['new-request','safety-review-1','supervisor-review','technician-report','safety-review-2','client-feedback','my-requests','quality-report']
      .forEach(show);
    showTab('safety-review-1');
    return;
  }

  if (role === ROLES.SAFETY_OFFICER) {
    // مسؤول السلامة: المراجعتين + الجودة
    ['safety-review-1','safety-review-2','quality-report'].forEach(show);
    showTab('safety-review-1');
    return;
  }

  if (role === ROLES.SUPERVISOR) {
    // مشرف الصيانة: تعيين فني/قرار + الجودة
    ['supervisor-review','quality-report'].forEach(show);
    showTab('supervisor-review');
    return;
  }

  if (role === ROLES.TECHNICIAN) {
    // الفني: فقط تقاريره
    ['technician-report'].forEach(show);
    showTab('technician-report');
    return;
  }

  // الموظف (صاحب الطلب)
  if (role === ROLES.EMPLOYEE) {
    ['new-request','my-requests','client-feedback'].forEach(show);
    showTab('my-requests');
  }
}

// Show Tab
function showTab(tabId) {
  // فعّل المحتوى
  document.querySelectorAll('.tab-content').forEach(c => {
    c.classList.toggle('active', c.id === tabId);
  });

  // فعّل زر التبويب المطابق
  document.querySelectorAll('.nav-tab').forEach(btn => {
    const isMatch = btn.getAttribute('onclick') === `showTab('${tabId}')`;
    btn.classList.toggle('active', isMatch);
  });

  refreshAllTables();
}


// Set Current DateTime
function setCurrentDateTime() {
  const now = new Date();
  const time = now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
  const date = now.toLocaleDateString('ar-SA');
  const hijri = toHijri(now);
  const day = getArabicDay(now);
  
  document.getElementById('requestTime').value = time;
  document.getElementById('requestDate').value = date;
  document.getElementById('hijriDate').value = hijri;
  document.getElementById('requestDay').value = day;
}

// Update Request ID

function updateNextRequestId() {
  const idInput = document.getElementById('requestId');
  if (!idInput) return;

  const list = Array.isArray(requests) ? requests : [];
  const maxId = list.reduce((max, r) => {
    const n = parseInt((r?.id || '0').toString().replace(/\D+/g, ''), 10);
    return Number.isFinite(n) && n > max ? n : max;
    // ملاحظة: لو تستخدم IDs غير رقمية بالكامل، استبدل المنطق بمولّد UUID من جهة الشيت
  }, 0);

  const nextId = (maxId + 1).toString().padStart(6, '0');
  idInput.value = nextId;
}

// Toggle Other Fault
function toggleOtherFault() {
  const faultType = document.getElementById('faultType').value;
  const otherDiv = document.getElementById('otherFaultDiv');
  
  if (faultType === 'أخرى') {
    otherDiv.classList.remove('hidden');
    document.getElementById('otherFault').required = true;
  } else {
    otherDiv.classList.add('hidden');
    document.getElementById('otherFault').required = false;
  }
}

// Reset Form
function resetForm() {
  removeImage();
  updateNextRequestId();
  setCurrentDateTime();
}

// Submit New Request

// ✅ إضافة طلب: الشيت أولاً، ثم تحديث النسخة المحلية
async function submitNewRequest(e) {
  e.preventDefault();

  const submitBtn = document.getElementById('submitRequestBtn');
  submitBtn.disabled = true;
  submitBtn.textContent = 'جاري الإرسال...';

  if (!uploadedImage) {
    alert('❌ يجب رفع صورة العطل قبل إرسال الطلب');
    submitBtn.disabled = false;
    submitBtn.textContent = 'إرسال الطلب';
    return;
  }

  const faultType = document.getElementById('faultType').value;
  const finalFaultType = faultType === 'أخرى' ? document.getElementById('otherFault').value : faultType;
  const requesterNameFinal = currentUser?.name || '';

const request = {
  id: document.getElementById('requestId').value,
  type: document.getElementById('requestType').value,
  building: document.getElementById('building').value,
  maintenanceType: document.getElementById('maintenanceType').value,
  requesterName: requesterNameFinal,
  time: document.getElementById('requestTime').value,
  date: document.getElementById('requestDate').value,
  hijriDate: document.getElementById('hijriDate').value,
  day: document.getElementById('requestDay').value,
  faultType: finalFaultType,
  faultDescription: document.getElementById('faultDescription').value,
  image: uploadedImage || '',
  status: 'بانتظار السلامة (أولية)',  // ← التصحيح
  createdAt: new Date().toISOString(),
  createdBy: currentUser?.name || ''
};

  try {
    // 1) حاول الحفظ في الشيت مباشرة
    const res = await callAppsScript('addRequest', request);
    if (!res || res.ok !== true) throw new Error(res?.message || 'فشل الحفظ في الشيت');

    // 2) بعد نجاح الشيت: اسحب نسخة جديدة كاملة (مصدر الحقيقة)
    await autoSync(true);

    showAlert('newRequestAlert', 'تم تسجيل البلاغ بنجاح! رقم البلاغ: ' + request.id, 'success');


  } catch (err) {
    console.warn('تعذّر الحفظ الآن، سنضيفه للصف:', err.message);

    // 3) صف انتظار (Offline-first) + إدراج محلي مؤقت حتى لا يضيع على المستخدم
    requests.push(request);
    saveRequestsToStorage();
    refreshAllTables();

    syncQueue.add({ type: 'add', data: request });
    showAlert('newRequestAlert', 'تم الحفظ محليًا وسيتم المزامنة تلقائيًا عند توفر الاتصال', 'info');
  }

  // 4) نظافة واجهة
  document.getElementById('newRequestForm').reset();
  removeImage();
  updateNextRequestId();
  setCurrentDateTime();
  lockRequesterToCurrentUser();
  showTab('my-requests'); // ✅ تحويل صاحب الطلب مباشرة لمتابعة طلبه

  const a = document.getElementById('myRequestsAlert');
  if (a) {
    a.textContent = 'تم إرسال طلبك! يمكنك متابعة مساره من هنا.';
    a.style.display = 'block';
    setTimeout(() => a.style.display = 'none', 4000);
  }

  submitBtn.disabled = false;
  submitBtn.textContent = 'إرسال الطلب';

  setTimeout(() => { document.getElementById('newRequestAlert').style.display = 'none'; }, 5000);
}


// Open Technician Modal
function openTechnicianModal(requestId) {
  document.getElementById('techRequestId').value = requestId;
  document.getElementById('technicianName').value = currentUser.name;
  
  // امسح الصورة السابقة
  techRepairImage = null;
  document.getElementById('techRepairImagePreview').classList.remove('show');
  document.getElementById('removeTechImageBtn').classList.remove('show');
  document.getElementById('techUploadContainer').classList.remove('has-image');
  document.getElementById('techRepairImage').value = '';
  
  document.getElementById('technicianModal').classList.add('active');
}

// Submit Technician Report
async function submitTechnicianReport(e) {
  e.preventDefault();
  
  const requestId = document.getElementById('techRequestId').value;

  // التحقق من وجود صورة الإصلاح
      if (!techRepairImage) {
        alert('❌ يجب رفع صورة الإصلاح قبل إرسال التقرير');
        return;
      }
      const request = requests.find(r => r.id === requestId);
      
      const res = updateRequestLifecycle({
      requestId,
      action: 'techReport',
      actor: currentUser?.name,
      role:  currentUser?.role,
      payload: {
        technicianName: document.getElementById('technicianName').value,
        workStatus: document.getElementById('workStatus').value,
        technicianNotes: document.getElementById('technicianNotes').value,
        repairImage: techRepairImage
      }
    });
    if(!res.ok){ alert(res.message); return; }

    closeModal('technicianModal');
    techRepairImage = null;
    showAlert('technicianAlert', 'تم حفظ التقرير بنجاح!', 'success');
    document.getElementById('technicianForm').reset();
    refreshAllTables();
    setTimeout(()=>{ document.getElementById('technicianAlert').style.display='none'; },3000);

}

// Open Supervisor Modal
async function openSupervisorModal(requestId) {
  if (techniciansLoading || !techniciansLoaded) {
    showNotification('⏳ جاري تحميل قائمة الفنيين...', 'info');
    if (!techniciansLoading && !techniciansLoaded) { try { await loadTechnicians(); } catch(_){} }
    if (!techniciansLoaded) return;
  }

  const req = requests.find(r => r.id === requestId);
  document.getElementById('supRequestId').value = requestId;
  document.getElementById('supervisorName').value = currentUser.name;

  // تعبئة الفنيين حسب نوع العطل
  populateTechnicianSelect(req?.faultType || '');

  // لو فيه فني معيَّن مسبقًا، اختَرْه
  const sel = document.getElementById('assignedTechnicianSelect');
  sel.value = req?.assignedTechnicianName || '';

  // إظهار/إخفاء القرار: يظهر فقط عندما الحالة "جاري المراجعة"
  const decisionBlock = document.getElementById('decisionBlock');
  const inTechReview = (req?.status || '').trim() === 'جاري المراجعة';
  decisionBlock.style.display = inTechReview ? 'block' : 'none';

  // لو مو "جاري المراجعة" فضّي القرار
  if (!inTechReview) document.getElementById('supervisorDecision').value = '';

  document.getElementById('supervisorModal').classList.add('active');
}




// Submit Supervisor Review

async function submitSupervisorReview(e) {
  e.preventDefault();
  const requestId = document.getElementById('supRequestId').value;
  const notes     = document.getElementById('supervisorNotes').value;
  const chosenTech= (document.getElementById('assignedTechnicianSelect')?.value || '').trim();
  const decision  = (document.getElementById('supervisorDecision')?.value || '').trim();

  const req = requests.find(r => r.id === requestId);
  const cur = (req?.status || '').trim();

  // 1) لو مو "جاري المراجعة": نسمح فقط بالتعيين
  if (cur !== 'جاري المراجعة') {
    if (!chosenTech) { alert('اختر الفني أولاً'); return; }
    const r1 = updateRequestLifecycle({
      requestId,
      action: 'assignTechnician',
      actor: currentUser?.name,
      role:  currentUser?.role,
      payload: { assignedTechnicianName: chosenTech, supervisorNotes: notes }
    });
    if (!r1.ok) { alert(r1.message); return; }
    closeModal('supervisorModal');
    showAlert('supervisorAlert','تم تحويل الطلب للفني بنجاح','success');
    return;
  }

  // 2) لو نحن في "جاري المراجعة": القرار فقط
  if (!decision) { alert('اختر القرار (معتمد / يحتاج مراجعة)'); return; }

const r2 = updateRequestLifecycle({
  requestId,
  action: 'supervisorDecision',
  actor: currentUser?.name,
  role:  currentUser?.role,
  payload: { decision, supervisorNotes: notes }
});

if (!r2.ok) { alert(r2.message); return; }

  closeModal('supervisorModal');
  showAlert('supervisorAlert','تم حفظ قرار المشرف','success');
}

// Open Safety Modal 1
function openSafetyModal1(requestId) {
  document.getElementById('safetyRequestId1').value = requestId;
  document.getElementById('safetyOfficerName1').value = currentUser.name;
  document.getElementById('safetyModal1').classList.add('active');
}

// Submit Safety Review 1
async function submitSafetyReview1(e) {
  e.preventDefault();
  
  const requestId = document.getElementById('safetyRequestId1').value;
  const decision = document.getElementById('safetyDecision1').value;
  const notes = document.getElementById('safetyNotes1').value;
  const request = requests.find(r => r.id === requestId);
  
  if (request) {
    request.safetyOfficerName1 = document.getElementById('safetyOfficerName1').value;
    request.safetyDecision1 = decision;
    request.safetyNotes1 = notes;
    request.safety1UpdatedAt = new Date().toISOString();
    

    if (decision === 'غير آمن - مرفوض') {
      request.status = 'مرفوض';
    } else {
      // آمن للتنفيذ أو يحتاج إجراءات سلامة → للمشرف مع إرفاق ملاحظات السلامة
      request.status = 'بانتظار المشرف';
    }
    
    saveRequestsToStorage();
    refreshAllTables();
    
    syncQueue.add({ type: 'update', data: request });
    
    closeModal('safetyModal1');
    showAlert('supervisorAlert', 'تم حفظ مراجعة السلامة بنجاح!', 'success');
    document.getElementById('safetyForm1').reset();
  }
}

// Open Safety Modal 2
function openSafetyModal2(requestId) {
  document.getElementById('safetyRequestId2').value = requestId;
  document.getElementById('safetyOfficerName2').value = currentUser.name;
  document.getElementById('safetyModal2').classList.add('active');
}

// Submit Safety Review 2
async function submitSafetyReview2(e) {
  e.preventDefault();
  
  const requestId = document.getElementById('safetyRequestId2').value;
  const decision = document.getElementById('safetyDecision2').value;
  const notes = document.getElementById('safetyNotes2').value;
  const request = requests.find(r => r.id === requestId);
  
  if (request) {
    request.safetyOfficerName2 = document.getElementById('safetyOfficerName2').value;
    request.safetyDecision2 = decision;
    request.safetyNotes2 = notes;
    request.safety2UpdatedAt = new Date().toISOString();
    
    if (decision === 'غير معتمد') {
      request.status = 'مرفوض';
    } else {
      request.status = 'معتمد';
    }
    
    saveRequestsToStorage();
    refreshAllTables();
    
    syncQueue.add({ type: 'update', data: request });
    
    closeModal('safetyModal2');
    showAlert('supervisorAlert', 'تم حفظ المراجعة النهائية للسلامة بنجاح!', 'success');
    document.getElementById('safetyForm2').reset();
  }
}

// Open Client Modal
function openClientModal(requestId) {
  document.getElementById('clientRequestId').value = requestId;
  document.getElementById('clientModal').classList.add('active');
}

// Submit Client Feedback
async function submitClientFeedback(e) {
  e.preventDefault();
  
  const requestId = document.getElementById('clientRequestId').value;
  const request = requests.find(r => r.id === requestId);
  
  if (request) {
    request.isFixed = document.getElementById('isFixed').value;
    request.satisfactionLevel = document.getElementById('satisfactionLevel').value;
    request.clientNotes = document.getElementById('clientNotes').value;
    request.status = request.isFixed === 'نعم' ? 'مكتمل' : 'غير مكتمل';
    request.clientUpdatedAt = new Date().toISOString();
    
    saveRequestsToStorage();
    refreshAllTables();
    
    syncQueue.add({
      type: 'update',
      data: request
    });
    
    closeModal('clientModal');
    showAlert('clientAlert', 'تم إرسال التقييم بنجاح! شكراً لك', 'success');
    refreshAllTables();
    
    document.getElementById('clientForm').reset();
    
    setTimeout(() => {
      document.getElementById('clientAlert').style.display = 'none';
    }, 3000);
  }
}

// View Request Details

function detailCard({icon='ℹ️', label='', value='-', extraClass=''}) {
  return `
    <div class="detail-card ${extraClass}">
      <div class="dc-ico">${icon}</div>
      <div class="dc-body">
        <div class="dc-label">${label}</div>
        <div class="dc-value">${value || '-'}</div>
      </div>
    </div>
  `;
}

function buildBasicInfoSection(req){
  const stClass = getStatusClass(req.status);
  const statusBadge = `<span class="status-badge status-${stClass}">${req.status||'-'}</span>`;
  const imgSrc = resolveImageSrc(req._faultImageResolved || req.image || req.imageUrl || '');


  return `
    <div class="details-grid">
      ${detailCard({icon:'🔢', label:'رقم الطلب', value:req.id, extraClass:'emph'})}
      ${detailCard({icon:'📥', label:'نوع الطلب', value:req.type})}
      ${detailCard({icon:'🏢', label:'المبنى', value:req.building})}
      ${detailCard({icon:'🛠️', label:'نوع الصيانة', value:req.maintenanceType})}
      ${detailCard({icon:'👤', label:'صاحب الطلب', value:req.requesterName})}
      ${detailCard({icon:'📅', label:'التاريخ (ميلادي/هجري)', value:`${req.date||'-'} — ${req.hijriDate||'-'}`})}
      ${detailCard({icon:'⏰', label:'الوقت', value:req.time})}
      ${detailCard({icon:'🗓️', label:'اليوم', value:req.day})}
      ${detailCard({icon:'⚡', label:'نوع العطل', value:req.faultType})}
      ${detailCard({icon:'👨‍🔧', label:'الفني المعيّن', value:req.assignedTechnicianName || req.technicianName || '-'})}
      ${detailCard({icon:'📌', label:'الحالة', value:statusBadge, extraClass:'detail-status'})}
      ${detailCard({icon:'📝', label:'وصف العطل', value:(req.faultDescription||'—'), extraClass:'detail-row-2'})}
      ${ imgSrc ? `
        <div class="detail-card detail-image detail-row-2">
          <div class="dc-ico">📷</div>
          <div class="dc-body">
            <div class="dc-label">صورة العطل</div>
            <img src="${imgSrc}" alt="صورة العطل" onclick="viewImage('${imgSrc.replace(/'/g, "\\'")}')">
          </div>
        </div>` : '' }
    </div>
  `;
}


async function viewRequest(requestId) {
  const request = requests.find(r => r.id === requestId);
  if (!request) return;
  
  document.getElementById('viewDetailsContent').innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div><p>جاري تحميل التفاصيل...</p></div>';
  document.getElementById('viewModal').classList.add('active');
  
  // تحميل الصور
  let faultImageData = request.image || '';
  let repairImageData = request.repairImage || '';

  // خزّن نسخًا محلولة لاستخدامها في البطاقات
request._faultImageResolved  = faultImageData || request.image || request.imageUrl || '';
request._repairImageResolved = repairImageData || request.repairImage || request.repairImageUrl || '';

  
  if (!faultImageData && request.imageUrl) {
    faultImageData = await getDriveImageAsDataURL(request.imageUrl) || request.imageUrl;
  }
  if (!repairImageData && request.repairImageUrl) {
    repairImageData = await getDriveImageAsDataURL(request.repairImageUrl) || request.repairImageUrl;
  }
  
  // بناء HTML مع Timeline أولاً
  let html = '<div style="text-align: right;">';

// المسار أولًا
html += generateTimeline(request);

// === تفاصيل أساسية (بنفس روح المسار) ===
html += '<h3 style="color: #006341; margin: 25px 0 12px;">📋 معلومات الطلب الأساسية</h3>';
html += buildBasicInfoSection(request);

// تقرير الفني
// تقرير الفني
if (request.technicianName || request.workStatus || request.technicianNotes) {
  html += '<hr style="margin: 22px 0;">';
  html += '<h3 style="color: #006341; margin-bottom: 12px;">🔧 تقرير الفني</h3>';

  const repImg = resolveImageSrc(request._repairImageResolved || request.repairImage || request.repairImageUrl || '');

  html += `
    <div class="details-grid">
      ${detailCard({icon:'👨‍🔧', label:'اسم الفني', value:request.technicianName||'-'})}
      ${detailCard({icon:'📊', label:'حالة العمل', value:request.workStatus||'-'})}
      ${detailCard({icon:'🗒️', label:'ملاحظات الفني', value:request.technicianNotes||'—', extraClass:'detail-row-2'})}
      ${ repImg ? `
        <div class="detail-card detail-image detail-row-2">
          <div class="dc-ico">🪛</div>
          <div class="dc-body">
            <div class="dc-label">صورة الإصلاح</div>
            <img src="${repImg}" alt="صورة الإصلاح" onclick="viewImage('${repImg.replace(/'/g, "\\'")}')">
          </div>
        </div>` : ''
      }
    </div>
  `;
}


// مراجعة المشرف
if (request.supervisorName) {
  html += '<hr style="margin: 22px 0;">';
  html += '<h3 style="color: #006341; margin-bottom: 12px;">✅ مراجعة المشرف</h3>';
  html += `
    <div class="details-grid">
      ${detailCard({icon:'🧑‍💼', label:'اسم المشرف', value:request.supervisorName})}
      ${detailCard({icon:'✔️', label:'القرار', value:request.supervisorDecision})}
      ${detailCard({icon:'🗒️', label:'ملاحظات المشرف', value:request.supervisorNotes, extraClass:'detail-row-2'})}
    </div>
  `;
}
  
// مراجعة السلامة الأولية
if (request.safetyOfficerName1) {
  html += '<hr style="margin: 22px 0;">';
  html += '<h3 style="color: #ffc107; margin-bottom: 12px;">🦺 مراجعة السلامة (أولية)</h3>';
  html += `
    <div class="details-grid">
      ${detailCard({icon:'🦺', label:'مسؤول السلامة', value:request.safetyOfficerName1})}
      ${detailCard({icon:'✔️', label:'القرار', value:request.safetyDecision1})}
      ${detailCard({icon:'🗒️', label:'ملاحظات السلامة', value:request.safetyNotes1, extraClass:'detail-row-2'})}
    </div>
  `;
}

// مراجعة السلامة النهائية
if (request.safetyOfficerName2) {
  html += '<hr style="margin: 22px 0;">';
  html += '<h3 style="color: #ffc107; margin-bottom: 12px;">🦺 مراجعة السلامة (نهائية)</h3>';
  html += `
    <div class="details-grid">
      ${detailCard({icon:'🦺', label:'مسؤول السلامة', value:request.safetyOfficerName2})}
      ${detailCard({icon:'✔️', label:'القرار النهائي', value:request.safetyDecision2})}
      ${detailCard({icon:'🗒️', label:'ملاحظات السلامة النهائية', value:request.safetyNotes2, extraClass:'detail-row-2'})}
    </div>
  `;
}

// تقييم العميل / أسباب
if (request.isFixed || request.redirectReason || request.cancelReason) {
  html += '<hr style="margin: 22px 0;">';
  html += '<h3 style="color: #006341; margin-bottom: 12px;">⭐ صاحب الطلب (تقييم/إجراء)</h3>';
  html += `
    <div class="details-grid">
      ${ request.isFixed ? detailCard({icon:'🛠️', label:'تم الإصلاح', value:request.isFixed}) : '' }
      ${ request.satisfactionLevel ? detailCard({icon:'🌟', label:'مستوى الرضا', value:request.satisfactionLevel}) : '' }
      ${ request.clientNotes ? detailCard({icon:'💬', label:'ملاحظات العميل', value:request.clientNotes, extraClass:'detail-row-2'}) : '' }
      ${ request.redirectReason ? detailCard({icon:'↩️', label:'سبب إعادة التوجيه', value:request.redirectReason, extraClass:'detail-row-2'}) : '' }
      ${ request.cancelReason ? detailCard({icon:'⛔', label:'سبب الإلغاء', value:request.cancelReason, extraClass:'detail-row-2'}) : '' }
    </div>
  `;
}

html += '</div>';
document.getElementById('viewDetailsContent').innerHTML = html;
}

// Delete Request

// ✅ حذف/تعليم محذوف: الشيت أولاً ثم المحلي (مع صف انتظار عند الفشل)
async function deleteRequest(requestId){
  const reason = prompt('أدخل سبب الحذف (سيُحفظ في السجل):');
  if (!reason || !reason.trim()) return;

  const res = updateRequestLifecycle({
    requestId,
    action: 'softDelete',
    actor: currentUser?.name,
    role:  currentUser?.role,
    payload: { deleteReason: reason.trim() }
  });

  if(!res.ok){ alert(res.message||'تعذّر الحذف'); return; }

  alert('تم تحويل الطلب إلى "محذوف". سيتم دفع التحديث إلى Google Sheets عبر الـ Queue.');
}





function openClientActionsModal(requestId) {
  document.getElementById('clientActionRequestId').value = requestId;
  document.getElementById('clientActionReason').value = '';
  document.getElementById('clientActionsModal').classList.add('active');
}

async function submitClientAction(e) {
  e.preventDefault();
  const id = document.getElementById('clientActionRequestId').value;
  const reason = (document.getElementById('clientActionReason').value||'').trim();
  if (!id || !reason) return;

  // تنفيذ حذف ناعم باسم صاحب الطلب
  const res = updateRequestLifecycle({
    requestId: id,
    action: 'softDelete',
    actor: currentUser?.name,
    role:  currentUser?.role,
    payload: { deleteReason: reason }
  });

  if (res.ok) {
    showNotification('تم حذف الطلب ووُثّق في السجل.', 'success');
  } else {
    showNotification(res.message||'تعذّر التنفيذ', 'error');
  }
  closeModal('clientActionsModal');
}



function renderMiniTimeline(req){
  // مراحلنا: مرسَل → تقرير فني → مراجعة مشرف → تقييم عميل → مكتمل/مرفوض
  const hasTech = !!req.technicianName;
  const hasSup  = !!req.supervisorName;
  const hasCli  = !!req.isFixed;

  // تحديد الحالة الحالية لإظهار اللون
  const statClass = getStatusClass(req.status); // pending/progress/completed/rejected

  // نص مختصر
  let label = 'مرسَل';
  if (req.status === 'مرفوض' || req.status === 'غير مكتمل') label = 'مرفوض';
  else if (req.status === 'مكتمل') label = 'مكتمل';
  else if (req.status === 'معتمد') label = 'معتمد';
  else if (req.status === 'جاري المراجعة') label = 'مراجعة مشرف';
  else if (hasTech) label = 'تقرير فني';

  // نقاط مصغّرة توضّح أين وصل
  // pending → progress → completed/rejected
  let dot1 = 'pending', dot2 = 'pending', dot3 = 'pending', dot4 = 'pending';
  // بعد الفني
  if (hasTech) dot2 = 'progress';
  // بعد المشرف
  if (hasSup) dot3 = 'progress';
  // بعد العميل
  if (hasCli) dot4 = 'progress';
  // لو الحالة النهائية مكتملة أو مرفوضة حوّل آخر نقطة لتلك الحالة
  if (statClass === 'completed') dot4 = 'completed';
  if (statClass === 'rejected')  dot4 = 'rejected';
  // لو لسا “جاري المراجعة” خلّي dot3 أو dot2 أزرق (progress)
  if (statClass === 'progress' && !hasCli) {
    if (hasSup) dot3 = 'progress';
    else if (hasTech) dot2 = 'progress';
  }

  return `
    <div class="mini-flow" title="المسار: ${label}">
      <span class="mini-dot ${dot1}"></span>
      <span class="mini-dot ${dot2}"></span>
      <span class="mini-dot ${dot3}"></span>
      <span class="mini-dot ${dot4}"></span>
      <span class="mini-text">${label}</span>
    </div>
  `;
}


// ======== جلب اليوزرات من Google Sheets + تعبئة قائمة الفنيين ========

// يتوقع الـ GAS يرجّع: { ok:true, users:[{name, role, specialty}] }
// أو يرجّع رؤوس عربية: الاسم/الدور/التخصص
function normalizeUsers(rawUsers) {
  if (!Array.isArray(rawUsers)) return [];
  return rawUsers.map(u => {
    const name = u.name || u['الاسم'] || '';
    const role = u.role || u['الدور'] || '';
    const specialty = u.specialty || u['التخصص'] || '';
    return { name, role, specialty };
  });
}

// جلب من السكربت
async function fetchUsersFromSheets() {
  if (!appsScriptUrl) return [];
  const res = await callAppsScript('getUsers', {});
  if (!res || res.ok !== true) return [];
  return normalizeUsers(res.users || res.data || []);
}

// fallback محلي لو فشل الشيت
function fallbackTechs() {
  return [
    { name: 'خالد علي',     role: ROLES.TECHNICIAN, specialty: 'كهربائي' },
    { name: 'سعيد القحطاني', role: ROLES.TECHNICIAN, specialty: 'تكييف' },
    { name: 'ماجد حمود',     role: ROLES.TECHNICIAN, specialty: 'سباكة' },
    { name: 'عبدالله سالم',  role: ROLES.TECHNICIAN, specialty: 'الكترونيات' },
  ];
}

// تخزين/تحميل كاش محلي
function saveUsersCache(u){ try{ localStorage.setItem('usersCache', JSON.stringify(u||[])); }catch{} }
function loadUsersCache(){ try{ return JSON.parse(localStorage.getItem('usersCache')||'[]'); }catch{ return []; } }

// الدالة المطلوبة في كودك: تُنادى داخل showMainApp()
async function loadTechnicians() {
  // بداية: علِّم إننا بدأنا التحميل
  techniciansLoading = true;
  techniciansLoaded  = false;

  // جرّب من الكاش أولًا (تسريع)
  let cached = loadUsersCache();
  if (cached.length) users = cached;

  // حاول جلب أحدث نسخة من الشيت
  let fromSheets = [];
  try {
    fromSheets = await fetchUsersFromSheets();
  } catch (e) {
    console.warn('fetchUsersFromSheets error:', e);
  }

  if (fromSheets.length) {
    users = fromSheets;
    saveUsersCache(users);
  } else if (!users.length) {
    // إن ما فيه شيت ولا كاش: استخدم قائمة محلية تجريبية
    users = fallbackTechs();
    saveUsersCache(users);
    // (اختياري) نبّه إننا استخدمنا قائمة محلية
    console.warn('⚠️ تعذّر الجلب من الشيت — تم استخدام قائمة محلية.');
  }

  // نهاية: انتهى التحميل
  techniciansLoaded  = true;
  techniciansLoading = false;

  // تسجيل بدون رسائل منبثقة متكررة
  console.log('✅ تم تحميل قائمة الفنيين:', users.length);
}
// خريطة بسيطة بين نوع العطل وتخصص الفني
function mapFaultToSpecialty(faultType) {
  const t = (faultType||'').trim();
  if (t.includes('كهرب')) return 'كهربائي';
  if (t.includes('تكييف')) return 'تكييف';
  if (t.includes('سباك') || t.includes('سباكة')) return 'سباكة';
  if (t.includes('الكترون')) return 'الكترونيات';
  // غير ذلك: رجّع فارغ عشان نعرض كل الفنيين
  return '';
}

// الدالة المطلوبة في كودك: تُنادى في openSupervisorModal(requestId)
function populateTechnicianSelect(faultType) {
  const sel = document.getElementById('assignedTechnicianSelect');
  if (!sel) return;

  // فلترة الفنيين فقط
  const allTechs = (users || []).filter(u => (u.role||'').trim() === ROLES.TECHNICIAN);

  // فلترة بالتخصص إن أمكن
  const spec = mapFaultToSpecialty(faultType);
  let list = allTechs;
  if (spec) {
    const s = spec.trim();
    list = allTechs.filter(u => (u.specialty||'').includes(s));
    // لو ما وجدنا أحد بالتخصص، اعرض الجميع بدل ما تتركها فاضية
    if (!list.length) list = allTechs;
  }

  // تعبئة القائمة
  sel.innerHTML = '<option value="">— اختر الفني —</option>';
  list.forEach(t => {
    const opt = document.createElement('option');
    opt.value = t.name;
    opt.textContent = t.specialty ? `${t.name} — ${t.specialty}` : t.name;
    sel.appendChild(opt);
  });
}

// (اختياري) زر فحص سريع في الكونسول
window.debugCheckUsers = function() {
  const techs = (users||[]).filter(u => (u.role||'').trim() === ROLES.TECHNICIAN);
  console.log('إجمالي المستخدمين:', users.length);
  console.log('عدد الفنيين:', techs.length, techs);
  alert(`تم الجلب.\nإجمالي المستخدمين: ${users.length}\nعدد الفنيين: ${techs.length}`);
};

function getVisibleRequests() {
  const list = Array.isArray(requests) ? requests : [];
  if (!currentUser) return list;

  const role = (currentUser.role || '').trim();
  if (role === ROLES.EMPLOYEE) {
    return list.filter(r => (r.requesterName || '') === (currentUser.name || ''));
  }
  if (role === ROLES.TECHNICIAN) {
    const me = normalizeName(currentUser.name || '');
    return list.filter(r => {
      const a = normalizeName(r.assignedTechnicianName || '');
      const t = normalizeName(r.technicianName || '');
      return a === me || t === me;
    });
  }
  // المشرف/الجودة/العميد يشوفون الكل
  return list;
}


// Refresh All Tables
// بدلاً من استدعاء 4 دوال في كل مرة، يمكن تحسينها:
function refreshAllTables() {
  if (!currentUser) return;
  refreshSafetyReviewTable1();     // ← جديد
  refreshSafetyReviewTable2();     // ← جديد
  refreshPendingRequestsTable();
  refreshTechnicianReportsTable();
  refreshApprovedRequestsTable();
  refreshAllRequestsTable();
  refreshMyRequestsTable();
  updateStatistics();
}


// Refresh Pending Requests Table
function refreshPendingRequestsTable() {
  const tbody = document.getElementById('pendingRequestsTable');

  // الفنيين يشتغلوا على "محوّل للفني"
  const list = getVisibleRequests().filter(r => r.status === 'محوّل للفني');

  if (list.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 30px; color: #999;">لا توجد طلبات محوّلة لك</td></tr>';
    return;
  }

  tbody.innerHTML = list.map(req => `
    <tr>
      <td>${req.id}</td>
      <td>${req.requesterName}</td>
      <td>${req.faultType}</td>
      <td>${req.building}</td>
      <td>${req.date}</td>
      <td>${
        resolveImageSrc(req.image || req.imageUrl)
          ? '<button class="action-btn btn-image" onclick="viewImage(\'' + resolveImageSrc(req.image || req.imageUrl).replace(/'/g, "\\'") + '\')">📷</button>'
          : '-'
      }</td>
      <td><span class="status-badge status-progress">${req.status}</span></td>
      <td>${renderMiniTimeline(req)}</td>
      <td>
        <div class="action-buttons">
          <button class="action-btn btn-view" onclick="viewRequest('${req.id}')">مسار</button>
          <button class="action-btn btn-edit" onclick="openTechnicianModal('${req.id}')">معالجة</button>
        </div>
      </td>
    </tr>
  `).join('');
}



// Refresh Technician Reports Table
function refreshTechnicianReportsTable() {
  const tbody = document.getElementById('technicianReportsTable');

  // المشرف يشوف: بانتظار المشرف + يحتاج مراجعة + جاري المراجعة
  const list = getVisibleRequests().filter(r =>
    ['بانتظار المشرف','يحتاج مراجعة','جاري المراجعة'].includes((r.status||'').trim())
  );

  if (!list.length) {
    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 30px; color: #999;">لا توجد طلبات للمراجعة حالياً</td></tr>';
    return;
  }

  tbody.innerHTML = list.map(req => `
    <tr>
      <td>${renderMiniTimeline(req)}</td>
      <td>${req.id} ${req.redirectReason ? '<span title="تعليق عميل" style="margin-right:6px;display:inline-block;padding:2px 8px;border-radius:12px;background:#fff3cd;color:#856404;font-size:.78rem;font-weight:700">💬</span>' : ''}</td>
      <td>${req.requesterName}</td>
      <td>${req.faultType}</td>
      <td>${req.assignedTechnicianName || req.technicianName || '-'}</td>
      <td>${req.date}</td>
      <td>${
        resolveImageSrc(req.image || req.imageUrl)
          ? '<button class="action-btn btn-image" onclick="viewImage(\'' + resolveImageSrc(req.image || req.imageUrl).replace(/'/g,"\\'") + '\')">📷</button>'
          : '-'
      }</td>
      <td><span class="status-badge status-${getStatusClass(req.status)}">${req.status}</span></td>
      <td>
        <div class="action-buttons">
          <button class="action-btn btn-view" onclick="viewRequest('${req.id}')">مسار</button>
          <button class="action-btn btn-edit" 
        ${techniciansLoading || !techniciansLoaded ? 'disabled title="⏳ انتظر تحميل قائمة الفنيين..."' : ''}
                onclick="openSupervisorModal('${req.id}')">
          ${techniciansLoading || !techniciansLoaded ? 'جاري التحميل...' : 'مراجعة/تعيين'}
        </button>
        </div>
      </td>
    </tr>
  `).join('');
}

// Refresh Safety Review Table 1
function refreshSafetyReviewTable1() {
  const tbody = document.getElementById('safetyReviewTable1');
  const list = getVisibleRequests().filter(r => r.status === 'بانتظار السلامة (أولية)');

  if (!list.length) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: #999;">لا توجد طلبات للمراجعة</td></tr>';
    return;
  }

  tbody.innerHTML = list.map(req => `
    <tr>
      <td>${req.id}</td>
      <td>${req.requesterName}</td>
      <td>${req.faultType}</td>
      <td>${req.building}</td>
      <td>${req.date}</td>
      <td>${resolveImageSrc(req.image || req.imageUrl) ? 
        '<button class="action-btn btn-image" onclick="viewImage(\'' + 
        resolveImageSrc(req.image || req.imageUrl).replace(/'/g,"\\'") + '\')">📷</button>' : '-'}</td>
      <td><span class="status-badge status-safety">${req.status}</span></td>
      <td>
        <div class="action-buttons">
          <button class="action-btn btn-view" onclick="viewRequest('${req.id}')">مسار</button>
          <button class="action-btn btn-edit" style="background:#ffc107" onclick="openSafetyModal1('${req.id}')">مراجعة</button>
        </div>
      </td>
    </tr>
  `).join('');
}

// Refresh Safety Review Table 2
function refreshSafetyReviewTable2() {
  const tbody = document.getElementById('safetyReviewTable2');
  const list = getVisibleRequests().filter(r => r.status === 'بانتظار السلامة (نهائية)');

  if (!list.length) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: #999;">لا توجد طلبات للمراجعة النهائية</td></tr>';
    return;
  }

  tbody.innerHTML = list.map(req => `
    <tr>
      <td>${req.id}</td>
      <td>${req.requesterName}</td>
      <td>${req.faultType}</td>
      <td>${req.assignedTechnicianName || req.technicianName || '-'}</td>
      <td>${req.date}</td>
      <td>${resolveImageSrc(req.image || req.imageUrl) ? 
        '<button class="action-btn btn-image" onclick="viewImage(\'' + 
        resolveImageSrc(req.image || req.imageUrl).replace(/'/g,"\\'") + '\')">📷</button>' : '-'}</td>
      <td><span class="status-badge status-safety">${req.status}</span></td>
      <td>
        <div class="action-buttons">
          <button class="action-btn btn-view" onclick="viewRequest('${req.id}')">مسار</button>
          <button class="action-btn btn-edit" style="background:#ffc107" onclick="openSafetyModal2('${req.id}')">مراجعة نهائية</button>
        </div>
      </td>
    </tr>
  `).join('');
}

// يربط حقل "اسم صاحب الطلب" بالمستخدم الحالي ويقفل الحقل
function lockRequesterToCurrentUser() {
  const nameInput = document.getElementById('requesterName');
  if (!nameInput) return;

  // تعبئة تلقائية باسم المستخدم + قفل الحقل
  nameInput.value = currentUser?.name || '';
  nameInput.disabled = true;
  nameInput.readOnly = true;
  nameInput.placeholder = 'يُعبّأ تلقائيًا من حساب الدخول';
  nameInput.title = 'هذا الحقل يُحدَّد تلقائيًا حسب المستخدم الذي سجّل الدخول';

  // إخفاء الحقل بصريًا (اختياري) — احذف السطرين التاليين لو تحب تبقيه ظاهرًا
  const group = nameInput.closest('.form-group');
  if (group) group.style.display = 'none';
}

// يُرجع الطلبات المرئية للمستخدم الحالي حسب الدور




// Refresh Approved Requests Table
function refreshApprovedRequestsTable() {
  const tbody = document.getElementById('approvedRequestsTable');
  const list = getVisibleRequests().filter(r => (r.status||'').trim() === 'معتمد');

  if (!list.length) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: #999;">لا توجد طلبات معتمدة للتقييم</td></tr>';
    return;
  }

  tbody.innerHTML = list.map(req => `
    <tr>
      <td>${renderMiniTimeline(req)}</td>
      <td>${req.id}</td>
      <td>${req.requesterName || '-'}</td>
      <td>${req.faultType || '-'}</td>
      <td>${req.date || '-'}</td>
      <td>${
        resolveImageSrc(req.image || req.imageUrl)
          ? '<button class="action-btn btn-image" onclick="viewImage(\'' + resolveImageSrc(req.image || req.imageUrl).replace(/'/g,"\\'") + '\')">📷</button>'
          : '-'
      }</td>
      <td><span class="status-badge status-${getStatusClass(req.status)}">${req.status}</span></td>
      <td>
        <div class="action-buttons">
          <button class="action-btn btn-view" onclick="viewRequest('${req.id}')">مسار</button>
          <button class="action-btn btn-edit" onclick="openClientModal('${req.id}')">تقييم العميل</button>
        </div>
      </td>
    </tr>
  `).join('');
}

function refreshMyRequestsTable() {
  const tbody = document.getElementById('myRequestsTable');
  const list = getVisibleRequests().filter(r => true); // getVisibleRequests يحصر الموظف تلقائيًا

  if (!list.length) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:30px;color:#999;">لا توجد طلبات حالياً</td></tr>';
    return;
  }

  tbody.innerHTML = list.map(req => `
    <tr>
      <td>${renderMiniTimeline(req)}</td>
      <td>${req.id}</td>
      <td>${req.faultType}</td>
      <td>${req.building}</td>
      <td>${req.date}</td>
      <td><span class="status-badge status-${getStatusClass(req.status)}">${req.status}</span></td>
      <td>
        <div class="action-buttons">
          <button class="action-btn btn-view" onclick="viewRequest('${req.id}')">تفاصيل</button>
          ${
            (req.status !== 'مكتمل' && req.status !== 'مرفوض' && req.status !== 'ملغي' && req.status !== 'محذوف')
            ? `<button class="action-btn btn-delete" onclick="openClientActionsModal('${req.id}')">حذف</button>`
            : ''
          }
        </div>
      </td>
    </tr>
  `).join('');
}


// === Template via relative URL ===
const TEMPLATE_URL = './templates/maintenance_template.xlsx';

// خريطة الحقول ← الخلايا (عدّل الخلايا حسب تمبليتك)
const TEMPLATE_CELL_MAP = {
  'C8':   r => r.id,
  'F8':   r => r.type,
  'I8':   r => r.building,
  'D9':   r => r.maintenanceType,
  'D11':  r => r.requesterName,
  'D13':  r => r.time,
  'H13':  r => r.date,             // الميلادي
  'C15':  r => r.faultType,
  'A19':  r => r.faultDescription,
  'C25':  r => r.assignedTechnicianName || r.technicianName || '',
  'H26':  r => r.techDate || r.date || '',
  'C29':  r => r.supervisorName || '',
  'C30':  r => r.status || '',
  'H31':  r => r.supDate || r.date || '',
  'C34':  r => r.requesterName || '',
  'C35':  r => r.isFixed || '',
  'H36':  r => r.clientDate || r.date || ''
};

// تحميل التمبليت من ملف مجاور (ويُخزّن بالذاكرة)
let __templateArrayBuffer = null;
async function loadTemplateArrayBuffer() {
  if (__templateArrayBuffer) return __templateArrayBuffer;
  const res = await fetch(TEMPLATE_URL);
  if (!res.ok) throw new Error('تعذّر تحميل ملف التمبليت');
  __templateArrayBuffer = await res.arrayBuffer();
  return __templateArrayBuffer;
}

function dataURLToBase64(dataURL) {
  return (dataURL || '').split(',')[1] || '';
}

// تعبئة خلايا النموذج
function fillTemplateCells(ws, request) {
  for (const cell in TEMPLATE_CELL_MAP) {
    const getter = TEMPLATE_CELL_MAP[cell];
    const val = (typeof getter === 'function') ? getter(request) : (request[getter] ?? '');
    const c = ws.getCell(cell);
    c.value = (val == null ? '' : val);
    c.alignment = Object.assign({}, c.alignment, { readingOrder: 'rtl' });
  }
}

// إدراج صورة العطل في نطاق محدد (اضبط المكان حسب تمبليتك)
// إدراج صورة العطل داخل التمبليت (يدعم imageUrl عبر Apps Script)
async function tryInsertFaultImage(wb, ws, request) {
  // نحاول أولاً dataURL المخزّن محليًا
  let dataUrl = request.image || '';
  // إن لم تتوفر وحصلنا على imageUrl من Drive، حوّلها إلى Base64
  if (!dataUrl && request.imageUrl) {
    dataUrl = await getDriveImageAsDataURL(request.imageUrl);
    if (!dataUrl) {
      try { dataUrl = await urlToDataURL(request.imageUrl); } catch(_) {}
    }
  }
  if (!dataUrl) return; // لا صورة

  try {
    const base64 = (dataUrl.split(',')[1] || '');
    const ext = dataUrl.startsWith('data:image/png') ? 'png' : 'jpeg';
    const imgId = wb.addImage({ base64, extension: ext });
    // عدّل الإحداثيات حسب تمبليتك
    ws.addImage(imgId, { tl: { col: 7, row: 18 }, br: { col: 11, row: 28 } });
  } catch (e) {
    console.warn('تعذّر إدراج الصورة داخل التمبليت:', e);
  }
}



// Refresh All Requests Table
function refreshAllRequestsTable() {
  const tbody = document.getElementById('allRequestsTable');
  const list = getVisibleRequests();

  if (!list.length) {
    tbody.innerHTML = '<tr><td colspan="12" style="text-align:center;padding:30px;color:#999;">لا توجد بيانات</td></tr>';
    return;
  }

  tbody.innerHTML = list.map(req => `
    <tr>
      <td>${renderMiniTimeline(req)}</td>
      <td>${req.id}</td>
      <td>${req.requesterName || '-'}</td>
      <td>${req.faultType || '-'}</td>
      <td>${req.building || '-'}</td>
      <td>${req.date || '-'}</td>
      <td>${req.assignedTechnicianName || req.technicianName || '-'}</td>
      <td>${req.supervisorName || '-'}</td>
      <td>${
        resolveImageSrc(req.image || req.imageUrl)
          ? '<button class="action-btn btn-image" onclick="viewImage(\'' + resolveImageSrc(req.image || req.imageUrl).replace(/'/g,"\\'") + '\')">📷</button>'
          : '-'
      }</td>
      <td><span class="status-badge status-${getStatusClass(req.status)}">${req.status}</span></td>
      <td>${req.satisfactionLevel || '-'}</td>
      <td>
        <div class="action-buttons">
          <button class="action-btn btn-view" onclick="viewRequest('${req.id}')">تفاصيل</button>
          <button class="action-btn btn-pdf" onclick="/* TODO: pdf for ${req.id} */ alert('قريبًا PDF لطلب ${req.id}')">PDF</button>
        </div>
      </td>
    </tr>
  `).join('');
}



// Update Statistics
function updateStatistics() {
  const list = Array.isArray(requests) ? requests : [];

  const total = list.length;

  // نعتبر “تمت المعالجة” = مكتمل فقط
  const completed = list.filter(r => (r.status||'').trim() === 'مكتمل').length;

  // نعتبر خارج المعالجة = مكتمل/مرفوض/ملغي/محذوف/غير مكتمل
  const terminalStatuses = new Set(['مكتمل','مرفوض','ملغي','محذوف','غير مكتمل']);
  const inProgress = list.filter(r => !terminalStatuses.has((r.status||'').trim())).length;

  const rejected = list.filter(r => (r.status||'').trim() === 'مرفوض').length;

  const el = id => document.getElementById(id);

  if (el('totalRequests'))     el('totalRequests').textContent = String(total);
  if (el('rejectedRequests'))  el('rejectedRequests').textContent = String(rejected);
  if (el('inProgressCount'))   el('inProgressCount').textContent = String(inProgress);
  if (el('completedCount'))    el('completedCount').textContent = String(completed);
}



// Export to Excel
function exportToExcel() {
  if (requests.length === 0) {
    alert('لا توجد بيانات للتصدير');
    return;
  }
  
  const data = requests.map(req => ({
    'رقم الطلب': req.id,
    'صاحب الطلب': req.requesterName,
    'نوع الطلب': req.type,
    'المبنى': req.building,
    'نوع الصيانة': req.maintenanceType,
    'نوع العطل': req.faultType,
    'وصف العطل': req.faultDescription,
    'التاريخ': req.date,
    'التاريخ الهجري': req.hijriDate,
    'الوقت': req.time,
    'اليوم': req.day,
    'اسم الفني': req.assignedTechnicianName || req.technicianName || '-',
    'حالة العمل': req.workStatus || '-',
    'اسم المشرف': req.supervisorName || '-',
    'قرار المشرف': req.supervisorDecision || '-',
    'تم الإصلاح': req.isFixed || '-',
    'مستوى الرضا': req.satisfactionLevel || '-',
    'الحالة النهائية': req.status,
    'يحتوي على صورة': (req.image || req.imageUrl) ? 'نعم' : 'لا'
  }));
  
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'تقرير الصيانة');
  
  const fileName = `تقرير_السلامة_TVTC_${new Date().toLocaleDateString('ar-SA').replace(/\//g, '-')}.xlsx`;
  XLSX.writeFile(wb, fileName);
}

// Export to PDF
function exportToPDF() {
  if (requests.length === 0) {
    alert('لا توجد بيانات للتصدير');
    return;
  }
  
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('l', 'mm', 'a4');
  
  //doc.setLanguage('ar');
  doc.setR2L(true);
  
  doc.setFontSize(20);
  doc.setTextColor(102, 126, 234);
  doc.text('🔧', 15, 15);
  
  doc.setFontSize(18);
  doc.setTextColor(0, 0, 0);
  doc.text('تقرير الصيانة الشامل', doc.internal.pageSize.width / 2, 20, { align: 'center' });
  
  doc.setFontSize(12);
  doc.text(`التاريخ: ${new Date().toLocaleDateString('ar-SA')}`, doc.internal.pageSize.width - 15, 15, { align: 'right' });
  
  const tableData = requests.map(req => [
    req.id,
    req.requesterName,
    req.faultType,
    req.building,
    req.date,
    req.technicianName || '-',
    req.supervisorName || '-',
    req.status,
    (req.image || req.imageUrl) ? '✓' : '-'
  ]);
  
  doc.autoTable({
    startY: 30,
    head: [['رقم الطلب', 'صاحب الطلب', 'نوع العطل', 'المبنى', 'التاريخ', 'الفني', 'المشرف', 'الحالة', 'صورة']],
    body: tableData,
    styles: {
      font: 'helvetica',
      fontSize: 10,
      halign: 'center'
    },
    headStyles: {
      fillColor: [102, 126, 234],
      textColor: 255,
      fontStyle: 'bold'
    },
    alternateRowStyles: {
      fillColor: [245, 245, 250]
    }
  });
  
  const pageCount = doc.internal.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(10);
    doc.setTextColor(150);
    doc.text(
      `صفحة ${i} من ${pageCount}`,
      doc.internal.pageSize.width / 2,
      doc.internal.pageSize.height - 10,
      { align: 'center' }
    );
  }
  
  const fileName = `تقرير_الصيانة_${new Date().toLocaleDateString('ar-SA').replace(/\//g, '-')}.pdf`;
  doc.save(fileName);
}

// Export All Requests with Templates
// Export All Requests with Templates (نسخة مُحسّنة)
async function exportAllWithTemplates() {
  if (requests.length === 0) { alert('لا توجد بيانات'); return; }

  showNotification('جاري تجهيز جميع النماذج...', 'info');

  // 1) حمّل التمبليت كـ ArrayBuffer
  const ab = await loadTemplateArrayBuffer();

  // 2) افتح التمبليت كـ Workbook أساسي للنسخ منه
  const baseWb = new ExcelJS.Workbook();
  await baseWb.xlsx.load(ab);
  const baseSheet = baseWb.worksheets[0];

  // 3) أنشئ ملف الإخراج
  const outWb = new ExcelJS.Workbook();

  // 4) كرر على كل طلب وأنشئ ورقة مطابقة للتمبليت
  for (const req of requests) {
    const sheetName = `طلب_${req.id}`.substring(0, 31);
    const ws = outWb.addWorksheet(sheetName);

    // انسخ شكل التمبليت (إعدادات الورقة+الدمج+المقاسات+الأنماط)
    cloneTemplateTo(baseSheet, ws);

    // عبّئ الخلايا بالقيم
    fillTemplateCells(ws, req);

    // إن رغبت بإدراج الصورة داخل كل نموذج، فك التعليق:
    // await tryInsertFaultImage(outWb, ws, req);
  }

  // 5) أنشئ الملف للتحميل
  const fileName = `نماذج_الصيانة_${new Date().toLocaleDateString('ar-SA').replace(/\//g, '-')}.xlsx`;
  const outBuf = await outWb.xlsx.writeBuffer();
  const blob = new Blob([outBuf], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = fileName;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);

  showNotification(`تم تصدير ${requests.length} نموذج من التمبليت!`, 'success');
}

// ينسخ ورقة التمبليت إلى ورقة جديدة مع الحفاظ على الإعدادات والدمج والتنسيقات
function cloneTemplateTo(srcSheet, dstSheet) {
  // إعدادات الطباعة/الورقة/العرض (تحافظ على RTL والهوامش…)
  dstSheet.pageSetup = JSON.parse(JSON.stringify(srcSheet.pageSetup || {}));
  dstSheet.properties = JSON.parse(JSON.stringify(srcSheet.properties || {}));
  dstSheet.views = JSON.parse(JSON.stringify(srcSheet.views || []));

  // أعمدة: العرض، الإخفاء، مستويات outline
  if (srcSheet.columns) {
    dstSheet.columns = srcSheet.columns.map(col => ({
      key: col.key,
      width: col.width,
      hidden: col.hidden,
      outlineLevel: col.outlineLevel
    }));
  }

  // نسخ القيم والأنماط صفاً بصف
  srcSheet.eachRow({ includeEmpty: true }, (row, r) => {
    const newRow = dstSheet.getRow(r);
    newRow.height = row.height; // مهم

    row.eachCell({ includeEmpty: true }, (cell, c) => {
      const nc = newRow.getCell(c);

      // القيمة (قد تكون نص/صيغة/غ…)
      nc.value = cell.value;

      // نسخ الأنماط (font, alignment, border, fill, numFmt, protection)
      if (cell.style) {
        nc.style = JSON.parse(JSON.stringify(cell.style));
      }

      // احتياط لقراءة RTL لو ما كانت في التمبليت
      nc.alignment = Object.assign({}, nc.alignment, { readingOrder: 'rtl' });
    });
  });

  // نسخ الدمج (merged cells)
  // ExcelJS يخزن الدمج داخليًا؛ ندعم الشكلين (Set أو Array)
  if (srcSheet._merges && typeof srcSheet._merges.forEach === 'function') {
    srcSheet._merges.forEach(range => dstSheet.mergeCells(range));
  } else if (Array.isArray(srcSheet._merges)) {
    srcSheet._merges.forEach(range => dstSheet.mergeCells(range));
  }
}



// Export Single Request with Template
async function exportWithTemplate(requestId) {
  const request = requests.find(r => r.id === requestId);
  if (!request) { alert('الطلب غير موجود'); return; }

  showNotification('جاري تجهيز النموذج...', 'info');

  // 1) حمل التمبليت
  const ab = await loadTemplateArrayBuffer();

  // 2) افتح التمبليت
  const wb = new ExcelJS.Workbook();
  await wb.xlsx.load(ab);

  // 3) اختر الورقة الأولى (أو اسم الورقة لو عندك اسم محدد)
  const ws = wb.worksheets[0]; // أو wb.getWorksheet('نموذج الصيانة');

  // 4) عبّئ الخلايا
  fillTemplateCells(ws, request);

  // 5) (اختياري) أدرج صورة العطل في مكانها
   // await tryInsertFaultImage(wb, ws, request);

  // 6) حمّل الملف للمستخدم
  const fileName = `نموذج_طلب_صيانة_${request.id}.xlsx`;
  const outBuf = await wb.xlsx.writeBuffer();
  const blob = new Blob([outBuf], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = fileName;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);

  showNotification('تم تصدير النموذج من التمبليت بنجاح!', 'success');
}

// Notification Helper
function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#3498db'};
    color: white;
    padding: 15px 25px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 10000;
    animation: slideIn 0.3s ease;
    font-weight: 500;
  `;
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

// Export Single PDF

// Export Single PDF (يدعم imageUrl من Drive بتحويلها إلى Base64)
// Export Single PDF (يدعم imageUrl من Drive بتحويلها إلى Base64)
// === استبدل الدالة كاملة بهذه النسخة ===
async function exportSinglePDF(requestId) {
  const req = requests.find(r => r.id === requestId);
  if (!req) { alert('الطلب غير موجود'); return; }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'mm', 'a4');
  doc.setR2L(true);

  const pageW = doc.internal.pageSize.getWidth();
  const pageH = doc.internal.pageSize.getHeight();
  let y = 20;

  // رأس الصفحة
  doc.setFontSize(20);
  doc.setTextColor(102, 126, 234);
  doc.text('🔧', 15, y);
  doc.setFontSize(16);
  doc.setTextColor(0, 0, 0);
  doc.text(`نموذج أمر عمل (صيانة) - رقم ${req.id}`, pageW / 2, y, { align: 'center' });
  y += 12;

  doc.setFontSize(11);
  const row = (label, value) => {
    doc.text(`${label}: ${value || '-'}`, pageW - 15, y, { align: 'right' });
    y += 7;
  };

  row('نوع الطلب', req.type);
  row('المبنى', req.building);
  row('نوع الصيانة', req.maintenanceType);
  row('صاحب الطلب', req.requesterName);
  row('التاريخ', `${req.date || '-'} — ${req.hijriDate || '-'}`);
  row('الوقت', req.time || '-');

  // فاصل
  y += 2; doc.setDrawColor(220); doc.line(15, y, pageW - 15, y); y += 6;

  // وصف العطل (بتفاف)
  doc.setTextColor(102, 126, 234);
  doc.text('وصف العطل', pageW - 15, y, { align: 'right' }); y += 6;
  doc.setTextColor(0, 0, 0);
  const desc = doc.splitTextToSize(req.faultDescription || '-', pageW - 30);
  doc.text(desc, pageW - 15, y, { align: 'right' });
  y += Math.min(40, desc.length * 6);

  // ملخص التنفيذ/الحالات
  y += 4;
  doc.setTextColor(102, 126, 234);
  doc.text('ملخص التنفيذ', pageW - 15, y, { align: 'right' }); y += 6;
  doc.setTextColor(0, 0, 0);
  [
    `الحالة الحالية: ${req.status || '-'}`,
    `الفني المعيّن: ${req.assignedTechnicianName || req.technicianName || '-'}`,
    `حالة العمل: ${req.workStatus || '-'}`,
    `المشرف: ${req.supervisorName || '-'}`,
    `قرار المشرف: ${req.supervisorDecision || '-'}`,
    `تم الإصلاح: ${req.isFixed || '-'}`,
    `مستوى الرضا: ${req.satisfactionLevel || '-'}`
  ].forEach(line => { doc.text(line, pageW - 15, y, { align: 'right' }); y += 6; });

  // دالة مساعدة لإدراج صورة (Base64 فقط)
  async function addImageBlock(title, dataUrl) {
    if (!dataUrl) return;
    const imgW = 80, imgH = 60;

    if (y + imgH + 20 > pageH) { doc.addPage(); y = 20; }
    doc.setTextColor(102, 126, 234);
    doc.text(title, pageW - 15, y, { align: 'right' }); y += 6;
    doc.setTextColor(0, 0, 0);

    try {
      const ext = dataUrl.startsWith('data:image/png') ? 'PNG' : 'JPEG';
      doc.addImage(dataUrl, ext, pageW - 15 - imgW, y, imgW, imgH);
      y += imgH + 6;
    } catch (e) {
      console.warn('addImage error:', e);
    }
  }

  // تجهيز صور العطل والإصلاح (Base64 إن أمكن)
  let faultData = req.image || '';
  if (!faultData && req.imageUrl) {
    faultData =
      (await getDriveImageAsDataURL(req.imageUrl)) ||
      (await (async () => { try { return await urlToDataURL(req.imageUrl); } catch { return ''; } })());
  }
  await addImageBlock('صورة العطل', faultData);

  let repairData = req.repairImage || '';
  if (!repairData && req.repairImageUrl) {
    repairData =
      (await getDriveImageAsDataURL(req.repairImageUrl)) ||
      (await (async () => { try { return await urlToDataURL(req.repairImageUrl); } catch { return ''; } })());
  }
  await addImageBlock('صورة الإصلاح', repairData);

  // تذييل الصفحات
  const pageCount = doc.internal.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(9);
    doc.setTextColor(150);
    doc.text(`صفحة ${i} من ${pageCount}`, pageW / 2, pageH - 10, { align: 'center' });
  }

  doc.save(`نموذج_بلاغ_سلامة_${req.id}.pdf`);
}

// Print Report
function printReport() {
  window.print();
}



// Close modal when clicking outside
window.onclick = function(event) {
  if (event.target.classList.contains('modal')) {
    event.target.classList.remove('active');
  }
};

// Storage Functions
// Storage Functions
function saveRequestsToStorage() {
  try { localStorage.setItem('requests', JSON.stringify(requests || [])); } catch {}
}

function loadRequestsFromStorage() {
  try { requests = JSON.parse(localStorage.getItem('requests') || '[]'); } catch { requests = []; }
}

function showAlert(elId, msg, type='success') {
  const el = document.getElementById(elId);
  if (!el) return;
  el.className = `alert alert-${type}`;
  el.textContent = msg;
  el.style.display = 'block';
  setTimeout(()=>{ el.style.display='none'; }, 4000);
}

function closeModal(id) {
  const m = document.getElementById(id);
  if (m) m.classList.remove('active');
}



// Auto-save and sync
setInterval(() => {
  if (currentUser && appsScriptUrl) {
    saveRequestsToStorage();
    // Optional: Auto-sync with Sheets
    // syncWithSheets();
  }
}, 30000);

// Update time every minute
setInterval(() => {
  if (currentUser) {
    setCurrentDateTime();
  }
}, 60000);

// زر مؤقت للمسح السريع
function clearLocalRequestsCache() {
  localStorage.removeItem('maintenanceRequests');
  requests = [];
  refreshAllTables();
  showNotification('تم مسح النسخة المحلية. حدّث/أعد تحميل الصفحة.', 'success');
}

// مزامنة تلقائية كل 5 دقائق
setInterval(async () => {
  if (currentUser && appsScriptUrl) {
    await autoSync(true); // سحب من الشيت وتحديث الجداول بصمت
  }
}, 5 * 60 * 1000);


// معالجة Queue عند الاتصال بالإنترنت
// ✅ معالجة Queue عند الاتصال بالإنترنت - محسّن
window.addEventListener('online', async () => {
  showSyncIndicator('syncing', '🌐 استعادة الاتصال...', false);
  
  if (syncQueue.queue.length > 0) {
    console.log(`🔄 معالجة ${syncQueue.queue.length} عملية معلقة...`);
    await syncQueue.process();
  }
  
  // مزامنة كاملة بعد Queue
  if (currentUser && appsScriptUrl) {
    await autoSync(true); // silent mode
  }
});

window.addEventListener('offline', () => {
  showSyncIndicator('error', '⚠️ انقطع الاتصال', true);
  console.warn('⚠️ وضع Offline: العمليات ستُضاف إلى Queue');
});



// ✅ دالة مراقبة Queue (للتطوير والاختبار)
window.checkSyncQueue = function() {
  console.log('📊 حالة Queue:');
  console.log('- عدد العمليات:', syncQueue.queue.length);
  console.log('- قيد المعالجة:', syncQueue.processing);
  console.log('- التفاصيل:', syncQueue.queue);
  
  if (syncQueue.queue.length > 0) {
    console.log('\n💡 لمعالجة العمليات المعلقة، اكتب: syncQueue.process()');
  }
  
  alert(`📊 حالة المزامنة:\n\n` +
        `عدد العمليات المعلقة: ${syncQueue.queue.length}\n` +
        `قيد المعالجة: ${syncQueue.processing ? 'نعم' : 'لا'}\n\n` +
        `تفاصيل إضافية في Console`);
};

window.addEventListener('error', (event) => {
  console.error('خطأ في التطبيق:', event.error);
  showNotification('حدث خطأ في النظام. تحقق من Console', 'error');
});

window.addEventListener('unhandledrejection', (event) => {
  console.error('Promise مرفوض:', event.reason);
  showNotification('فشلت عملية غير متزامنة', 'error');
});

</script>

</body>
</html>